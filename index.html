<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ v17.7</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
    --male:#2563eb; --female:#f97316;
    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;
    --scale:1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:.78}

  h1{margin:0 0 12px;font-size:18px;display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  button,input[type="text"],input[type="file"],input[type="number"],input[type="time"],textarea,select{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:16px;cursor:pointer
  }
  input[type="text"],input[type="time"],textarea,select{width:100%;cursor:text}
  input[type="number"]{width:7em}
  textarea{min-height:120px;resize:vertical}
  .pill{border-radius:999px;padding:6px 10px;font-size:13px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;background:#fff;cursor:pointer}
  .chip.active{background:#eef2ff;border-color:#c7d2fe}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

  .today-banner{margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:14px}

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:84vh}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:700;font-size:12px;color:#111;
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);
  }
  tr:hover td{background:#f9fafb}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  .tinted td{background:var(--tint)!important}
  .done-row td{background:var(--doneTint)!important;color:#111!important}

  .col-date{width:160px}
  .col-type{width:160px}
  .col-goal,.col-result,.col-review{width:1fr}
  .col-donebtn{width:120px}
  .cell{display:flex;align-items:center;gap:8px}
  .type-buttons .chip{min-width:68px;text-align:center}

  /* pop */
  .pop{
    position:absolute;pointer-events:none;font-weight:800;font-size:16px;
    animation:pop 1.2s ease forwards; text-shadow:0 1px 0 #fff;
    transform:translate(-50%,-50%);
  }
  @keyframes pop{0%{opacity:0;transform:translate(-50%,-10px) scale(.9)}10%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50px) scale(1.05)}}

  /* rankãªã©ï¼ˆçœç•¥ï¼šå…ƒã®ã¾ã¾ï¼‰ */
  .fab{position:fixed;z-index:5;right:14px;bottom:14px;width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.12)}
  .fab span{font-size:22px;line-height:1}
  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:100px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}
  .bubble{position:absolute;left:8px;right:8px;top:8px;border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);display:none;white-space:pre-line}
  .bubble.show{display:block;animation:fadeIn .15s ease}
  .bubble.yell{font-size:22px;padding:16px 18px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰<span class="muted" id="verTag">v17.7</span>
    <span class="muted" id="savedAt" style="margin-left:8px">æœ€çµ‚ä¿å­˜: -</span>
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab" title="å­¦æ ¡">C ğŸ«</button>
    <button id="tabRank" class="tab" title="é †ä½">T ğŸ†</button>
    <button id="tabEdit" class="tab" title="ã‚»ãƒªãƒ•ãƒ»äººç‰©ç·¨é›†">S ğŸ’¬ğŸ‘¤</button>
  </div>

  <!-- ===== Page 1 ===== -->
  <section id="pageProgress" style="display:block">
    <div class="topbar">
      <button id="undoP">æˆ»ã‚‹</button><button id="redoP">é€²ã‚€</button><button id="wipeP">å…¨å‰Šé™¤</button>
    </div>

    <div class="topbar" style="gap:12px; align-items:center">
      <div class="row">
        <label class="muted">ç§‘ç›®ï¼š</label>
        <select id="subjectSelect" style="width:auto"></select>
        <button id="addSubject">ï¼‹ç§‘ç›®è¿½åŠ </button>
        <button id="toggleAllBtn" class="chip" title="å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰"><span id="allIcon">ğŸ“š</span> å…¨ç§‘ç›®</button>
      </div>

      <div class="row">
        <span class="muted">ğŸ¨ ãƒ†ãƒ¼ãƒè‰²</span>
        <button class="chip preset" data-preset="redsox">Red Sox</button>
        <button class="chip preset" data-preset="bluejays">Blue Jays</button>
        <button class="chip preset" data-preset="dodgers">Dodgers</button>
        <button class="chip preset" data-preset="nl">NL All-Star</button>
        <input id="colorPicker" type="text" placeholder="#RRGGBB" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label>
        <input id="tintRange" type="range" min="0" max="95" value="20" style="width:120px">
        <button id="applyColor" class="chip">é©ç”¨</button>
      </div>

      <div class="row">
        <span class="muted">âœ… å®Œäº†è‰²</span>
        <input id="doneColorPicker" type="text" placeholder="#B0A89F" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label>
        <input id="doneTintRange" type="range" min="10" max="95" value="34" style="width:120px">
        <button id="applyDoneColor" class="chip">é©ç”¨</button>
      </div>

      <div class="row">
        <span class="muted">ğŸ…ãƒã‚¤ãƒ³ãƒˆ</span>
        <span class="muted">å­¦ç¿’ <input id="ptStudy" class="pill" type="number" min="0" value="10" style="width:5.2em"></span>
        <span class="muted">å¾©ç¿’ <input id="ptReview" class="pill" type="number" min="0" value="6" style="width:5.2em"></span>
        <span class="muted">ä¼‘æ—¥ <input id="ptHoliday" class="pill" type="number" min="0" value="0" style="width:5.2em"></span>
        <button id="applyPts" class="chip">ä¿å­˜</button>
      </div>

      <div class="row" style="margin-left:auto">
        <button id="ttOpen" class="chip">ğŸ—“ æ™‚é–“å‰²ã‚’é–‹ã</button>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="pill">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="pill">æ¬¡æœˆ â–¶</button>
      <button id="save" class="pill">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load" class="pill">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact" class="pill">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <th class="col-date">æ—¥ä»˜</th>
            <th class="col-type">ç¨®åˆ¥</th>
            <th class="col-goal">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
            <th class="col-result">çµæœ</th>
            <th class="col-review">å¾©ç¿’</th>
            <th class="col-donebtn">å®Œäº†</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2/3/4 ã¯ v17 ã¨åŒç­‰ï¼ˆçœç•¥ï¼‰ ===== -->
  <section id="pageClass" style="display:none">
    <div class="topbar"><button id="undoC">æˆ»ã‚‹</button><button id="redoC">é€²ã‚€</button><button id="wipeC">å…¨å‰Šé™¤</button></div>
    <div class="blackboard">1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œ<span id="meOnBoard">æ©‹æœ¬æ·‘é›…</span>ã€ã‚’å¿œæ´ä¸­ï¼</div>
    <div class="room"><div class="desks" id="desks"></div></div>
  </section>

  <section id="pageRank" style="display:none">
    <div class="topbar"><button id="undoT">æˆ»ã‚‹</button><button id="redoT">é€²ã‚€</button><button id="wipeT">å…¨å‰Šé™¤</button></div>
    <div id="rankGrid" style="padding:8px" class="muted">ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯v17ç›¸å½“ã®ã¾ã¾å‹•ä½œï¼‰</div>
  </section>

  <section id="pageEdit" style="display:none">
    <div class="topbar"><button id="undoS">æˆ»ã‚‹</button><button id="redoS">é€²ã‚€</button></div>
    <div id="editGrid" class="muted" style="padding:8px">ï¼ˆç·¨é›†UIã¯v17ç›¸å½“ã®ã¾ã¾å‹•ä½œï¼‰</div>
  </section>

  <!-- æ™‚é–“å‰²ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ v17 ã¨åŒç­‰ï¼ˆçœç•¥ï¼‰ -->

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';
  const VER='v17.7';

  /* Keys / Stateï¼ˆå¿…è¦æœ€ä½é™ã ã‘æ®‹ã—ã¦å‹•ä½œå®‰å®šåŒ–ï¼‰ */
  const NS='studyplanner.v17'; // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯å¾“æ¥ã‚­ãƒ¼ã®ã¾ã¾
  const SUBJ_KEY   = `${NS}.subjects`;
  const COL_KEY    = `${NS}.subjectColors`;
  const DONE_KEY   = `${NS}.doneColor`;
  const DATA_KEY   = `${NS}.data`;
  const PTS_KEY    = `${NS}.points`;

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let subjects = loadSubjects();
  let subject = subjects[0] || 'ä¸–ç•Œå²';
  let showAll = false;
  let subjectColors = loadSubjectColors();
  let doneColor = loadDoneColor();
  let pointsCfg = loadPoints();
  let rows=[];

  /* Utils */
  const $=s=>document.querySelector(s);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function tintCss(hex, percent){ const m=hex.replace('#',''); const r=parseInt(m.slice(0,2),16), g=parseInt(m.slice(2,4),16), b=parseInt(m.slice(4,6),16); const a=Math.max(0,Math.min(1,percent/100)); return `rgba(${r},${g},${b},${a})`; }

  /* Subjects & Colors */
  function loadSubjects(){ try{ const raw=localStorage.getItem(SUBJ_KEY); const arr = raw? JSON.parse(raw): null; return (Array.isArray(arr)&&arr.length)?arr:['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; }catch(_){ return ['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; } }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function renderSubjectSelect(){ const sel=$('#subjectSelect'); sel.innerHTML=''; subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); if(!subjects.includes(subject)) subject=subjects[0]; sel.value=subject; }
  function loadSubjectColors(){ try{ const raw=localStorage.getItem(COL_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; } }
  function saveSubjectColors(){ try{ localStorage.setItem(COL_KEY, JSON.stringify(subjectColors)); }catch(_){} }
  function colorFor(subj){
    const c = subjectColors[subj];
    if(c && c.hex){ return {hex:c.hex, tint: Math.max(0,Math.min(95,c.tint??20))}; }
    if(/è‹±èª/.test(subj)) return {hex:'#BD3039', tint:20};     // Red Sox
    if(/æ•°å­¦/.test(subj)) return {hex:'#134A8E', tint:20};     // Blue Jays
    if(/ä¸–ç•Œå²/.test(subj)) return {hex:'#005A9C', tint:18};   // Dodgers
    return {hex:'#2563eb', tint:16};
  }
  function loadDoneColor(){ try{ const raw=localStorage.getItem(DONE_KEY); return raw? JSON.parse(raw): {hex:'#B0A89F', tint:34}; }catch(_){ return {hex:'#B0A89F', tint:34}; } }
  function saveDoneColor(){ try{ localStorage.setItem(DONE_KEY, JSON.stringify(doneColor)); }catch(_){} }

  /* Points */
  function loadPoints(){ try{ const raw=localStorage.getItem(PTS_KEY); return raw? JSON.parse(raw): {study:10, review:6, holiday:0}; }catch(_){ return {study:10, review:6, holiday:0}; } }
  function savePoints(){ try{ localStorage.setItem(PTS_KEY, JSON.stringify(pointsCfg)); }catch(_){} }
  const pointsForType=t=> t==='å¾©ç¿’'? +pointsCfg.review||0 : (t==='ä¼‘æ—¥'? +pointsCfg.holiday||0 : +pointsCfg.study||0);

  /* Per-month Data */
  const currentKey = (s=subject)=> `${DATA_KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s));
    let arr=[]; if(raw){ try{ arr=JSON.parse(raw)||[]; }catch(_){ } }
    // scaffold
    const need=new Set(monthDates(year,month)); const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
    return arr;
  }
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  // â˜…è¶³ã‚Šã¦ãªã‹ã£ãŸã‚„ã¤ï¼šUIä¸Šã®1è¡Œã‚’ rows[] ã«åæ˜ 
  function persist(rec){
    const i = rows.findIndex(x=> x.date===rec.date && (showAll? (x._subject===rec._subject): true));
    if(i>=0) rows[i]=rec;
    else rows.push(rec);
  }
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr=loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r,_subject:sub}));
      });
      rows=merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
    }else{
      rows=loadSubjectMonth(subject);
    }
    return true;
  }

  /* Autosave + ä¿å­˜æ™‚åˆ»è¡¨ç¤º */
  const SAVED_AT_ID = 'savedAt';
  function setSavedNow(){
    const t=new Date();
    const s = `${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
    $('#'+SAVED_AT_ID).textContent = `æœ€çµ‚ä¿å­˜: ${s}`;
  }
  let autoSaveTimer=null;
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        const map=new Map();
        rows.forEach(r=>{ const subj=r._subject||subject; if(!map.has(subj)) map.set(subj,[]); map.get(subj).push(stripSubject(r)); });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      setSavedNow();
      autoSaveTimer=null;
    }, 600);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    if(showAll){
      const map=new Map();
      rows.forEach(r=>{ const subj=r._subject||subject; if(!map.has(subj)) map.set(subj,[]); map.get(subj).push(stripSubject(r)); });
      map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    }else{
      doSaveToLocal(subject, rows);
    }
    setSavedNow();
  }
  window.addEventListener('beforeunload', flushAutoSave);

  /* Render Progress */
  function renderProgress(){
    load();
    const days = monthDates(year,month).length;
    $('#label').textContent = showAll? `å…¨ç§‘ç›® ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰` : `${subject} â€” ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());
    const subjColor = colorFor(subject);
    const themeTint = tintCss(subjColor.hex, subjColor.tint);
    const doneTint  = tintCss(doneColor.hex, doneColor.tint);

    // è¡¨ç¤ºãƒªã‚¹ãƒˆ
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach((r,rowIndex)=>{
      const tr=document.createElement('tr');

      const isHoliday = (r.type==='ä¼‘æ—¥');
      const isDone = (r.color==='gray') || isHoliday;

      if(r.date===todayStr) tr.classList.add('today');
      if(isDone){
        tr.classList.add('done-row');
        tr.style.setProperty('--doneTint', doneTint);
      }else{
        tr.classList.add('tinted');
        tr.style.setProperty('--tint', themeTint);
      }

      // æ—¥ä»˜
      const tdDate = document.createElement('td'); tdDate.className='col-date'; tdDate.innerHTML = `<div class="cell">${jpDateLabel(r.date)}</div>`;

      // ç¨®åˆ¥ï¼ˆå­¦ç¿’ï¼ä¼‘æ—¥ï¼‰
      const tdType = document.createElement('td'); tdType.className='col-type';
      tdType.innerHTML = `<div class="cell type-buttons">
        <button class="chip btnType ${r.type==='å­¦ç¿’'?'active':''}" data-val="å­¦ç¿’">å­¦ç¿’</button>
        <button class="chip btnType ${r.type==='ä¼‘æ—¥'?'active':''}" data-val="ä¼‘æ—¥">ä¼‘æ—¥</button>
      </div>`;

      const tdGoal=document.createElement('td'); tdGoal.className='col-goal';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24'; inGoal.value=(r.goal??''); tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='col-result';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾'; inRes.value=(r.result??''); tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='col-review';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²'; inRev.value=(r.review??''); tdRev.appendChild(inRev);

      // å®Œäº†ï¼ˆãƒˆã‚°ãƒ«ï¼‰
      const tdDone=document.createElement('td'); tdDone.className='col-donebtn';
      const btnDone=document.createElement('button'); btnDone.className='chip'; btnDone.textContent='å®Œäº†';
      tdDone.appendChild(btnDone);

      // å…¥åŠ›å¤‰æ›´
      const onInput=(field)=>(e)=>{ r[field]=e.target.value; persist(r); touch(); };
      inGoal.addEventListener('input', onInput('goal'));
      inRes .addEventListener('input', onInput('result'));
      inRev .addEventListener('input', onInput('review'));

      // ç¨®åˆ¥ã‚¯ãƒªãƒƒã‚¯
      tdType.querySelectorAll('.btnType').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const v=btn.dataset.val;
          r.type=v;
          // ã€Œå­¦ç¿’ã€ã«æˆ»ã—ãŸã‚‰ç°è‰²è§£é™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã¸ï¼‰
          if(v==='å­¦ç¿’' && r.color!=='gray'){ /* holiday ã®ç°è‰²è¦‹ãŸç›®ã¯ type ç”±æ¥ãªã®ã§å­¦ç¿’ã«æˆ»ã™ã ã‘ã§è§£é™¤ã•ã‚Œã‚‹ */ }
          persist(r); touch(); renderProgress();
          setTimeout(scrollTodayIntoView,0);
        });
      });

      // å®Œäº†ãƒˆã‚°ãƒ«
      btnDone.addEventListener('click',(ev)=>{
        // holiday ã¯ type ã§ç°è‰²è¡¨ç¤ºã«ãªã‚‹ã€‚å®Œäº†ã¯ color=gray ã‚’ãƒˆã‚°ãƒ«ã€‚
        const wasDone = (r.color==='gray');
        if(wasDone){
          // è§£é™¤
          r.color='normal';
          persist(r); touch(); renderProgress();
          popAt(ev.target, `âˆ’${pointsForType(r.type||'å­¦ç¿’')}`, '#ef4444'); // red-ish
        }else{
          r.color='gray';
          persist(r); touch(); renderProgress();
          popAt(ev.target, `+${pointsForType(r.type||'å­¦ç¿’')}`, '#10b981'); // green
        }
        setTimeout(scrollTodayIntoView,0);
      });

      // çŸ¢å°ã‚­ãƒ¼ç§»å‹•
      const focusables=[inGoal,inRes,inRev,btnDone];
      focusables.forEach((el,colIndex)=>{
        el.dataset.rowIndex=rowIndex; el.dataset.colIndex=colIndex;
        el.addEventListener('keydown',(ev)=>{
          const rIdx=+el.dataset.rowIndex, cIdx=+el.dataset.colIndex;
          let nr=rIdx, nc=cIdx;
          if(ev.key==='ArrowDown'||ev.key==='Enter') nr=rIdx+1;
          if(ev.key==='ArrowUp')   nr=rIdx-1;
          if(ev.key==='ArrowRight')nc=cIdx+1;
          if(ev.key==='ArrowLeft') nc=cIdx-1;
          if(nr!==rIdx || nc!==cIdx){
            ev.preventDefault();
            const q=`[data-row-index="${nr}"][data-col-index="${nc}"]`;
            const next=$('#tbody').querySelector(q);
            if(next){ next.focus(); if(next.select) next.select(); }
          }
        });
      });

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdDone);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;
  }

  function popAt(anchor, text, color){
    const r = anchor.getBoundingClientRect();
    const pop=document.createElement('div'); pop.className='pop'; pop.textContent=text;
    pop.style.left = (r.left + r.width/2) + 'px';
    pop.style.top  = (r.top - 8 + window.scrollY) + 'px';
    pop.style.color = color||'#10b981';
    document.body.appendChild(pop);
    setTimeout(()=>{ pop.remove(); }, 1200);
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead'); const todayRow=scroller.querySelector('tr.today');
    if(!todayRow||!thead) return; const headerH=thead.getBoundingClientRect().height; const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'instant'});
  }

  /* Eventsï¼ˆå¿…è¦ç®‡æ‰€ã ã‘ï¼‰ */
  $('#save').addEventListener('click',()=>{ flushAutoSave(); renderProgress(); /* â† ã“ã‚Œã§ã€Œæ›´æ–°å¾Œã«ç©ºã€å¯¾ç­– */ alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); setSavedNow(); });
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });
  $('#prev').addEventListener('click',()=>{ flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} renderProgress(); });
  $('#next').addEventListener('click',()=>{ flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} renderProgress(); });

  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  const PRESETS={ redsox:{hex:'#BD3039',tint:20}, bluejays:{hex:'#134A8E',tint:20}, dodgers:{hex:'#005A9C',tint:18}, nl:{hex:'#13274F',tint:18} };
  document.querySelectorAll('.preset').forEach(btn=> btn.addEventListener('click',()=>{ const p=PRESETS[btn.dataset.preset]; $('#colorPicker').value=p.hex; $('#tintRange').value=p.tint; }));
  $('#applyColor').addEventListener('click',()=>{ const hex=(($('#colorPicker').value)||'').trim(); const tint=+$('#tintRange').value||20; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXã‚«ãƒ©ãƒ¼ã‚’ #RRGGBB ã§å…¥åŠ›'); return; } const hx=hex.startsWith('#')?hex:('#'+hex); subjectColors[subject]={hex:hx,tint:Math.max(0,Math.min(95,tint))}; saveSubjectColors(); renderProgress(); });
  $('#applyDoneColor').addEventListener('click',()=>{ const hex=(($('#doneColorPicker').value)||'').trim()||doneColor.hex; const tint=+$('#doneTintRange').value||doneColor.tint; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXã‚«ãƒ©ãƒ¼ã‚’ #RRGGBB ã§å…¥åŠ›'); return; } doneColor={hex:hex.startsWith('#')?hex:('#'+hex), tint:Math.max(10,Math.min(95,tint))}; saveDoneColor(); renderProgress(); });
  $('#applyPts').addEventListener('click',()=>{ pointsCfg={ study:+$('#ptStudy').value||0, review:+$('#ptReview').value||0, holiday:+$('#ptHoliday').value||0 }; savePoints(); });

  function highlightAllToggle(){ $('#allIcon').textContent = showAll? 'ğŸ“–':'ğŸ“š'; $('#toggleAllBtn').classList.toggle('active', showAll); }
  $('#toggleAllBtn').addEventListener('click',()=>{ showAll=!showAll; renderProgress(); highlightAllToggle(); });

  $('#addSubject').addEventListener('click',()=>{ const name=prompt('è¿½åŠ ã™ã‚‹ç§‘ç›®åï¼ˆä¾‹ï¼šè‹±èªï¼‰'); if(!name) return; const trimmed=name.trim(); if(!trimmed) return; if(subjects.includes(trimmed)){ alert('ãã®ç§‘ç›®ã¯ã™ã§ã«ã‚ã‚Šã¾ã™'); return; } subjects.push(trimmed); saveSubjects(); renderSubjectSelect(); subject=trimmed; showAll=false; renderProgress(); });
  $('#subjectSelect').addEventListener('change',e=>{ subject=e.target.value; showAll=false; renderProgress(); });

  // ã‚¿ãƒ–
  $('#tabProgress').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));
  $('#tabEdit').addEventListener('click',()=>showPage('edit'));
  function setActiveTab(a,b,c,d){ $('#tabProgress').classList.toggle('active',a); $('#tabClass').classList.toggle('active',b); $('#tabRank').classList.toggle('active',c); $('#tabEdit').classList.toggle('active',d); }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit');
    const show=(a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); renderProgress(); }
    if(which==='class'){ show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); }
    if(which==='rank'){ show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); }
    if(which==='edit'){ show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); }
  }

  // ğŸ¹ & R
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#reloadBtn').addEventListener('click',()=>{ const url = location.pathname + '?r=' + Date.now(); location.replace(url); });

  /* Init */
  function init(){
    $('#verTag').textContent = VER;
    renderSubjectSelect(); highlightAllToggle();
    load(); renderProgress(); document.body.classList.add('compact');
    setSavedNow();
    setTimeout(scrollTodayIntoView,0);
  }
  init();
})();
</script>
</body>
</html>
