<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆé–“é€²æ—ï¼‹C(ğŸ«)ï¼‹T(ğŸ†)</title>

<!-- ç”»åƒOCRï¼ˆiPadå®Œçµï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --row-gray-bg:#b0a89f; --row-gray-text:#000000;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;

    --male:#2563eb; --female:#f97316;

    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;

    --scale: 1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:0.72;}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale));display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"]{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .pill{border-radius:999px;padding:6px 10px;font-size:14px}

  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  .pager{display:flex;gap:8px;align-items:center;margin:6px 0 6px}

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  .tbl{
    width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;
    max-height:calc(84vh*var(--scale));
  }
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:calc(8px*var(--scale));border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:calc(12px*var(--scale));color:var(--muted);
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);backdrop-filter:saturate(1.1);
  }
  td.padL{padding-left:calc(14px*var(--scale))}
  td.small{width:calc(110px*var(--scale))}
  td.medium{width:calc(160px*var(--scale))}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.manual-gray td{background:var(--row-gray-bg)!important;color:var(--row-gray-text)!important}

  .type-wrap{display:flex;align-items:center;gap:8px}
  .type-badge{font-weight:700}
  .type-toggle{
    padding:calc(4px*var(--scale)) calc(8px*var(--scale));
    border:1px solid var(--line);border-radius:10px;background:#fff;
    font-size:calc(12px*var(--scale));cursor:pointer
  }

  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;-webkit-user-select:none;
    right:14px;bottom:14px
  }
  .fab:hover{transform:translateY(-1px)} .fab:active{transform:translateY(0)}
  .fab span{font-size:22px;line-height:1}

  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:12px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}

  .bubble{
    position:absolute;left:8px;right:8px;top:8px;
    border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:8px 10px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);
    display:none;max-width:unset;white-space:pre-line
  }
  .bubble::after{content:"";position:absolute;left:22px;bottom:-10px;border-width:10px 10px 0 10px;border-style:solid;border-color:var(--bubble-gen-bd) transparent transparent transparent}
  .bubble::before{content:"";position:absolute;left:22px;bottom:-9px;border-width:9px 9px 0 9px;border-style:solid;border-color:var(--bubble-gen-bg) transparent transparent transparent}
  .bubble.famous{background:var(--bubble-fam-bg);border-color:var(--bubble-fam-bd)}
  .bubble.famous::after{border-top-color:var(--bubble-fam-bd)}
  .bubble.famous::before{border-top-color:var(--bubble-fam-bg)}
  .bubble.show{display:block;animation:fadeIn .15s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-grid{column-width:240px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}

  .ops{display:flex;gap:8px;align-items:center;margin:6px 0 10px}
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab" title="å­¦æ ¡">C ğŸ«</button>
    <button id="tabRank" class="tab" title="é †ä½">T ğŸ†</button>
  </div>

  <div class="pager">
    <button id="pagePrev">â—€ æˆ»ã‚‹</button>
    <button id="pageNext">é€²ã‚€ â–¶</button>
  </div>

  <!-- ===== Page 1: é€²æ— ===== -->
  <section id="pageProgress" style="display:block">
    <div class="ops">
      <button id="undoP">æˆ»ã‚‹</button>
      <button id="redoP">é€²ã‚€</button>
      <button id="wipeP">å…¨å‰Šé™¤</button>
    </div>
    <div class="topbar">
      <button id="prev" class="primary">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
      <button id="save">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div class="topbar">
      <button id="importPaste">ğŸ“‹ è²¼ã‚Šä»˜ã‘å–è¾¼</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">ğŸ“„ CSV/TSV/TXTå–è¾¼</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">ğŸ–¼ ç”»åƒOCRå–è¾¼</button>
      </label>
      <span class="muted">è¦‹å‡ºã—ï¼š<code>æ—¥ä»˜, ç¨®åˆ¥, ç›®æ¨™, çµæœ, å¾©ç¿’</code>ï¼<code>8/10(æ—¥)</code>ã‚‚OK</span>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr>
            <th class="medium">æ—¥ä»˜</th>
            <th class="small padL">ç¨®åˆ¥</th>
            <th class="medium padL">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
            <th class="medium padL">çµæœ</th>
            <th class="medium padL">å¾©ç¿’</th>
            <th class="small padL">è‰²</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ ===== -->
  <section id="pageClass" style="display:none">
    <div class="ops">
      <button id="undoC">æˆ»ã‚‹</button>
      <button id="redoC">é€²ã‚€</button>
      <button id="wipeC">å…¨å‰Šé™¤</button>
    </div>
    <div class="blackboard">1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œæ©‹æœ¬æ·‘é›…ã€ã‚’å¿œæ´ä¸­ï¼</div>
    <div class="room">
      <div class="desks" id="desks"></div>
    </div>
  </section>

  <!-- ===== Page 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== -->
  <section id="pageRank" style="display:none">
    <div class="ops">
      <button id="undoT">æˆ»ã‚‹</button>
      <button id="redoT">é€²ã‚€</button>
      <button id="wipeT">å…¨å‰Šé™¤</button>
    </div>
    <div class="rank-card">
      <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
      <div id="rankGrid" class="rank-grid"></div>
      <div class="muted" style="margin-top:8px">
        ãƒ«ãƒ¼ãƒ«ï¼šå®Œäº†=+10ã€å¾©ç¿’+å®Œäº†=+6ã€ä¼‘æ—¥=0ã€‚ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆã¯æ—¥æ›¿ã‚ã‚Šã§è‡ªå‹•ã‚¹ã‚³ã‚¢ï¼ˆæ“¬ä¼¼ä¹±æ•°ãƒ»ä¸æ­£ãªã—ï¼‰ã€‚
      </div>
    </div>
  </section>

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';

  const KEY='studyplanner.v15.ocr';
  const NAME_KEY='studyplanner.displayName';

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[]; // {date,type,goal,result,review,color}

  // ======= Auto Save =======
  const AUTOSAVE_MS = 800;
  let autoSaveTimer = null;
  const currentKey = ()=> `${KEY}:${year}-${String(month+1).padStart(2,'0')}`;

  function doSaveToLocal(){
    const data=rows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(), JSON.stringify(data)); }catch(_){}
  }
  function touch(){ if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=>{ doSaveToLocal(); autoSaveTimer=null; }, AUTOSAVE_MS);
  }
  function flushAutoSave(){ if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; } doSaveToLocal(); }
  window.addEventListener('beforeunload', flushAutoSave);

  /* ========== Undo/Redo ========== */
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({year,month,rows}));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); ({year,month,rows}=prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); ({year,month,rows}=nxt); renderAll(); }

  /* ========== å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function ensureScaffold(){
    const need=new Set(monthDates(year,month));
    const have=new Set(rows.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) rows.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    rows.sort((a,b)=>a.date.localeCompare(b.date));
  }
  function persist(rec){const i=rows.findIndex(x=>x.date===rec.date); if(i>=0) rows[i]=rec; else rows.push(rec);}

  /* ========== ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜/èª­è¾¼ ========== */
  function save(){ pushHistory(); flushAutoSave(); alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); renderRank(); scrollTodayIntoView(); }
  function load(){
    const raw=localStorage.getItem(currentKey());
    if(!raw) return false;
    try{
      const data=JSON.parse(raw)||[];
      const map=new Map(rows.map(r=>[r.date,r]));
      data.forEach(d=>map.set(d.date,d));
      rows=[...map.values()];
      return true;
    }catch(e){ return false; }
  }

  /* ========== é€²æ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========== */
  function renderProgress(){
    ensureScaffold();
    $('#label').textContent=`${year}å¹´${month+1}æœˆï¼ˆ${monthDates(year,month).length}æ—¥ï¼‰`;
    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    monthDates(year,month).forEach(date=>{
      const r=rows.find(x=>x.date===date) || {date,type:'å­¦ç¿’',goal:'',result:'',review:'',color:'normal'};
      const tr=document.createElement('tr');

      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(date===todayStr) tr.classList.add('today');

      const tdDate=document.createElement('td'); tdDate.className='medium'; tdDate.textContent=jpDateLabel(date);

      const tdType=document.createElement('td'); tdType.className='small padL';
      const wrap=document.createElement('div'); wrap.className='type-wrap';
      const badge=document.createElement('span'); badge.className='type-badge'; badge.textContent=(r.type==='ä¼‘æ—¥')?'ä¼‘æ—¥':(r.type==='å¾©ç¿’'?'å¾©ç¿’':'å­¦ç¿’');
      const btn=document.createElement('button'); btn.className='type-toggle'; btn.type='button';
      btn.textContent=(r.type==='ä¼‘æ—¥')?'å­¦ç¿’ã«ã™ã‚‹':'ä¼‘æ—¥ã«ã™ã‚‹';
      btn.addEventListener('click',()=>{ pushHistory(); r.type=(r.type==='ä¼‘æ—¥')?'å­¦ç¿’':'ä¼‘æ—¥'; persist(r); touch(); renderProgress(); renderRank(); });
      wrap.appendChild(badge); wrap.appendChild(btn); tdType.appendChild(wrap);

      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24';
      inGoal.value=r.goal||''; inGoal.addEventListener('input',e=>{ pushHistory(); r.goal=e.target.value; persist(r); touch(); });
      tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾';
      inRes.value=r.result||''; inRes.addEventListener('input',e=>{ pushHistory(); r.result=e.target.value; persist(r); touch(); });
      tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²';
      inRev.value=r.review||''; inRev.addEventListener('input',e=>{ pushHistory(); r.review=e.target.value; persist(r); touch(); });
      tdRev.appendChild(inRev);

      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'é€šå¸¸'}, {v:'gray',t:'å®Œäº†'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{ pushHistory(); r.color=e.target.value; persist(r); touch(); renderProgress(); renderRank(); });
      tdClr.appendChild(selClr);

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdClr);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;
    scrollTodayIntoView();
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead');
    const todayRow=scroller.querySelector('tr.today');
    if(!todayRow || !thead) return;
    const headerH=thead.getBoundingClientRect().height;
    const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'instant'});
  }

  /* ========== å–ã‚Šè¾¼ã¿ï¼šè²¼ä»˜ / CSV/TSV / OCR ========== */
  function normalizeDateToken(raw){
    if(!raw) return null;
    let s = String(raw).trim();
    s = s.replace(/ï¼ˆ.*?ï¼‰|\(.*?\)/g,''); 
    s = s.replace(/[ï¼ã€‚ãƒ»â€’â€“â€”â€•ã€œï½]/g,'-'); 
    let m = s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/);
    if(m){ return {y:+m[1], mo:+m[2]-1, d:+m[3]}; }
    m = s.match(/^(\d{1,2})\s*(?:\/|æœˆ)\s*(\d{1,2})/);
    if(m){ const y = year; return {y, mo:+m[1]-1, d:+m[2]}; }
    return null;
  }
  function clean(v){
    const s = String(v ?? '').trim();
    if(!s) return '';
    if(/^(nan|null|undefined)$/i.test(s)) return '';
    return s;
  }
  function parseTypeImport(text){
    const lines = (text||'').replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    let applied=0;
    for(const ln of lines){
      const parts = ln.split(/[\s,ã€€\t]+/).filter(Boolean);
      if(parts.length<2) continue;
      const dtk = normalizeDateToken(parts[0]); if(!dtk) continue;
      let typ = parts[1].replace(/\s/g,'').trim();
      if(typ==='ä¼‘ã¿') typ='ä¼‘æ—¥';
      if(!/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(typ)) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(rec){ pushHistory(); rec.type=typ; persist(rec); applied++; }
    }
    if(applied) touch();
    return applied;
  }
  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const sep = (text.indexOf('\t')!==-1) ? '\t' : ',';
    const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header = lines[0].split(sep).map(s=>s.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {}; header.forEach((h,i)=> obj[h] = (cells[i]??'').trim());
      return obj;
    });
    return {header, rows};
  }
  function importCsvText(text){
    const {header, rows:objs} = parseDelimited(text);
    const col = {};
    header.forEach(h=>{
      if(/æ—¥ä»˜/.test(h)) col.date=h;
      if(/ç¨®åˆ¥/.test(h)) col.type=h;
      if(/ç›®æ¨™/.test(h)) col.goal=h;
      if(/çµæœ/.test(h)) col.result=h;
      if(/å¾©ç¿’/.test(h)) col.review=h;
    });
    if(!col.date || !col.type){ alert('CSVè¦‹å‡ºã—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆå°‘ãªãã¨ã‚‚ã€Œæ—¥ä»˜ã€ã€Œç¨®åˆ¥ã€ï¼‰'); return 0; }
    let applied=0;
    for(const o of objs){
      const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(!rec) continue;

      let t = clean(o[col.type]);
      if(t==='ä¼‘ã¿') t='ä¼‘æ—¥';
      if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }

      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);

      persist(rec); applied++;
    }
    if(applied) touch();
    return applied;
  }
  function looksLikeColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if (L.length < 12) return false;
    const i = L.findIndex(s => s.includes('æ—¥ä»˜'));
    if (i < 0 || i + 4 >= L.length) return false;
    const head = L.slice(i, i+5);
    const need = ['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'];
    if (!need.every((w,idx)=> (head[idx]||'').includes(w))) return false;
    return L.slice(i+5).some(s => /^\d{1,2}[\/\-æœˆ]\d{1,2}/.test(s) || /^\d{4}-\d{2}-\d{2}$/.test(s));
  }
  function parseColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const i = L.findIndex(s => s.includes('æ—¥ä»˜'));
    const data = L.slice(i+5);

    const rows = [];
    let block = {};
    let ptr = 0; // 0æ—¥ä»˜ 1ç¨®åˆ¥ 2ç›®æ¨™ 3çµæœ 4å¾©ç¿’
    for (const line of data){
      if (['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'].includes(line)) continue;
      if (ptr === 0){ block={}; block['æ—¥ä»˜']=line; ptr=1; continue; }
      if (ptr === 1){ block['ç¨®åˆ¥']=line; ptr=2; continue; }
      if (ptr === 2){ block['ç›®æ¨™']=line; ptr=3; continue; }
      if (ptr === 3){ block['çµæœ']=line; ptr=4; continue; }
      if (ptr === 4){ block['å¾©ç¿’']=line; rows.push(block); ptr=0; continue; }
    }
    if (ptr !== 0){
      block['ç›®æ¨™'] = block['ç›®æ¨™'] ?? '';
      block['çµæœ'] = block['çµæœ'] ?? '';
      block['å¾©ç¿’'] = block['å¾©ç¿’'] ?? '';
      rows.push(block);
    }
    return { header:['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'], rows };
  }
  function importAnyText(text){
    try{
      const n = importCsvText(text);
      if (n>0){ touch(); return n; }
    }catch(_){}
    if (looksLikeColumnBlocks(text)){
      const parsed = parseColumnBlocks(text);
      let applied=0;
      const col = {date:'æ—¥ä»˜', type:'ç¨®åˆ¥', goal:'ç›®æ¨™', result:'çµæœ', review:'å¾©ç¿’'};
      for (const o of parsed.rows){
        const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
        if (dtk.y !== year || dtk.mo !== month) continue;
        const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
        const rec = rows.find(x=>x.date===ds); if(!rec) continue;

        let t = clean(o[col.type]);
        if (t==='ä¼‘ã¿') t='ä¼‘æ—¥';
        if (/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }

        rec.goal   = clean(o[col.goal]);
        rec.result = clean(o[col.result]);
        rec.review = clean(o[col.review]);

        persist(rec); applied++;
      }
      if(applied) touch();
      return applied;
    }
    return 0;
  }

  async function ocrImage(file){
    try{
      const worker = await Tesseract.createWorker('jpn');
      const { data:{ text } } = await worker.recognize(file);
      await worker.terminate();
      return text;
    }catch(e){
      try{
        const worker = await Tesseract.createWorker('eng');
        const { data:{ text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
      }catch(err){
        throw e;
      }
    }
  }

  /* ========== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ========== */
  function myMonthlyPoints(){
    let total=0;
    monthDates(year,month).forEach(date=>{
      const r=rows.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray'){
        if(r.type==='å¾©ç¿’') total+=6;
        else if(r.type==='å­¦ç¿’') total+=10;
      }
    });
    return total;
  }
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  function classmatesMonthlyPoints(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=10; else if(r>0.50) sum+=6;});
      if(name==='æœ›æœˆäºœå¸Œå­') sum += 20 + Math.floor(rnd()*10);
      return {name, pts:sum};
    });
  }
  function renderRank(){
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyPoints();
    const fifth = [...rivals].sort((a,b)=>b.pts-a.pts)[4]?.pts ?? 0;
    rivals = rivals.map(p=> p.name==='æœ›æœˆäºœå¸Œå­' && p.pts<=fifth ? {...p, pts:fifth+1} : p);
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    const grid=$('#pageRank #rankGrid'); if(grid){
      grid.innerHTML='';
      list.forEach((p,i)=>{
        const div=document.createElement('div'); div.className='rank-item';
        div.innerHTML=`<div class="rank-row">
          <div class="rank-no">${i+1}ä½</div>
          <div class="grow"><strong>${p.name}</strong></div>
          <div>${p.pts} pt</div>
        </div>`;
        grid.appendChild(div);
      });
    }
  }

  /* ========== ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆï¼ˆå¹ãå‡ºã—ï¼šæ‹¡å¼µç‰ˆï¼‰ ========== */
  const CLASSMATES = [
    'æ©‹æœ¬æ·‘é›…','æœ›æœˆäºœå¸Œå­',
    'æ°¸ç”°ç§€ä»','é«˜æ©‹','å¶‹åº·','ç”°ä¸­','æ± ä¹‹å†…è‹±æ˜','åŠ è—¤','ä½ã€…æœ¨','å¯Œç”°é›„äºŒ','å¯Œå³¶é›…äºº','æˆæœ¨æ´‹å¹³','å”æ‰å…ˆç”Ÿ',
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','æ©‹æœ¬ç¯„ä¹‹','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€',
    'å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­'
  ];
  const FEMALES = new Set(['æœ›æœˆäºœå¸Œå­','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­']);
  const FAMOUS_SET = new Set([
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­',
    'æœ›æœˆäºœå¸Œå­','å”æ‰å…ˆç”Ÿ'
  ]);

  // â–¼ ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆç”¨ãƒ‘ãƒ¼ãƒ„ï¼ˆçµ„ã¿åˆã‚ã›ã§100å€ä»¥ä¸Šã«å¢—æ®–ï¼‰
  const rand = (a)=> a[Math.floor(Math.random()*a.length)];
  const ends = ['ã„ã“ï¼','ã„ã‘ã‚‹ï¼','ã‚„ã‚Œã‚‹ï¼','ã‚„ã£ã¡ã‚ƒãŠï¼','ã‚µã‚¯ãƒƒã¨ï¼','é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼','+10ptå–ã‚Šã«ã„ã“ï¼','æ°—æ¥½ã«ï¼','ä¸å¯§ã«ï¼','ä¸€å•ãšã¤ï¼'];
  const pushers = ['å…¨åŠ›','æ·¡ã€…','ç€å®Ÿ','è¶…é›†ä¸­','é™ã‹ã«ç‡ƒãˆã‚‹','ã«ã“ã£ã¨','ãã‚Šã£ã¨','æ™‚çŸ­ã§','ä¸å¯§ã«','çˆ†ä¼¸ã³ãƒ ãƒ¼ãƒ‰ã§'];
  const emojis = ['ğŸ”¥','ğŸ’ª','âœ¨','ğŸ“š','ğŸ“','ğŸ¯','â±ï¸','ğŸŒŸ','ğŸ¥‡','ğŸš€'];
  const breakTips = ['3åˆ†ã‚¹ãƒˆãƒ¬ãƒƒãƒ','1åˆ†æ·±å‘¼å¸','ç™½æ¹¯ã‚’ä¸€å£','çª“ã®å¤–ã‚’10ç§’','ç›®ã‚’é–‰ã˜ã¦15ç§’','è‚©å›ã—10å›','å§¿å‹¢ã‚’ç›´ã™','éŸ³é‡ã‚’ä¸‹ã’ã‚‹','æœºã‚’æ‹­ã','ã‚¿ã‚¤ãƒãƒ¼å†ã‚»ãƒƒãƒˆ'];

  // ç§‘ç›®ãƒã‚¿ï¼šä¸–ç•Œå²/åœ°ç†/æ¼¢æ–‡/å¤æ–‡/ç¾ä»£æ–‡/å€«ç†/åŒ–å­¦/ç‰©ç†
  const subjectLines = {
    ä¸–ç•Œå²:[
      'å¹´å·ã¯ç‰©èªã§è¦šãˆã‚‹ã¨å®šç€ã™ã‚‹ã‚ˆ','å› æœé–¢ä¿‚â†’çµæœã®æµã‚Œã§æ•´ç†','åœ°å›³ã¨ä¸€ç·’ã«çœºã‚ã‚‹ã¨è¨˜æ†¶ãŒå¼·åŒ–',
      'äººç‰©ç›¸é–¢ã§ã¾ã¨ã‚ã¦æš—è¨˜','é »å‡ºå›½ã¯æ™‚ä»£ã”ã¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§'
    ],
    åœ°ç†:[
      'åœ°å›³å¸³ã‚’é–‹ã„ã¦æ‰‹ã‚’å‹•ã‹ã™ã¨å®šç€â†‘','ã‚°ãƒ©ãƒ•ã¯å˜ä½ãƒ»è»¸ã‹ã‚‰èª­ã‚€','æ°—å€™ã¯é¢¨ã¨æµ·æµã®ã‚»ãƒƒãƒˆã§ç†è§£',
      'å·¥æ¥­ã¯ç«‹åœ°ã¨è¼¸é€ã‚³ã‚¹ãƒˆã®è¦–ç‚¹ã§','è¾²æ¥­ã¯ä½œç‰©Ã—ç·¯åº¦Ã—æ°´'
    ],
    æ¼¢æ–‡:[
      'è¿”ã‚Šç‚¹ã¯ãƒªã‚ºãƒ ã§èª­ã‚€ã¨æ¥½','å†èª­æ–‡å­—ã¯å£ã«å‡ºã™ã¨è¦šãˆã‚‹','å¥å½¢ã”ã¨ã«çŸ­å†Šã‚«ãƒ¼ãƒ‰åŒ–ã—ã‚ˆã†',
      'ä¸»èªã¨è¿°èªã‚’ã¾ãšæ‹¾ã†','é€ã‚Šä»®åã®æ„Ÿè¦šã‚’æ´ã‚‚ã†'
    ],
    å¤æ–‡:[
      'ä¿‚ã‚Šçµã³ãŒæ±ºã¾ã‚Œã°90%å‹ã¡','ä¸»èªè£œã†ã¨ä¸€æ°—ã«èª­ã‚ã‚‹','å’Œæ­Œã¯å¿ƒæƒ…ãƒ¯ãƒ¼ãƒ‰ã‚’æ‹¾ã†',
      'æ•¬èªã¯ç«‹å ´ã‚’å›³ã«ã™ã‚‹ã¨æ—©ã„','å¤èªã¯å ´é¢ã”ã¨ã«æŸã­ã¦æš—è¨˜'
    ],
    ç¾ä»£æ–‡:[
      'è¨­å•ã‹ã‚‰æœ¬æ–‡ã«æˆ»ã‚‹é€†èµ°èª­è§£','æŒ‡ç¤ºèªã¯ç›´å‰ã®åè©ã‚’ç¢ºèª','å¯¾æ¯”ãƒ»å› æœã®æ¥ç¶šã«æ³¨ç›®',
      'è¦ç´„ã¯30å­—ã§ç·´ç¿’','ç­†è€…ã®ä¸»å¼µâ†’æ ¹æ‹ ã®é †ã§ç·šã‚’å¼•ã'
    ],
    å€«ç†:[
      'ç”¨èªã¯ã€Œèª°ãŒä½•ã‚’ä¸»å¼µã€ã‚»ãƒƒãƒˆã§','è¿‘ä»£ä»¥é™ã¯å¹´ä»£æ„Ÿã‚’ã–ã£ãã‚Š','å›³ã§æ€æƒ³ã®ç³»è­œã‚’ã¤ãªã',
      'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªåˆ†ã®è¨€è‘‰ã«ç½®æ›','ä¼¼ã¦ã„ã‚‹ä¸»å¼µã¯å¯¾æ¯”è¡¨ã«'
    ],
    åŒ–å­¦:[
      'æ¡ä»¶ï¼ˆæ¸©åº¦/åœ§åŠ›ï¼‰ã‚’æ›¸ãå‡ºãã†','ãƒ¢ãƒ«è¨ˆç®—ã¯å˜ä½ã‚’æœ€å¾Œã¾ã§','æ§‹é€ å¼ã¯ä¸å¯§ã«æãã¨é€Ÿã„',
      'é…¸åŒ–é‚„å…ƒã¯åŠåå¿œå¼ã«åˆ†è§£','å®Ÿé¨“æ“ä½œã¯ç›®çš„ã¨ç†ç”±ã‚’ãƒ¡ãƒ¢'
    ],
    ç‰©ç†:[
      'åŠ›ã®å‘ãã‚’å›³ã§åˆ†è§£','æ¬¡å…ƒï¼ˆå˜ä½ï¼‰ã§ãƒŸã‚¹æ¤œå‡º','ã‚¨ãƒãƒ«ã‚®ãƒ¼ä¿å­˜ã§ä¸€æ°—ã«è§£ã',
      'ç­‰åŠ é€Ÿåº¦ã¯å¼ã‚’ä¸¦ã¹ã¦é¸ã¶','ãƒ™ã‚¯ãƒˆãƒ«ã¯æˆåˆ†ã”ã¨ã«å‡¦ç†'
    ]
  };

  // å”æ‰å…ˆç”Ÿï¼šæ—¥æœ¬å²ã®åè¨€ï¼ˆå®‰å…¨ãªç¯„å›²ã§å³é¸ï¼‰
  const jpHistoryQuotes = [
    'ã€Œå¿—ã‚’ç«‹ã¦ã¦ä»¥ã¦ä¸‡äº‹ã®æºã¨ãªã™ã€â€” å‰ç”°æ¾é™°',
    'ã€Œæˆã›ã°æˆã‚‹ã€æˆã•ã­ã°æˆã‚‰ã¬ã€â€” ä¸Šæ‰é·¹å±±',
    'ã€Œå¿ƒãŒå¤‰ã‚ã‚Œã°è¡Œå‹•ãŒå¤‰ã‚ã‚‹ã€â€” ä¸­æ‘å¤©é¢¨',
    'ã€Œæ—¥æ—¥æ˜¯å¥½æ—¥ã€â€” åƒåˆ©ä¼‘',
    'ã€Œé…ã‚Œã¦ã‚‚ã‚ˆã„ã€ã‚„ã‚ãªã‘ã‚Œã°å¿…ãšç€ãã€â€” æ­£å²¡å­è¦',
    'ã€Œå­¦ã¯äººãŸã‚‹æ‰€ä»¥ã‚’å­¦ã¶ãªã‚Šã€â€” ç¦æ²¢è«­å‰',
    'ã€Œå’Œã—ã¦åŒãœãšã€â€” è–å¾³å¤ªå­',
    'ã€Œè‡³èª ã«ã—ã¦å‹•ã‹ã–ã‚‹è€…ã¯ã€æœªã ä¹‹ã‚Œæœ‰ã‚‰ã–ã‚‹ãªã‚Šã€â€” å‰ç”°æ¾é™°',
    'ã€Œæ€ã†ã“ã¨æˆã‚‰ã¬ã¯æ€ã„è¶³ã‚‰ã¬ãŒæ•…ãªã‚Šã€â€” äºŒå®®å°Šå¾³',
    'ã€Œå¿è€ã¯è‹¦ã„ãŒã€ãã®å®Ÿã¯ç”˜ã„ã€â€” å¾³å·å®¶åº·'
  ];

  // æ€§æ ¼ï¼ˆã–ã£ãã‚Šï¼‰â€” åå‰ã«ã‚ˆã‚Šå£èª¿ã‚’å°‘ã—å¤‰ãˆã‚‹
  const PERSONA = {
    genki:['ãƒ•ã‚¡ã‚¤ãƒˆï¼','ã‚„ã£ã¡ã‚ƒãŠï¼','æœ€é«˜ã®ä¸€æ—¥ä½œã‚ï¼'],
    cool:['ç²›ã€…ã¨ã€‚','é™ã‹ãªé›†ä¸­ã§ã€‚','ä¸å¯§ã«ã„ã“ã†ã€‚'],
    tsun:['åˆ¥ã«â€¦å¿œæ´ãªã‚“ã‹ã—ãªã„ã‘ã©ã€ã‚„ã‚‹ãªã‚‰æœ¬æ°—ã§ã­','ãµãƒ¼ã‚“ã€ãã®èª¿å­','ãƒŸã‚¹ã¯ä¼¸ã³ã—ã‚ã€‚ä»¥ä¸Š'],
    senpai:['ã“ã“ã‚’æŠ¼ã•ãˆã‚Œã°ç‚¹ã«ãªã‚‹ã‚ˆ','ã‚³ãƒ„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã€ç¶™ç¶šã ã‚ˆ','è¿·ã£ãŸã‚‰åŸç†ã«æˆ»ã‚‹ã‚“ã ']
  };

  const NAME_PERSONA = new Map([
    ['æœ›æœˆäºœå¸Œå­','genki'],['æ°¸ç”°ç§€ä»','cool'],['é«˜æ©‹','senpai'],['å¶‹åº·','cool'],['ç”°ä¸­','genki'],
    ['æ± ä¹‹å†…è‹±æ˜','senpai'],['åŠ è—¤','tsun'],['ä½ã€…æœ¨','cool'],['å¯Œç”°é›„äºŒ','genki'],
    ['å¯Œå³¶é›…äºº','senpai'],['æˆæœ¨æ´‹å¹³','cool'],['ã·ã‚ãŸã‚“','genki'],['ã²ã‚ã‚†ã','tsun']
  ]);

  const recentLines = [];
  let lastSpeaker = { name:null, ts:0 };
  let classTicker = null;

  function personaTail(name){
    const p = NAME_PERSONA.get(name);
    if(!p) return '';
    return ' ' + rand(PERSONA[p]);
  }

  // 1) ä¸€èˆ¬ç”Ÿå¾’ã®åŠ±ã¾ã—ã‚’ç”Ÿæˆï¼ˆç§‘ç›®ãƒã‚¿ï¼‹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ï¼‰
  function makeStudentLine(name){
    const subjKeys = Object.keys(subjectLines);
    const subj = rand(subjKeys);
    const tip = rand(subjectLines[subj]);
    const tail = rand(ends);
    const mood = rand(pushers);
    const em = rand(emojis);
    const you = ($('#displayName').value||'å›').trim();
    const pattern = [
      `${subj}ï¼š${tip} ${tail} ${em}`,
      `${mood}ã«${subj}ã„ã“ã†ã€‚${tip}`,
      `${you}ã€${subj}ã§ä¸€æ­©é€²ã‚ã‚ˆã€‚${tip}`,
      `${subj}â†’${tip}ï¼çµ‚ã‚ã£ãŸã‚‰${rand(breakTips)}ã­`,
      `${subj}ã®æ™‚é–“ã€‚${tip} ${em}`
    ];
    return rand(pattern) + personaTail(name);
  }

  // 2) å”æ‰å…ˆç”Ÿï¼šåè¨€ã‚’é«˜ç¢ºç‡ã§å¼•ç”¨
  function makeTeacherLine(){
    const useQuote = Math.random() < 0.65;
    if(useQuote) return rand(jpHistoryQuotes);
    const you = ($('#displayName').value||'å›').trim();
    const pattern = [
      `æ—¥æœ¬å²ã¯å› æœã§æ‰ãˆã‚‹ã€‚å‡ºæ¥äº‹â†’ç†ç”±â†’çµæœã®é †ã«ç·šã‚’å¼•ã‘ã€${you}ã€‚`,
      `ã¾ãšã¯ç”¨èªã‚’è‡ªåˆ†ã®è¨€è‘‰ã«ã›ã‚ˆã€‚æš—è¨˜ã¯ç†è§£ã®å…¥å£ã ã€${you}ã€‚`,
      `å²æ–™ã¯ä¸»èªã¨ç«‹å ´ã‚’æŠ¼ã•ãˆã‚‹ã¨ä¸€æ°—ã«èª­ã‚ã‚‹ãã€‚`,
      `ä»Šæ—¥ã¯é€šå²ã‚’ä¸€æœ¬é€šã™ã€‚ç´°éƒ¨ã¯ã‚ã¨ã§è‚‰ä»˜ã‘ã ã€‚`,
      `è¿·ã£ãŸã‚‰æ™‚ä»£ã®æµã‚Œã«æˆ»ã‚Œã€‚åœ°å›³ã¨å¹´è¡¨ã‚’ä¸¦ã¹ã‚‹ã‚“ã ã€‚`
    ];
    return rand(pattern);
  }

  // é‡è¤‡é˜²æ­¢ï¼ˆæœ€è¿‘20ä»¶ã®å°è©ã¯é¿ã‘ã‚‹ï¼‰
  function pickUnique(generator, tries=10){
    let msg='';
    for(let i=0;i<tries;i++){
      msg = generator();
      if(!recentLines.includes(msg)) break;
    }
    recentLines.push(msg);
    if(recentLines.length>20) recentLines.shift();
    return msg;
  }

  function showBubble(deskEl, name){
    const bubble = deskEl.querySelector('.bubble');
    if(!bubble) return;
    const isFamous = FAMOUS_SET.has(name);
    bubble.className = 'bubble' + (isFamous ? ' famous' : '');
    const line = (name==='å”æ‰å…ˆç”Ÿ')
      ? pickUnique(makeTeacherLine)
      : pickUnique(()=>makeStudentLine(name));
    bubble.textContent = line;
    bubble.classList.add('show');
    setTimeout(()=> bubble.classList.remove('show'), 3000);
    lastSpeaker = {name, ts:Date.now()};
  }

  function buildClassroom(){
    const desks=$('#desks'); if(!desks) return; desks.innerHTML='';
    CLASSMATES.forEach((name)=>{
      const d=document.createElement('div'); d.className='desk';
      d.classList.add(FEMALES.has(name)?'female':'male');
      d.innerHTML = `
        <div class="name">${name}</div>
        <div class="role">${name==='æ©‹æœ¬æ·‘é›…'?'ï¼ˆã‚ãªãŸï¼‰':'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ'}</div>
        <div class="bubble"></div>
      `;
      d.addEventListener('click',()=> showBubble(d, name));
      desks.appendChild(d);
    });
  }

  // å…¥å®¤æ™‚ã«ä¸€æ°—ã«æ•°äººãŒç™ºè©±ï¼ˆã‚¬ãƒ¤æ„Ÿï¼‰
  function burstBubbles(n=3){
    const desks = Array.from(document.querySelectorAll('#desks .desk'));
    if(desks.length===0) return;
    const used = new Set();
    for(let k=0;k<n;k++){
      setTimeout(()=>{
        let el=null, guard=0;
        while(guard++<10){
          const cand = rand(desks);
          const name = cand.querySelector('.name')?.textContent||'';
          if(!used.has(name)){ used.add(name); el=cand; break; }
        }
        if(el){
          const name = el.querySelector('.name')?.textContent||'';
          showBubble(el, name);
        }
      }, k*400);
    }
  }

  // å‘¨æœŸçš„ã«ã‚‚æ™‚ã€…2äººåŒæ™‚ã«ç™ºè©±
  function startClassTicker(){
    stopClassTicker();
    classTicker = setInterval(()=>{
      const desks = Array.from(document.querySelectorAll('#desks .desk'));
      if(desks.length===0) return;
      const multi = Math.random()<0.4 ? 2 : 1;
      const chosen = new Set();
      for(let i=0;i<multi;i++){
        setTimeout(()=>{
          let el=null, guard=0;
          while(guard++<10){
            const cand = rand(desks);
            const name = cand.querySelector('.name')?.textContent||'';
            const tooSoon = (name===lastSpeaker.name && Date.now()-lastSpeaker.ts<2000);
            if(!chosen.has(name) && !tooSoon){ chosen.add(name); el=cand; break; }
          }
          if(el){
            const name = el.querySelector('.name')?.textContent||'';
            showBubble(el, name);
          }
        }, i*350);
      }
    }, 2200);
  }
  function stopClassTicker(){
    if(classTicker){ clearInterval(classTicker); classTicker=null; }
  }

  /* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY);
    $('#displayName').value = saved || 'æ©‹æœ¬æ·‘é›…';
  })();
  $('#saveName').addEventListener('click',()=>{ localStorage.setItem(NAME_KEY, ($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim()); renderRank(); });

  // ã‚¿ãƒ–
  $('#tabProgress').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));

  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank');
    const t1=$('#tabProgress'), t2=$('#tabClass'), t3=$('#tabRank');
    const show = (a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){
      show(p1,[p2,p3]); t1.classList.add('active'); t2.classList.remove('active'); t3.classList.remove('active');
      stopClassTicker(); renderProgress();
    }
    if(which==='class'){
      show(p2,[p1,p3]); t2.classList.add('active'); t1.classList.remove('active'); t3.classList.remove('active');
      buildClassroom(); burstBubbles(3+Math.floor(Math.random()*2)); startClassTicker();
    }
    if(which==='rank'){
      show(p3,[p1,p2]); t3.classList.add('active'); t1.classList.remove('active'); t2.classList.remove('active');
      stopClassTicker(); renderRank();
    }
  }
  const PAGES = ['progress','class','rank'];
  function pageIndexNow(){
    if($('#pageProgress').style.display!=='none') return 0;
    if($('#pageClass').style.display!=='none') return 1;
    return 2;
  }
  $('#pagePrev').addEventListener('click',()=>{
    const i = pageIndexNow(); const ni = (i+3-1)%3; showPage(PAGES[ni]); if(ni===0) setTimeout(scrollTodayIntoView,0);
  });
  $('#pageNext').addEventListener('click',()=>{
    const i = pageIndexNow(); const ni = (i+1)%3; showPage(PAGES[ni]); if(ni===0) setTimeout(scrollTodayIntoView,0);
  });

  // æœˆç§»å‹•ï¼ˆå‰æœˆ/æ¬¡æœˆï¼‰â†’ ç¾åœ¨æœˆã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ä¿å­˜ã—ã¦ã‹ã‚‰ç§»å‹•
  $('#prev').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} load(); renderProgress(); renderRank(); });
  $('#next').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} load(); renderProgress(); renderRank(); });

  // ä¿å­˜/èª­è¾¼
  $('#save').addEventListener('click',save);
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); renderRank(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // è¡¨ç¤ºåˆ‡æ›¿
  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  // å–è¾¼ï¼ˆè²¼ä»˜ï¼‰
  $('#importPaste').addEventListener('click',()=>{
    const text = prompt('æ—¥ä»˜ã¨ç¨®åˆ¥ã®ä¸€è¦§ã‚„ã€ç¸¦ä¸€åˆ—ã®è¡¨ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: 8/13(æ—¥) ä¼‘æ—¥ ãªã©ï¼‰');
    if(!text) return;
    pushHistory();
    const n = parseTypeImport(text) || importAnyText(text);
    renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆè¦‹å‡ºã—ãƒ»æœˆãƒ»æ›¸å¼ã‚’ç¢ºèªï¼‰');
  });

  // å–è¾¼ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
  $('#importFile').addEventListener('change',async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text();
    pushHistory();
    const n= importAnyText(txt);
    renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆè¦‹å‡ºã—ãƒ»å½“æœˆã‹è¦ç¢ºèªï¼‰');
    e.target.value='';
  });

  // å–è¾¼ï¼ˆOCRï¼‰
  $('#importImg').addEventListener('change',async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text = await ocrImage(f);
      pushHistory();
      const n = importAnyText(text) || parseTypeImport(text||'');
      renderProgress(); renderRank();
      alert(n?`OCRå–è¾¼ã§å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'æ–‡å­—ãŒèªè­˜ã§ããªã„ã‹ã€å½“æœˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }catch(err){
      alert('OCRã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã®é®®æ˜ã•ãƒ»ç…§æ˜ãƒ»å‚¾ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }finally{
      e.target.value='';
    }
  });

  // Undo/Redo/å…¨å‰Šé™¤
  $('#undoP').onclick = $('#undoC').onclick = $('#undoT').onclick = ()=>{ undo(); setTimeout(scrollTodayIntoView,0); };
  $('#redoP').onclick = $('#redoC').onclick = $('#redoT').onclick = ()=>{ redo(); setTimeout(scrollTodayIntoView,0); };
  $('#wipeP').onclick = ()=>{ if(confirm('å½“æœˆã®é€²æ—ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ pushHistory(); monthDates(year,month).forEach(ds=>{ const r=rows.find(x=>x.date===ds); if(r){ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; persist(r);} }); touch(); renderProgress(); renderRank(); } };
  $('#wipeC').onclick = ()=>{ if(confirm('Cãƒšãƒ¼ã‚¸ã®ç™ºè©±çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ recentLines.length=0; lastSpeaker={name:null,ts:0}; buildClassroom(); } };
  $('#wipeT').onclick = ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ')){ renderRank(); } };

  // ğŸ¹ï¼ãƒ›ãƒ¼ãƒ ï¼†ä»Šæ—¥ã¸
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });

  // Rï¼å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹ï¼‰
  $('#reloadBtn').addEventListener('click',()=>{
    const url = location.pathname + '?r=' + Date.now();
    location.replace(url);
  });

  // åˆæœŸåŒ–
  function renderAll(){
    const p1 = $('#pageProgress').style.display!=='none';
    const p2 = $('#pageClass').style.display!=='none';
    const p3 = $('#pageRank').style.display!=='none';
    if(p1) renderProgress();
    if(p2) { buildClassroom(); burstBubbles(3+Math.floor(Math.random()*2)); startClassTicker(); }
    if(p3) renderRank();
  }
  (function init(){
    const keyOld=`studyplanner.v14.ocr:${year}-${String(month+1).padStart(2,'0')}`;
    const rawOld=localStorage.getItem(keyOld);
    if(rawOld && !localStorage.getItem(currentKey())){
      try{ localStorage.setItem(currentKey(), rawOld); }catch{}
    }
    load(); renderProgress(); document.body.classList.add('compact'); renderRank();
    setTimeout(scrollTodayIntoView,0);
  })();

})();
</script>
</body>
</html>
