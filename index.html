<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ v17.13</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
    --male:#2563eb; --female:#f97316;
    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;
    --scale:1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:.78}

  h1{margin:0 0 12px;font-size:18px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  button,input[type="text"],input[type="file"],input[type="number"],input[type="time"],textarea,select{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:16px;cursor:pointer
  }
  input[type="text"],input[type="time"],textarea,select{width:100%;cursor:text}
  input[type="number"]{width:7em}
  textarea{min-height:120px;resize:vertical}
  .pill{border-radius:999px;padding:6px 10px;font-size:13px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;background:#fff;cursor:pointer}
  .chip.active{background:#eef2ff;border-color:#c7d2fe}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

  .today-banner{margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:14px}

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:84vh}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:700;font-size:12px;color:#111;
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);
  }
  tr:hover td{background:#f9fafb}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  .tinted td{background:var(--tint)!important}
  tr.done-row td{background:var(--doneTint)!important;color:#111!important}
  tr.today.done-row td{background:var(--doneTint)!important;color:#111!important}

  .col-date{width:160px}
  .col-type{width:160px}
  .col-goal,.col-result,.col-review{width:1fr}
  .col-donebtn{width:120px}
  .cell{display:flex;align-items:center;gap:8px}
  .type-buttons .chip{min-width:68px;text-align:center}

  /* pop (+pt/-pt) */
  .pop{
    position:absolute;pointer-events:none;font-weight:800;font-size:16px;
    animation:pop 1.2s ease forwards; text-shadow:0 1px 0 #fff;
    transform:translate(-50%,-50%);
  }
  @keyframes pop{0%{opacity:0;transform:translateY(-10px) scale(.9)}10%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translateY(-50px) scale(1.05)}}

  /* Page2/3/4 */
  .fab{position:fixed;z-index:5;right:14px;bottom:14px;width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.12)}
  .fab span{font-size:22px;line-height:1}
  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:100px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}
  .bubble{
    position:absolute;left:8px;right:8px;top:8px;border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);display:none;white-space:pre-line
  }
  .bubble.show{display:block;animation:fadeIn .15s ease}
  .bubble.yell{font-size:22px;padding:16px 18px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  .rank-wrap{display:grid;grid-template-columns:1fr 340px;gap:12px}
  @media(max-width:960px){ .rank-wrap{grid-template-columns:1fr} }
  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-rules{font-size:13px;color:#374151;background:#f9fafb;border:1px dashed #d1d5db;border-radius:8px;padding:8px;margin-bottom:8px}
  .rank-grid{column-width:260px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}
  .small{font-size:12px}
  .inl{display:inline-flex;gap:6px;align-items:center}
  .inp-mini{width:4.5em;padding:4px 6px;border-radius:8px;font-size:12px}
  .sel-mini{padding:4px 6px;border-radius:8px;font-size:12px}

  /* ãƒ©ãƒ³ã‚¯å¤‰å‹•ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
  @keyframes flashUp   { 0%,100%{background:transparent} 50%{background:rgba(134,239,172,.65)} }
  @keyframes flashDown { 0%,100%{background:transparent} 50%{background:rgba(254,202,202,.75)} }
  .flash-up{animation:flashUp 1.2s ease 1}
  .flash-down{animation:flashDown 1.2s ease 1}

  .rank-sidebar{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;max-height:78vh;overflow:auto}
  .rank-sidebar h4{margin:0 0 8px}
  .rank-list li{display:flex;justify-content:space-between;gap:8px;padding:6px 4px;border-bottom:1px dashed #e5e7eb}
  .rank-list li:last-child{border-bottom:none}

  .grid-edit{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .card h4{margin:0 0 6px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Timetable / Import modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:24px;z-index:50}
  .modal.show{display:flex}
  .panel{width:min(96vw,900px);max-height:80vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 24px 48px rgba(0,0,0,.2);padding:12px}
  .tt-grid{display:grid;grid-template-columns:110px 1fr 1fr 1fr; gap:8px; align-items:center}
  .tt-grid > div,.tt-row>div{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
  .tt-row{display:contents}
  .linklike{color:#2563eb;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰<span class="muted" id="verTag">v17.13</span>
    <span class="muted" id="savedAt">æœ€çµ‚ä¿å­˜: -</span>
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab" title="å­¦æ ¡">C ğŸ«</button>
    <button id="tabRank" class="tab" title="é †ä½">T ğŸ†</button>
    <button id="tabEdit" class="tab" title="ã‚»ãƒªãƒ•ãƒ»äººç‰©ç·¨é›†">S ğŸ’¬ğŸ‘¤</button>
  </div>

  <!-- ===== Page 1: é€²æ— ===== -->
  <section id="pageProgress" style="display:block">
    <div class="topbar">
      <button id="undoP">æˆ»ã‚‹</button>
      <button id="redoP">é€²ã‚€</button>
      <button id="wipeP">å…¨å‰Šé™¤</button>
      <!-- å–è¾¼ç³» -->
      <button id="btnPasteImport" class="chip">ğŸ“‹ è²¼ã‚Šä»˜ã‘å–è¾¼</button>
      <label class="chip">
        ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼
        <input id="fileImport" type="file" accept=".csv,.tsv,.txt,.text" style="display:none">
      </label>
      <button id="btnSheetsImport" class="chip" title="Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URL/IDã‹ã‚‰å–è¾¼">ğŸ§© Sheetså–è¾¼</button>
    </div>

    <!-- ç§‘ç›®/å…¨ç§‘ç›® + ãƒ†ãƒ¼ãƒè‰² + å®Œäº†è‰² + ãƒã‚¤ãƒ³ãƒˆ + æ™‚é–“å‰² -->
    <div class="topbar" style="gap:12px; align-items:center">
      <div class="row">
        <label class="muted">ç§‘ç›®ï¼š</label>
        <select id="subjectSelect" style="width:auto"></select>
        <button id="addSubject">ï¼‹ç§‘ç›®è¿½åŠ </button>
        <button id="toggleAllBtn" class="chip" title="å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰"><span id="allIcon">ğŸ“š</span> å…¨ç§‘ç›®</button>
      </div>

      <div class="row">
        <span class="muted">ğŸ¨ ãƒ†ãƒ¼ãƒè‰²</span>
        <button class="chip preset" data-preset="redsox">Red Sox</button>
        <button class="chip preset" data-preset="bluejays">Blue Jays</button>
        <button class="chip preset" data-preset="dodgers">Dodgers</button>
        <button class="chip preset" data-preset="nl">NL All-Star</button>
        <input id="colorPicker" type="text" placeholder="#RRGGBB" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label>
        <input id="tintRange" type="range" min="0" max="95" value="20" style="width:120px">
        <button id="applyColor" class="chip">é©ç”¨</button>
      </div>

      <div class="row">
        <span class="muted">âœ… å®Œäº†è‰²</span>
        <input id="doneColorPicker" type="text" placeholder="#B0A89F" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label>
        <input id="doneTintRange" type="range" min="10" max="95" value="34" style="width:120px">
        <button id="applyDoneColor" class="chip">é©ç”¨</button>
      </div>

      <div class="row">
        <span class="muted">ğŸ…ãƒã‚¤ãƒ³ãƒˆ</span>
        <span class="inl small">å­¦ç¿’ <input id="ptStudy" class="inp-mini" type="number" min="0" value="10"></span>
        <span class="inl small">å¾©ç¿’ <input id="ptReview" class="inp-mini" type="number" min="0" value="6"></span>
        <span class="inl small">ä¼‘æ—¥ <input id="ptHoliday" class="inp-mini" type="number" min="0" value="0"></span>
        <button id="applyPts" class="chip">ä¿å­˜</button>
      </div>

      <div class="row" style="margin-left:auto">
        <button id="ttOpen" class="chip">ğŸ—“ æ™‚é–“å‰²ã‚’é–‹ã</button>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="pill">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="pill">æ¬¡æœˆ â–¶</button>
      <button id="save" class="pill">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load" class="pill">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact" class="pill">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <th class="col-date">æ—¥ä»˜</th>
            <th class="col-type">ç¨®åˆ¥</th>
            <th class="col-goal">ç›®æ¨™</th>
            <th class="col-result">çµæœ</th>
            <th class="col-review">å¾©ç¿’</th>
            <th class="col-donebtn">å®Œäº†</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ ===== -->
  <section id="pageClass" style="display:none">
    <div class="topbar">
      <button id="undoC">æˆ»ã‚‹</button>
      <button id="redoC">é€²ã‚€</button>
      <button id="wipeC">å…¨å‰Šé™¤</button>
      <button id="shuffleSeat" class="chip">ğŸ”€ å¸­æ›¿ãˆ</button>
      <button id="toggleLayout" class="chip">M/F/M æ•´åˆ—</button>
    </div>
    <div class="blackboard">
      1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œ<span id="meOnBoard">æ©‹æœ¬æ·‘é›…</span>ã€ã‚’å¿œæ´ä¸­ï¼
      <span style="margin-left:10px" class="muted">é€Ÿã•%å¢—ã—ï¼š</span>
      <input id="boostInput" type="number" min="0" step="1" value="0" title="ä¾‹: 13 â†’ 13%é€Ÿã" style="width:8em">
      <button id="applyBoost">é©ç”¨</button>
      <span id="boostHint" class="muted"></span>
    </div>
    <div class="room"><div class="desks" id="desks"></div></div>
  </section>

  <!-- ===== Page 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== -->
  <section id="pageRank" style="display:none">
    <div class="topbar" style="justify-content:space-between">
      <div class="row">
        <button id="undoT">æˆ»ã‚‹</button>
        <button id="redoT">é€²ã‚€</button>
        <button id="wipeT">å…¨å‰Šé™¤</button>
      </div>
      <div class="row">
        <span class="inl small">é †ä½å¤‰å‹•ã‚¹ãƒ”ãƒ¼ãƒ‰(%) <input id="rankSpeed" class="inp-mini" type="number" min="10" max="300" value="100" title="100%=æ¨™æº–ã€200%=2å€é€Ÿ"></span>
      </div>
    </div>

    <div class="rank-wrap">
      <div class="rank-card">
        <div class="rank-rules" id="rankRules">
          <strong>ãƒã‚¤ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒ«</strong><br>
          ãƒ»å½“æ—¥ã€Œå®Œäº†ï¼ˆã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢è‰²ï¼‰ã€ã«ã—ãŸå­¦ç¿’â€¦ +<span id="ruleStudy">10</span> / å¾©ç¿’â€¦ +<span id="ruleReview">6</span>ï¼ˆã€Œä¼‘æ—¥ã€ã¯ +<span id="ruleHoliday">0</span>ï¼‰<br>
          ãƒ»æœ¬æ—¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŠ ç‚¹ã¯ <strong>18:00</strong> ã¾ã§ï¼ˆä»¥é™ã¯ç¿Œæ—¥ã«ç¹°è¶Šï¼‰<br>
          ãƒ»å­¦æ ¡å‹¢ã¯ 16â€“18æ™‚ã«åŠ ç‚¹ãŒä¼¸ã³ã‚„ã™ã„ï¼æµªäººãƒ»ç‹¬å­¦å‹¢ã¯åˆå‰ï½15æ™‚ã‚‚ä¼¸ã³ã‚„ã™ã„ï¼ˆç–‘ä¼¼ï¼‰
        </div>
        <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
        <div id="rankGrid" class="rank-grid"></div>
        <div id="rankTicker" class="muted" style="margin-top:6px">â€¦æ›´æ–°ä¸­</div>
      </div>

      <aside class="rank-sidebar">
        <h4>å…¨å“¡ã®ä¸€è¦§</h4>
        <ol id="rankList" class="rank-list"></ol>
      </aside>
    </div>
  </section>

  <!-- ===== Page 4: ã‚»ãƒªãƒ•ãƒ»äººç‰©ç·¨é›† ===== -->
  <section id="pageEdit" style="display:none">
    <div class="topbar">
      <button id="undoS">æˆ»ã‚‹</button>
      <button id="redoS">é€²ã‚€</button>
      <button id="addPerson" class="chip">ï¼‹äººç‰©è¿½åŠ </button>
      <span class="muted">å„äººï¼š1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºæ¬„ã§ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆè‡ªå‹•ä¿å­˜ï¼šå…¥åŠ›åœæ­¢0.6ç§’ï¼‰</span>
      <button id="exportLines">ğŸ’¾ æ›¸ãå‡ºã—</button>
      <label>
        <input id="importLinesFile" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('importLinesFile').click()">ğŸ“¥ èª­è¾¼</button>
      </label>
    </div>
    <div class="grid-edit" id="editGrid"></div>
  </section>

  <!-- æ™‚é–“å‰²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="ttModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong id="ttTitle">ä»Šæ—¥ã®æ™‚é–“å‰²</strong>
        <div class="row" style="gap:8px">
          <button id="ttAddRow" class="chip">ï¼‹è¡Œè¿½åŠ </button>
          <button id="ttSuggest" class="chip">ğŸ”€ è‡ªå‹•ææ¡ˆï¼ˆ20ä»¶ï¼‰</button>
          <button id="ttClose" class="chip">é–‰ã˜ã‚‹ âœ•</button>
        </div>
      </div>
      <div class="tt-grid" style="margin-top:8px">
        <div class="muted">é–‹å§‹</div><div class="muted">çµ‚äº†</div><div class="muted">å†…å®¹</div><div class="muted">æ“ä½œ</div>
      </div>
      <div id="ttRows"></div>
      <div class="ttSuggestBar row" id="ttSuggestBar" style="gap:10px; align-items:center; margin-top:10px; display:none">
        <button id="ttPrev" class="chip">â—€ å‰</button>
        <span id="ttIndex" class="muted">1 / 20</span>
        <button id="ttNext" class="chip">æ¬¡ â–¶</button>
        <button id="ttApply" class="chip">âœ… æ¡ç”¨</button>
      </div>
      <div class="muted" style="margin-top:8px">ãƒ’ãƒ³ãƒˆï¼šå…¥åŠ›ã¯å³ä¿å­˜ï¼ææ¡ˆã‚’æ¡ç”¨ã—ã¦ã‹ã‚‰å¾®èª¿æ•´å¯èƒ½</div>
    </div>
  </div>

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';
  const VER='v17.13';

  /* ===== Keys ===== */
  const NS='studyplanner.v17'; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨äº’æ›
  const NAME_KEY   = `${NS}.displayName`;
  const SUBJ_KEY   = `${NS}.subjects`;
  const COL_KEY    = `${NS}.subjectColors`;
  const DONE_KEY   = `${NS}.doneColor`;
  const LINES_KEY  = `${NS}.lines`;
  const TT_KEY     = `${NS}.tt`;
  const DATA_KEY   = `${NS}.data`; // per subject, per month
  const PTS_KEY    = `${NS}.points`;
  const DP_KEY     = `${NS}.dailyPoints`;
  const PEOPLE_KEY = `${NS}.people`;
  const BOOST_KEY  = `${NS}.classBoost`;

  /* ===== State ===== */
  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let subjects = loadSubjects();
  let subject = subjects[0] || 'ä¸–ç•Œå²';
  let showAll = false;
  let subjectColors = loadSubjectColors();
  let doneColor = loadDoneColor();
  let pointsCfg = loadPoints();
  let rows=[];

  /* ===== Undo/Redo ===== */
  const history = { past:[], future:[] };
  const snapshot = ()=> JSON.parse(JSON.stringify({
    year, month, rows, subject, showAll, subjectColors, doneColor, pointsCfg,
    people, customLines
  }));
  function pushHistory(){ history.past.push(snapshot()); history.future.length=0; }
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); ({year,month,rows,subject,showAll,subjectColors,doneColor,pointsCfg,people,customLines}=prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); ({year,month,rows,subject,showAll,subjectColors,doneColor,pointsCfg,people,customLines}=nxt); renderAll(); }

  /* ===== Utils ===== */
  const $=s=>document.querySelector(s);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function tintCss(hex, percent){ const m=hex.replace('#',''); const r=parseInt(m.slice(0,2),16), g=parseInt(m.slice(2,4),16), b=parseInt(m.slice(4,6),16); const a=Math.max(0,Math.min(1,percent/100)); return `rgba(${r},${g},${b},${a})`; }

  /* ===== Subjects & Colors ===== */
  function loadSubjects(){ try{ const raw=localStorage.getItem(SUBJ_KEY); const arr = raw? JSON.parse(raw): null; return (Array.isArray(arr)&&arr.length)?arr:['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; }catch(_){ return ['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; } }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function renderSubjectSelect(){ const sel=$('#subjectSelect'); if(!sel) return; sel.innerHTML=''; subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); if(!subjects.includes(subject)) subject=subjects[0]; sel.value=subject; }
  function loadSubjectColors(){ try{ const raw=localStorage.getItem(COL_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; } }
  function saveSubjectColors(){ try{ localStorage.setItem(COL_KEY, JSON.stringify(subjectColors)); }catch(_){} }
  function colorFor(subj){
    const c = subjectColors[subj];
    if(c && c.hex){ return {hex:c.hex, tint: Math.max(0,Math.min(95,c.tint??20))}; }
    if(/è‹±èª/.test(subj)) return {hex:'#BD3039', tint:20};
    if(/æ•°å­¦/.test(subj)) return {hex:'#134A8E', tint:20};
    if(/ä¸–ç•Œå²/.test(subj)) return {hex:'#005A9C', tint:18};
    return {hex:'#2563eb', tint:16};
  }
  function loadDoneColor(){ try{ const raw=localStorage.getItem(DONE_KEY); return raw? JSON.parse(raw): {hex:'#B0A89F', tint:34}; }catch(_){ return {hex:'#B0A89F', tint:34}; } }
  function saveDoneColor(){ try{ localStorage.setItem(DONE_KEY, JSON.stringify(doneColor)); }catch(_){} }

  /* ===== Points ===== */
  function loadPoints(){ try{ const raw=localStorage.getItem(PTS_KEY); return raw? JSON.parse(raw): {study:10, review:6, holiday:0}; }catch(_){ return {study:10, review:6, holiday:0}; } }
  function savePoints(){ try{ localStorage.setItem(PTS_KEY, JSON.stringify(pointsCfg)); }catch(_){} }
  function pointsForType(t){ if(t==='å¾©ç¿’') return +pointsCfg.review||0; if(t==='ä¼‘æ—¥') return +pointsCfg.holiday||0; return +pointsCfg.study||0; }

  /* ===== Per-month data ===== */
  const currentKey = (s=subject)=> `${DATA_KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function ensureScaffoldFor(arr){
    const result = Array.isArray(arr) ? arr : [];
    const need=new Set(monthDates(year,month));
    const have=new Set(result.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) result.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    result.sort((a,b)=>a.date.localeCompare(b.date));
    return result;
  }
  function loadSubjectMonth(s=subject){
    try{
      const raw=localStorage.getItem(currentKey(s));
      const arr = raw? JSON.parse(raw): [];
      return ensureScaffoldFor(arr);
    }catch(_){
      return ensureScaffoldFor([]);
    }
  }
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=(dataRows||[]).filter(r=>{ const d=fromYmd(r.date); return d.getMonth()===month && d.getFullYear()===year; });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }
  function persist(rec){
    const i=rows.findIndex(x=>x.date===rec.date && (showAll? (x._subject===rec._subject):true));
    if(i>=0) rows[i]=rec; else rows.push(rec);
  }

  function reloadRows(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr=loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r,_subject:sub}));
      });
      rows=merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
    }else{
      rows=loadSubjectMonth(subject);
    }
    return true;
  }

  /* ===== SavedAt & Autosave ===== */
  function setSavedNow(){
    const t=new Date();
    const s = `${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
    const el=$('#savedAt'); if(el) el.textContent = `æœ€çµ‚ä¿å­˜: ${s}`;
  }

  let autoSaveTimer=null;
  function computeSavePayload(){
    const map = new Map();
    if(showAll){
      rows.forEach(r=>{
        const subj=r._subject||subject;
        if(!map.has(subj)) map.set(subj,[]);
        map.get(subj).push(stripSubject(r));
      });
    }else{
      map.set(subject, rows.map(stripSubject));
    }
    return map;
  }
  function scheduleSave(){
    const payload = computeSavePayload();
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      payload.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      setSavedNow();
      autoSaveTimer=null;
    }, 600);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    const payload = computeSavePayload();
    payload.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    setSavedNow();
  }
  window.addEventListener('beforeunload', flushAutoSave);

  /* ===== People & Lines ===== */
  const FEMALES = new Set(['æœ›æœˆäºœå¸Œå­','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­']);
  const FAMOUS = new Set(['ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­','æœ›æœˆäºœå¸Œå­']);

  function defaultPeople(){
    const names = ['æ©‹æœ¬æ·‘é›…','æœ›æœˆäºœå¸Œå­','æ°¸ç”°ç§€ä»','é«˜æ©‹','å¶‹åº·','ç”°ä¸­','æ± ä¹‹å†…è‹±æ˜','åŠ è—¤','ä½ã€…æœ¨','å¯Œç”°é›„äºŒ','å¯Œå³¶é›…äºº','æˆæœ¨æ´‹å¹³','å”æ‰å…ˆç”Ÿ',
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','æ©‹æœ¬ç¯„ä¹‹','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­'];
    const tokuiList = ['è‹±èª','ä¸–ç•Œå²','æ—¥æœ¬å²','æ•°å­¦','ç‰©ç†','åŒ–å­¦','ç¾ä»£æ–‡','å¤å…¸','ç”Ÿç‰©','åœ°ç†','æ”¿çµŒ','æƒ…å ±'];
    const nigateList= ['æ•°å­¦','è‹±èª','ä¸–ç•Œå²','ç‰©ç†','åŒ–å­¦','æ—¥æœ¬å²','ç¾ä»£æ–‡','å¤å…¸','åœ°ç†','ç”Ÿç‰©','æ”¿çµŒ','æƒ…å ±'];
    const seikakuList=['ã‚³ãƒ„ã‚³ãƒ„','ãƒã‚¤ãƒšãƒ¼ã‚¹','è² ã‘ãšå«Œã„','ç†å±ˆæ´¾','ç›´æ„Ÿæ´¾','ç››ã‚Šä¸Šã’å½¹','é™ã‹','å‡ å¸³é¢','ãƒã‚¸ãƒ†ã‚£ãƒ–','å„ªã—ã„','ã‚¹ãƒˆã‚¤ãƒƒã‚¯','æŸ”è»Ÿ'];
    return names.map((n,i)=>({
      name:n,
      female: FEMALES.has(n),
      famous: FAMOUS.has(n),
      profile:{age:18+i%5, ron:i%3, geneki:(i%4!==0), quota: 60 + (i*7)%41},
      traits:{tokui: tokuiList[i%tokuiList.length], nigate: nigateList[(i+3)%nigateList.length], seikaku: seikakuList[(i+5)%seikakuList.length]}
    }));
  }
  function loadPeople(){ try{ const raw=localStorage.getItem(PEOPLE_KEY); return raw? JSON.parse(raw): defaultPeople(); }catch(_){ return defaultPeople(); } }
  function savePeople(){ try{ localStorage.setItem(PEOPLE_KEY, JSON.stringify(people)); }catch(_){} }
  let people = loadPeople();

  // 20å€‹ã®å€‹æ€§çš„ãªåˆæœŸã‚»ãƒªãƒ•
  function makeDefaultLinesFor(p){
    const n=p.name, t=p.traits||{}, pr=p.profile||{};
    const pieces=[
      `ã€${n}ã€‘æ˜¨æ—¥ã‚ˆã‚Šè§£ãé€Ÿã•ãŒä¸ŠãŒã£ã¦ã‚‹ã€ç©ã¿é‡ã­ãŒåŠ¹ã„ã¦ã‚‹ã‚ˆï¼`,
      `ã€${n}ã€‘${t.tokui||'å¾—æ„ç§‘ç›®'}ã®ä¼¸ã³ãŒç›®ã«è¦‹ãˆã‚‹ã€ãƒšãƒ¼ã‚¹ã‚’å´©ã•ãšã„ã“ã†ã€‚`,
      `ã€${n}ã€‘é–“é•ã„ã®ãƒ¡ãƒ¢ãŒè‰¯ã„ã€æ¬¡ã®ä¸€å•ã§æ´»ãã‚‹ã¯ãšã€‚`,
      `ã€${n}ã€‘ã‚‚ã†5åˆ†ç¶™ç¶šã§ããŸã‚‰ä»Šæ—¥ã®è‡ªåˆ†ã‚’è¶Šãˆã‚‰ã‚Œã‚‹ã€ã„ã‘ã‚‹ã€‚`,
      `ã€${n}ã€‘ä¼‘æ†©ã®å…¥ã‚Œæ–¹ãŒä¸Šæ‰‹ã€é›†ä¸­ãŒé•·æŒã¡ã—ã¦ã‚‹ï¼`,
      `ã€${n}ã€‘${t.nigate||'è‹¦æ‰‹'}ã®ä¸€æ­©ãŒå°Šã„ã€å‰é€²ã—ã¦ã‚‹ã‹ã‚‰è‡ªä¿¡æŒã£ã¦ã€‚`,
      `ã€${n}ã€‘å§¿å‹¢ãŒè‰¯ã„ã¨é ­ã‚‚å†´ãˆã‚‹ã€ã„ã¾ãã®ãƒ•ã‚©ãƒ¼ãƒ æœ€é«˜ã€‚`,
      `ã€${n}ã€‘éŸ³èª­ã¯è¨˜æ†¶ã‚’å¼·ãã™ã‚‹ã€å£°ãŒå‡ºã›ãŸã‚‰ã•ã‚‰ã«è‰¯ã„ã­ã€‚`,
      `ã€${n}ã€‘ç›®æ¨™ã‚’æ•°å­—ã§åˆ»ã‚ã¦ã‚‹ã€é”æˆã®é“ç­‹ãŒã¯ã£ãã‚Šã—ã¦ããŸã€‚`,
      `ã€${n}ã€‘${pr.geneki?'ç¾å½¹ã®å‹¢ã„':'è½ã¡ç€ã'}ãŒå‡ºã¦ã‚‹ã€å®‰å®šã—ã¦å¼·ã„ã€‚`,
      `ã€${n}ã€‘ãƒãƒ¼ãƒˆã®ä½™ç™½ã®ä½¿ã„æ–¹ãŒã‚¹ãƒãƒ¼ãƒˆã€è¦‹è¿”ã—ã‚„ã™ã„ï¼`,
      `ã€${n}ã€‘ã‚ã‹ã‚‰ãªã‹ã£ãŸæ‰€ã‚’æ”¾ç½®ã—ã¦ãªã„ã€ãã®å§¿å‹¢ã¯ä¼¸ã³ã‚‹ã€‚`,
      `ã€${n}ã€‘ä»Šæ—¥ã¯${t.tokui||'å¾—æ„'}ã§ç‚¹ã‚’ç¨¼ã’ã‚‹æ—¥ã€ã‚„ã‚Šåˆ‡ã‚ã†ã€‚`,
      `ã€${n}ã€‘è§£ãç›´ã—ã®å›æ•°ãŒå¢—ãˆã¦ã‚‹ã€å®šç€ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé•ã†ã€‚`,
      `ã€${n}ã€‘åŒºåˆ‡ã‚Šæ–¹ãŒã†ã¾ã„ã€é›†ä¸­ã‚¹ã‚¤ãƒƒãƒã®å…¥ã‚ŠãŒæ—©ã„ï¼`,
      `ã€${n}ã€‘ä¸€å•ã«ã“ã ã‚ã‚‹ç²˜ã‚ŠãŒç´ æ•µã€çµæœã¯å¾Œã‹ã‚‰ä»˜ã„ã¦ãã‚‹ã€‚`,
      `ã€${n}ã€‘å°ã•ãªå®Œäº†ã§ã‚‚èƒ¸ã‚’å¼µã£ã¦ã„ã„ã€ç¶™ç¶šã¯æœ€å¤§ã®æ­¦å™¨ã€‚`,
      `ã€${n}ã€‘${t.seikaku||'ãƒã‚¤ãƒšãƒ¼ã‚¹'}ãªãƒªã‚ºãƒ ãŒåŠŸã‚’å¥ã—ã¦ã‚‹ã€ã¶ã‚Œãªã„ã€‚`,
      `ã€${n}ã€‘è¦‹ç›´ã—ã®å°ãŒå¢—ãˆã¦ã‚‹ã€ä¸å¯§ã•ãŒç‚¹ã«å¤‰ã‚ã‚‹ã‚ˆã€‚`,
      `ã€${n}ã€‘ä»Šæ—¥ã®ã‚ãªãŸã€ç¢ºå®Ÿã«æ˜¨æ—¥ã‚ˆã‚Šå¼·ã„ã€‚è‡ªåˆ†ã§ä½œã£ãŸæˆé•·ã ã‚ˆã€‚`
    ];
    return pieces;
  }

  function loadCustomLines(){
    try{
      const raw=localStorage.getItem(LINES_KEY);
      if(raw) return JSON.parse(raw) || {};
      const obj={}; people.forEach(p=>{ obj[p.name]=makeDefaultLinesFor(p); });
      localStorage.setItem(LINES_KEY, JSON.stringify(obj));
      return obj;
    }catch(_){ return {}; }
  }
  function saveCustomLines(){ try{ localStorage.setItem(LINES_KEY, JSON.stringify(customLines)); }catch(_){} }
  let customLines = loadCustomLines();
  let lineAutosaveTimer=null; const scheduleLinesSave=()=>{ if(lineAutosaveTimer) clearTimeout(lineAutosaveTimer); lineAutosaveTimer=setTimeout(saveCustomLines,600); };
  function getLinesFor(name){ const arr = Array.isArray(customLines[name])? customLines[name] : []; return arr.slice(); }

  /* ===== Page1: Render ===== */
  function renderProgress(){
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ä¿æŒ
    const scroller=$('#scroller'); const prevTop = scroller? scroller.scrollTop : 0;

    const days = monthDates(year,month).length;
    const label=$('#label'); if(label) label.textContent = showAll? `å…¨ç§‘ç›® ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰` : `${subject} â€” ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰`;

    const tb=$('#tbody'); if(!tb) return; tb.innerHTML='';
    const todayStr=ymd(new Date());
    const subjColor = colorFor(subject);
    const themeTint = tintCss(subjColor.hex, subjColor.tint);
    const doneTint  = tintCss(doneColor.hex, doneColor.tint);

    // è¡¨ç¤ºãƒªã‚¹ãƒˆ
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach((r,rowIndex)=>{
      const tr=document.createElement('tr');

      const isHoliday = (r.type==='ä¼‘æ—¥');
      const isDone = (r.color==='gray') || isHoliday;

      if(r.date===todayStr) tr.classList.add('today');
      if(isDone){
        tr.classList.add('done-row');
        tr.style.setProperty('--doneTint', doneTint);
      }else{
        tr.classList.add('tinted');
        tr.style.setProperty('--tint', themeTint);
      }

      // æ—¥ä»˜
      const tdDate = document.createElement('td'); tdDate.className='col-date'; tdDate.innerHTML = `<div class="cell">${jpDateLabel(r.date)}</div>`;

      // ç¨®åˆ¥ï¼ˆå­¦ç¿’ï¼ä¼‘æ—¥ï¼‰
      const tdType = document.createElement('td'); tdType.className='col-type';
      tdType.innerHTML = `<div class="cell type-buttons">
        <button class="chip btnType ${r.type==='å­¦ç¿’'?'active':''}" data-val="å­¦ç¿’">å­¦ç¿’</button>
        <button class="chip btnType ${r.type==='ä¼‘æ—¥'?'active':''}" data-val="ä¼‘æ—¥">ä¼‘æ—¥</button>
      </div>`;

      const tdGoal=document.createElement('td'); tdGoal.className='col-goal';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24'; inGoal.value=(r.goal??''); tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='col-result';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾'; inRes.value=(r.result??''); tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='col-review';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²'; inRev.value=(r.review??''); tdRev.appendChild(inRev);

      // å®Œäº†ï¼ˆãƒˆã‚°ãƒ«ï¼‰
      const tdDone=document.createElement('td'); tdDone.className='col-donebtn';
      const btnDone=document.createElement('button'); btnDone.className='chip'; btnDone.textContent='å®Œäº†';
      tdDone.appendChild(btnDone);

      // å…¥åŠ›å¤‰æ›´ï¼ˆå³ä¿å­˜ï¼‰
      const onInput=(field)=>(e)=>{ r[field]=e.target.value; persist(r); scheduleSave(); };
      inGoal.addEventListener('input', onInput('goal'));
      inRes .addEventListener('input', onInput('result'));
      inRev .addEventListener('input', onInput('review'));

      // ç¨®åˆ¥ã‚¯ãƒªãƒƒã‚¯ï¼ˆå­¦ç¿’ã«æˆ»ã—ãŸã‚‰è‰²ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¸ï¼‰
      tdType.querySelectorAll('.btnType').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const v=btn.dataset.val;
          r.type=v;
          if(v==='å­¦ç¿’') r.color='normal'; // å­¦ç¿’ã«æˆ»ã—ãŸã‚‰ç§‘ç›®è‰²ã¸
          persist(r); scheduleSave(); renderProgress();
        });
      });

      // å®Œäº†ãƒˆã‚°ãƒ«ï¼ˆç°è‰²â‡„å…ƒã®è‰²ï¼‰
      btnDone.addEventListener('click',(ev)=>{
        const wasDone = (r.color==='gray');
        r.color = wasDone? 'normal':'gray';
        persist(r); scheduleSave(); renderProgress();
        popAt(ev.target, `${wasDone?'âˆ’':'+'}${pointsForType(r.type||'å­¦ç¿’')}`, wasDone?'#ef4444':'#10b981');
      });

      // ã‚­ãƒ¼ç§»å‹•
      const focusables=[inGoal,inRes,inRev,btnDone];
      focusables.forEach((el,colIndex)=>{
        el.dataset.rowIndex=rowIndex; el.dataset.colIndex=colIndex;
        el.addEventListener('keydown',(ev)=>{
          const rIdx=+el.dataset.rowIndex, cIdx=+el.dataset.colIndex;
          let nr=rIdx, nc=cIdx;
          if(ev.key==='ArrowDown'||ev.key==='Enter') nr=rIdx+1;
          if(ev.key==='ArrowUp')   nr=rIdx-1;
          if(ev.key==='ArrowRight')nc=cIdx+1;
          if(ev.key==='ArrowLeft') nc=cIdx-1;
          if(nr!==rIdx || nc!==cIdx){
            ev.preventDefault();
            const q=`[data-row-index="${nr}"][data-col-index="${nc}"]`;
            const next=$('#tbody').querySelector(q);
            if(next){ next.focus(); if(next.select) next.select(); }
          }
        });
      });

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdDone);
      tb.appendChild(tr);
    });

    const t=new Date();
    const todayBanner=$('#todayBanner'); if(todayBanner) todayBanner.textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®å¾©å…ƒ
    if(scroller) scroller.scrollTop = prevTop;
  }

  function popAt(anchor, text, color){
    const r = anchor.getBoundingClientRect();
    const pop=document.createElement('div'); pop.className='pop'; pop.textContent=text;
    pop.style.left = (r.left + r.width/2) + 'px';
    pop.style.top  = (r.top - 8 + window.scrollY) + 'px';
    pop.style.color = color||'#10b981';
    document.body.appendChild(pop);
    setTimeout(()=>{ pop.remove(); }, 1200);
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead'); const todayRow=scroller.querySelector('tr.today');
    if(!todayRow||!thead) return; const headerH=thead.getBoundingClientRect().height; const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'auto'});
  }

  /* ===== Import / OCR / Sheets ===== */
  const normalizeDateToken=(raw)=>{
    if(!raw) return null;
    let s=String(raw).trim();
    s=s.replace(/ï¼ˆ.*?ï¼‰|\(.*?\)/g,'');
    s=s.replace(/[ï¼ã€‚ãƒ»â€’â€“â€”â€•ã€œï½]/g,'-');
    let m=s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/);
    if(m) return {y:+m[1],mo:+m[2]-1,d:+m[3]};
    m=s.match(/^(\d{1,2})\s*(?:\/|æœˆ)\s*(\d{1,2})/);
    if(m){ const y=year; return {y,mo:+m[1]-1,d:+m[2]}; }
    return null;
  };
  const clean=v=>{ const s=String(v??'').trim(); if(!s) return ''; if(/^(nan|null|undefined)$/i.test(s)) return ''; return s; };
  const isTruthy=v=>{
    const s=String(v??'').trim().toLowerCase();
    return ['1','true','yes','y','t','å®Œäº†','æ¸ˆ','æ¸ˆã¿','done','â—‹','â—¯'].includes(s);
  };
  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
    const sep=(text.indexOf('\t')!==-1)?'\t':',';
    const lines=text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header=lines[0].split(sep).map(s=>s.trim());
    const rows=lines.slice(1).map(line=>{
      const cells=line.split(sep);
      const obj={}; header.forEach((h,i)=> obj[h]=(cells[i]??'').trim());
      return obj;
    });
    return {header,rows};
  }

  // æ±ç”¨CSVå–è¾¼ï¼ˆæ—¥ä»˜,ç¨®åˆ¥,ç›®æ¨™,çµæœ,å¾©ç¿’,å®Œäº† ã«å¯¾å¿œï¼å®Œäº†ãŒç„¡ã„å ´åˆã¯ç„¡è¦–ï¼‰
  function importCsvText(text){
    const {header,rows:objs}=parseDelimited(text);
    const col={};
    header.forEach(h=>{
      if(/æ—¥ä»˜/.test(h)) col.date=h;
      if(/ç¨®åˆ¥/.test(h)) col.type=h;
      if(/^ç›®æ¨™(?:ï¼ˆç§‘ç›®åï¼‰)?$/.test(h)||/ç›®æ¨™/.test(h)) col.goal=h;
      if(/çµæœ/.test(h)) col.result=h;
      if(/å¾©ç¿’/.test(h)) col.review=h;
      if(/å®Œäº†/.test(h)) col.done=h;
    });
    if(!col.date||!col.type){ alert('CSVã®è¦‹å‡ºã—ã«ã€Œæ—¥ä»˜ã€ã€Œç¨®åˆ¥ã€ãŒå¿…è¦ã§ã™'); return 0; }
    if(showAll){ alert('å…¨ç§‘ç›®ã§ã¯CSVå–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return 0; }
    let applied=0;
    for(const o of objs){
      const dtk=normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year||dtk.mo!==month) continue;
      const ds=ymd(new Date(dtk.y,dtk.mo,dtk.d));
      const rec=rows.find(x=>x.date===ds); if(!rec) continue;
      let t=clean(o[col.type]); if(t==='ä¼‘ã¿') t='ä¼‘æ—¥';
      if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }
      if(col.goal!==undefined)   rec.goal   = clean(o[col.goal]);
      if(col.result!==undefined) rec.result = clean(o[col.result]);
      if(col.review!==undefined) rec.review = clean(o[col.review]);
      if(col.done && clean(o[col.done])!==''){
        rec.color = isTruthy(o[col.done]) ? 'gray' : 'normal';
      }
      persist(rec); applied++;
    }
    if(applied) scheduleSave();
    return applied;
  }

  function looksLikeColumnBlocks(text){
    const L=text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if(L.length<12) return false;
    const i=L.findIndex(s=>s.includes('æ—¥ä»˜'));
    if(i<0||i+4>=L.length) return false;
    const head=L.slice(i,i+5);
    const need=['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'];
    if(!need.every((w,idx)=> (head[idx]||'').includes(w))) return false;
    return L.slice(i+5).some(s=>/^\d{1,2}[\/\-æœˆ]\d{1,2}/.test(s)||/^\d{4}-\d{2}-\d{2}$/.test(s));
  }
  function parseColumnBlocks(text){
    const L=text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const i=L.findIndex(s=>s.includes('æ—¥ä»˜'));
    const data=L.slice(i+5);
    const rows=[]; let block={}; let ptr=0;
    for(const line of data){
      if(['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’','å®Œäº†'].includes(line)) continue;
      if(ptr===0){ block={}; block['æ—¥ä»˜']=line; ptr=1; continue; }
      if(ptr===1){ block['ç¨®åˆ¥']=line; ptr=2; continue; }
      if(ptr===2){ block['ç›®æ¨™']=line; ptr=3; continue; }
      if(ptr===3){ block['çµæœ']=line; ptr=4; continue; }
      if(ptr===4){ block['å¾©ç¿’']=line; ptr=5; continue; }
      if(ptr===5){ block['å®Œäº†']=line; rows.push(block); ptr=0; continue; }
    }
    if(ptr!==0){ block['ç›®æ¨™']=block['ç›®æ¨™']??''; block['çµæœ']=block['çµæœ']??''; block['å¾©ç¿’']=block['å¾©ç¿’']??''; rows.push(block); }
    return {header:['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’','å®Œäº†'], rows};
  }
  function importAnyText(text){
    try{ const n=importCsvText(text); if(n>0){ scheduleSave(); return n; } }catch(_){}
    if(looksLikeColumnBlocks(text)){
      if(showAll){ alert('å…¨ç§‘ç›®ã§ã¯å–è¾¼ä¸å¯'); return 0; }
      const parsed=parseColumnBlocks(text);
      let applied=0; const col={date:'æ—¥ä»˜',type:'ç¨®åˆ¥',goal:'ç›®æ¨™',result:'çµæœ',review:'å¾©ç¿’',done:'å®Œäº†'};
      for(const o of parsed.rows){
        const dtk=normalizeDateToken(o[col.date]); if(!dtk) continue;
        if(dtk.y!==year||dtk.mo!==month) continue;
        const ds=ymd(new Date(dtk.y,dtk.mo,dtk.d));
        const rec=rows.find(x=>x.date===ds); if(!rec) continue;
        let t=clean(o[col.type]); if(t==='ä¼‘ã¿') t='ä¼‘æ—¥';
        if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }
        rec.goal=clean(o[col.goal]); rec.result=clean(o[col.result]); rec.review=clean(o[col.review]);
        if(o[col.done]!==undefined && clean(o[col.done])!==''){ rec.color = isTruthy(o[col.done])?'gray':'normal'; }
        persist(rec); applied++;
      }
      if(applied) scheduleSave();
      return applied;
    }
    return 0;
  }

  async function ocrImage(file){
    try{
      const worker=await Tesseract.createWorker('jpn'); const {data:{text}}=await worker.recognize(file);
      await worker.terminate(); return text;
    }catch(e){
      try{ const worker=await Tesseract.createWorker('eng'); const {data:{text}}=await worker.recognize(file); await worker.terminate(); return text; }
      catch(err){ throw e; }
    }
  }

  // Google Sheets å–è¾¼ï¼ˆå…¬é–‹ã‚·ãƒ¼ãƒˆã®CSVï¼‰
  async function importFromSheets(urlOrId){
    try{
      let url=String(urlOrId||'').trim();
      if(!url) return 0;
      if(/^[-\w]{20,}$/.test(url)){ // IDã ã‘
        url=`https://docs.google.com/spreadsheets/d/${url}/export?format=csv`;
      }
      const gidMatch=url.match(/[?&]gid=(\d+)/);
      const hasGid = gidMatch? `&gid=${gidMatch[1]}`:'';
      if(/\/edit(\?|#|$)/.test(url)) url=url.replace(/\/edit.*$/,'')+`/export?format=csv${hasGid}`;
      if(/\/gviz\/tq/.test(url))     url=url.replace(/\/gviz\/tq.*$/,'')+`/export?format=csv${hasGid}`;
      const res=await fetch(url,{mode:'cors'});
      if(!res.ok) throw new Error('fetch failed');
      const csv=await res.text();
      const n=importCsvText(csv);
      if(!n) alert('CSVã¯èª­ã¿è¾¼ã‚ã¾ã—ãŸãŒå½“æœˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return n;
    }catch(_){
      alert('Sheetsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆã‚’ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ã«å…¬é–‹ã€ã«ã—ã€URLã‚’è²¼ã£ã¦ãã ã•ã„ï¼ˆ/export?format=csv ã§ã‚‚å¯ï¼‰ã€‚');
      return 0;
    }
  }

  /* ===== Points aggregation / Ranking ===== */
  function myMonthlyPoints(){
    const base = loadSubjectMonth(subject); // è‡ªåˆ†ã¯é¸æŠç§‘ç›®ã®æœˆåˆè¨ˆ
    let total=0;
    monthDates(year,month).forEach(date=>{
      const r=base.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray' || r.type==='ä¼‘æ—¥'){ total += pointsForType(r.type||'å­¦ç¿’'); }
    });
    return total + getDailyPointsFor($('#displayName').value||'æ©‹æœ¬æ·‘é›…');
  }

  function loadDailyPoints(){ try{ const raw=localStorage.getItem(DP_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; } }
  function saveDailyPoints(obj){ try{ localStorage.setItem(DP_KEY, JSON.stringify(obj)); }catch(_){} }
  function getDailyPointsFor(name){ const all=loadDailyPoints(); const today=ymd(new Date()); return (all[today]?.[name])||0; }
  function addDailyPoints(name, delta){ const all=loadDailyPoints(); const today=ymd(new Date()); if(!all[today]) all[today]={}; all[today][name]=(all[today][name]||0)+delta; saveDailyPoints(all); }

  let lastOrder=[];
  let rankTimer=null, rankSpeedPct=100;

  function seedRand(seed){ let x=seed%2147483647; if(x<=0) x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647; }
  function classmatesMonthlyBase(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    return people.filter(p=>p.name!==meName).map(p=>{
      let sum=0; dates.forEach(()=>{ const r=rnd(); if(r>0.65) sum+=pointsCfg.study; else if(r>0.50) sum+=pointsCfg.review; });
      if(p.name==='æœ›æœˆäºœå¸Œå­') sum += 20 + Math.floor(rnd()*10);
      return {name:p.name, pts:sum};
    });
  }

  const rankGrid=$('#rankGrid');
  function renderRank(){
    if(!rankGrid) return;
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyBase();
    const allDP = loadDailyPoints(); const today=ymd(new Date());
    rivals = rivals.map(p=> ({...p, pts:p.pts + ((allDP[today]?.[p.name])||0)}));
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    rankGrid.innerHTML='';
    const nowOrder = list.map(p=>p.name);

    list.forEach((p,i)=>{
      const was = lastOrder.indexOf(p.name);
      const delta = (was>=0) ? (was - i) : 0;

      const wrap=document.createElement('div'); wrap.className='rank-item';
      if(delta>0) wrap.classList.add('flash-up');
      if(delta<0) wrap.classList.add('flash-down');

      const person = people.find(x=>x.name===p.name) || {profile:{},traits:{}};
      const title = `å¾—æ„:${person.traits?.tokui||'-'} / è‹¦æ‰‹:${person.traits?.nigate||'-'} / æ€§æ ¼:${person.traits?.seikaku||'-'}\nå¹´é½¢:${person.profile?.age??'-'} / æµªæ•°:${person.profile?.ron??0} / ${person.profile?.geneki?'ç¾å½¹':'æ—¢å’'} / ãƒãƒ«ãƒé”æˆç‡:${person.profile?.quota??0}%`;
      wrap.title = title;

      const row=document.createElement('div'); row.className='rank-row';
      row.innerHTML=`<div class="rank-no">${i+1}ä½</div>
        <div class="grow"><strong>${p.name}</strong></div>
        <div>${p.pts} pt</div>`;
      wrap.appendChild(row);

      const editor=document.createElement('div'); editor.className='row small';
      const pr=person.profile||{age:null, ron:0, geneki:true, quota:0};
      editor.innerHTML=`
        <span class="inl">æµªæ•° <input data-name="${p.name}" data-k="ron" class="inp-mini" type="number" min="0" max="10" value="${pr.ron??0}"></span>
        <span class="inl">ç¾å½¹ <select data-name="${p.name}" data-k="geneki" class="sel-mini"><option value="1" ${pr.geneki?'selected':''}>ç¾å½¹</option><option value="0" ${!pr.geneki?'selected':''}>æ—¢å’</option></select></span>
        <span class="inl">å¹´é½¢ <input data-name="${p.name}" data-k="age" class="inp-mini" type="number" min="6" max="99" value="${pr.age??''}"></span>
        <span class="inl">ãƒãƒ«ãƒé”æˆç‡(%) <input data-name="${p.name}" data-k="quota" class="inp-mini" type="number" min="0" max="100" value="${pr.quota??0}"></span>
      `;
      wrap.appendChild(editor);

      rankGrid.appendChild(wrap);
    });
    lastOrder = nowOrder;

    // å³å´ä¸€è¦§
    const ol=$('#rankList'); if(ol){ ol.innerHTML=''; list.forEach((p,i)=>{ const li=document.createElement('li'); li.innerHTML=`<span>${i+1}. ${p.name}</span><span>${p.pts} pt</span>`; ol.appendChild(li); }); }

    const ticker=$('#rankTicker'); if(ticker) ticker.textContent='ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆã€œ18:00ï¼‰ç¨¼åƒä¸­';
  }

  function rankLiveTick(){
    const hour=(new Date()).getHours();
    const ticker=$('#rankTicker');
    if(hour>=18){ if(ticker) ticker.textContent='æœ¬æ—¥ã®ãƒ©ã‚¤ãƒ–åŠ ç‚¹ã¯çµ‚äº†ï¼ˆä»¥é™ã¯ç¿Œæ—¥ã«åæ˜ ï¼‰'; return; }
    const pool = people.filter(p=>p.name!==($('#displayName').value||'æ©‹æœ¬æ·‘é›…'));
    const nChanges= Math.max(1, Math.round(4*rankSpeedPct/100)); // é€Ÿåº¦ã«æ¯”ä¾‹
    for(let i=0;i<nChanges;i++){
      const w=pool.map(x=> (x.profile.quota||0)+10); const sum=w.reduce((a,b)=>a+b,0)||1;
      let r=Math.random()*sum, pick=pool[0];
      for(let j=0;j<pool.length;j++){ if((r-=w[j])<=0){ pick=pool[j]; break; } }
      const isSchoolTime = (hour>=16 && hour<18);
      const delta = isSchoolTime? (Math.random()<0.5? pointsCfg.review:pointsCfg.study) : (Math.random()<0.5? 0:pointsCfg.review);
      if(delta>0) addDailyPoints(pick.name, delta);
    }
    renderRank();
  }
  function startRankTimer(){
    if(rankTimer){ clearInterval(rankTimer); rankTimer=null; }
    const base=30000; // 30ç§’
    const interval = Math.max(3000, Math.round(base * (100/rankSpeedPct))); // é€Ÿã„ã»ã©çŸ­å‘¨æœŸ
    rankTimer=setInterval(rankLiveTick, interval);
  }

  /* ===== Classroom (page2) ===== */
  let classTicker=null; const lastSpokenAt=new Map(); let layoutMode='MFM';
  function factorFromBoost(k){ return 1/(1+Math.max(0,Number(k)||0)/100); }
  function getBoost(){ const v=Number($('#boostInput')?.value)||0; return Math.max(0,v); }
  function visibleDurationMs(){ return Math.round(2600*factorFromBoost(getBoost())); }
  function cooldownMs(){ return Math.max(700,Math.round(visibleDurationMs()*0.9)); }
  function baseTickMs(){ return Math.max(200,Math.round(800*factorFromBoost(getBoost()))); }
  function randomEmissionCount(){ const r=Math.random(); if(r<.15) return 0; if(r<.45) return 1; if(r<.8) return 2; if(r<.96) return 3; return 4; }
  function randomIsYell(){ return Math.random()<0.14; }
  function lineFor(name){
    const me = ($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim();
    const pool=getLinesFor(name);
    const amplified = (name===me)? pool.concat(pool).concat(pool) : pool; // è¡¨ç¤ºåã‚’å¤šã‚ã«
    if(amplified.length===0) return null;
    let msg=amplified[(Math.random()*amplified.length)|0];
    if(msg.length<20) msg = msg + 'ã€‚é›†ä¸­ãŒç¶šã„ã¦ã„ã‚‹ã€ãã®èª¿å­ï¼';
    return msg;
  }

  function arrangeNamesMFM(){
    const males = people.filter(p=>!p.female).map(p=>p.name);
    const females = people.filter(p=>p.female).map(p=>p.name);
    const half=Math.ceil(males.length/2); const col1=males.slice(0,half), col3=males.slice(half), col2=females;
    const rows=Math.max(col1.length,col2.length,col3.length); const arranged=[];
    for(let i=0;i<rows;i++){ if(col1[i]) arranged.push(col1[i]); if(col2[i]) arranged.push(col2[i]); if(col3[i]) arranged.push(col3[i]); }
    return arranged;
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]]; } return a; }
  function buildClassroom(){
    const desks=$('#desks'); if(!desks) return; desks.innerHTML='';
    const order=(layoutMode==='MFM')? arrangeNamesMFM() : shuffle(people.map(p=>p.name));
    order.forEach(name=>{
      const p=people.find(x=>x.name===name); if(!p) return;
      const d=document.createElement('div'); d.className='desk'; d.classList.add(p.female?'female':'male');
      d.innerHTML=`<div class="name">${name}</div><div class="role">${name===($('#displayName').value||'æ©‹æœ¬æ·‘é›…')?'ï¼ˆã‚ãªãŸï¼‰':'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ'}</div><div class="bubble"></div>`;
      d.addEventListener('click',()=> showBubble(d,name));
      desks.appendChild(d);
    });
  }
  function showBubble(deskEl,name){
    const bubble=deskEl.querySelector('.bubble'); if(!bubble) return;
    const msg=lineFor(name); if(msg===null){ bubble.classList.remove('show'); return; }
    const isFamous = (people.find(p=>p.name===name)?.famous) || false;
    bubble.className='bubble'+(isFamous?' famous':'')+(randomIsYell()?' yell':'');
    bubble.textContent = msg;
    bubble.classList.add('show');
    const vms=visibleDurationMs(); setTimeout(()=> bubble.classList.remove('show'), vms);
    lastSpokenAt.set(name, Date.now());
  }
  function tickOnce(){
    const desks = Array.from(document.querySelectorAll('#desks .desk'));
    if(desks.length===0) return;
    const now=Date.now(); const count=randomEmissionCount();
    const candidates=desks
      .map(el=>({el, name:el.querySelector('.name')?.textContent||''}))
      .filter(x=>x.name && (!lastSpokenAt.has(x.name) || (now-(lastSpokenAt.get(x.name)||0)>cooldownMs())))
      .filter(x=> (getLinesFor(x.name).length>0));
    for(let i=0;i<count && candidates.length>0;i++){ const idx=(Math.random()*candidates.length)|0; const pick=candidates.splice(idx,1)[0]; showBubble(pick.el, pick.name); }
  }
  function startClassTicker(){ stopClassTicker(); classTicker=setInterval(tickOnce, baseTickMs()); }
  function stopClassTicker(){ if(classTicker){ clearInterval(classTicker); classTicker=null; } }
  function restartClassTicker(){ stopClassTicker(); startClassTicker(); }

  /* ===== Editor (page4) ===== */
  function renderEditPage(){
    const grid=$('#editGrid'); if(!grid) return; grid.innerHTML='';
    people.forEach((p,i)=>{
      const card=document.createElement('div'); card.className='card';
      const id='ta_'+btoa(unescape(encodeURIComponent(p.name))).replace(/=+/g,'');
      const lines=getLinesFor(p.name); const text=lines.join('\n');
      card.innerHTML=`
        <h4><input class="inp-mini" style="width:14em" value="${escapeHtml(p.name)}"> 
            <label class="small"><input type="checkbox" ${p.female?'checked':''}>å¥³å­</label>
            <label class="small"><input type="checkbox" ${p.famous?'checked':''}>æœ‰å</label>
            <button class="chip btnDel">å‰Šé™¤</button></h4>
        <div class="row small">
          å¹´é½¢ <input class="inp-mini age" type="number" min="6" max="99" value="${p.profile.age??''}">
          æµªæ•° <input class="inp-mini ron" type="number" min="0" max="10" value="${p.profile.ron??0}">
          ç¾å½¹ <select class="sel-mini geneki"><option value="1" ${p.profile.geneki?'selected':''}>ç¾å½¹</option><option value="0" ${!p.profile.geneki?'selected':''}>æ—¢å’</option></select>
          ãƒãƒ«ãƒé”æˆç‡(%) <input class="inp-mini quota" type="number" min="0" max="100" value="${p.profile.quota??0}">
        </div>
        <div class="row small">
          å¾—æ„ <input class="inp-mini tokui" style="width:10em" value="${escapeHtml(p.traits.tokui)}">
          è‹¦æ‰‹ <input class="inp-mini nigate" style="width:10em" value="${escapeHtml(p.traits.nigate)}">
          æ€§æ ¼ <input class="inp-mini seikaku" style="width:12em" value="${escapeHtml(p.traits.seikaku)}">
        </div>
        <textarea id="${id}" placeholder="1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºãªã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆ">${escapeHtml(text)}</textarea>
        <div class="row small">
          <button data-name="${p.name}" class="btnClear chip">ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆç©ºã«ï¼‰</button>
          <span class="muted">ç¾åœ¨ ${lines.length} ä»¶</span>
        </div>`;
      grid.appendChild(card);

      const nameInput=card.querySelector('h4 input'); const chkFemale=card.querySelector('h4 input[type="checkbox"]'); const chkFamous=card.querySelectorAll('h4 input[type="checkbox"]')[1];
      const age=card.querySelector('.age'), ron=card.querySelector('.ron'), geneki=card.querySelector('.geneki'), quota=card.querySelector('.quota');
      const tokui=card.querySelector('.tokui'), nigate=card.querySelector('.nigate'), seikaku=card.querySelector('.seikaku');

      nameInput.addEventListener('change',()=>{
        const newName=(nameInput.value||'').trim(); if(!newName){ nameInput.value=p.name; return; }
        if(people.some((x,ix)=> ix!==i && x.name===newName)){ alert('åŒåãŒæ—¢ã«ã‚ã‚Šã¾ã™'); nameInput.value=p.name; return; }
        customLines[newName]= (customLines[p.name]||[]); delete customLines[p.name];
        p.name=newName; savePeople(); saveCustomLines(); renderEditPage();
      });
      chkFemale.addEventListener('change',()=>{ p.female=chkFemale.checked; savePeople(); });
      chkFamous.addEventListener('change',()=>{ p.famous=chkFamous.checked; savePeople(); });

      const patchProfile=()=>{ p.profile.age=Number(age.value)||null; p.profile.ron=Number(ron.value)||0; p.profile.geneki=geneki.value==='1'; p.profile.quota=Number(quota.value)||0; savePeople(); };
      [age,ron,geneki,quota].forEach(el=> el.addEventListener('change',patchProfile));
      const patchTraits=()=>{ p.traits.tokui=tokui.value||''; p.traits.nigate=nigate.value||''; p.traits.seikaku=seikaku.value||''; savePeople(); };
      [tokui,nigate,seikaku].forEach(el=> el.addEventListener('change',patchTraits));

      const ta=card.querySelector('textarea');
      ta.addEventListener('input',()=>{ const v=String(ta.value||''); const arr=v.split('\n').map(s=>s.trim()).filter(Boolean); customLines[p.name]=arr; scheduleLinesSave(); });

      card.querySelector('.btnClear').addEventListener('click',()=>{ customLines[p.name]=[]; ta.value=''; scheduleLinesSave(); });

      card.querySelector('.btnDel').addEventListener('click',()=>{
        if(!confirm(`ã€Œ${p.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        pushHistory();
        people.splice(i,1); savePeople();
        delete customLines[p.name]; saveCustomLines();
        renderEditPage();
      });
    });
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  $('#addPerson')?.addEventListener('click',()=>{
    const name = prompt('è¿½åŠ ã™ã‚‹äººç‰©å'); if(!name) return;
    if(people.some(p=>p.name===name)){ alert('åŒåãŒæ—¢ã«ã‚ã‚Šã¾ã™'); return; }
    const female = confirm('å¥³å­ã§ã™ã‹ï¼Ÿï¼ˆOK=å¥³å­ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«=ç”·å­ï¼‰');
    const np={ name, female, famous:false, profile:{age:null, ron:0, geneki:true, quota:50}, traits:{tokui:'',nigate:'',seikaku:'ãƒã‚¤ãƒšãƒ¼ã‚¹'} };
    people.push(np); savePeople();
    customLines[name]=makeDefaultLinesFor(np); saveCustomLines();
    renderEditPage();
  });

  // export/import lines
  $('#exportLines')?.addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(customLines, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='class_lines.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  $('#importLinesFile')?.addEventListener('change',async(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{ const txt=await f.text(); const obj=JSON.parse(txt); if(obj && typeof obj==='object'){ pushHistory(); customLines=obj; saveCustomLines(); renderEditPage(); } }
    catch(_){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    e.target.value='';
  });

  /* ===== Timetable (modal) ===== */
  function ttKey(s=subject){ return `${TT_KEY}:${s}`; }
  function loadTT(s=subject){ try{ const raw=localStorage.getItem(ttKey(s)); return raw? JSON.parse(raw): []; }catch(_){ return []; } }
  function saveTT(s=subject, data){ try{ localStorage.setItem(ttKey(s), JSON.stringify(data)); }catch(_){} }
  function renderTimetable(){
    const rowsEl=$('#ttRows'); if(!rowsEl) return; rowsEl.innerHTML=''; const data=loadTT(subject);
    data.forEach((item,idx)=>{
      const row=document.createElement('div'); row.className='tt-row';
      row.innerHTML=`<div><input type="time" value="${item.start||''}"></div>
        <div><input type="time" value="${item.end||''}"></div>
        <div><input type="text" placeholder="ä½•ã‚’ã™ã‚‹ï¼Ÿ" value="${escapeHtml(item.title||'')}"></div>
        <div><span class="linklike" data-act="up">â†‘</span>
            <span class="linklike" data-act="down" style="margin-left:8px">â†“</span>
            <span class="linklike" data-act="del" style="margin-left:8px">å‰Šé™¤</span></div>`;
      const inputs=row.querySelectorAll('input');
      inputs[0].addEventListener('input',()=>{ item.start=inputs[0].value; saveTT(subject,data); });
      inputs[1].addEventListener('input',()=>{ item.end  =inputs[1].value; saveTT(subject,data); });
      inputs[2].addEventListener('input',()=>{ item.title=inputs[2].value; saveTT(subject,data); });
      row.querySelector('[data-act="del"]').addEventListener('click',()=>{ data.splice(idx,1); saveTT(subject,data); renderTimetable(); });
      row.querySelector('[data-act="up"]').addEventListener('click',()=>{ if(idx>0){ const t=data[idx-1]; data[idx-1]=data[idx]; data[idx]=t; saveTT(subject,data); renderTimetable(); }});
      row.querySelector('[data-act="down"]').addEventListener('click',()=>{ if(idx<data.length-1){ const t=data[idx+1]; data[idx+1]=data[idx]; data[idx]=t; saveTT(subject,data); renderTimetable(); }});
      rowsEl.appendChild(row);
    });
  }
  const modal=$('#ttModal');
  $('#ttOpen')?.addEventListener('click',()=>{ modal.classList.add('show'); renderTimetable(); });
  $('#ttClose')?.addEventListener('click',()=> modal.classList.remove('show'));
  modal?.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('show'); });
  $('#ttAddRow')?.addEventListener('click',()=>{ const data=loadTT(subject); data.push({start:'',end:'',title:''}); saveTT(subject,data); renderTimetable(); });

  // 20ææ¡ˆ
  let suggestions=[]; let sugIndex=0;
  function generateSuggestions(){
    const baseStart=new Date(); baseStart.setMinutes(Math.ceil(baseStart.getMinutes()/5)*5,0,0);
    const startHour=Math.max(9, baseStart.getHours()); const endHour=18;
    const dayStart=new Date(); dayStart.setHours(startHour,0,0,0);
    function seedRand(seed){ let x=seed%2147483647; if(x<=0) x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647; }
    function slotsMake(seed){
      const rng=seedRand(seed); const blocks=[]; let t=new Date(dayStart); const subs=[...subjects];
      while(t.getHours()<endHour){
        const dur=[25,30,40,45,50,60][(rng()*6)|0]; const nt=new Date(t.getTime()+dur*60000);
        const s=String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0');
        const e=String(nt.getHours()).padStart(2,'0')+':'+String(nt.getMinutes()).padStart(2,'0');
        const pick=subs[(rng()*subs.length)|0]; const label=(rng()<0.5?'å¾©ç¿’':'å­¦ç¿’')+'ï¼š'+pick;
        blocks.push({start:s,end:e,title:label}); t=new Date(nt.getTime()+ (rng()<0.4?5:10)*60000);
      }
      return blocks.slice(0,9);
    }
    const list=[]; for(let i=0;i<20;i++) list.push(slotsMake(Date.now()+i*97)); return list;
  }
  $('#ttSuggest')?.addEventListener('click',()=>{ suggestions=generateSuggestions(); sugIndex=0; $('#ttSuggestBar').style.display='flex'; previewSuggestion(); });
  function previewSuggestion(){ const data=suggestions[sugIndex]||[]; const rowsEl=$('#ttRows'); rowsEl.innerHTML=''; data.forEach(item=>{ const row=document.createElement('div'); row.className='tt-row'; row.innerHTML=`<div>${item.start}</div><div>${item.end}</div><div>${escapeHtml(item.title)}</div><div class="muted">ææ¡ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>`; rowsEl.appendChild(row); }); $('#ttIndex').textContent=`${sugIndex+1} / ${suggestions.length}`; }
  $('#ttPrev')?.addEventListener('click',()=>{ if(sugIndex>0){ sugIndex--; previewSuggestion(); }});
  $('#ttNext')?.addEventListener('click',()=>{ if(suggestions && sugIndex<suggestions.length-1){ sugIndex++; previewSuggestion(); }});
  $('#ttApply')?.addEventListener('click',()=>{ const data=suggestions[sugIndex]||[]; saveTT(subject,data); renderTimetable(); alert('ææ¡ˆã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã“ã“ã‹ã‚‰ç·¨é›†ã§ãã¾ã™ã€‚'); });

  /* ===== Events ===== */
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY);
    const me = saved || 'æ©‹æœ¬æ·‘é›…';
    $('#displayName').value = me;
    $('#meOnBoard') && ($('#meOnBoard').textContent = me);
    if(!customLines[me] || customLines[me].length<20){
      customLines[me]=[
        `${me}ã•ã‚“ã€ä»Šæ—¥ã®ãƒãƒ«ãƒæ¶ˆåŒ–ãŒè¨ˆç”»é€šã‚Šã§ç´ æ™´ã‚‰ã—ã„ã€‚è‡ªåˆ†ã§è‡ªåˆ†ã‚’å‰ã«é€²ã‚ã¦ã‚‹ï¼`,
        `${me}ã•ã‚“ã®è§£ç­”ãƒ—ãƒ­ã‚»ã‚¹ãŒæ˜ç¢ºã§ã€æ­£è§£ã ã‘ã§ãªãå†ç¾æ€§ã¾ã§èº«ã«ã¤ã„ã¦ã„ã‚‹ã€‚`,
        `é›†ä¸­ã®å…¥ã‚ŠãŒé€Ÿã„${me}ã•ã‚“ã€çŸ­æ™‚é–“ã§ã‚‚å¯†åº¦ãŒé«˜ã„ã‹ã‚‰æˆæœãŒå¤§ãã„ã€‚`,
        `ãƒŸã‚¹ã®ç†ç”±ã‚’è¨€èªåŒ–ã§ãã¦ã„ã‚‹${me}ã•ã‚“ã€æ¬¡ã«åŒã˜æ‰€ã§æ­¢ã¾ã‚‰ãªã„ã®ãŒå¼·ã¿ã€‚`,
        `ä¼‘ã‚€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´ã§ãã‚‹${me}ã•ã‚“ã€ä½“åŠ›ç®¡ç†ãŒä¸Šæ‰‹ã§é•·è·é›¢æˆ¦ã«å¼·ã„ã€‚`,
        `${me}ã•ã‚“ã€æ˜¨æ—¥ã‚ˆã‚Š1å•å¤šãæŒ‘æˆ¦ã§ããŸäº‹å®ŸãŒã€ç¢ºå®Ÿãªä¼¸ã³ã‚’ç‰©èªã£ã¦ã„ã‚‹ã€‚`,
        `å­¦ç¿’ãƒ­ã‚°ã®ç²’åº¦ãŒç´°ã‹ã„${me}ã•ã‚“ã€æ”¹å–„ã®æ ¹æ‹ ãŒã‚ã‚‹ã‹ã‚‰ä¼¸ã³ãŒé€Ÿã„ã€‚`,
        `éŸ³èª­ãƒ»æ›¸ãå‡ºã—ãƒ»å£é ­èª¬æ˜ã®ä½¿ã„åˆ†ã‘ãŒçµ¶å¦™ã€ç†è§£ãŒç«‹ä½“çš„ã«ãªã£ã¦ã„ã‚‹ã‚ˆã€‚`,
        `${me}ã•ã‚“ã®ä¸å¯§ãªè¦‹ç›´ã—ã€ã‚±ã‚¢ãƒ¬ã‚¹ã‚’ç‚¹ã«æ›ãˆã‚‹ä¸Šç­‰ãªç¿’æ…£ã ã­ã€‚`,
        `è‹¦æ‰‹åˆ†é‡ã«ã‚‚çœŸæ­£é¢ã‹ã‚‰å‘ãåˆã†å§¿å‹¢ãŒå°Šã„ã€‚ãã®å‹‡æ°—ãŒå®ŸåŠ›ã«ãªã‚‹ã€‚`,
        `æ™‚é–“é…åˆ†ã®ä¿®æ­£ãŒçš„ç¢ºã€ä½™è£•ã‚’ä½œã‚‹åˆ¤æ–­ãŒã§ãã‚‹ã®ã¯ã™ã§ã«å¼·è€…ã®è¨¼ã€‚`,
        `${me}ã•ã‚“ã€æ¯æ—¥ã®å°ã•ãªå®Œäº†ãŒé€£ãªã£ã¦ã€ç¢ºã‹ãªè‡ªä¿¡ã«ãªã£ã¦ããŸã­ã€‚`,
        `ä¼¼ãŸå•é¡Œã®å·®ã‚’è¦‹æŠœã‘ã‚‹è¦³å¯Ÿçœ¼ãŒé‹­ã„ã€‚å¾—ç‚¹åŠ›ã®æºã ã‚ˆã€‚`,
        `ã‚ã‹ã‚‰ãªã„ã‚’æ®‹ã•ãšãƒ¡ãƒ¢ã¸é€ã‚‹é‹ç”¨ã€ç¿Œæ—¥ã®è‡ªåˆ†ã¸ã®æœ€é«˜ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã€‚`,
        `æ•™æã®é¸åˆ¥ãŒã†ã¾ã„${me}ã•ã‚“ã€å¿…è¦ãªè² è·ã ã‘ã‚’ç¢ºå®Ÿã«ç©ã‚ã¦ã„ã‚‹ã€‚`,
        `ä»Šæ—¥ã®å§¿å‹¢ã¨è¦–ç·šãŒå‹è€…ã®ãã‚Œã€‚é›†ä¸­ã®è³ªãŒæ®µé•ã„ã«è‰¯ã„ã€‚`,
        `${me}ã•ã‚“ã®ãƒšãƒ¼ã‚¹é…åˆ†ã€é•·ã„æ™‚é–“ã§ã‚‚ãƒãƒ†ãšã«è³ªãŒè½ã¡ãªã„ã®ãŒæœ¬å½“ã«ã™ã”ã„ã€‚`,
        `å°‘ã—ãšã¤ã®å‰é€²ã‚’ç©ã‚€å¿è€åŠ›ã€ãã‚ŒãŒé›£é–¢ã‚’æŠœã‘ã‚‹å”¯ä¸€ã®é“ã€‚å›ã¯æ­©ã‘ã¦ã‚‹ã€‚`,
        `ã§ããŸã®åŸºæº–ãŒé«˜ããªã£ã¦ã„ã‚‹ã€‚ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã®è¨¼æ‹ ã ã‚ˆã€‚`,
        `ä»Šæ—¥ã“ã“ã¾ã§ç©ã¿é‡ã­ãŸ${me}ã•ã‚“ã€èƒ¸ã‚’å¼µã£ã¦ã„ã„ã€‚æ¬¡ã®ä¸€æ­©ã‚‚ä¸€ç·’ã«ã„ã“ã†ã€‚`
      ];
      saveCustomLines();
    }
  })();
  $('#saveName')?.addEventListener('click',()=>{
    const me = ($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim();
    localStorage.setItem(NAME_KEY, me);
    $('#meOnBoard') && ($('#meOnBoard').textContent = me);
    if(!customLines[me] || customLines[me].length<20){ customLines[me]=makeDefaultLinesFor({name:me,traits:{},profile:{}}); saveCustomLines(); }
    renderRank();
  });

  // Tabs
  $('#tabProgress')?.addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass')?.addEventListener('click',()=>showPage('class'));
  $('#tabRank')?.addEventListener('click',()=>showPage('rank'));
  $('#tabEdit')?.addEventListener('click',()=>showPage('edit'));
  function setActiveTab(a,b,c,d){ $('#tabProgress').classList.toggle('active',a); $('#tabClass').classList.toggle('active',b); $('#tabRank').classList.toggle('active',c); $('#tabEdit').classList.toggle('active',d); }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit']);
    const show=(a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); stopClassTicker(); renderProgress(); }
    if(which==='class'){ show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); buildClassroom(); restartClassTicker(); }
    if(which==='rank'){ show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); stopClassTicker(); renderRank(); startRankTimer(); }
    if(which==='edit'){ show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); stopClassTicker(); renderEditPage(); }
  }

  // æœˆç§»å‹•
  $('#prev')?.addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} reloadRows(); renderProgress(); renderRank(); });
  $('#next')?.addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} reloadRows(); renderProgress(); renderRank(); });

  // ä¿å­˜/èª­è¾¼ï¼ˆèª­è¾¼ï¼ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®å†èª­è¾¼ï¼‰
  $('#save')?.addEventListener('click',()=>{ pushHistory(); flushAutoSave(); renderProgress(); renderRank(); alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); setTimeout(scrollTodayIntoView,0); });
  $('#load')?.addEventListener('click',()=>{ const ok=reloadRows(); renderProgress(); renderRank(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // å–è¾¼UI
  $('#btnPasteImport')?.addEventListener('click',()=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
    const text=prompt('CSV/TSV/è¡¨ã®åˆ—ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆåˆ—: æ—¥ä»˜, ç¨®åˆ¥, ç›®æ¨™, çµæœ, å¾©ç¿’, å®Œäº†â€»ä»»æ„ï¼‰');
    if(!text) return;
    pushHistory(); const n=importAnyText(text); renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  });
  $('#fileImport')?.addEventListener('change',async (e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ã§ã¯å–è¾¼ä¸å¯'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
    pushHistory(); const n=importAnyText(txt); renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); e.target.value='';
  });
  $('#btnSheetsImport')?.addEventListener('click',async()=>{
    if(showAll){ alert('å…¨ç§‘ç›®ã§ã¯å–è¾¼ä¸å¯'); return; }
    const url=prompt('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã¾ãŸã¯IDï¼ˆâ€»å…¬é–‹è¨­å®šã«ã—ã¦ãã ã•ã„ï¼‰');
    if(!url) return;
    pushHistory(); const n=await importFromSheets(url); renderProgress(); renderRank();
    if(n) alert(`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`);
  });

  // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ
  $('#toggleCompact')?.addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  // Undo/Redo/å…¨å‰Šé™¤
  $('#undoP')?.addEventListener('click',()=>{ undo(); setTimeout(scrollTodayIntoView,0); });
  $('#undoC')?.addEventListener('click',()=>{ undo(); });
  $('#undoT')?.addEventListener('click',()=>{ undo(); });
  $('#undoS')?.addEventListener('click',()=>{ undo(); });

  $('#redoP')?.addEventListener('click',()=>{ redo(); setTimeout(scrollTodayIntoView,0); });
  $('#redoC')?.addEventListener('click',()=>{ redo(); });
  $('#redoT')?.addEventListener('click',()=>{ redo(); });
  $('#redoS')?.addEventListener('click',()=>{ redo(); });

  $('#wipeP')?.addEventListener('click',()=>{ if(confirm((showAll?'å…¨ç§‘ç›®ã®ä»Šæœˆè¡Œã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚':'å½“æœˆã®é€²æ—ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚')+'\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ pushHistory(); if(showAll){ subjects.forEach(sub=>{ const arr=loadSubjectMonth(sub); monthDates(year,month).forEach(ds=>{ const r=arr.find(x=>x.date===ds); if(r){ r.type='å­¦ç¿’'; r.color='normal'; } }); doSaveToLocal(sub,arr); }); } else { rows.forEach(r=>{ r.type='å­¦ç¿’'; r.color='normal'; }); scheduleSave(); } renderProgress(); renderRank(); } });
  $('#wipeC')?.addEventListener('click',()=>{ if(confirm('Cãƒšãƒ¼ã‚¸ã®ç™ºè©±çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ lastSpokenAt.clear(); buildClassroom(); } });
  $('#wipeT')?.addEventListener('click',()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ')){ renderRank(); } });

  // ğŸ¹ï¼ãƒ›ãƒ¼ãƒ ï¼†ä»Šæ—¥ã¸ï¼ˆå…¨ãƒšãƒ¼ã‚¸ã§1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã™ï¼‰
  $('#fabHome')?.addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });

  // Rï¼å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹ï¼‰
  $('#reloadBtn')?.addEventListener('click',()=>{ const url = location.pathname + '?r=' + Date.now() + '&v=' + VER; location.replace(url); });

  // Boostï¼ˆ2ãƒšãƒ¼ã‚¸ï¼‰
  (function initBoost(){
    const saved=localStorage.getItem(BOOST_KEY);
    const v=saved?Number(saved):0;
    const input=$('#boostInput'); if(input){ input.value=String(isFinite(v)?v:0); updateBoostHint(); }
  })();
  function updateBoostHint(){ const v=getBoost(); const h=$('#boostHint'); if(h) h.textContent=`ï¼ˆç¾åœ¨: ${v}%å¢—ã— / é–“éš”ã¨å¹ãå‡ºã—æ™‚é–“ã‚’çŸ­ç¸®ï¼‰`; }
  $('#applyBoost')?.addEventListener('click',()=>{ const v=getBoost(); localStorage.setItem(BOOST_KEY,String(v)); updateBoostHint(); restartClassTicker(); });
  $('#boostInput')?.addEventListener('change',()=>{ const v=getBoost(); localStorage.setItem(BOOST_KEY,String(v)); updateBoostHint(); restartClassTicker(); });

  // å…¨ç§‘ç›®ãƒœã‚¿ãƒ³
  function highlightAllToggle(){ const icon=$('#allIcon'); const btn=$('#toggleAllBtn'); if(icon) icon.textContent = showAll? 'ğŸ“–':'ğŸ“š'; if(btn) btn.classList.toggle('active', showAll); }
  $('#toggleAllBtn')?.addEventListener('click',()=>{ pushHistory(); showAll=!showAll; reloadRows(); renderProgress(); highlightAllToggle(); });

  // ç§‘ç›®/è‰²
  const PRESETS={ redsox:{hex:'#BD3039',tint:20}, bluejays:{hex:'#134A8E',tint:20}, dodgers:{hex:'#005A9C',tint:18}, nl:{hex:'#13274F',tint:18} };
  document.querySelectorAll('.preset').forEach(btn=> btn.addEventListener('click',()=>{ const p=PRESETS[btn.dataset.preset]; const cp=$('#colorPicker'); const tr=$('#tintRange'); if(cp) cp.value=p.hex; if(tr) tr.value=p.tint; }));
  $('#applyColor')?.addEventListener('click',()=>{ const cp=$('#colorPicker'); const tr=$('#tintRange'); if(!cp||!tr) return; const hex=(cp.value||'').trim(); const tint=+tr.value||20; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXã‚«ãƒ©ãƒ¼ã‚’ #RRGGBB ã§å…¥åŠ›'); return; } const hx=hex.startsWith('#')?hex:('#'+hex); subjectColors[subject]={hex:hx,tint:Math.max(0,Math.min(95,tint))}; saveSubjectColors(); renderProgress(); });
  $('#applyDoneColor')?.addEventListener('click',()=>{ const cp=$('#doneColorPicker'); const tr=$('#doneTintRange'); if(!cp||!tr) return; const hex=(cp.value||'').trim()||doneColor.hex; const tint=+tr.value||doneColor.tint; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXã‚«ãƒ©ãƒ¼ã‚’ #RRGGBB ã§å…¥åŠ›'); return; } doneColor={hex:hex.startsWith('#')?hex:('#'+hex), tint:Math.max(10,Math.min(95,tint))}; saveDoneColor(); renderProgress(); });

  // ãƒã‚¤ãƒ³ãƒˆè¨­å®š
  function updateRuleNumbers(){ const rs=$('#ruleStudy'), rr=$('#ruleReview'), rh=$('#ruleHoliday'); if(rs) rs.textContent=pointsCfg.study; if(rr) rr.textContent=pointsCfg.review; if(rh) rh.textContent=pointsCfg.holiday; }
  $('#applyPts')?.addEventListener('click',()=>{ const ps=$('#ptStudy'), pr=$('#ptReview'), ph=$('#ptHoliday'); pointsCfg={ study:+(ps?.value||10), review:+(pr?.value||6), holiday:+(ph?.value||0) }; savePoints(); updateRuleNumbers(); renderRank(); });

  // ãƒ©ãƒ³ã‚¯é€Ÿåº¦
  $('#rankSpeed')?.addEventListener('change',()=>{ const v=Number($('#rankSpeed').value)||100; rankSpeedPct=Math.max(10,Math.min(300,v)); startRankTimer(); });

  // å¸­æ›¿ãˆ/ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  let randomLayout=false;
  $('#shuffleSeat')?.addEventListener('click',()=>{ randomLayout=true; layoutMode='RANDOM'; buildClassroom(); });
  $('#toggleLayout')?.addEventListener('click',()=>{ layoutMode = (layoutMode==='MFM'?'RANDOM':'MFM'); buildClassroom(); });

  // ç§‘ç›®é¸æŠ
  $('#addSubject')?.addEventListener('click',()=>{ const name=prompt('è¿½åŠ ã™ã‚‹ç§‘ç›®åï¼ˆä¾‹ï¼šè‹±èªï¼‰'); if(!name) return; const trimmed=name.trim(); if(!trimmed) return; if(subjects.includes(trimmed)){ alert('ãã®ç§‘ç›®ã¯ã™ã§ã«ã‚ã‚Šã¾ã™'); return; } subjects.push(trimmed); saveSubjects(); renderSubjectSelect(); subject=trimmed; showAll=false; reloadRows(); renderProgress(); });
  $('#subjectSelect')?.addEventListener('change',e=>{ pushHistory(); subject=e.target.value; showAll=false; reloadRows(); renderProgress(); });

  /* ===== Init ===== */
  function renderAll(){
    $('#verTag') && ($('#verTag').textContent = VER);
    renderSubjectSelect(); highlightAllToggle();
    const p1=$('#pageProgress')?.style.display!=='none';
    const p2=$('#pageClass')?.style.display!=='none';
    const p3=$('#pageRank')?.style.display!=='none';
    const p4=$('#pageEdit')?.style.display!=='none';
    if(p1) renderProgress();
    if(p2){ buildClassroom(); restartClassTicker(); }
    if(p3){ renderRank(); startRankTimer(); }
    if(p4) renderEditPage();
    const theme=colorFor(subject); const cp=$('#colorPicker'), tr=$('#tintRange'); if(cp) cp.value=theme.hex; if(tr) tr.value=theme.tint;
    const dcp=$('#doneColorPicker'), dtr=$('#doneTintRange'); if(dcp) dcp.value=doneColor.hex; if(dtr) dtr.value=doneColor.tint;
    const ps=$('#ptStudy'), pr=$('#ptReview'), ph=$('#ptHoliday'); if(ps) ps.value=pointsCfg.study; if(pr) pr.value=pointsCfg.review; if(ph) ph.value=pointsCfg.holiday;
    setSavedNow(); updateRuleNumbers();
  }
  (function init(){ reloadRows(); renderAll(); document.body.classList.add('compact'); setTimeout(scrollTodayIntoView,0); })();

})();
</script>
</body>
</html>
