<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆä¸€è¦§ï¼‹é †ä½è¡¨</title>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C;      /* æœ¬æ—¥ï¼šãƒ‰ã‚¸ãƒ£ãƒ¼ã‚¹ãƒ–ãƒ«ãƒ¼ */
    --today-text:#ffffff;    /* æœ¬æ—¥ æ–‡å­—è‰² */
    --row-gray-bg:#b0a89f;   /* å®Œäº†ï¼šã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢ãƒ³ç° */
    --row-gray-text:#000000; /* å®Œäº† æ–‡å­—è‰² */
    --header-bg:#ffffff;
    --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0;padding:14px;
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;
    color:#111827;background:#fff
  }
  h1{margin:0 0 12px;font-size:18px}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  button,select,input[type="text"]{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px
  }
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:14px
  }

  .layout{
    display:grid;gap:12px;grid-template-columns:1fr;align-items:start;
  }
  @media(min-width:980px){
    .layout{grid-template-columns: minmax(0,1fr) 320px;}
  }

  .tbl{
    width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:82vh;
  }
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:12px;color:var(--muted);
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);backdrop-filter:saturate(1.1);
  }
  td.padL{padding-left:22px}
  td.small{width:120px}
  td.medium{width:180px}

  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.manual-gray td{background:var(--row-gray-bg)!important;color:var(--row-gray-text)!important}

  .card{
    border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff
  }
  .card h3{margin:0 0 8px;font-size:15px}
  .lb-row{
    display:flex;align-items:center;justify-content:space-between;
    padding:8px;border-bottom:1px dashed var(--line)
  }
  .lb-row:last-child{border-bottom:none}
  .me{background:#eef2ff;border-radius:8px}
  .name{display:flex;gap:8px;align-items:center}
  .rank{width:26px;text-align:center;font-weight:700}
  .pts{font-variant-numeric:tabular-nums}
  .chip{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#374151}
  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;-webkit-user-select:none
  }
  .fab:hover{transform:translateY(-1px)} .fab:active{transform:translateY(0)}
  .fab-top-right{right:14px;top:14px} .fab-bottom-right{right:14px;bottom:14px}
  .fab span{font-size:22px;line-height:1}
</style>
</head>
<body>
  <h1>å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼é †ä½ã¤ãï¼‰</h1>
  <div class="bar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆè‡ªåˆ†ã®åå‰ï¼‰" style="min-width:200px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¸€åº¦å…¥ã‚Œã‚‹ã¨ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™</span>
  </div>
  <div class="bar">
    <button id="prev" class="primary">â—€ å‰æœˆ</button>
    <div id="label" class="muted"></div>
    <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
    <button id="todayBtn">âŸ³ ä»Šæ—¥ã¸</button>
    <button id="save">ğŸ’¾ ä¿å­˜</button>
    <button id="load">ğŸ“¥ èª­è¾¼</button>
  </div>
  <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

  <div class="layout">
    <!-- å·¦ï¼šè¨ˆç”»è¡¨ -->
    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr>
            <th class="medium">æ—¥ä»˜</th>
            <th class="small padL">ç¨®åˆ¥</th>
            <th class="medium padL">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
            <th class="medium padL">çµæœ</th>
            <th class="medium padL">å¾©ç¿’</th>
            <th class="small padL">è‰²</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- å³ï¼šé †ä½è¡¨ -->
    <aside class="card">
      <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
      <div id="leaderboard"></div>
      <div style="margin-top:8px" class="muted">
        ãƒ«ãƒ¼ãƒ«ï¼š<span class="chip">å®Œäº†=+10</span>ã€<span class="chip">å¾©ç¿’+å®Œäº†=+6</span>ã€ä¼‘æ—¥=0ã€‚<br>
        ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆã¯æ—¥æ›¿ã‚ã‚Šã§è‡ªå‹•ã‚¹ã‚³ã‚¢ï¼ˆãƒãƒ¼ãƒˆãªã—ï¼‰ã€‚
      </div>
    </aside>
  </div>

  <!-- å³ä¸Šï¼šãƒãƒƒãƒˆï¼å³ä¸‹ï¼šãƒœãƒ¼ãƒ« -->
  <button class="fab fab-top-right" id="fabTop" title="ä»Šæ—¥ã¸"><span>ğŸ¦¾</span></button>
  <button class="fab fab-bottom-right" id="fabBottom" title="ä»Šæ—¥ã¸"><span>âš¾ï¸</span></button>

<script>
(function(){
  'use strict';
  const KEY='studyplanner.month.form.v5.leader';
  const NAME_KEY='studyplanner.displayName';

  // æœˆåˆ‡æ›¿
  let year, month; // 0-11
  const now=new Date(); year=now.getFullYear(); month=now.getMonth();

  // ãƒ¢ãƒ‡ãƒ«ï¼šdate(YYYY-MM-DD), type('å­¦ç¿’'|'ä¼‘æ—¥'|'å¾©ç¿’'), goal, result, review, color('normal'|'gray')
  let rows=[];

  // è‡ªåˆ†ã®è¡¨ç¤ºå
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};

  // ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆï¼ˆå›ºå®šã®é¡”ã¶ã‚Œï¼‰
  const classmates = [
    'ä½è—¤', 'éˆ´æœ¨', 'ç”°ä¸­', 'é«˜æ©‹', 'ä¼Šè—¤'
  ];

  // æ“¬ä¼¼ä¹±æ•°ï¼ˆåŒã˜æœˆã¯åŒã˜çµæœã«ãªã‚‹ã‚ˆã†ã«ï¼‰
  function seedRand(seed){
    let x = seed % 2147483647; if (x <= 0) x += 2147483646;
    return ()=> (x = x * 16807 % 2147483647) / 2147483647;
  }

  function monthDates(y,m){
    const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[];
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d));
    return arr;
  }

  function ensureScaffold(){
    const need=new Set(monthDates(year,month));
    const have=new Set(rows.map(r=>r.date));
    need.forEach(d=>{
      if(!have.has(d)){
        rows.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'});
      }
    });
    rows.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function save(){
    try{
      const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
      const data=rows.filter(r=>fromYmd(r.date).getMonth()===month && fromYmd(r.date).getFullYear()===year);
      localStorage.setItem(key, JSON.stringify(data));
      alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰');
      renderLeaderboard(); // ä¿å­˜ã®ãŸã³ã«é †ä½å†è¨ˆç®—
    }catch(e){}
  }

  function load(){
    const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
    const raw=localStorage.getItem(key);
    if(!raw) return false;
    try{
      const data=JSON.parse(raw)||[];
      const map=new Map(rows.map(r=>[r.date,r]));
      data.forEach(d=>map.set(d.date, d));
      rows=[...map.values()];
      return true;
    }catch(e){ return false; }
  }

  function myMonthlyPoints(){
    // ã€Œå®Œäº†(gray)ã€ã®æ—¥ãŒ+10ã€‚type=å¾©ç¿’ ã‹ã¤ å®Œäº† ã¯ +6 ã¨ã™ã‚‹ã€‚
    let total = 0;
    monthDates(year,month).forEach(date=>{
      const r = rows.find(x=>x.date===date);
      if(!r) return;
      if(r.color==='gray'){ // å®Œäº†
        if(r.type==='å¾©ç¿’') total += 6;
        else if(r.type==='å­¦ç¿’') total += 10;
        // ä¼‘æ—¥ã¯å®Œäº†ã«ã—ãªã„å‰æã ãŒã€ã—ã¦ã‚‚0æ‰±ã„ã«ã—ãŸã„å ´åˆã¯ã“ã“ã§åˆ†å²
      }
    });
    return total;
  }

  function classmatesMonthlyPoints(){
    // æœˆ(YYYYMM) ã‚’ã‚·ãƒ¼ãƒ‰ã«ã—ã¦ã€å„æ—¥å°‘ã—ã¶ã‚Œã‚‹ç‚¹æ•°ã‚’ä¸ãˆã‚‹
    const seed = parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd = seedRand(seed);
    const dates = monthDates(year,month);
    return classmates.map(name=>{
      let sum=0;
      dates.forEach(d=>{
        const r = rnd();
        // ãã®æ—¥ã‚„ã‚‹æ°—ï¼š0ã€œ1 â†’ 0.35ä»¥ä¸Šã®ã¨ãå‹‰å¼·ã€å­¦ç¿’ or å¾©ç¿’ã‚’åˆ¤å®š
        if(r > 0.65) sum += 10;        // ã—ã£ã‹ã‚Šå­¦ç¿’
        else if(r > 0.50) sum += 6;    // å¾©ç¿’
        // else 0ï¼ˆä¼‘ã‚€ï¼‰
      });
      return { name, pts: sum };
    });
  }

  function renderLeaderboard(){
    const meName = ($('#displayName').value || 'ã‚ãªãŸ').trim();
    const mePts = myMonthlyPoints();
    const rivals = classmatesMonthlyPoints();
    const list = [...rivals, {name: meName, pts: mePts, me:true}];
    list.sort((a,b)=> b.pts - a.pts);

    const box = $('#leaderboard'); box.innerHTML='';
    list.forEach((p, idx)=>{
      const row = document.createElement('div');
      row.className = 'lb-row' + (p.me ? ' me' : '');
      row.innerHTML = `
        <div class="name">
          <span class="rank">${idx+1}</span>
          <strong>${p.name}</strong>
        </div>
        <div class="pts">${p.pts} pt</div>
      `;
      box.appendChild(row);
    });
  }

  function render(){
    ensureScaffold();
    $('#label').textContent=`${year}å¹´${month+1}æœˆï¼ˆ${monthDates(year,month).length}æ—¥ï¼‰`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    monthDates(year,month).forEach(date=>{
      const r = rows.find(x=>x.date===date) || {date, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'};
      const tr=document.createElement('tr');

      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(date===todayStr) tr.classList.add('today');

      const tdDate=document.createElement('td');
      tdDate.className='medium';
      tdDate.textContent = jpDateLabel(date);

      const tdType=document.createElement('td'); tdType.className='small padL';
      const selType=document.createElement('select');
      ['å­¦ç¿’','ä¼‘æ—¥','å¾©ç¿’'].forEach(opt=>{
        const o=document.createElement('option'); o.value=opt; o.textContent = opt;
        if((r.type||'å­¦ç¿’')===opt) o.selected=true;
        selType.appendChild(o);
      });
      selType.addEventListener('change',e=>{
        r.type=e.target.value; render(); persist(r);
      });
      tdType.appendChild(selType);

      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24';
      inGoal.value=r.goal||''; inGoal.disabled = (r.type==='ä¼‘æ—¥');
      inGoal.addEventListener('input',e=>{ r.goal=e.target.value; persist(r); });
      tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾';
      inRes.value=r.result||''; inRes.disabled = (r.type==='ä¼‘æ—¥');
      inRes.addEventListener('input',e=>{ r.result=e.target.value; persist(r); });
      tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²';
      inRev.value=r.review||''; inRev.disabled = (r.type==='ä¼‘æ—¥');
      inRev.addEventListener('input',e=>{ r.review=e.target.value; persist(r); });
      tdRev.appendChild(inRev);

      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'é€šå¸¸'}, {v:'gray',t:'å®Œäº†'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{
        r.color=e.target.value; render(); persist(r); renderLeaderboard();
      });
      tdClr.appendChild(selClr);

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdClr);
      tb.appendChild(tr);
    });

    const t = new Date();
    $('#todayBanner').textContent = `æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;
    renderLeaderboard();
  }

  function persist(rec){
    const i=rows.findIndex(x=>x.date===rec.date);
    if(i>=0) rows[i]=rec; else rows.push(rec);
  }

  function scrollTodayIntoView(){
    const scroller = $('#scroller');
    const thead = scroller.querySelector('thead');
    const todayRow = scroller.querySelector('tr.today') || scroller.querySelector('tbody tr');
    if(!todayRow) return;
    const headerH = thead.getBoundingClientRect().height;
    const rowTop = todayRow.offsetTop;
    scroller.scrollTo({ top: Math.max(0, rowTop - headerH - 4), behavior: 'smooth' });
  }

  // åå‰èª­ã¿è¾¼ã¿
  (function initName(){
    const saved = localStorage.getItem(NAME_KEY);
    if(saved) $('#displayName').value = saved;
  })();

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  $('#saveName').addEventListener('click',()=>{ localStorage.setItem(NAME_KEY, ($('#displayName').value||'ã‚ãªãŸ').trim()); renderLeaderboard(); });
  $('#prev').addEventListener('click',()=>{ month-=1; if(month<0){month=11;year-=1;} load(); render(); setTimeout(scrollTodayIntoView, 50); });
  $('#next').addEventListener('click',()=>{ month+=1; if(month>11){month=0;year+=1;} load(); render(); setTimeout(scrollTodayIntoView, 50); });
  $('#save').addEventListener('click',save);
  $('#load').addEventListener('click',()=>{ const ok=load(); render(); setTimeout(scrollTodayIntoView, 50); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });
  $('#todayBtn').addEventListener('click',scrollTodayIntoView);
  $('#fabTop').addEventListener('click',scrollTodayIntoView);
  $('#fabBottom').addEventListener('click',scrollTodayIntoView);

  // åˆæœŸæç”»
  load(); render();
  window.addEventListener('load', ()=> setTimeout(scrollTodayIntoView, 80));
})();
</script>
</body>
</html>
