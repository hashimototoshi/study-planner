<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner – 月間進捗＋C(🏫)＋T(🏆)</title>

<!-- 画像OCR（iPad完結） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --row-gray-bg:#b0a89f; --row-gray-text:#000000;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;

    --male:#2563eb;        /* 男性=青 */
    --female:#f97316;      /* 女性=オレンジ */

    --board:#0f3b3f; --board-frame:#2f4f4f; --desk:#ffffff; --room:#f7fafc;

    --bubble-gen-bg:#f4f8ff;   --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec;   --bubble-fam-bd:#ffe5ad;

    --scale: 1; /* 一覧スケール（1=標準, 0.72=詰め）*/
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:0.72;}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale))}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"]{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  /* ページ操作（進む/戻る） */
  .pager{display:flex;gap:8px;align-items:center;margin:6px 0 6px}

  /* 今日バナー */
  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  /* 表（進捗） */
  .tbl{
    width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;
    max-height:calc(84vh*var(--scale));
  }
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:calc(8px*var(--scale));border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:calc(12px*var(--scale));color:var(--muted);
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);backdrop-filter:saturate(1.1);
  }
  td.padL{padding-left:calc(14px*var(--scale))}
  td.small{width:calc(110px*var(--scale))}
  td.medium{width:calc(160px*var(--scale))}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.manual-gray td{background:var(--row-gray-bg)!important;color:var(--row-gray-text)!important}

  .type-wrap{display:flex;align-items:center;gap:8px}
  .type-badge{font-weight:700}
  .type-toggle{
    padding:calc(4px*var(--scale)) calc(8px*var(--scale));
    border:1px solid var(--line);border-radius:10px;background:#fff;
    font-size:calc(12px*var(--scale));cursor:pointer
  }

  /* 右下：ホームへ(🐹) */
  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;-webkit-user-select:none;
    right:14px;bottom:14px
  }
  .fab:hover{transform:translateY(-1px)} .fab:active{transform:translateY(0)}
  .fab span{font-size:22px;line-height:1}

  /* C：教室ページ */
  .blackboard{border-radius:10px;border:2px solid var(--board-frame);background:var(--board);color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:12px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}

  .bubble{
    position:absolute;left:8px;right:8px;top:8px;
    border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:8px 10px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);
    display:none;max-width:unset;white-space:pre-line
  }
  .bubble::after{content:"";position:absolute;left:22px;bottom:-10px;border-width:10px 10px 0 10px;border-style:solid;border-color:var(--bubble-gen-bd) transparent transparent transparent}
  .bubble::before{content:"";position:absolute;left:22px;bottom:-9px;border-width:9px 9px 0 9px;border-style:solid;border-color:var(--bubble-gen-bg) transparent transparent transparent}
  .bubble.famous{background:var(--bubble-fam-bg);border-color:var(--bubble-fam-bd)}
  .bubble.famous::after{border-top-color:var(--bubble-fam-bd)}
  .bubble.famous::before{border-top-color:var(--bubble-fam-bg)}
  .bubble.show{display:block;animation:fadeIn .15s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  /* T：ランキングページ */
  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-grid{column-width:240px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}

  /* ページ操作バー（Undo/Redo/全削除） */
  .ops{display:flex;gap:8px;align-items:center;margin:6px 0 10px}
</style>
</head>
<body>
  <h1>学習計画（1ヶ月表示）</h1>

  <!-- 表示名 -->
  <div class="topbar">
    <input id="displayName" type="text" placeholder="表示名（例：橋本淑雅）" style="min-width:240px">
    <button id="saveName">保存</button>
    <span class="muted">※保存すると呼びかけ・順位に反映</span>
  </div>

  <!-- タブ -->
  <div class="tabs">
    <button id="tabProgress" class="tab active">進捗</button>
    <button id="tabClass" class="tab" title="学校">C 🏫</button>
    <button id="tabRank" class="tab" title="順位">T 🏆</button>
  </div>

  <!-- ページ進む/戻る -->
  <div class="pager">
    <button id="pagePrev">◀ 戻る</button>
    <button id="pageNext">進む ▶</button>
  </div>

  <!-- ===== Page 1: 進捗 ===== -->
  <section id="pageProgress" style="display:block">
    <div class="ops">
      <button id="undoP">戻る</button>
      <button id="redoP">進む</button>
      <button id="wipeP">全削除</button>
    </div>
    <div class="topbar">
      <button id="prev" class="primary">◀ 前月</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">次月 ▶</button>
      <button id="save">💾 更新/保存</button>
      <button id="load">📥 読込</button>
      <button id="toggleCompact">🗂 一覧表示</button>
    </div>

    <div class="topbar">
      <button id="importPaste">📋 貼り付け取込</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">📄 CSV/TSV/TXT取込</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">🖼 画像OCR取込</button>
      </label>
      <span class="muted">見出し：<code>日付, 種別, 目標, 結果, 復習</code>／<code>8/10(日)</code>もOK</span>
    </div>

    <div id="todayBanner" class="today-banner">本日: 読み込み中…</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr>
            <th class="medium">日付</th>
            <th class="small padL">種別</th>
            <th class="medium padL">目標（科目名）</th>
            <th class="medium padL">結果</th>
            <th class="medium padL">復習</th>
            <th class="small padL">色</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: クラスメート ===== -->
  <section id="pageClass" style="display:none">
    <div class="ops">
      <button id="undoC">戻る</button>
      <button id="redoC">進む</button>
      <button id="wipeC">全削除</button>
    </div>
    <div class="blackboard">1年B組 – クラスメートが「橋本淑雅」を応援中！</div>
    <div class="room">
      <div class="desks" id="desks"></div>
    </div>
  </section>

  <!-- ===== Page 3: ランキング ===== -->
  <section id="pageRank" style="display:none">
    <div class="ops">
      <button id="undoT">戻る</button>
      <button id="redoT">進む</button>
      <button id="wipeT">全削除</button>
    </div>
    <div class="rank-card">
      <h3>今月の順位（合計ポイント）</h3>
      <div id="rankGrid" class="rank-grid"></div>
      <div class="muted" style="margin-top:8px">
        ルール：完了=+10、復習+完了=+6、休日=0。クラスメイトは日替わりで自動スコア（擬似乱数・不正なし）。
      </div>
    </div>
  </section>

  <!-- 右下：🐹ホームへ（右上📍は無し） -->
  <button class="fab" id="fabHome" title="ホームへ"><span>🐹</span></button>

<script>
(function(){
  'use strict';
  const KEY='studyplanner.v15.ocr';
  const NAME_KEY='studyplanner.displayName';

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[]; // {date,type,goal,result,review,color}

  /* ========== Undo/Redo ========== */
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({year,month,rows}));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); ({year,month,rows}=prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); ({year,month,rows}=nxt); renderAll(); }

  /* ========== 小ユーティリティ ========== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'日月火水木金土'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}月${d.getDate()}日(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function ensureScaffold(){
    const need=new Set(monthDates(year,month));
    const have=new Set(rows.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) rows.push({date:d, type:'学習', goal:'', result:'', review:'', color:'normal'}); });
    rows.sort((a,b)=>a.date.localeCompare(b.date));
  }
  function persist(rec){const i=rows.findIndex(x=>x.date===rec.date); if(i>=0) rows[i]=rec; else rows.push(rec);}

  /* ========== ローカル保存/読込 ========== */
  function save(){
    pushHistory();
    const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
    const data=rows.filter(r=>fromYmd(r.date).getMonth()===month && fromYmd(r.date).getFullYear()===year);
    localStorage.setItem(key, JSON.stringify(data));
    alert('更新しました（この端末のブラウザ内）');
    renderRank(); // ページ移動しない
  }
  function load(){
    const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
    const raw=localStorage.getItem(key);
    if(!raw) return false;
    try{
      const data=JSON.parse(raw)||[];
      const map=new Map(rows.map(r=>[r.date,r]));
      data.forEach(d=>map.set(d.date,d));
      rows=[...map.values()];
      return true;
    }catch(e){ return false; }
  }

  /* ========== 進捗レンダリング ========== */
  function renderProgress(){
    ensureScaffold();
    $('#label').textContent=`${year}年${month+1}月（${monthDates(year,month).length}日）`;
    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    monthDates(year,month).forEach(date=>{
      const r=rows.find(x=>x.date===date) || {date,type:'学習',goal:'',result:'',review:'',color:'normal'};
      const tr=document.createElement('tr');

      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(date===todayStr) tr.classList.add('today');

      // 日付
      const tdDate=document.createElement('td'); tdDate.className='medium'; tdDate.textContent=jpDateLabel(date);

      // 種別（表示＋小トグル）
      const tdType=document.createElement('td'); tdType.className='small padL';
      const wrap=document.createElement('div'); wrap.className='type-wrap';
      const badge=document.createElement('span'); badge.className='type-badge'; badge.textContent=(r.type==='休日')?'休日':(r.type==='復習'?'復習':'学習');
      const btn=document.createElement('button'); btn.className='type-toggle'; btn.type='button';
      btn.textContent=(r.type==='休日')?'学習にする':'休日にする';
      btn.addEventListener('click',()=>{ pushHistory(); r.type=(r.type==='休日')?'学習':'休日'; persist(r); renderProgress(); renderRank(); });
      wrap.appendChild(badge); wrap.appendChild(btn); tdType.appendChild(wrap);

      // 目標
      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='例：世界史 23〜24';
      inGoal.value=r.goal||''; inGoal.addEventListener('input',e=>{ pushHistory(); r.goal=e.target.value; persist(r); });
      tdGoal.appendChild(inGoal);

      // 結果
      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='実績';
      inRes.value=r.result||''; inRes.addEventListener('input',e=>{ pushHistory(); r.result=e.target.value; persist(r); });
      tdRes.appendChild(inRes);

      // 復習
      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='復習範囲';
      inRev.value=r.review||''; inRev.addEventListener('input',e=>{ pushHistory(); r.review=e.target.value; persist(r); });
      tdRev.appendChild(inRev);

      // 色
      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'通常'}, {v:'gray',t:'完了'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{ pushHistory(); r.color=e.target.value; persist(r); renderProgress(); renderRank(); });
      tdClr.appendChild(selClr);

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdClr);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`本日: ${t.getMonth()+1}月${t.getDate()}日(${jpWeek(t)})`;
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); const thead=scroller.querySelector('thead');
    const todayRow=scroller.querySelector('tr.today')||scroller.querySelector('tbody tr'); if(!todayRow) return;
    const headerH=thead.getBoundingClientRect().height; const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4)});
  }

  /* ========== 取り込み：貼付 / CSV/TSV / OCR ========== */
  function normalizeDateToken(raw){
    if(!raw) return null;
    raw = String(raw).trim();
    raw = raw.replace(/（.*?）|\(.*?\)/g,'').trim(); // 曜日カッコ除去
    let y, mo, d;
    let m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m){ y=+m[1]; mo=+m[2]-1; d=+m[3]; }
    else{
      const m1 = raw.match(/^(\d{1,2})[\/\-月](\d{1,2})/);
      if(!m1) return null;
      y = year; mo = month; d = +m1[2];
    }
    return {y,mo,d};
  }

  // 空欄/NaN/null/undefined を空文字に正規化
  function clean(v){
    const s = String(v ?? '').trim();
    if(!s) return '';
    if(/^(nan|null|undefined)$/i.test(s)) return '';
    return s;
  }

  function parseTypeImport(text){
    const lines = (text||'').replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    let applied=0;
    for(const ln of lines){
      const parts = ln.split(/[\s,　\t]+/).filter(Boolean);
      if(parts.length<2) continue;
      const dtk = normalizeDateToken(parts[0]); if(!dtk) continue;
      let typ = parts[1].replace(/\s/g,'').trim();
      if(typ==='休み') typ='休日';
      if(!/^(学習|休日|復習)$/.test(typ)) continue;

      if(dtk.y!==year || dtk.mo!==month) continue; // 当月のみ
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const r = rows.find(x=>x.date===ds);
      if(r){ pushHistory(); r.type=typ; persist(r); applied++; }
    }
    return applied;
  }

  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const sep = (text.indexOf('\t')!==-1) ? '\t' : ',';
    const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header = lines[0].split(sep).map(s=>s.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {}; header.forEach((h,i)=> obj[h] = (cells[i]??'').trim());
      return obj;
    });
    return {header, rows};
  }

  function importCsvText(text){
    const {header, rows:objs} = parseDelimited(text);
    const col = {};
    header.forEach(h=>{
      if(/日付/.test(h)) col.date=h;
      if(/種別/.test(h)) col.type=h;
      if(/目標/.test(h)) col.goal=h;
      if(/結果/.test(h)) col.result=h;
      if(/復習/.test(h)) col.review=h;
    });
    if(!col.date || !col.type){ alert('CSV見出しを確認してください（少なくとも「日付」「種別」）'); return 0; }
    let applied=0;
    for(const o of objs){
      const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(!rec) continue;

      // 種別
      let t = clean(o[col.type]);
      if(t==='休み') t='休日';
      if(/^(学習|休日|復習)$/.test(t)) { pushHistory(); rec.type=t; }

      // 「列が存在するなら空でも上書き」←重要
      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);

      persist(rec); applied++;
    }
    return applied;
  }

  async function ocrImage(file){
    try{
      const worker = await Tesseract.createWorker('jpn');
      const { data:{ text } } = await worker.recognize(file);
      await worker.terminate();
      return text;
    }catch(e){
      try{
        const worker = await Tesseract.createWorker('eng');
        const { data:{ text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
      }catch(err){
        throw e;
      }
    }
  }

  /* ========== ランキング ========== */
  function myMonthlyPoints(){
    let total=0;
    monthDates(year,month).forEach(date=>{
      const r=rows.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray'){
        if(r.type==='復習') total+=6;
        else if(r.type==='学習') total+=10;
      }
    });
    return total;
  }
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  function classmatesMonthlyPoints(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='橋本淑雅').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=10; else if(r>0.50) sum+=6;});
      // 望月はTop5寄せ
      if(name==='望月亜希子') sum += 20 + Math.floor(rnd()*10);
      return {name, pts:sum};
    });
  }
  function renderRank(){
    const meName=(($('#displayName').value)||'橋本淑雅').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyPoints();
    // 5位保証
    const fifth = [...rivals].sort((a,b)=>b.pts-a.pts)[4]?.pts ?? 0;
    rivals = rivals.map(p=> p.name==='望月亜希子' && p.pts<=fifth ? {...p, pts:fifth+1} : p);
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    const grid=$('#pageRank #rankGrid'); if(grid){
      grid.innerHTML='';
      list.forEach((p,i)=>{
        const div=document.createElement('div'); div.className='rank-item';
        div.innerHTML=`<div class="rank-row">
          <div class="rank-no">${i+1}位</div>
          <div class="grow"><strong>${p.name}</strong></div>
          <div>${p.pts} pt</div>
        </div>`;
        grid.appendChild(div);
      });
    }
  }

  /* ========== クラスメート ========== */
  const CLASSMATES = [
    '橋本淑雅',  // あなた
    '望月亜希子',

    '永田秀仁','高橋','嶋康','田中','池之内英明','加藤','佐々木','富田雄二','富島雅人','成木洋平','唐杉先生',

    // 男性（芸能・論客）
    'ぷろたん','大森元木','橋本範之','米山隆一','ひろゆき',

    // 女優（女性）
    '綾瀬はるか','永野芽郁','石原さとみ','北川景子','有村架純','長澤まさみ','広瀬すず','深田恭子',
    '本田翼','杏','木村文乃','優香','生田絵梨花','上戸彩','菜々緒','内田有紀',
    '多部未華子','戸田恵梨香','広瀬アリス','吉高由里子'
  ];

  // 性別マップ（色分け：男=青 / 女=オレンジ）
  const FEMALES = new Set(['望月亜希子','綾瀬はるか','永野芽郁','石原さとみ','北川景子','有村架純','長澤まさみ','広瀬すず','深田恭子','本田翼','杏','木村文乃','優香','生田絵梨花','上戸彩','菜々緒','内田有紀','多部未華子','戸田恵梨香','広瀬アリス','吉高由里子']);
  const FAMOUS_SET = new Set([
    'ぷろたん','大森元木','米山隆一','ひろゆき',
    '綾瀬はるか','永野芽郁','石原さとみ','北川景子','有村架純','長澤まさみ','広瀬すず','深田恭子',
    '本田翼','杏','木村文乃','優香','生田絵梨花','上戸彩','菜々緒','内田有紀','多部未華子','戸田恵梨香','広瀬アリス','吉高由里子',
    '望月亜希子'
  ]);
  const ACTRESS_SET = new Set(FEMALES); // 女優は女性集合と同一で扱う

  // 吹き出し表示時間（ms）：最短5秒、人により～10秒
  const SPEAK_MS = new Map([
    ['綾瀬はるか',[7000,11000]], ['有村架純',[7000,11000]], ['長澤まさみ',[7000,11000]],
    ['望月亜希子',[6500,10000]],
    ['大森元木',[5000,8000]],
  ]);
  function speakDur(name){
    const p = SPEAK_MS.get(name);
    const min = p? p[0]:5000, max=p? p[1]:10000;
    return Math.floor(min + Math.random()*(max-min));
  }

  // 大森：Mrs. GREEN APPLE「風」（固有歌詞の引用は避け、励ましに再構成）
  function lineForOmori(){
    const pool = [
      '胸の空が晴れるまで、少しずつ重ねよう',
      '迷いは手を動かした先でほどけるよ',
      '君のテンポでいい、でも止まらずにいこう',
      '小さな光でも、続ければ景色になる',
      '鼓動を合図に、ページを開こう'
    ];
    return pool[Math.floor(Math.random()*pool.length)];
  }
  // 女優：主演作の雰囲気に寄せた台詞“風”（新規文）
  function lineForActress(){
    const calm = [
      '背筋を伸ばして、最初の一行からいこう',
      '丁寧でいい。確かめながら進めば大丈夫',
      '悩んだ分だけ深くなるよ。いまは目の前だけ見て',
      '凛として、手をつけよう。流れはあとから来る'
    ];
    const bright = [
      'よし、まず5分！その5分が思ったより効くから',
      '小さな達成を積もう。笑顔はあとからついてくる',
      '最初のページ、開いちゃおう！そこから始まるよ'
    ];
    const pick = Math.random()<0.55 ? calm : bright;
    return pick[Math.floor(Math.random()*pick.length)];
  }
  const GENERAL = [
    '千里の道も一歩から。今日は一歩だけでも',
    '手を動かせば集中は育つ。まず1問',
    '完璧より継続。今日は“完了”まで持っていこう',
    'できることから一つずつ。積み上げは裏切らない',
    '迷ったら開く。開けばエンジンがかかる'
  ];

  const recentLines = []; // 直近5件で重複防止
  const lastSpeaker = { name: null };
  const INTRO = ['よし、','さて、','静かに深呼吸。','焦らずいこう。','ここからだよ。','今が合図。','まずは1分だけ。'];
  const ENDINGS = ['。','！','。','！','。'];

  function makeLine(name){
    let base;
    if(name==='大森元木') base = lineForOmori();
    else if(ACTRESS_SET.has(name)) base = lineForActress();
    else base = GENERAL[Math.floor(Math.random()*GENERAL.length)];
    if(Math.random()<0.6) base = INTRO[Math.floor(Math.random()*INTRO.length)] + base;
    if(Math.random()<0.4) base = base.replace(/[。!]?$/, ENDINGS[Math.floor(Math.random()*ENDINGS.length)]);
    if(!/^橋本淑雅/.test(base)) base = '橋本淑雅、' + base;

    let tries=0;
    while((recentLines.includes(base) || lastSpeaker.name===name) && tries<5){
      if(name==='大森元木') base = lineForOmori();
      else if(ACTRESS_SET.has(name)) base = lineForActress();
      else base = GENERAL[Math.floor(Math.random()*GENERAL.length)];
      if(Math.random()<0.6) base = INTRO[Math.floor(Math.random()*INTRO.length)] + base;
      if(Math.random()<0.4) base = base.replace(/[。!]?$/, ENDINGS[Math.floor(Math.random()*ENDINGS.length)]);
      if(!/^橋本淑雅/.test(base)) base = '橋本淑雅、' + base;
      tries++;
    }
    recentLines.unshift(base); if(recentLines.length>5) recentLines.pop();
    lastSpeaker.name = name;
    return base;
  }

  let speechTimers=[];
  function clearSpeechTimers(){ speechTimers.forEach(id=>clearTimeout(id)); speechTimers=[]; }

  function buildClassroom(){
    clearSpeechTimers();
    const desks=$('#desks'); desks.innerHTML='';
    CLASSMATES.forEach((name, idx)=>{
      const d=document.createElement('div'); d.className='desk';
      d.classList.add(FEMALES.has(name)?'female':'male');
      const bubbleId=`bubble-${idx}`;
      const isYou = (name==='橋本淑雅');
      d.innerHTML = `
        <div class="bubble ${FAMOUS_SET.has(name)?'famous':''}" id="${bubbleId}"></div>
        <div class="name">${name}</div>
        <div class="role">${isYou ? '（あなた）' : 'クラスメイト'}</div>`;
      desks.appendChild(d);
    });

    const allBubbles = CLASSMATES.map((_,i)=>document.getElementById(`bubble-${i}`)).filter(Boolean);
    function speak(i){
      const who = CLASSMATES[i];
      const b = allBubbles[i]; if(!b) return;
      const isFamous = FAMOUS_SET.has(who);
      b.classList.toggle('famous', isFamous);
      b.textContent = makeLine(who);
      b.classList.add('show');

      const visibleMs = speakDur(who);           // 5〜10秒（人により長め）
      const hideId = setTimeout(()=>b.classList.remove('show'), visibleMs);
      speechTimers.push(hideId);

      const nextMs = 4000 + Math.floor(Math.random()*5000); // 騒がしさの揺れ
      const nextId = setTimeout(()=>speak(i), nextMs);
      speechTimers.push(nextId);
    }
    allBubbles.forEach((_,i)=> {
      const firstId = setTimeout(()=>speak(i), Math.floor(Math.random()*1200));
      speechTimers.push(firstId);
    });
  }

  /* ========== タブ＆ページ ========== */
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank');
    const t1=$('#tabProgress'), t2=$('#tabClass'), t3=$('#tabRank');
    const show = (a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3]); t1.classList.add('active'); t2.classList.remove('active'); t3.classList.remove('active'); renderProgress(); }
    if(which==='class'){    show(p2,[p1,p3]); t2.classList.add('active'); t1.classList.remove('active'); t3.classList.remove('active'); buildClassroom(); }
    if(which==='rank'){     show(p3,[p1,p2]); t3.classList.add('active'); t1.classList.remove('active'); t2.classList.remove('active'); renderRank(); }
  }
  const PAGES = ['progress','class','rank'];
  function pageIndexNow(){
    if($('#pageProgress').style.display!=='none') return 0;
    if($('#pageClass').style.display!=='none') return 1;
    return 2;
  }

  function renderAll(){
    const p1 = $('#pageProgress').style.display!=='none';
    const p2 = $('#pageClass').style.display!=='none';
    const p3 = $('#pageRank').style.display!=='none';
    if(p1) renderProgress();
    if(p2) buildClassroom();
    if(p3) renderRank();
  }

  /* ========== イベント ========== */
  // 名前
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY);
    $('#displayName').value = saved || '橋本淑雅';
  })();
  $('#saveName').addEventListener('click',()=>{ localStorage.setItem(NAME_KEY, ($('#displayName').value||'橋本淑雅').trim()); renderRank(); });

  // タブ
  $('#tabProgress').addEventListener('click',()=>showPage('progress'));
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));

  // ページ戻る/進む
  $('#pagePrev').addEventListener('click',()=>{
    const i = pageIndexNow();
    const ni = (i+3-1)%3;
    showPage(PAGES[ni]);
  });
  $('#pageNext').addEventListener('click',()=>{
    const i = pageIndexNow();
    const ni = (i+1)%3;
    showPage(PAGES[ni]);
  });

  // 進捗ナビ
  $('#prev').addEventListener('click',()=>{ pushHistory(); month-=1; if(month<0){month=11;year-=1;} load(); renderProgress(); renderRank(); });
  $('#next').addEventListener('click',()=>{ pushHistory(); month+=1; if(month>11){month=0;year+=1;} load(); renderProgress(); renderRank(); });
  $('#save').addEventListener('click',save);
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); renderRank(); alert(ok?'読み込みました':'保存データが見つかりません'); });
  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); });

  // 取り込み：貼付
  $('#importPaste').addEventListener('click',()=>{
    const text = prompt('日付と種別の一覧を貼り付け（例: 8/13(日) 休日）');
    if(!text) return;
    pushHistory();
    const n = parseTypeImport(text);
    renderProgress(); renderRank();
    alert(n?`当月に ${n} 件反映しました`:'反映対象が見つかりませんでした');
  });

  // 取り込み：CSV/TSV/TXT
  $('#importFile').addEventListener('change',async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text();
    pushHistory();
    const n=importCsvText(txt);
    renderProgress(); renderRank();
    alert(n?`当月に ${n} 件反映しました`:'反映対象が見つかりませんでした（見出し・当月か要確認）');
    e.target.value='';
  });

  // 取り込み：OCR
  $('#importImg').addEventListener('change',async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text = await ocrImage(f);
      pushHistory();
      const n = importCsvText(text) || parseTypeImport(text||'');
      renderProgress(); renderRank();
      alert(n?`OCR取込で当月に ${n} 件反映しました`:'文字が認識できないか、当月データが見つかりませんでした');
    }catch(err){
      alert('OCRに失敗しました。画像の鮮明さ・照明・傾きを確認してください。');
    }finally{
      e.target.value='';
    }
  });

  // ページ別：Undo/Redo/全削除（実体は共通）
  $('#undoP').onclick = $('#undoC').onclick = $('#undoT').onclick = ()=>undo();
  $('#redoP').onclick = $('#redoC').onclick = $('#redoT').onclick = ()=>redo();
  $('#wipeP').onclick = ()=>{ if(confirm('当月の進捗を初期化します。よろしいですか？')){ pushHistory(); monthDates(year,month).forEach(ds=>{ const r=rows.find(x=>x.date===ds); if(r){ r.type='学習'; r.goal=''; r.result=''; r.review=''; r.color='normal'; persist(r);} }); renderProgress(); renderRank(); } };
  $('#wipeC').onclick = ()=>{ if(confirm('Cページの発話状態をリセットしますか？')){ recentLines.length=0; lastSpeaker.name=null; clearSpeechTimers(); buildClassroom(); } };
  $('#wipeT').onclick = ()=>{ if(confirm('ランキング表示を再計算しますか？')){ renderRank(); } };

  // 右下：🐹＝ホーム(進捗)へ
  $('#fabHome').addEventListener('click',()=> showPage('progress'));

  // 初期表示
  (function init(){
    // v13/14のキーがあれば当月分を移行
    const keyOld=`studyplanner.v14.ocr:${year}-${String(month+1).padStart(2,'0')}`;
    const rawOld=localStorage.getItem(keyOld);
    if(rawOld && !localStorage.getItem(`${KEY}:${year}-${String(month+1).padStart(2,'0')}`)){
      try{ localStorage.setItem(`${KEY}:${year}-${String(month+1).padStart(2,'0')}`, rawOld); }catch{}
    }
    load(); renderProgress(); document.body.classList.add('compact'); renderRank();
  })();
})();
</script>
</body>
</html>
