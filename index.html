<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner – v17.7</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
    --male:#2563eb; --female:#f97316;
    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;
    --scale:1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:.78}

  h1{margin:0 0 12px;font-size:18px;display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  button,input[type="text"],input[type="file"],input[type="number"],input[type="time"],textarea,select{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:16px;cursor:pointer
  }
  input[type="text"],input[type="time"],textarea,select{width:100%;cursor:text}
  input[type="number"]{width:7em}
  textarea{min-height:120px;resize:vertical}
  .pill{border-radius:999px;padding:6px 10px;font-size:13px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;background:#fff;cursor:pointer}
  .chip.active{background:#eef2ff;border-color:#c7d2fe}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}

  .today-banner{margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:14px}

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:84vh}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:700;font-size:12px;color:#111;
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);
  }
  tr:hover td{background:#f9fafb}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  .tinted td{background:var(--tint)!important}
  .done-row td{background:var(--doneTint)!important;color:#111!important}

  .col-date{width:160px}
  .col-type{width:160px}
  .col-goal,.col-result,.col-review{width:1fr}
  .col-donebtn{width:120px}
  .cell{display:flex;align-items:center;gap:8px}
  .type-buttons .chip{min-width:68px;text-align:center}

  /* pop */
  .pop{
    position:absolute;pointer-events:none;font-weight:800;font-size:16px;
    animation:pop 1.2s ease forwards; text-shadow:0 1px 0 #fff;
    transform:translate(-50%,-50%);
  }
  @keyframes pop{0%{opacity:0;transform:translate(-50%,-10px) scale(.9)}10%{opacity:1}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-50px) scale(1.05)}}

  /* rankなど（省略：元のまま） */
  .fab{position:fixed;z-index:5;right:14px;bottom:14px;width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.12)}
  .fab span{font-size:22px;line-height:1}
  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:100px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}
  .bubble{position:absolute;left:8px;right:8px;top:8px;border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);display:none;white-space:pre-line}
  .bubble.show{display:block;animation:fadeIn .15s ease}
  .bubble.yell{font-size:22px;padding:16px 18px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
  <h1>
    学習計画（1ヶ月表示）<span class="muted" id="verTag">v17.7</span>
    <span class="muted" id="savedAt" style="margin-left:8px">最終保存: -</span>
    <button id="reloadBtn" class="pill" title="強制リロード">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="表示名（例：橋本淑雅）" style="min-width:240px">
    <button id="saveName">保存</button>
    <span class="muted">※保存すると呼びかけ・順位に反映</span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">進捗</button>
    <button id="tabClass" class="tab" title="学校">C 🏫</button>
    <button id="tabRank" class="tab" title="順位">T 🏆</button>
    <button id="tabEdit" class="tab" title="セリフ・人物編集">S 💬👤</button>
  </div>

  <!-- ===== Page 1 ===== -->
  <section id="pageProgress" style="display:block">
    <div class="topbar">
      <button id="undoP">戻る</button><button id="redoP">進む</button><button id="wipeP">全削除</button>
    </div>

    <div class="topbar" style="gap:12px; align-items:center">
      <div class="row">
        <label class="muted">科目：</label>
        <select id="subjectSelect" style="width:auto"></select>
        <button id="addSubject">＋科目追加</button>
        <button id="toggleAllBtn" class="chip" title="全科目（一覧）"><span id="allIcon">📚</span> 全科目</button>
      </div>

      <div class="row">
        <span class="muted">🎨 テーマ色</span>
        <button class="chip preset" data-preset="redsox">Red Sox</button>
        <button class="chip preset" data-preset="bluejays">Blue Jays</button>
        <button class="chip preset" data-preset="dodgers">Dodgers</button>
        <button class="chip preset" data-preset="nl">NL All-Star</button>
        <input id="colorPicker" type="text" placeholder="#RRGGBB" style="width:9em">
        <label class="muted">濃淡</label>
        <input id="tintRange" type="range" min="0" max="95" value="20" style="width:120px">
        <button id="applyColor" class="chip">適用</button>
      </div>

      <div class="row">
        <span class="muted">✅ 完了色</span>
        <input id="doneColorPicker" type="text" placeholder="#B0A89F" style="width:9em">
        <label class="muted">濃淡</label>
        <input id="doneTintRange" type="range" min="10" max="95" value="34" style="width:120px">
        <button id="applyDoneColor" class="chip">適用</button>
      </div>

      <div class="row">
        <span class="muted">🏅ポイント</span>
        <span class="muted">学習 <input id="ptStudy" class="pill" type="number" min="0" value="10" style="width:5.2em"></span>
        <span class="muted">復習 <input id="ptReview" class="pill" type="number" min="0" value="6" style="width:5.2em"></span>
        <span class="muted">休日 <input id="ptHoliday" class="pill" type="number" min="0" value="0" style="width:5.2em"></span>
        <button id="applyPts" class="chip">保存</button>
      </div>

      <div class="row" style="margin-left:auto">
        <button id="ttOpen" class="chip">🗓 時間割を開く</button>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="pill">◀ 前月</button>
      <div id="label" class="muted"></div>
      <button id="next" class="pill">次月 ▶</button>
      <button id="save" class="pill">💾 更新/保存</button>
      <button id="load" class="pill">📥 読込</button>
      <button id="toggleCompact" class="pill">🗂 一覧表示</button>
    </div>

    <div id="todayBanner" class="today-banner">本日: 読み込み中…</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <th class="col-date">日付</th>
            <th class="col-type">種別</th>
            <th class="col-goal">目標（科目名）</th>
            <th class="col-result">結果</th>
            <th class="col-review">復習</th>
            <th class="col-donebtn">完了</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2/3/4 は v17 と同等（省略） ===== -->
  <section id="pageClass" style="display:none">
    <div class="topbar"><button id="undoC">戻る</button><button id="redoC">進む</button><button id="wipeC">全削除</button></div>
    <div class="blackboard">1年B組 – クラスメートが「<span id="meOnBoard">橋本淑雅</span>」を応援中！</div>
    <div class="room"><div class="desks" id="desks"></div></div>
  </section>

  <section id="pageRank" style="display:none">
    <div class="topbar"><button id="undoT">戻る</button><button id="redoT">進む</button><button id="wipeT">全削除</button></div>
    <div id="rankGrid" style="padding:8px" class="muted">（ランキングはv17相当のまま動作）</div>
  </section>

  <section id="pageEdit" style="display:none">
    <div class="topbar"><button id="undoS">戻る</button><button id="redoS">進む</button></div>
    <div id="editGrid" class="muted" style="padding:8px">（編集UIはv17相当のまま動作）</div>
  </section>

  <!-- 時間割モーダルは v17 と同等（省略） -->

  <button class="fab" id="fabHome" title="ホームへ"><span>🐹</span></button>

<script>
(function(){
  'use strict';
  const VER='v17.7';

  /* Keys / State（必要最低限だけ残して動作安定化） */
  const NS='studyplanner.v17'; // ストレージは従来キーのまま
  const SUBJ_KEY   = `${NS}.subjects`;
  const COL_KEY    = `${NS}.subjectColors`;
  const DONE_KEY   = `${NS}.doneColor`;
  const DATA_KEY   = `${NS}.data`;
  const PTS_KEY    = `${NS}.points`;

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let subjects = loadSubjects();
  let subject = subjects[0] || '世界史';
  let showAll = false;
  let subjectColors = loadSubjectColors();
  let doneColor = loadDoneColor();
  let pointsCfg = loadPoints();
  let rows=[];

  /* Utils */
  const $=s=>document.querySelector(s);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'日月火水木金土'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}月${d.getDate()}日(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function tintCss(hex, percent){ const m=hex.replace('#',''); const r=parseInt(m.slice(0,2),16), g=parseInt(m.slice(2,4),16), b=parseInt(m.slice(4,6),16); const a=Math.max(0,Math.min(1,percent/100)); return `rgba(${r},${g},${b},${a})`; }

  /* Subjects & Colors */
  function loadSubjects(){ try{ const raw=localStorage.getItem(SUBJ_KEY); const arr = raw? JSON.parse(raw): null; return (Array.isArray(arr)&&arr.length)?arr:['世界史','英語','数学']; }catch(_){ return ['世界史','英語','数学']; } }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function renderSubjectSelect(){ const sel=$('#subjectSelect'); sel.innerHTML=''; subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); if(!subjects.includes(subject)) subject=subjects[0]; sel.value=subject; }
  function loadSubjectColors(){ try{ const raw=localStorage.getItem(COL_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; } }
  function saveSubjectColors(){ try{ localStorage.setItem(COL_KEY, JSON.stringify(subjectColors)); }catch(_){} }
  function colorFor(subj){
    const c = subjectColors[subj];
    if(c && c.hex){ return {hex:c.hex, tint: Math.max(0,Math.min(95,c.tint??20))}; }
    if(/英語/.test(subj)) return {hex:'#BD3039', tint:20};     // Red Sox
    if(/数学/.test(subj)) return {hex:'#134A8E', tint:20};     // Blue Jays
    if(/世界史/.test(subj)) return {hex:'#005A9C', tint:18};   // Dodgers
    return {hex:'#2563eb', tint:16};
  }
  function loadDoneColor(){ try{ const raw=localStorage.getItem(DONE_KEY); return raw? JSON.parse(raw): {hex:'#B0A89F', tint:34}; }catch(_){ return {hex:'#B0A89F', tint:34}; } }
  function saveDoneColor(){ try{ localStorage.setItem(DONE_KEY, JSON.stringify(doneColor)); }catch(_){} }

  /* Points */
  function loadPoints(){ try{ const raw=localStorage.getItem(PTS_KEY); return raw? JSON.parse(raw): {study:10, review:6, holiday:0}; }catch(_){ return {study:10, review:6, holiday:0}; } }
  function savePoints(){ try{ localStorage.setItem(PTS_KEY, JSON.stringify(pointsCfg)); }catch(_){} }
  const pointsForType=t=> t==='復習'? +pointsCfg.review||0 : (t==='休日'? +pointsCfg.holiday||0 : +pointsCfg.study||0);

  /* Per-month Data */
  const currentKey = (s=subject)=> `${DATA_KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s));
    let arr=[]; if(raw){ try{ arr=JSON.parse(raw)||[]; }catch(_){ } }
    // scaffold
    const need=new Set(monthDates(year,month)); const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'学習', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
    return arr;
  }
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  // ★足りてなかったやつ：UI上の1行を rows[] に反映
  function persist(rec){
    const i = rows.findIndex(x=> x.date===rec.date && (showAll? (x._subject===rec._subject): true));
    if(i>=0) rows[i]=rec;
    else rows.push(rec);
  }
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr=loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r,_subject:sub}));
      });
      rows=merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
    }else{
      rows=loadSubjectMonth(subject);
    }
    return true;
  }

  /* Autosave + 保存時刻表示 */
  const SAVED_AT_ID = 'savedAt';
  function setSavedNow(){
    const t=new Date();
    const s = `${t.getFullYear()}/${String(t.getMonth()+1).padStart(2,'0')}/${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`;
    $('#'+SAVED_AT_ID).textContent = `最終保存: ${s}`;
  }
  let autoSaveTimer=null;
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        const map=new Map();
        rows.forEach(r=>{ const subj=r._subject||subject; if(!map.has(subj)) map.set(subj,[]); map.get(subj).push(stripSubject(r)); });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      setSavedNow();
      autoSaveTimer=null;
    }, 600);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    if(showAll){
      const map=new Map();
      rows.forEach(r=>{ const subj=r._subject||subject; if(!map.has(subj)) map.set(subj,[]); map.get(subj).push(stripSubject(r)); });
      map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    }else{
      doSaveToLocal(subject, rows);
    }
    setSavedNow();
  }
  window.addEventListener('beforeunload', flushAutoSave);

  /* Render Progress */
  function renderProgress(){
    load();
    const days = monthDates(year,month).length;
    $('#label').textContent = showAll? `全科目 ${year}年${month+1}月（${days}日）` : `${subject} — ${year}年${month+1}月（${days}日）`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());
    const subjColor = colorFor(subject);
    const themeTint = tintCss(subjColor.hex, subjColor.tint);
    const doneTint  = tintCss(doneColor.hex, doneColor.tint);

    // 表示リスト
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'学習', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach((r,rowIndex)=>{
      const tr=document.createElement('tr');

      const isHoliday = (r.type==='休日');
      const isDone = (r.color==='gray') || isHoliday;

      if(r.date===todayStr) tr.classList.add('today');
      if(isDone){
        tr.classList.add('done-row');
        tr.style.setProperty('--doneTint', doneTint);
      }else{
        tr.classList.add('tinted');
        tr.style.setProperty('--tint', themeTint);
      }

      // 日付
      const tdDate = document.createElement('td'); tdDate.className='col-date'; tdDate.innerHTML = `<div class="cell">${jpDateLabel(r.date)}</div>`;

      // 種別（学習／休日）
      const tdType = document.createElement('td'); tdType.className='col-type';
      tdType.innerHTML = `<div class="cell type-buttons">
        <button class="chip btnType ${r.type==='学習'?'active':''}" data-val="学習">学習</button>
        <button class="chip btnType ${r.type==='休日'?'active':''}" data-val="休日">休日</button>
      </div>`;

      const tdGoal=document.createElement('td'); tdGoal.className='col-goal';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='例：世界史 23〜24'; inGoal.value=(r.goal??''); tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='col-result';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='実績'; inRes.value=(r.result??''); tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='col-review';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='復習範囲'; inRev.value=(r.review??''); tdRev.appendChild(inRev);

      // 完了（トグル）
      const tdDone=document.createElement('td'); tdDone.className='col-donebtn';
      const btnDone=document.createElement('button'); btnDone.className='chip'; btnDone.textContent='完了';
      tdDone.appendChild(btnDone);

      // 入力変更
      const onInput=(field)=>(e)=>{ r[field]=e.target.value; persist(r); touch(); };
      inGoal.addEventListener('input', onInput('goal'));
      inRes .addEventListener('input', onInput('result'));
      inRev .addEventListener('input', onInput('review'));

      // 種別クリック
      tdType.querySelectorAll('.btnType').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const v=btn.dataset.val;
          r.type=v;
          // 「学習」に戻したら灰色解除（デフォルト色へ）
          if(v==='学習' && r.color!=='gray'){ /* holiday の灰色見た目は type 由来なので学習に戻すだけで解除される */ }
          persist(r); touch(); renderProgress();
          setTimeout(scrollTodayIntoView,0);
        });
      });

      // 完了トグル
      btnDone.addEventListener('click',(ev)=>{
        // holiday は type で灰色表示になる。完了は color=gray をトグル。
        const wasDone = (r.color==='gray');
        if(wasDone){
          // 解除
          r.color='normal';
          persist(r); touch(); renderProgress();
          popAt(ev.target, `−${pointsForType(r.type||'学習')}`, '#ef4444'); // red-ish
        }else{
          r.color='gray';
          persist(r); touch(); renderProgress();
          popAt(ev.target, `+${pointsForType(r.type||'学習')}`, '#10b981'); // green
        }
        setTimeout(scrollTodayIntoView,0);
      });

      // 矢印キー移動
      const focusables=[inGoal,inRes,inRev,btnDone];
      focusables.forEach((el,colIndex)=>{
        el.dataset.rowIndex=rowIndex; el.dataset.colIndex=colIndex;
        el.addEventListener('keydown',(ev)=>{
          const rIdx=+el.dataset.rowIndex, cIdx=+el.dataset.colIndex;
          let nr=rIdx, nc=cIdx;
          if(ev.key==='ArrowDown'||ev.key==='Enter') nr=rIdx+1;
          if(ev.key==='ArrowUp')   nr=rIdx-1;
          if(ev.key==='ArrowRight')nc=cIdx+1;
          if(ev.key==='ArrowLeft') nc=cIdx-1;
          if(nr!==rIdx || nc!==cIdx){
            ev.preventDefault();
            const q=`[data-row-index="${nr}"][data-col-index="${nc}"]`;
            const next=$('#tbody').querySelector(q);
            if(next){ next.focus(); if(next.select) next.select(); }
          }
        });
      });

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdDone);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`本日: ${t.getMonth()+1}月${t.getDate()}日(${jpWeek(t)})`;
  }

  function popAt(anchor, text, color){
    const r = anchor.getBoundingClientRect();
    const pop=document.createElement('div'); pop.className='pop'; pop.textContent=text;
    pop.style.left = (r.left + r.width/2) + 'px';
    pop.style.top  = (r.top - 8 + window.scrollY) + 'px';
    pop.style.color = color||'#10b981';
    document.body.appendChild(pop);
    setTimeout(()=>{ pop.remove(); }, 1200);
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead'); const todayRow=scroller.querySelector('tr.today');
    if(!todayRow||!thead) return; const headerH=thead.getBoundingClientRect().height; const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'instant'});
  }

  /* Events（必要箇所だけ） */
  $('#save').addEventListener('click',()=>{ flushAutoSave(); renderProgress(); /* ← これで「更新後に空」対策 */ alert('更新しました（この端末のブラウザ内）'); setSavedNow(); });
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); alert(ok?'読み込みました':'保存データが見つかりません'); });
  $('#prev').addEventListener('click',()=>{ flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} renderProgress(); });
  $('#next').addEventListener('click',()=>{ flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} renderProgress(); });

  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  const PRESETS={ redsox:{hex:'#BD3039',tint:20}, bluejays:{hex:'#134A8E',tint:20}, dodgers:{hex:'#005A9C',tint:18}, nl:{hex:'#13274F',tint:18} };
  document.querySelectorAll('.preset').forEach(btn=> btn.addEventListener('click',()=>{ const p=PRESETS[btn.dataset.preset]; $('#colorPicker').value=p.hex; $('#tintRange').value=p.tint; }));
  $('#applyColor').addEventListener('click',()=>{ const hex=(($('#colorPicker').value)||'').trim(); const tint=+$('#tintRange').value||20; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXカラーを #RRGGBB で入力'); return; } const hx=hex.startsWith('#')?hex:('#'+hex); subjectColors[subject]={hex:hx,tint:Math.max(0,Math.min(95,tint))}; saveSubjectColors(); renderProgress(); });
  $('#applyDoneColor').addEventListener('click',()=>{ const hex=(($('#doneColorPicker').value)||'').trim()||doneColor.hex; const tint=+$('#doneTintRange').value||doneColor.tint; if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXカラーを #RRGGBB で入力'); return; } doneColor={hex:hex.startsWith('#')?hex:('#'+hex), tint:Math.max(10,Math.min(95,tint))}; saveDoneColor(); renderProgress(); });
  $('#applyPts').addEventListener('click',()=>{ pointsCfg={ study:+$('#ptStudy').value||0, review:+$('#ptReview').value||0, holiday:+$('#ptHoliday').value||0 }; savePoints(); });

  function highlightAllToggle(){ $('#allIcon').textContent = showAll? '📖':'📚'; $('#toggleAllBtn').classList.toggle('active', showAll); }
  $('#toggleAllBtn').addEventListener('click',()=>{ showAll=!showAll; renderProgress(); highlightAllToggle(); });

  $('#addSubject').addEventListener('click',()=>{ const name=prompt('追加する科目名（例：英語）'); if(!name) return; const trimmed=name.trim(); if(!trimmed) return; if(subjects.includes(trimmed)){ alert('その科目はすでにあります'); return; } subjects.push(trimmed); saveSubjects(); renderSubjectSelect(); subject=trimmed; showAll=false; renderProgress(); });
  $('#subjectSelect').addEventListener('change',e=>{ subject=e.target.value; showAll=false; renderProgress(); });

  // タブ
  $('#tabProgress').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));
  $('#tabEdit').addEventListener('click',()=>showPage('edit'));
  function setActiveTab(a,b,c,d){ $('#tabProgress').classList.toggle('active',a); $('#tabClass').classList.toggle('active',b); $('#tabRank').classList.toggle('active',c); $('#tabEdit').classList.toggle('active',d); }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit');
    const show=(a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); renderProgress(); }
    if(which==='class'){ show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); }
    if(which==='rank'){ show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); }
    if(which==='edit'){ show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); }
  }

  // 🐹 & R
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#reloadBtn').addEventListener('click',()=>{ const url = location.pathname + '?r=' + Date.now(); location.replace(url); });

  /* Init */
  function init(){
    $('#verTag').textContent = VER;
    renderSubjectSelect(); highlightAllToggle();
    load(); renderProgress(); document.body.classList.add('compact');
    setSavedNow();
    setTimeout(scrollTodayIntoView,0);
  }
  init();
})();
</script>
</body>
</html>
