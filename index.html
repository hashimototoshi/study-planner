<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Classmates & Ranking – 差し替え版</title>
<style>
  :root{
    --color-bg: #f5f7fb;
    --card-bg: #ffffff;
    --bubble-bg: #f7f9fc;
    --line: #e6ebf3;
    --text: #1b2430;
    --muted: #6b7684;
    --color-male:   #1E88E5; /* 既存の青を想定 */
    --color-female: #FB8C00; /* 既存のオレンジを想定 */
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--color-bg); color:var(--text); font: 15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Yu Gothic UI","YuGothic",Meiryo,sans-serif;
  }

  /* Top bar */
  .top{
    position:sticky; top:0; z-index:10;
    background:#fff; border-bottom:1px solid var(--line);
    padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .top .brand{font-weight:700; margin-right:auto}
  .top .nav button{
    padding:8px 10px; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer;
    min-width:40px; font-weight:700;
  }
  .top .nav button.active{background:#eef4ff; border-color:#c7d6ff}
  .top .tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .top .tools input[type="file"]{display:none}
  .file-label,.btn{
    padding:8px 12px; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer;
  }
  .btn.primary{background:#1a73e8; color:#fff; border-color:#1a73e8}
  .btn.ghost{background:#fff}
  .sheet-url{width:280px; max-width:70vw; padding:8px 10px; border:1px solid var(--line); border-radius:10px}

  main{padding:16px; max-width:1200px; margin:0 auto}
  .page{display:none}
  .page.active{display:block}

  /* Page 1: ざっくり情報（必要最低限） */
  .card{
    background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:14px;
  }
  .muted{color:var(--muted)}

  /* Page 2: クラスメートの言葉（右パネルを広げる） */
  .page-2{
    display:grid; grid-template-columns: 1fr 2fr; gap:16px;
  }
  .list{
    background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:12px;
  }
  .list h3, .words-panel h3{margin:6px 4px 10px}
  .student{padding:8px 10px; border-radius:10px; background:#fff; border:1px solid var(--line); margin:8px 0;}
  .student .name{font-weight:700}
  .words-panel{
    background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:12px;
  }
  .word{
    padding:8px 10px; margin:6px 0; border-radius:10px; background:var(--bubble-bg);
    line-height:1.6; border:1px solid var(--line);
  }
  .word.male   { color: var(--color-male); }
  .word.female { color: var(--color-female); }

  /* Page 3: ポイント順位（縦→右に折返し） */
  .rank-section{
    background:var(--card-bg); border:1px solid var(--line); border-radius:14px; padding:12px;
  }
  .rank-list{
    column-width: 240px; /* 画面幅に応じて列数が自動増減 */
    column-gap: 16px;
    list-style:none; margin:0; padding:0;
  }
  .rank-list li{
    break-inside: avoid;
    background:#fff; border:1px solid var(--line); border-radius:10px;
    padding:8px 10px; margin:6px 0; display:block;
  }
  .rank-list .male   { border-left:4px solid var(--color-male); }
  .rank-list .female { border-left:4px solid var(--color-female); }
  .rank-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .rank-no{font-weight:800; min-width:3.5em}
  .grow{flex:1}

  /* 小さめ画面対応 */
  @media (max-width:820px){
    .page-2{grid-template-columns: 1fr;}
  }
</style>
</head>
<body>
  <header class="top">
    <div class="brand">Dashboard</div>
    <nav class="nav">
      <button id="btn-page1" class="active" title="ホーム">Home</button>
      <button id="btn-classmates" title="クラスメート">C</button>
      <button id="btn-test" title="テスト（ポイント順位）">T</button>
    </nav>
    <div class="tools">
      <button id="btn-load" class="btn">読み込み</button>
      <button id="btn-save" class="btn">保存</button>

      <label class="file-label" for="csv-file">CSV読み込み</label>
      <input id="csv-file" type="file" accept=".csv,text/csv">

      <input id="sheet-url" class="sheet-url" placeholder="公開CSV URL（Googleスプレッドシートのexport=csv）">
      <button id="btn-sync-sheets" class="btn ghost">URLから取り込み</button>
    </div>
  </header>

  <main>
    <!-- Page 1 -->
    <section id="page-1" class="page active">
      <div class="card">
        <h2>ようこそ</h2>
        <p class="muted">上の「CSV読み込み」または「URLから取り込み」で名簿を反映できます。<br>
        保存はローカル（ブラウザの localStorage）。「読み込み」で復元します。</p>
      </div>
      <div class="card">
        <h3>CSVフォーマット（例）</h3>
<pre><code>id,name,gender,points,comment
1,山田太郎,male,120,すごい集中力
2,田中花子,female,140,丁寧で正確
</code></pre>
        <p class="muted">gender は <strong>male</strong>/<strong>female</strong>。<br>列名が一致しない場合は取り込み失敗になります。</p>
      </div>
    </section>

    <!-- Page 2 -->
    <section id="page-2" class="page">
      <div class="page-2">
        <div class="list">
          <h3>メンバー</h3>
          <div id="student-list"></div>
        </div>
        <div class="words-panel">
          <h3>クラスメートの言葉（右側に拡張表示）</h3>
          <div id="words-list"></div>
        </div>
      </div>
    </section>

    <!-- Page 3 -->
    <section id="page-3" class="page">
      <section class="rank-section">
        <h2>ポイント順位</h2>
        <ol class="rank-list" id="rank-list"></ol>
      </section>
    </section>
  </main>

<script>
/* ========= ユーティリティ ========= */
function notifyError(err, userMsg = "処理に失敗しました") {
  console.error(err);
  alert(`${userMsg}\n${err?.message ?? ""}`);
}
function assertHasRows(rows, msg="データがありませんでした"){
  if (!Array.isArray(rows) || rows.length === 0) throw new Error(msg);
}
function escapeHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

/* ========= 状態 ========= */
const STORAGE_KEY = "app:data:v1";

const state = {
  students: [],   // {id,name,gender('male'|'female'),points:number,comment}
  messages: []    // 使わないが将来拡張用
};

/* ========= 褒め言葉：重複抑制＆ランダム性 ========= */
const praisePool = {
  精度: ["正確無比","丁寧で緻密","ブレがない","詰めが美しい","安定感抜群"],
  速度: ["展開が速い","反応が鋭い","切り替えが早い","テンポが良い","進みが軽快"],
  発想: ["着眼点が鋭い","発想が柔軟","切り口が新しい","発見が多い","視点が広い"],
  継続: ["積み上げが見事","継続力が光る","コツコツ型の強み","粘り強い","習慣化できている"]
};
const extraPraise = ["判断が的確","説明が明快","段取りが良い","対応が速い","集中が深い","工夫が冴える","姿勢が安定","理解が早い","反省が上手","改善が速い","視野が広い","質問が良質","手際が良い","根拠が強い","メンタルが強い","配慮が細やか","言語化が上手","要点を掴む","再現性が高い","伸びしろが大きい"];

const usedToday = new Set();
let praiseOrder = Object.keys(praisePool); // カテゴリを毎回回転
function nextPraise(){
  praiseOrder.push(praiseOrder.shift());
  const cat = praiseOrder[0];
  const candidates = praisePool[cat].filter(p => !usedToday.has(p));
  let p;
  if (candidates.length === 0) {
    usedToday.clear(); // 使い切ったらリセット
    return nextPraise();
  } else {
    p = candidates[Math.floor(Math.random()*candidates.length)];
  }
  usedToday.add(p);
  return p;
}

/* ========= CSV パース（簡易/BOM対応） ========= */
function parseCSV(text){
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const lines = text.replace(/\r\n?/g,"\n").split("\n").filter(l => l.trim()!=="");
  const header = lines[0].split(",").map(s=>s.trim());
  const rows = lines.slice(1).map(line=>{
    // ※厳密CSVが必要なら Papa Parse 等に置換
    const cells = line.split(",").map(s=>s.trim());
    const obj = {};
    header.forEach((h,i)=> obj[h] = cells[i] ?? "");
    return obj;
  });
  return rows;
}
function mapRowsToStudents(rows){
  return rows.map(r => ({
    id: String(r.id ?? crypto.randomUUID()),
    name: r.name ?? "",
    gender: (r.gender === "female" ? "female" : "male"),
    points: Number(r.points ?? 0),
    comment: r.comment ?? ""
  }));
}

/* ========= レンダリング ========= */
function renderPage(which){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(`page-${which}`).classList.add("active");
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  if (which===1) document.getElementById("btn-page1").classList.add("active");
  if (which===2) document.getElementById("btn-classmates").classList.add("active");
  if (which===3) document.getElementById("btn-test").classList.add("active");
  if (which===2) { renderStudents(); renderWords(); }
  if (which===3) { renderRanking(); }
}
function renderStudents(){
  const host = document.getElementById("student-list");
  if (!host) return;
  host.innerHTML = state.students.map(s => {
    return `<div class="student">
      <div class="name">${escapeHtml(s.name)}</div>
      <div class="muted">${s.gender==="female"?"女性":"男性"}／${s.points} pt</div>
      ${s.comment ? `<div class="muted">メモ：${escapeHtml(s.comment)}</div>` : ""}
    </div>`;
  }).join("") || `<div class="muted">メンバー未登録</div>`;
}
function renderWords(){
  const host = document.getElementById("words-list");
  if (!host) return;
  const out = [];
  // 各メンバーに 1〜2 個の褒め言葉＋任意で comment
  state.students.forEach(s=>{
    const praise1 = nextPraise();
    const maybe2  = Math.random() < 0.35 ? `・${extraPraise[Math.floor(Math.random()*extraPraise.length)]}` : "";
    const c = s.comment ? `（${escapeHtml(s.comment)}）` : "";
    out.push(`<div class="word ${s.gender==='female'?'female':'male'}">
      <strong>${escapeHtml(s.name)}</strong>：${praise1}${maybe2}${c}
    </div>`);
  });
  host.innerHTML = out.join("") || `<div class="muted">表示する言葉がありません</div>`;
}
function renderRanking(){
  const list = document.getElementById("rank-list");
  if (!list) return;
  const ranked = [...state.students].sort((a,b)=> b.points - a.points);
  list.innerHTML = ranked.map((s,i)=>`
    <li class="${s.gender==='female'?'female':'male'}">
      <div class="rank-row">
        <div class="rank-no">${i+1}位</div>
        <div class="grow"><strong>${escapeHtml(s.name)}</strong></div>
        <div>${s.points} pt</div>
      </div>
    </li>
  `).join("") || `<li><div class="muted">データなし</div></li>`;
}

/* ========= 永続化 ========= */
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({students: state.students, messages: state.messages}));
  alert("保存しました");
}
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) throw new Error("保存データが見つかりません");
  const data = JSON.parse(raw);
  assertHasRows(data?.students ?? []);
  state.students = data.students;
  state.messages = data.messages ?? [];
}

/* ========= 取り込み系 ========= */
async function importCsvFile(file){
  const text = await file.text();
  const rows = parseCSV(text);
  assertHasRows(rows);
  mergeStudents(mapRowsToStudents(rows));
  renderAfterImport();
}
async function importFromSheetCsv(url){
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  const rows = parseCSV(text);
  assertHasRows(rows);
  mergeStudents(mapRowsToStudents(rows));
  renderAfterImport();
}
function mergeStudents(incoming){
  const map = new Map(state.students.map(s => [s.id, s]));
  incoming.forEach(s => map.set(s.id, s)); // id一致は上書き
  state.students = Array.from(map.values());
}
function renderAfterImport(){
  // 現在ページを見直して反映（2/3ページなら即更新）
  const p2 = document.getElementById("page-2").classList.contains("active");
  const p3 = document.getElementById("page-3").classList.contains("active");
  if (p2) { renderStudents(); renderWords(); }
  if (p3) { renderRanking(); }
  if (!p2 && !p3) { /* Home のままなら軽く通知 */ }
  alert("取り込み完了");
}

/* ========= イベント ========= */
document.getElementById("btn-page1").addEventListener("click", ()=> renderPage(1));
document.getElementById("btn-classmates").addEventListener("click", ()=> renderPage(2));
document.getElementById("btn-test").addEventListener("click", ()=> renderPage(3));

document.getElementById("btn-save").addEventListener("click", ()=>{
  try { save(); } catch(err){ notifyError(err, "保存に失敗しました"); }
});
document.getElementById("btn-load").addEventListener("click", ()=>{
  try { load(); renderStudents(); renderWords(); renderRanking(); alert("読み込み完了"); }
  catch(err){ notifyError(err, "読み込みに失敗しました"); }
});

document.getElementById("csv-file").addEventListener("change", async (e)=>{
  try{
    const file = e.target.files?.[0];
    if (!file) throw new Error("CSVファイルが選択されていません");
    await importCsvFile(file);
    e.target.value = ""; // 同じファイルを続けて選んでもイベント発火するようクリア
  }catch(err){ notifyError(err, "CSV取り込みに失敗しました"); }
});
document.getElementById("btn-sync-sheets").addEventListener("click", async ()=>{
  try{
    const url = document.getElementById("sheet-url").value.trim();
    if (!url) throw new Error("公開CSVのURLを入力してください");
    await importFromSheetCsv(url);
  }catch(err){ notifyError(err, "URL取り込みに失敗しました"); }
});

/* 初期表示 */
renderPage(1);
</script>
</body>
</html>
