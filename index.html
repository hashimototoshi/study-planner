<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner – 月一覧（曜日つき・色最適化・本日ジャンプ）</title>
<style>
  :root{
    --line:#e5e7eb;
    --muted:#6b7280;
    --today-bg:#005A9C;      /* 本日 背景：ドジャースブルー */
    --today-text:#ffffff;    /* 本日 文字色：白 */
    --row-gray-bg:#b0a89f;   /* 完了 背景：ジャンガリアン色 */
    --row-gray-text:#000000; /* 完了 文字色：黒 */
    --header-bg:#ffffff;
    --header-shadow: 0 6px 12px rgba(0,0,0,0.06); /* ほんのり影 */
  }
  *{box-sizing:border-box}
  body{
    margin:0;padding:14px;
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;
    color:#111827;background:#fff
  }
  h1{margin:0 0 12px;font-size:18px}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .muted{color:var(--muted);font-size:12px}
  button,select,input[type="text"]{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px
  }
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}

  /* 本日表示バナー（バー直下に固定表示） */
  .today-banner{
    margin:6px 0 10px;
    padding:8px 12px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#f8fafc;
    font-size:14px;
  }

  /* テーブル（表内スクロール。ヘッダーはsticky） */
  .tbl{
    width:100%;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:auto;
    max-height:82vh; /* ← 少し拡げて1〜2行ぶん余裕を作る */
  }
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:12px;color:var(--muted);
    position:sticky; top:0; z-index:3;
    background:var(--header-bg);
    border-bottom:2px solid var(--line);
    box-shadow:var(--header-shadow);
    backdrop-filter:saturate(1.1);
  }
  td.padL{padding-left:22px} /* 列間のゆとり（日付↔種別、種別↔目標など） */
  td.small{width:120px}
  td.medium{width:180px}

  /* 行色：today は自動（ただし完了＝手動色があればそちら優先） */
  tr.today td{
    background:var(--today-bg) !important;
    color:var(--today-text) !important;
  }
  tr.manual-gray td{
    background:var(--row-gray-bg) !important;
    color:var(--row-gray-text) !important;
  }

  /* 右上＆右下の本日ジャンプボタン */
  .fab{
    position:fixed; z-index:5;
    width:54px; height:54px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    border:1px solid var(--line); background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);
    user-select:none; -webkit-user-select:none;
  }
  .fab:hover{transform:translateY(-1px)}
  .fab:active{transform:translateY(0)}
  .fab-top-right{ right:14px; top:14px; }
  .fab-bottom-right{ right:14px; bottom:14px; }
  .fab span{font-size:22px; line-height:1}

  @media (max-width:820px){
    th,td{font-size:16px}
    button,select,input{font-size:16px}
  }
</style>
</head>
<body>
  <h1>学習計画（1ヶ月表示／曜日つき）</h1>
  <div class="bar">
    <button id="prev" class="primary">◀ 前月</button>
    <div id="label" class="muted"></div>
    <button id="next" class="primary">次月 ▶</button>
    <button id="todayBtn">⟳ 今日へ</button>
    <button id="save">💾 保存</button>
    <button id="load">📥 読込</button>
  </div>

  <!-- バー直下に本日のテキストを出す -->
  <div id="todayBanner" class="today-banner">本日: 読み込み中…</div>

  <div class="tbl" id="scroller">
    <table>
      <thead>
        <tr>
          <th class="medium">日付</th>
          <th class="small padL">種別</th>
          <th class="medium padL">目標（科目名）</th>
          <th class="medium padL">結果</th>
          <th class="medium padL">復習</th>
          <th class="small padL">色</th> <!-- 行色→色 -->
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- 右上：バット（大谷くんリスペクトの汎用アイコン） -->
  <button class="fab fab-top-right" id="fabTop" title="今日へ"><span>🦾</span></button>
  <!-- 右下：ボール（ドジャース球リスペクトの汎用アイコン） -->
  <button class="fab fab-bottom-right" id="fabBottom" title="今日へ"><span>⚾️</span></button>

<script>
(function(){
  'use strict';
  const KEY='studyplanner.month.form.v4.jump';

  // 月切替
  let year, month; // 0-11
  const now=new Date(); year=now.getFullYear(); month=now.getMonth();

  // モデル：date(YYYY-MM-DD), type('学習'|'休日'|'復習'), goal, result, review, color('normal'|'gray')
  let rows=[];

  // ユーティリティ
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'日月火水木金土'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}月${d.getDate()}日(${jpWeek(d)})`;};

  function monthDates(y,m){
    const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[];
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d));
    return arr;
  }

  function ensureScaffold(){
    const need=new Set(monthDates(year,month));
    const have=new Set(rows.map(r=>r.date));
    need.forEach(d=>{
      if(!have.has(d)){
        rows.push({date:d, type:'学習', goal:'', result:'', review:'', color:'normal'});
      }
    });
    rows.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function save(){
    try{
      const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
      const data=rows.filter(r=>fromYmd(r.date).getMonth()===month && fromYmd(r.date).getFullYear()===year);
      localStorage.setItem(key, JSON.stringify(data));
      alert('保存しました（この端末のブラウザ内）');
    }catch(e){}
  }

  function load(){
    const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
    const raw=localStorage.getItem(key);
    if(!raw) return false;
    try{
      const data=JSON.parse(raw)||[];
      const map=new Map(rows.map(r=>[r.date,r]));
      data.forEach(d=>map.set(d.date, d));
      rows=[...map.values()];
      return true;
    }catch(e){ return false; }
  }

  function render(){
    ensureScaffold();
    $('#label').textContent=`${year}年${month+1}月（${monthDates(year,month).length}日）`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    monthDates(year,month).forEach(date=>{
      const r = rows.find(x=>x.date===date) || {date, type:'学習', goal:'', result:'', review:'', color:'normal'};
      const tr=document.createElement('tr');

      // 行色：完了(gray) > 本日(today)
      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(date===todayStr) tr.classList.add('today');

      // 日付（8月13日(火)）
      const tdDate=document.createElement('td');
      tdDate.className='medium';
      tdDate.textContent = jpDateLabel(date);

      // 種別（「未設定」を削除）
      const tdType=document.createElement('td'); tdType.className='small padL';
      const selType=document.createElement('select');
      ['学習','休日','復習'].forEach(opt=>{
        const o=document.createElement('option');
        o.value=opt; o.textContent = opt;
        if((r.type||'学習')===opt) o.selected=true;
        selType.appendChild(o);
      });
      selType.addEventListener('change',e=>{
        r.type=e.target.value;
        render(); // disabled切り替え反映
        persist(r);
      });
      tdType.appendChild(selType);

      // 目標（科目名）※空欄スタート
      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='例：世界史 23〜24';
      inGoal.value=r.goal||'';
      inGoal.disabled = (r.type==='休日');
      inGoal.addEventListener('input',e=>{ r.goal=e.target.value; persist(r); });
      tdGoal.appendChild(inGoal);

      // 結果
      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='実績';
      inRes.value=r.result||'';
      inRes.disabled = (r.type==='休日');
      inRes.addEventListener('input',e=>{ r.result=e.target.value; persist(r); });
      tdRes.appendChild(inRes);

      // 復習
      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='復習範囲';
      inRev.value=r.review||'';
      inRev.disabled = (r.type==='休日');
      inRev.addEventListener('input',e=>{ r.review=e.target.value; persist(r); });
      tdRev.appendChild(inRev);

      // 色（手動）… 通常 / 完了（＝ジャンガリアン灰）
      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'通常'}, {v:'gray',t:'完了'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{
        r.color=e.target.value;
        render(); // 即反映（today色より手動色が勝つ）
        persist(r);
      });
      tdClr.appendChild(selClr);

      tr.appendChild(tdDate);
      tr.appendChild(tdType);
      tr.appendChild(tdGoal);
      tr.appendChild(tdRes);
      tr.appendChild(tdRev);
      tr.appendChild(tdClr);

      tb.appendChild(tr);
    });

    // 本日テキスト更新
    const t = new Date();
    $('#todayBanner').textContent = `本日: ${t.getMonth()+1}月${t.getDate()}日(${jpWeek(t)})`;
  }

  function persist(rec){
    const i=rows.findIndex(x=>x.date===rec.date);
    if(i>=0) rows[i]=rec; else rows.push(rec);
  }

  // 「本日をヘッダー直下にスクロール」
  function scrollTodayIntoView(){
    const scroller = $('#scroller');
    const thead = scroller.querySelector('thead');
    const todayRow = scroller.querySelector('tr.today') || scroller.querySelector('tbody tr');
    if(!todayRow) return;
    const headerH = thead.getBoundingClientRect().height;
    // 要素位置（スクロール容器基準）を計算
    const rowTop = todayRow.offsetTop; // tbody内の位置
    scroller.scrollTo({
      top: Math.max(0, rowTop - headerH - 4),
      behavior: 'smooth'
    });
  }

  // イベント
  $('#prev').addEventListener('click',()=>{ month-=1; if(month<0){month=11;year-=1;} load(); render(); setTimeout(scrollTodayIntoView, 50); });
  $('#next').addEventListener('click',()=>{ month+=1; if(month>11){month=0;year+=1;} load(); render(); setTimeout(scrollTodayIntoView, 50); });
  $('#save').addEventListener('click',()=>{ save(); });
  $('#load').addEventListener('click',()=>{ const ok=load(); render(); setTimeout(scrollTodayIntoView, 50); alert(ok?'読み込みました':'保存データが見つかりません'); });
  $('#todayBtn').addEventListener('click',()=>{ scrollTodayIntoView(); });

  // 右上/右下のジャンプボタン
  $('#fabTop').addEventListener('click', scrollTodayIntoView);
  $('#fabBottom').addEventListener('click', scrollTodayIntoView);

  // 初期描画 → 本日へ自動スクロール
  load(); render();
  window.addEventListener('load', ()=> setTimeout(scrollTodayIntoView, 80));
})();
</script>
</body>
</html>
