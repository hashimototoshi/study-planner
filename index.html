<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner – 月間進捗＋C(🏫)＋T(🏆)</title>

<!-- 画像OCR（iPad完結） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --row-gray-bg:#b0a89f; --row-gray-text:#000000;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;

    --male:#2563eb; --female:#f97316;

    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;

    /* 球団カラー */
    --bos-red:#BD3039; --bos-navy:#0D2B56;     /* レッドソックス */
    --jays-blue:#134A8E; --jays-navy:#1D2D5C;   /* ブルージェイズ */
    --nl-navy:#0C2340; --nl-red:#BA0C2F;        /* ナ・リーグ系 */

    --scale: 1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:0.72;}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale));display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"],input[type="number"],textarea,select{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  textarea{width:100%;min-height:120px;resize:vertical;cursor:text}
  input[type="number"]{width:7em}
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .pill{border-radius:999px;padding:6px 10px;font-size:14px}

  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  .pager{display:flex;gap:8px;align-items:center;margin:6px 0 6px}

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  .tbl{
    width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;
    max-height:calc(84vh*var(--scale));
  }
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:calc(8px*var(--scale));border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:calc(12px*var(--scale));color:#334155;
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);backdrop-filter:saturate(1.1);
  }
  td.padL{padding-left:calc(14px*var(--scale))}
  td.small{width:calc(110px*var(--scale))}
  td.medium{width:calc(160px*var(--scale))}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.manual-gray td{background:var(--row-gray-bg)!important;color:var(--row-gray-text)!important}

  /* 科目カラー（行） */
  tr.subj-eng td{background:linear-gradient(90deg, rgba(189,48,57,.08), rgba(13,43,86,.05))} /* 英語=RedSox */
  tr.subj-math td{background:linear-gradient(90deg, rgba(19,74,142,.08), rgba(29,45,92,.05))}/* 数学=BlueJays */
  body.theme-nl th{background:linear-gradient(90deg, var(--nl-navy), var(--nl-red)); color:#fff}

  .type-wrap{display:flex;align-items:center;gap:8px}
  .type-badge{font-weight:700}
  .type-toggle{
    padding:calc(4px*var(--scale)) calc(8px*var(--scale));
    border:1px solid var(--line);border-radius:10px;background:#fff;
    font-size:calc(12px*var(--scale));cursor:pointer
  }

  /* 操作列の「完了」 */
  .btn-done{border:1px solid #9ca3af;background:#f1f5f9;border-radius:10px}
  .btn-done:hover{background:#e5e7eb}

  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);
    right:14px;bottom:14px
  }
  .fab span{font-size:22px;line-height:1}

  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}

  /* 教室 */
  .room{border:1px solid var(--line);border-radius:12px;padding:10px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(4, minmax(0,1fr))}
  .desk{
    background:linear-gradient(#f6ead6, #e2cfa6);
    border:1px solid #b08b57;border-radius:12px;padding:8px;min-height:96px;
    display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 2px 6px rgba(0,0,0,.04)
  }
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}

  .bubble{
    position:absolute;left:8px;right:8px;top:8px;z-index:1;
    border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:8px 10px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);
    display:none;max-width:unset;white-space:pre-line
  }
  .bubble::after{content:"";position:absolute;left:22px;bottom:-10px;border-width:10px 10px 0 10px;border-style:solid;border-color:var(--bubble-gen-bd) transparent transparent transparent}
  .bubble::before{content:"";position:absolute;left:22px;bottom:-9px;border-width:9px 9px 0 9px;border-style:solid;border-color:var(--bubble-gen-bg) transparent transparent transparent}
  .bubble.famous{background:var(--bubble-fam-bg);border-color:var(--bubble-fam-bd)}
  .bubble.famous::after{border-top-color:var(--bubble-fam-bd)}
  .bubble.famous::before{border-top-color:var(--bubble-fam-bg)}
  .bubble.shout{
    font-size:28px; padding:14px 16px; z-index:2;
    box-shadow:0 14px 30px rgba(0,0,0,.18);
    left:4px; right:4px;
  }
  .bubble.show{display:block;animation:fadeIn .15s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-grid{column-width:240px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}

  .ops{display:flex;gap:8px;align-items:center;margin:6px 0 10px}

  /* Page4 editor */
  .grid-edit{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .card h4{margin:0 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* 時間割（クリックで小窓表示） */
  .tt{margin-left:auto; position:relative}
  .tt .pill{cursor:pointer}
  .tt-panel{
    position:absolute; right:0; top:42px; width:min(92vw,720px); max-height:70vh; overflow:auto;
    border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:0 20px 40px rgba(0,0,0,.12);
    opacity:0; transform:translateY(-6px) scale(.98); pointer-events:none; transition:opacity .18s ease, transform .18s ease;
    padding:10px; z-index:5;
  }
  .tt.open .tt-panel{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
  .tt-grid{display:grid;grid-template-columns:110px 1fr 1fr 1fr; gap:8px; align-items:center}
  .tt-grid > div{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
  .tt-row{display:contents}
  .tt-actions{display:flex;gap:8px;align-items:center;margin:8px 0}
  .linklike{color:var(--accent);text-decoration:underline;cursor:pointer}

  /* 大きめ “一覧” ボタン */
  .btn-big{padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:700}
  .btn-big.active{background:linear-gradient(90deg, var(--nl-navy), var(--nl-red));color:#fff;border-color:transparent}
</style>
</head>
<body>
  <h1>
    学習計画（1ヶ月表示）
    <button id="reloadBtn" class="pill" title="強制リロード">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="表示名（例：橋本淑雅）" style="min-width:240px">
    <button id="saveName">保存</button>
    <span class="muted">※保存すると呼びかけ・順位に反映</span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">進捗</button>
    <button id="tabClass" class="tab" title="学校">C 🏫</button>
    <button id="tabRank" class="tab" title="順位">T 🏆</button>
    <button id="tabEdit" class="tab" title="セリフ編集">S 💬</button>
  </div>

  <div class="pager">
    <button id="pagePrev">◀ 戻る</button>
    <button id="pageNext">進む ▶</button>
  </div>

  <!-- ===== Page 1: 進捗 ===== -->
  <section id="pageProgress" style="display:block">
    <div class="ops">
      <button id="undoP">戻る</button>
      <button id="redoP">進む</button>
      <button id="wipeP">全削除</button>
    </div>

    <!-- 科目切替 + 全科目（一覧） + 時間割 -->
    <div class="topbar" style="gap:12px; align-items:center">
      <div class="row" style="gap:8px">
        <label class="muted">科目：</label>
        <select id="subjectSelect"></select>
        <button id="addSubject">＋科目追加</button>
        <button id="btnToggleAll" class="btn-big">⭐ 全科目（一覧）</button>
        <label class="muted" style="display:none"><input id="toggleAll" type="checkbox"> 全科目（一覧表示）</label>
      </div>

      <div class="tt" id="ttBox">
        <span class="pill" id="ttOpenBtn">🗓 時間割（開く）</span>
        <div class="tt-panel">
          <div class="row tt-actions">
            <strong id="ttTitle">今日の時間割</strong>
            <button id="ttAddRow">＋行追加</button>
            <button id="ttShuffle">🔀 自動提案</button>
            <span class="muted">科目ごとに保存</span>
            <span style="margin-left:auto" class="linklike" id="ttClose">× 閉じる</span>
          </div>
          <div class="tt-grid">
            <div class="muted">開始</div>
            <div class="muted">終了</div>
            <div class="muted">内容</div>
            <div class="muted">操作</div>
          </div>
          <div id="ttRows"></div>
          <div class="muted" style="margin-top:8px">ヒント：入力はオートセーブ／自動提案しても小窓は閉じません</div>
        </div>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="primary">◀ 前月</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">次月 ▶</button>
      <button id="save">💾 更新/保存</button>
      <button id="load">📥 読込</button>
      <button id="toggleCompact">🗂 一覧表示（行を詰める）</button>
    </div>

    <div class="topbar">
      <button id="importPaste">📋 貼り付け取込</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">📄 CSV/TSV/TXT取込</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">🖼 画像OCR取込</button>
      </label>
      <span class="muted">見出し：<code>日付, 種別, 目標, 結果, 復習</code></span>
    </div>

    <div id="todayBanner" class="today-banner">本日: 読み込み中…</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <!-- JSで生成 -->
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: クラスメート ===== -->
  <section id="pageClass" style="display:none">
    <div class="ops" style="justify-content:flex-start">
      <button id="undoC">戻る</button>
      <button id="redoC">進む</button>
      <button id="wipeC">全削除</button>
    </div>
    <div class="blackboard">
      1年B組 – クラスメートが「<span id="meOnBoard">橋本淑雅</span>」を応援中！
      <span style="margin-left:10px" class="muted">速さ%増し：</span>
      <input id="boostInput" type="number" min="0" step="1" value="0" title="例: 13 → 13%速く">
      <button id="applyBoost">適用</button>
      <span id="boostHint" class="muted"></span>
    </div>
    <div class="room">
      <div class="desks" id="desks"></div>
    </div>
  </section>

  <!-- ===== Page 3: ランキング ===== -->
  <section id="pageRank" style="display:none">
    <div class="ops">
      <button id="undoT">戻る</button>
      <button id="redoT">進む</button>
      <button id="wipeT">全削除</button>
    </div>
    <div class="rank-card">
      <h3>今月の順位（合計ポイント）</h3>
      <div id="rankGrid" class="rank-grid"></div>
      <div class="muted" style="margin-top:8px">
        ルール：完了=+10、復習+完了=+6、休日=0。クラスメイトは日替わりで自動スコア（擬似乱数・不正なし）。
      </div>
    </div>
  </section>

  <!-- ===== Page 4: セリフ編集 ===== -->
  <section id="pageEdit" style="display:none">
    <div class="ops">
      <span class="muted">各人：1行=1セリフ。空欄でミュート（発言しない）／0.6秒で自動保存</span>
      <button id="exportLines">💾 書き出し</button>
      <label>
        <input id="importLinesFile" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('importLinesFile').click()">📥 読込</button>
      </label>
    </div>
    <div class="grid-edit" id="editGrid"></div>
  </section>

  <button class="fab" id="fabHome" title="ホームへ"><span>🐹</span></button>

<script>
(function(){
  'use strict';

  const KEY='studyplanner.v15.ocr';
  const NAME_KEY='studyplanner.displayName';
  const LINES_KEY='studyplanner.v15.lines';
  const BOOST_KEY='studyplanner.v15.classBoost';
  const SUBJ_KEY='studyplanner.v15.subjects';
  const TT_KEY='studyplanner.v15.tt'; // 時間割
  const LAST_VIEW_KEY='studyplanner.v15.lastView'; // showAll保持

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[];
  let subjects = loadSubjects();
  let subject = subjects[0] || '世界史';
  let showAll = loadLastView(); // 全科目（一覧）

  /* ======= Auto Save (Page1) ======= */
  const AUTOSAVE_MS = 800;
  let autoSaveTimer = null;
  const currentKey = (s=subject)=> `${KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        const map = new Map();
        rows.forEach(r=>{
          const subj = r._subject || subject;
          if(!map.has(subj)) map.set(subj,[]);
          map.get(subj).push(stripSubject(r));
        });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      autoSaveTimer=null;
    }, AUTOSAVE_MS);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    if(showAll){
      const map = new Map();
      rows.forEach(r=>{
        const subj = r._subject || subject;
        if(!map.has(subj)) map.set(subj,[]);
        map.get(subj).push(stripSubject(r));
      });
      map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    }else{
      doSaveToLocal(subject, rows);
    }
  }
  window.addEventListener('beforeunload', flushAutoSave);

  /* ===== Undo/Redo ===== */
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({year,month,rows,subject,showAll}));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); ({year,month,rows,subject,showAll}=prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); ({year,month,rows,subject,showAll}=nxt); renderAll(); }

  /* ===== Utils ===== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'日月火水木金土'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}月${d.getDate()}日(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function ensureScaffoldFor(arr){
    const need=new Set(monthDates(year,month));
    const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'学習', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
  }
  function persist(rec){const i=rows.findIndex(x=>x.date===rec.date && (showAll? (x._subject===rec._subject):true)); if(i>=0) rows[i]=rec; else rows.push(rec);}
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }

  /* ===== 科目保存/読込 ===== */
  function loadSubjects(){
    try{
      const raw=localStorage.getItem(SUBJ_KEY);
      let arr = raw? JSON.parse(raw): null;
      if(!Array.isArray(arr) || arr.length===0) arr=['世界史','英語','数学'];
      return arr;
    }catch(_){ return ['世界史','英語','数学']; }
  }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function loadLastView(){ try{ return localStorage.getItem(LAST_VIEW_KEY)==='1'; }catch(_){ return false; } }
  function saveLastView(v){ try{ localStorage.setItem(LAST_VIEW_KEY, v?'1':'0'); }catch(_){} }
  function renderSubjectSelect(){
    const sel = $('#subjectSelect'); sel.innerHTML='';
    subjects.forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
    });
    if(!subjects.includes(subject)) subject=subjects[0];
    sel.value=subject;
  }

  /* ===== Page1 保存/読込 ===== */
  function save(){ pushHistory(); flushAutoSave(); alert('更新しました（この端末のブラウザ内）'); renderRank(); scrollTodayIntoView(); }
  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s));
    let arr=[];
    if(raw){ try{ arr = JSON.parse(raw)||[]; }catch(_){ } }
    ensureScaffoldFor(arr);
    return arr;
  }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr = loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r, _subject:sub}));
      });
      rows = merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
      return true;
    }else{
      rows = loadSubjectMonth(subject);
      return true;
    }
  }

  /* ===== ヘッダー生成 ===== */
  function renderHead(){
    const thead = $('#theadRow'); thead.innerHTML='';
    if(showAll){
      thead.innerHTML = `
        <th class="small">科目</th>
        <th class="medium">日付</th>
        <th class="small padL">種別</th>
        <th class="medium padL">目標（科目名）</th>
        <th class="medium padL">結果</th>
        <th class="medium padL">復習</th>
        <th class="small padL">色</th>
        <th class="small">操作</th>`;
    }else{
      thead.innerHTML = `
        <th class="medium">日付</th>
        <th class="small padL">種別</th>
        <th class="medium padL">目標（科目名）</th>
        <th class="medium padL">結果</th>
        <th class="medium padL">復習</th>
        <th class="small padL">色</th>
        <th class="small">操作</th>`;
    }
  }

  /* ===== Page1: 進捗描画 ===== */
  function rowThemeClass(subj){
    if(!subj) return '';
    if(subj==='英語') return 'subj-eng';
    if(subj==='数学') return 'subj-math';
    return '';
  }
  function renderProgress(){
    load();
    const days = monthDates(year,month).length;
    $('#label').textContent = showAll? `全科目 ${year}年${month+1}月（${days}日）` : `${subject} — ${year}年${month+1}月（${days}日）`;
    document.body.classList.toggle('theme-nl', showAll);

    renderHead();

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    // ビュー用リスト
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'学習', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach(r=>{
      const tr=document.createElement('tr');
      const subj = r._subject || subject;
      const themeClass = rowThemeClass(subj);
      if(themeClass) tr.classList.add(themeClass);

      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(r.date===todayStr) tr.classList.add('today');

      if(showAll){
        const tdSub=document.createElement('td'); tdSub.className='small'; tdSub.textContent=subj; tr.appendChild(tdSub);
      }

      const tdDate=document.createElement('td'); tdDate.className='medium'; tdDate.textContent=jpDateLabel(r.date);

      const tdType=document.createElement('td'); tdType.className='small padL';
      const wrap=document.createElement('div'); wrap.className='type-wrap';
      const badge=document.createElement('span'); badge.className='type-badge'; badge.textContent=(r.type==='休日')?'休日':(r.type==='復習'?'復習':'学習');
      const btn=document.createElement('button'); btn.className='type-toggle'; btn.type='button';
      btn.textContent=(r.type==='休日')?'学習にする':'休日にする';
      btn.addEventListener('click',()=>{ pushHistory(); r.type=(r.type==='休日')?'学習':'休日'; persist(r); touch(); renderProgress(); renderRank(); });
      wrap.appendChild(badge); wrap.appendChild(btn); tdType.appendChild(wrap);

      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='例：世界史 23〜24';
      inGoal.value=r.goal||''; inGoal.addEventListener('input',e=>{ pushHistory(); r.goal=e.target.value; persist(r); touch(); });
      tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='実績';
      inRes.value=r.result||''; inRes.addEventListener('input',e=>{ pushHistory(); r.result=e.target.value; persist(r); touch(); });
      tdRes.appendChild(inRes);

      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='復習範囲';
      inRev.value=r.review||''; inRev.addEventListener('input',e=>{ pushHistory(); r.review=e.target.value; persist(r); touch(); });
      tdRev.appendChild(inRev);

      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'通常'}, {v:'gray',t:'完了'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{ pushHistory(); r.color=e.target.value; persist(r); touch(); renderProgress(); renderRank(); });
      tdClr.appendChild(selClr);

      /* 右端：完了ボタン（行の移動なし・色だけ付ける／今日の行に軽く合わせ） */
      const tdOps=document.createElement('td'); tdOps.className='small';
      const btnDone=document.createElement('button'); btnDone.className='btn-done'; btnDone.textContent='完了';
      btnDone.addEventListener('click',()=>{
        pushHistory();
        r.color='gray';
        persist(r); touch(); renderProgress(); renderRank();
        setTimeout(scrollTodayIntoView,0);
      });
      tdOps.appendChild(btnDone);

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdClr); tr.appendChild(tdOps);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`本日: ${t.getMonth()+1}月${t.getDate()}日(${jpWeek(t)})`;
    scrollTodayIntoView();
    renderTimetable();
    // 一覧ボタンの見た目
    $('#btnToggleAll').classList.toggle('active', showAll);
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead');
    const todayRow=scroller.querySelector('tr.today');
    if(!todayRow || !thead) return;
    const headerH=thead.getBoundingClientRect().height;
    const rowTop=todayRow.offsetTop;
    scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'instant'});
  }

  /* ===== 取り込み ===== */
  function normalizeDateToken(raw){
    if(!raw) return null;
    let s = String(raw).trim();
    s = s.replace(/（.*?）|\(.*?\)/g,'');
    s = s.replace(/[．。・‒–—―〜～]/g,'-');
    let m = s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/);
    if(m){ return {y:+m[1], mo:+m[2]-1, d:+m[3]}; }
    m = s.match(/^(\d{1,2})\s*(?:\/|月)\s*(\d{1,2})/);
    if(m){ const y = year; return {y, mo:+m[1]-1, d:+m[2]}; }
    return null;
  }
  function clean(v){ const s = String(v ?? '').trim(); if(!s) return ''; if(/^(nan|null|undefined)$/i.test(s)) return ''; return s; }
  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const sep = (text.indexOf('\t')!==-1) ? '\t' : ',';
    const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header = lines[0].split(sep).map(s=>s.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {}; header.forEach((h,i)=> obj[h] = (cells[i]??'').trim());
      return obj;
    });
    return {header, rows};
  }

  function parseTypeImport(text){
    const lines = (text||'').replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    let applied=0;
    for(const ln of lines){
      const parts = ln.split(/[\s,　\t]+/).filter(Boolean);
      if(parts.length<2) continue;
      const dtk = normalizeDateToken(parts[0]); if(!dtk) continue;
      let typ = parts[1].replace(/\s/g,'').trim();
      if(typ==='休み') typ='休日';
      if(!/^(学習|休日|復習)$/.test(typ)) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      if(showAll){ alert('全科目（一覧）では貼付取込は不可です。科目を選んでください。'); return 0; }
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(rec){ pushHistory(); rec.type=typ; persist(rec); applied++; }
    }
    if(applied) touch();
    return applied;
  }

  function importCsvText(text){
    const {header, rows:objs} = parseDelimited(text);
    const col = {};
    header.forEach(h=>{
      if(/日付/.test(h)) col.date=h;
      if(/種別/.test(h)) col.type=h;
      if(/目標/.test(h)) col.goal=h;
      if(/結果/.test(h)) col.result=h;
      if(/復習/.test(h)) col.review=h;
    });
    if(!col.date || !col.type){ alert('CSV見出しを確認してください（少なくとも「日付」「種別」）'); return 0; }
    if(showAll){ alert('全科目（一覧）ではCSV取込は不可です。科目を選んでください。'); return 0; }

    let applied=0;
    for(const o of objs){
      const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(!rec) continue;

      let t = clean(o[col.type]);
      if(t==='休み') t='休日';
      if(/^(学習|休日|復習)$/.test(t)) { pushHistory(); rec.type=t; }
      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);

      persist(rec); applied++;
    }
    if(applied) touch();
    return applied;
  }

  function looksLikeColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if (L.length < 12) return false;
    const i = L.findIndex(s => s.includes('日付'));
    if (i < 0 || i + 4 >= L.length) return false;
    const head = L.slice(i, i+5);
    const need = ['日付','種別','目標','結果','復習'];
    if (!need.every((w,idx)=> (head[idx]||'').includes(w))) return false;
    return L.slice(i+5).some(s => /^\d{1,2}[\/\-月]\d{1,2}/.test(s) || /^\d{4}-\d{2}-\d{2}$/.test(s));
  }
  function parseColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const i = L.findIndex(s => s.includes('日付'));
    const data = L.slice(i+5);
    const rows = [];
    let block = {};
    let ptr = 0;
    for (const line of data){
      if (['日付','種別','目標','結果','復習'].includes(line)) continue;
      if (ptr === 0){ block={}; block['日付']=line; ptr=1; continue; }
      if (ptr === 1){ block['種別']=line; ptr=2; continue; }
      if (ptr === 2){ block['目標']=line; ptr=3; continue; }
      if (ptr === 3){ block['結果']=line; ptr=4; continue; }
      if (ptr === 4){ block['復習']=line; rows.push(block); ptr=0; continue; }
    }
    if (ptr !== 0){
      block['目標'] = block['目標'] ?? '';
      block['結果'] = block['結果'] ?? '';
      block['復習'] = block['復習'] ?? '';
      rows.push(block);
    }
    return { header:['日付','種別','目標','結果','復習'], rows };
  }
  function importAnyText(text){
    try{
      const n = importCsvText(text);
      if (n>0){ touch(); return n; }
    }catch(_){}
    if (looksLikeColumnBlocks(text)){
      if(showAll){ alert('全科目（一覧）では取込できません。科目を選んでください。'); return 0; }
      const parsed = parseColumnBlocks(text);
      let applied=0;
      const col = {date:'日付', type:'種別', goal:'目標', result:'結果', review:'復習'};
      for (const o of parsed.rows){
        const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
        if (dtk.y !== year || dtk.mo !== month) continue;
        const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
        const rec = rows.find(x=>x.date===ds); if(!rec) continue;

        let t = clean(o[col.type]);
        if (t==='休み') t='休日';
        if (/^(学習|休日|復習)$/.test(t)) { pushHistory(); rec.type=t; }
        rec.goal   = clean(o[col.goal]);
        rec.result = clean(o[col.result]);
        rec.review = clean(o[col.review]);
        persist(rec); applied++;
      }
      if(applied) touch();
      return applied;
    }
    return 0;
  }

  async function ocrImage(file){
    try{
      const worker = await Tesseract.createWorker('jpn');
      const { data:{ text } } = await worker.recognize(file);
      await worker.terminate();
      return text;
    }catch(e){
      try{
        const worker = await Tesseract.createWorker('eng');
        const { data:{ text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
      }catch(err){
        throw e;
      }
    }
  }

  /* ===== Page3: ランキング ===== */
  function myMonthlyPoints(){
    let total=0;
    const base = loadSubjectMonth(subject);
    monthDates(year,month).forEach(date=>{
      const r=base.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray'){
        if(r.type==='復習') total+=6;
        else if(r.type==='学習') total+=10;
      }
    });
    return total;
  }
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  function classmatesMonthlyPoints(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='橋本淑雅').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=10; else if(r>0.50) sum+=6;});
      if(name==='望月亜希子') sum += 20 + Math.floor(rnd()*10);
      return {name, pts:sum};
    });
  }
  function renderRank(){
    const meName=(($('#displayName').value)||'橋本淑雅').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyPoints();
    const fifth = [...rivals].sort((a,b)=>b.pts-a.pts)[4]?.pts ?? 0;
    rivals = rivals.map(p=> p.name==='望月亜希子' && p.pts<=fifth ? {...p, pts:fifth+1} : p);
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    const grid=$('#pageRank #rankGrid'); if(grid){
      grid.innerHTML='';
      list.forEach((p,i)=>{
        const div=document.createElement('div'); div.className='rank-item';
        div.innerHTML=`<div class="rank-row">
          <div class="rank-no">${i+1}位</div>
          <div class="grow"><strong>${p.name}</strong></div>
          <div>${p.pts} pt</div>
        </div>`;
        grid.appendChild(div);
      });
    }
  }

  /* ===== Page2: クラスメート ===== */
  const CLASSMATES = [
    '橋本淑雅','望月亜希子',
    '永田秀仁','高橋','嶋康','田中','池之内英明','加藤','佐々木','富田雄二','富島雅人','成木洋平','唐杉先生',
    'ぷろたん','大森元木','橋本範之','米山隆一','ひろゆき',
    '綾瀬はるか','永野芽郁','石原さとみ','北川景色','有村架純
