<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆé–“é€²æ—ï¼‹C(ğŸ«)ï¼‹T(ğŸ†)</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --done-bg:#b0a89f; --done-text:#000000; /* ã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢ç° */
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
    --male:#2563eb; --female:#f97316;
    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;
    --scale: 1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:0.72;}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale));display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"],input[type="number"],input[type="time"],textarea,select{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  input[type="text"], input[type="time"], textarea, select{width:100%; cursor:text}
  textarea{min-height:120px;resize:vertical}
  input[type="number"]{width:7em}
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .pill{border-radius:999px;padding:6px 10px;font-size:14px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;background:#fff;cursor:pointer}

  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  .pager{display:none} /* â† æˆ»ã‚‹ï¼é€²ã‚€ï¼ˆãƒšãƒ¼ã‚¸ç§»å‹•ï¼‰ã¯éè¡¨ç¤ºã« */

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:calc(84vh*var(--scale));}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:calc(8px*var(--scale));border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:700;font-size:calc(12px*var(--scale));color:#111;
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow);
  }
  tr:hover td{background:#f9fafb}
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.done td{background:var(--done-bg)!important;color:var(--done-text)!important}

  /* åˆ—å¹…ãƒ»æƒãˆï¼ˆã‚ºãƒ¬è§£æ¶ˆï¼‰ */
  .col-date{width:160px}
  .col-type{width:120px}
  .col-goal,.col-result,.col-review{width:1fr}
  .col-color{width:120px}
  .col-donebtn{width:120px}
  .cell{display:flex;align-items:center;gap:8px}
  .cell input[type="text"]{width:100%}
  .type-toggle{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:12px;cursor:pointer}

  /* subject color tint (æ¿ƒæ·¡) */
  .tinted td{background:var(--tint) !important}

  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;-webkit-user-select:none;
    right:14px;bottom:14px
  }
  .fab:hover{transform:translateY(-1px)} .fab:active{transform:translateY(0)}
  .fab span{font-size:22px;line-height:1}

  /* Classroom */
  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:100px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)}
  .desk.female .name{color:var(--female)}

  .bubble{
    position:absolute;left:8px;right:8px;top:8px;
    border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:10px 12px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);
    display:none;max-width:unset;white-space:pre-line
  }
  .bubble::after{content:"";position:absolute;left:22px;bottom:-10px;border-width:10px 10px 0 10px;border-style:solid;border-color:var(--bubble-gen-bd) transparent transparent transparent}
  .bubble::before{content:"";position:absolute;left:22px;bottom:-9px;border-width:9px 9px 0 9px;border-style:solid;border-color:var(--bubble-gen-bg) transparent transparent transparent}
  .bubble.famous{background:var(--bubble-fam-bg);border-color:var(--bubble-fam-bd)}
  .bubble.famous::after{border-top-color:var(--bubble-fam-bd)}
  .bubble.famous::before{border-top-color:var(--bubble-fam-bg)}
  .bubble.show{display:block;animation:fadeIn .15s ease}
  .bubble.yell{font-size:22px;padding:16px 18px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  /* Rank */
  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-rules{font-size:13px;color:#374151;background:#f9fafb;border:1px dashed #d1d5db;border-radius:8px;padding:8px;margin-bottom:8px}
  .rank-grid{column-width:240px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}
  .rise2{background:#ffe4ef} /* +2ä»¥ä¸Šä¸Šæ˜‡ã§ãƒ”ãƒ³ã‚¯ */
  .rise5{background:#e1effe} /* +5ä»¥ä¸Šä¸Šæ˜‡ã§ãƒ–ãƒ«ãƒ¼ */

  .ops{display:flex;gap:8px;align-items:center;margin:6px 0 10px}

  /* Editor */
  .grid-edit{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .card h4{margin:0 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Timetable modal */
  .tt-wrap{margin-left:auto}
  .tt-open{border:1px solid var(--line);border-radius:999px;background:#fff;padding:6px 10px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-start;justify-content:center;padding:24px;z-index:50}
  .modal.show{display:flex}
  .panel{width:min(96vw,820px);max-height:80vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 24px 48px rgba(0,0,0,.2);padding:12px}
  .tt-grid{display:grid;grid-template-columns:110px 1fr 1fr 1fr; gap:8px; align-items:center}
  .tt-grid > div, .tt-row > div{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
  .tt-row{display:contents}
  .linklike{color:var(--accent);text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab" title="å­¦æ ¡">C ğŸ«</button>
    <button id="tabRank" class="tab" title="é †ä½">T ğŸ†</button>
    <button id="tabEdit" class="tab" title="ã‚»ãƒªãƒ•ç·¨é›†">S ğŸ’¬</button>
  </div>

  <!-- ===== Page 1: é€²æ— ===== -->
  <section id="pageProgress" style="display:block">
    <div class="ops">
      <button id="undoP">æˆ»ã‚‹</button>
      <button id="redoP">é€²ã‚€</button>
      <button id="wipeP">å…¨å‰Šé™¤</button>
    </div>

    <!-- ç§‘ç›®åˆ‡æ›¿ + å…¨ç§‘ç›®ï¼ˆğŸ“šãƒœã‚¿ãƒ³ï¼‰ + ã‚«ãƒ©ãƒ¼ + æ™‚é–“å‰²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="topbar" style="gap:12px; align-items:center">
      <div class="row" style="gap:8px">
        <label class="muted">ç§‘ç›®ï¼š</label>
        <select id="subjectSelect" style="width:auto"></select>
        <button id="addSubject">ï¼‹ç§‘ç›®è¿½åŠ </button>

        <button id="toggleAllBtn" class="chip" title="å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰"><span id="allIcon">ğŸ“š</span> å…¨ç§‘ç›®</button>
      </div>

      <!-- ğŸ¨ ã‚«ãƒ©ãƒ¼æ“ä½œ -->
      <div class="row" style="gap:8px">
        <span class="muted">ğŸ¨ ã‚«ãƒ©ãƒ¼ï¼š</span>
        <button class="chip preset" data-preset="redsox">Red Sox</button>
        <button class="chip preset" data-preset="bluejays">Blue Jays</button>
        <button class="chip preset" data-preset="dodgers">Dodgers</button>
        <button class="chip preset" data-preset="nl">NL All-Star</button>
        <input id="colorPicker" type="text" placeholder="#RRGGBB" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label>
        <input id="tintRange" type="range" min="0" max="90" value="18" style="width:140px">
        <button id="applyColor" class="chip">é©ç”¨</button>
      </div>

      <!-- ğŸ—“ æ™‚é–“å‰² -->
      <div class="tt-wrap">
        <button id="ttOpen" class="tt-open">ğŸ—“ æ™‚é–“å‰²ã‚’é–‹ã</button>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="primary">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
      <button id="save">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div class="topbar">
      <button id="importPaste">ğŸ“‹ è²¼ã‚Šä»˜ã‘å–è¾¼</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">ğŸ“„ CSV/TSV/TXTå–è¾¼</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">ğŸ–¼ ç”»åƒOCRå–è¾¼</button>
      </label>
      <span class="muted">è¦‹å‡ºã—ï¼š<code>æ—¥ä»˜, ç¨®åˆ¥, ç›®æ¨™, çµæœ, å¾©ç¿’</code></span>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <th class="col-date">æ—¥ä»˜</th>
            <th class="col-type">ç¨®åˆ¥</th>
            <th class="col-goal">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
            <th class="col-result">çµæœ</th>
            <th class="col-review">å¾©ç¿’</th>
            <th class="col-color">è‰²</th>
            <th class="col-donebtn">å®Œäº†</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ ===== -->
  <section id="pageClass" style="display:none">
    <div class="ops">
      <button id="undoC">æˆ»ã‚‹</button>
      <button id="redoC">é€²ã‚€</button>
      <button id="wipeC">å…¨å‰Šé™¤</button>
      <button id="shuffleSeat" class="chip">ğŸ”€ å¸­æ›¿ãˆ</button>
      <button id="toggleLayout" class="chip">M/F/M æ•´åˆ—</button>
    </div>
    <div class="blackboard">
      1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œ<span id="meOnBoard">æ©‹æœ¬æ·‘é›…</span>ã€ã‚’å¿œæ´ä¸­ï¼
      <span style="margin-left:10px" class="muted">é€Ÿã•%å¢—ã—ï¼š</span>
      <input id="boostInput" type="number" min="0" step="1" value="0" title="ä¾‹: 13 â†’ 13%é€Ÿã" style="width:8em">
      <button id="applyBoost">é©ç”¨</button>
      <span id="boostHint" class="muted"></span>
    </div>
    <div class="room"><div class="desks" id="desks"></div></div>
  </section>

  <!-- ===== Page 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== -->
  <section id="pageRank" style="display:none">
    <div class="ops">
      <button id="undoT">æˆ»ã‚‹</button>
      <button id="redoT">é€²ã‚€</button>
      <button id="wipeT">å…¨å‰Šé™¤</button>
    </div>
    <div class="rank-card">
      <div class="rank-rules" id="rankRules">
        <strong>ãƒã‚¤ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒ«</strong><br>
        ãƒ»å½“æ—¥ã€Œå®Œäº†ï¼ˆç°è‰²ï¼‰ã€ã«ã—ãŸå­¦ç¿’â€¦ +10 / å¾©ç¿’â€¦ +6ï¼ˆã€Œä¼‘æ—¥ã€ã¯ +0ï¼‰<br>
        ãƒ»æœ¬æ—¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŠ ç‚¹ã¯ <strong>18:00</strong> ã¾ã§ï¼ˆä»¥é™ã¯ç¿Œæ—¥ã«ç¹°è¶Šï¼‰<br>
        ãƒ»å­¦æ ¡å‹¢ã¯ 16â€“18æ™‚ã«åŠ ç‚¹ãŒä¼¸ã³ã‚„ã™ã„ï¼æµªäººãƒ»ç‹¬å­¦å‹¢ã¯åˆå‰ï½15æ™‚ã‚‚ä¼¸ã³ã‚„ã™ã„ï¼ˆç–‘ä¼¼ï¼‰<br>
        ãƒ»ä¸æ­£é˜²æ­¢ã®ãŸã‚ä¹±æ•°ãƒ™ãƒ¼ã‚¹ã€æ¯æ—¥ã‚†ã‚‰ãã¾ã™
      </div>
      <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
      <div id="rankGrid" class="rank-grid"></div>
      <div id="rankTicker" class="muted" style="margin-top:6px">â€¦æ›´æ–°ä¸­</div>
    </div>
  </section>

  <!-- ===== Page 4: ã‚»ãƒªãƒ•ç·¨é›† ===== -->
  <section id="pageEdit" style="display:none">
    <div class="ops">
      <button id="undoS">æˆ»ã‚‹</button>
      <button id="redoS">é€²ã‚€</button>
      <span class="muted">å„äººï¼š1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºæ¬„ã§ãƒŸãƒ¥ãƒ¼ãƒˆ</span>
      <span class="muted">ï¼ˆè‡ªå‹•ä¿å­˜ï¼šå…¥åŠ›åœæ­¢0.6ç§’ï¼‰</span>
      <button id="exportLines">ğŸ’¾ æ›¸ãå‡ºã—</button>
      <label>
        <input id="importLinesFile" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('importLinesFile').click()">ğŸ“¥ èª­è¾¼</button>
      </label>
    </div>
    <div class="grid-edit" id="editGrid"></div>
  </section>

  <!-- æ™‚é–“å‰²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="ttModal" class="modal" aria-hidden="true">
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong id="ttTitle">ä»Šæ—¥ã®æ™‚é–“å‰²</strong>
        <div class="row" style="gap:8px">
          <button id="ttAddRow" class="chip">ï¼‹è¡Œè¿½åŠ </button>
          <button id="ttSuggest" class="chip">ğŸ”€ è‡ªå‹•ææ¡ˆï¼ˆ20ä»¶ï¼‰</button>
          <button id="ttClose" class="chip">é–‰ã˜ã‚‹ âœ•</button>
        </div>
      </div>
      <div class="tt-grid" style="margin-top:8px">
        <div class="muted">é–‹å§‹</div>
        <div class="muted">çµ‚äº†</div>
        <div class="muted">å†…å®¹</div>
        <div class="muted">æ“ä½œ</div>
      </div>
      <div id="ttRows"></div>
      <div id="ttSuggestBar" class="row" style="gap:10px; align-items:center; margin-top:10px; display:none">
        <button id="ttPrev" class="chip">â—€ å‰</button>
        <span id="ttIndex" class="muted">1 / 20</span>
        <button id="ttNext" class="chip">æ¬¡ â–¶</button>
        <button id="ttApply" class="chip">âœ… æ¡ç”¨</button>
      </div>
      <div class="muted" style="margin-top:8px">ãƒ’ãƒ³ãƒˆï¼šå…¥åŠ›ã¯å³ä¿å­˜ï¼ææ¡ˆã‚’æ¡ç”¨ã—ã¦ã‹ã‚‰å¾®èª¿æ•´å¯èƒ½</div>
    </div>
  </div>

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';

  /* ===================== Keys ===================== */
  const KEY='studyplanner.v16';
  const NAME_KEY='studyplanner.displayName';
  const LINES_KEY='studyplanner.v16.lines';
  const BOOST_KEY='studyplanner.v16.classBoost';
  const SUBJ_KEY='studyplanner.v16.subjects';
  const COLOR_KEY='studyplanner.v16.subjectColors';
  const TT_KEY='studyplanner.v16.tt';   // æ™‚é–“å‰²ï¼ˆç§‘ç›®åˆ¥ï¼‰
  const DP_KEY='studyplanner.v16.dailyPoints'; // æ—¥åˆ¥ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æºã‚‰ãï¼‰

  /* ===================== State ===================== */
  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[];            // è¡¨ç¤ºãƒ»ç·¨é›†ä¸­ã®é…åˆ—ï¼ˆç§‘ç›® or å…¨ç§‘ç›®åˆæˆï¼‰
  let subjects = loadSubjects();
  let subject = subjects[0] || 'ä¸–ç•Œå²';
  let showAll = false;    // å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰
  let subjectColors = loadSubjectColors(); // subj -> {hex, tint}

  // Undo/Redoï¼ˆ4ãƒšãƒ¼ã‚¸ã‚‚å«ã‚ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({
    year,month,rows,subject,showAll, subjectColors, customLines
  }));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); Object.assign(window, prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); Object.assign(window, nxt); renderAll(); }

  /* ===================== Utils ===================== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function ensureScaffoldFor(arr){
    const need=new Set(monthDates(year,month));
    const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
  }
  function persist(rec){
    const i=rows.findIndex(x=>x.date===rec.date && (showAll? (x._subject===rec._subject):true));
    if(i>=0) rows[i]=rec; else rows.push(rec);
  }
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }

  /* ===================== Subjects & Colors ===================== */
  function loadSubjects(){
    try{ const raw=localStorage.getItem(SUBJ_KEY); const arr = raw? JSON.parse(raw): null; return (Array.isArray(arr)&&arr.length)?arr:['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; }
    catch(_){ return ['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; }
  }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function renderSubjectSelect(){
    const sel = $('#subjectSelect'); sel.innerHTML='';
    subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
    if(!subjects.includes(subject)) subject=subjects[0];
    sel.value=subject;
  }
  function loadSubjectColors(){
    try{ const raw=localStorage.getItem(COLOR_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; }
  }
  function saveSubjectColors(){ try{ localStorage.setItem(COLOR_KEY, JSON.stringify(subjectColors)); }catch(_){} }
  function colorFor(subj){
    const c = subjectColors[subj];
    if(c && c.hex){ const tint = Math.max(0, Math.min(90, c.tint ?? 18)); return {hex:c.hex, tint}; }
    // æ—¢å®šï¼ˆç§‘ç›®åã§è»½ãæŒ¯ã‚Šåˆ†ã‘ï¼‰
    if(/è‹±èª/.test(subj)) return {hex:'#BD3039', tint:18};       // Red Sox ãƒ¬ãƒƒãƒ‰
    if(/æ•°å­¦/.test(subj)) return {hex:'#134A8E', tint:18};       // Blue Jays ãƒ–ãƒ«ãƒ¼
    if(/ä¸–ç•Œå²/.test(subj)) return {hex:'#005A9C', tint:14};     // Dodgers ãƒã‚¤ãƒ“ãƒ¼å¯„ã‚Š
    return {hex:'#2563eb', tint:12};
  }
  function tintCss(hex, percent){
    // hex -> rgbaé¢¨ã§è–„ã‚èƒŒæ™¯
    const m = hex.replace('#','');
    const r=parseInt(m.slice(0,2),16), g=parseInt(m.slice(2,4),16), b=parseInt(m.slice(4,6),16);
    const a = Math.max(0, Math.min(1, percent/100));
    return `rgba(${r},${g},${b},${a})`;
  }

  /* ===================== Storage for Month ===================== */
  const AUTOSAVE_MS=800; let autoSaveTimer=null;
  const currentKey = (s=subject)=> `${KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date); return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        const map = new Map();
        rows.forEach(r=>{
          const subj = r._subject || subject;
          if(!map.has(subj)) map.set(subj,[]);
          map.get(subj).push(stripSubject(r));
        });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      autoSaveTimer=null;
    }, AUTOSAVE_MS);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    if(showAll){
      const map = new Map();
      rows.forEach(r=>{
        const subj = r._subject || subject;
        if(!map.has(subj)) map.set(subj,[]);
        map.get(subj).push(stripSubject(r));
      });
      map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    }else{
      doSaveToLocal(subject, rows);
    }
  }
  window.addEventListener('beforeunload', flushAutoSave);

  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s)); let arr=[];
    if(raw){ try{ arr = JSON.parse(raw)||[]; }catch(_){ } }
    ensureScaffoldFor(arr); return arr;
  }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr = loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r, _subject:sub}));
      });
      rows = merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
      return true;
    }else{
      rows = loadSubjectMonth(subject);
      return true;
    }
  }

  /* ===================== Page1 Render ===================== */
  function renderProgress(){
    load();
    const days = monthDates(year,month).length;
    $('#label').textContent = showAll? `å…¨ç§‘ç›® ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰` : `${subject} â€” ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰`;
    const thead = $('#theadRow');
    thead.innerHTML = `
      <th class="col-date">æ—¥ä»˜</th>
      <th class="col-type">ç¨®åˆ¥</th>
      <th class="col-goal">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
      <th class="col-result">çµæœ</th>
      <th class="col-review">å¾©ç¿’</th>
      <th class="col-color">è‰²</th>
      <th class="col-donebtn">å®Œäº†</th>`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    // è¡¨ç¤ºãƒªã‚¹ãƒˆ
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    // ç§‘ç›®è‰²
    const subjColor = colorFor(subject);
    const tintBg = tintCss(subjColor.hex, subjColor.tint);

    list.forEach((r,rowIndex)=>{
      const tr=document.createElement('tr');
      if(r.color==='gray' || r.type==='ä¼‘æ—¥') tr.classList.add('done');
      if(r.date===todayStr) tr.classList.add('today');
      if(!showAll){ tr.classList.add('tinted'); tr.style.setProperty('--tint', tintBg); }

      // å„ã‚»ãƒ«
      const tdDate = document.createElement('td'); tdDate.innerHTML = `<div class="cell">${jpDateLabel(r.date)}</div>`;
      const tdType = document.createElement('td');
      const typeBadge = (r.type==='ä¼‘æ—¥')?'ä¼‘æ—¥':(r.type==='å¾©ç¿’'?'å¾©ç¿’':'å­¦ç¿’');
      tdType.innerHTML = `<div class="cell"><span class="muted">${typeBadge}</span><button class="type-toggle">${r.type==='ä¼‘æ—¥'?'å­¦ç¿’ã«ã™ã‚‹':'ä¼‘æ—¥ã«ã™ã‚‹'}</button></div>`;

      const tdGoal=document.createElement('td');
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24'; inGoal.value=r.goal||'';
      tdGoal.appendChild(inGoal);

      const tdRes=document.createElement('td');
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾'; inRes.value=r.result||'';
      tdRes.appendChild(inRes);

      const tdRev=document.createElement('td');
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²'; inRev.value=r.review||'';
      tdRev.appendChild(inRev);

      const tdClr=document.createElement('td');
      const selClr=document.createElement('select');
      [{v:'normal',t:'é€šå¸¸'}, {v:'gray',t:'å®Œäº†'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t; if((r.color||'normal')===p.v) o.selected=true; selClr.appendChild(o);
      });
      tdClr.appendChild(selClr);

      const tdDone=document.createElement('td');
      const btnDone=document.createElement('button'); btnDone.className='chip'; btnDone.textContent='âœ… å®Œäº†';
      tdDone.appendChild(btnDone);

      // ã‚¯ãƒªãƒƒã‚¯ç³»
      tdType.querySelector('.type-toggle').addEventListener('click',()=>{
        pushHistory();
        r.type = (r.type==='ä¼‘æ—¥')?'å­¦ç¿’':'ä¼‘æ—¥';
        if(r.type==='ä¼‘æ—¥'){ r.color='gray'; } // ä¼‘æ—¥ã¯ç°è‰²ï¼†ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã—æ‰±ã„
        persist(r); touch(); renderProgress(); scrollTodayIntoView();
      });
      selClr.addEventListener('change',e=>{
        pushHistory(); r.color=e.target.value; if(r.color==='gray'){ /* å®Œäº†æ™‚ã®ã¿ãƒã‚¤ãƒ³ãƒˆå¯¾è±¡ */ }
        persist(r); touch(); renderProgress(); scrollTodayIntoView();
      });
      btnDone.addEventListener('click',()=>{
        pushHistory();
        r.color='gray'; // å®Œäº†ï¼ç°è‰²
        if(r.type==='ä¼‘æ—¥'){ r.type='ä¼‘æ—¥'; } // ä¼‘æ—¥ã¯+0ã€å­¦ç¿’/å¾©ç¿’ã¯æœˆæ¬¡é›†è¨ˆã§åŠ ç‚¹
        persist(r); touch(); renderProgress(); scrollTodayIntoView();
      });

      // å…¥åŠ›å¤‰æ›´
      const onInput=(field)=> (e)=>{ pushHistory(); r[field]=e.target.value; persist(r); touch(); };
      inGoal.addEventListener('input', onInput('goal'));
      inRes .addEventListener('input', onInput('result'));
      inRev .addEventListener('input', onInput('review'));

      // çŸ¢å°ã‚­ãƒ¼ç§»å‹•
      [inGoal,inRes,inRev,selClr,btnDone].forEach((el,colIndex)=>{
        el.dataset.rowIndex=rowIndex; el.dataset.colIndex=colIndex; // 0..4
        el.addEventListener('keydown', (ev)=>{
          const rIdx = +el.dataset.rowIndex, cIdx = +el.dataset.colIndex;
          let nr=rIdx, nc=cIdx;
          if(ev.key==='ArrowDown'){ nr=rIdx+1; }
          if(ev.key==='ArrowUp'){ nr=rIdx-1; }
          if(ev.key==='ArrowRight'){ nc=cIdx+1; }
          if(ev.key==='ArrowLeft'){ nc=cIdx-1; }
          if(ev.key==='Enter'){ nr=rIdx+1; }
          if(nr!==rIdx || nc!==cIdx){
            ev.preventDefault();
            const q=`[data-row-index="${nr}"][data-col-index="${nc}"]`;
            const next=tb.querySelector(q);
            if(next){ next.focus(); if(next.select) next.select(); }
          }
        });
      });

      tr.appendChild(tdDate); tr.appendChild(tdType); tr.appendChild(tdGoal);
      tr.appendChild(tdRes); tr.appendChild(tdRev); tr.appendChild(tdClr); tr.appendChild(tdDone);
      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;
    scrollTodayIntoView();
    renderTimetable(); // ç§‘ç›®ã«å¿œã˜ã¦
    highlightAllToggle();
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const thead=scroller.querySelector('thead'); const todayRow=scroller.querySelector('tr.today');
    if(!todayRow || !thead) return; const headerH=thead.getBoundingClientRect().height;
    const rowTop=todayRow.offsetTop; scroller.scrollTo({top:Math.max(0,rowTop-headerH-4), behavior:'instant'});
  }

  /* ===================== Import (CSV/Paste/OCR) ===================== */
  function normalizeDateToken(raw){
    if(!raw) return null; let s = String(raw).trim();
    s = s.replace(/ï¼ˆ.*?ï¼‰|\(.*?\)/g,''); s = s.replace(/[ï¼ã€‚ãƒ»â€’â€“â€”â€•ã€œï½]/g,'-');
    let m = s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/);
    if(m){ return {y:+m[1], mo:+m[2]-1, d:+m[3]}; }
    m = s.match(/^(\d{1,2})\s*(?:\/|æœˆ)\s*(\d{1,2})/);
    if(m){ const y = year; return {y, mo:+m[1]-1, d:+m[2]}; }
    return null;
  }
  function clean(v){ const s = String(v ?? '').trim(); if(!s) return ''; if(/^(nan|null|undefined)$/i.test(s)) return ''; return s; }
  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const sep = (text.indexOf('\t')!==-1) ? '\t' : ',';
    const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header = lines[0].split(sep).map(s=>s.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {}; header.forEach((h,i)=> obj[h] = (cells[i]??'').trim());
      return obj;
    });
    return {header, rows};
  }
  function parseTypeImport(text){
    const lines = (text||'').replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    let applied=0;
    for(const ln of lines){
      const parts = ln.split(/[\s,ã€€\t]+/).filter(Boolean);
      if(parts.length<2) continue;
      const dtk = normalizeDateToken(parts[0]); if(!dtk) continue;
      let typ = parts[1].replace(/\s/g,'').trim(); if(typ==='ä¼‘ã¿') typ='ä¼‘æ—¥';
      if(!/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(typ)) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯è²¼ä»˜ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸å¯ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return 0; }
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds); if(rec){ pushHistory(); rec.type=typ; persist(rec); applied++; }
    }
    if(applied) touch(); return applied;
  }
  function importCsvText(text){
    const {header, rows:objs} = parseDelimited(text);
    const col = {}; header.forEach(h=>{ if(/æ—¥ä»˜/.test(h)) col.date=h; if(/ç¨®åˆ¥/.test(h)) col.type=h; if(/ç›®æ¨™/.test(h)) col.goal=h; if(/çµæœ/.test(h)) col.result=h; if(/å¾©ç¿’/.test(h)) col.review=h; });
    if(!col.date || !col.type){ alert('CSVè¦‹å‡ºã—ã‚’ç¢ºèªï¼ˆå°‘ãªãã¨ã‚‚ã€Œæ—¥ä»˜ã€ã€Œç¨®åˆ¥ã€ï¼‰'); return 0; }
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯CSVå–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return 0; }
    let applied=0;
    for(const o of objs){
      const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds); if(!rec) continue;
      let t = clean(o[col.type]); if(t==='ä¼‘ã¿') t='ä¼‘æ—¥';
      if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }
      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);
      persist(rec); applied++;
    }
    if(applied) touch(); return applied;
  }
  function looksLikeColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if (L.length < 12) return false;
    const i = L.findIndex(s => s.includes('æ—¥ä»˜')); if (i < 0 || i + 4 >= L.length) return false;
    const head = L.slice(i, i+5); const need = ['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'];
    if (!need.every((w,idx)=> (head[idx]||'').includes(w))) return false;
    return L.slice(i+5).some(s => /^\d{1,2}[\/\-æœˆ]\d{1,2}/.test(s) || /^\d{4}-\d{2}-\d{2}$/.test(s));
  }
  function parseColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const i = L.findIndex(s => s.includes('æ—¥ä»˜')); const data = L.slice(i+5);
    const rows = []; let block = {}; let ptr = 0;
    for (const line of data){
      if (['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'].includes(line)) continue;
      if (ptr === 0){ block={}; block['æ—¥ä»˜']=line; ptr=1; continue; }
      if (ptr === 1){ block['ç¨®åˆ¥']=line; ptr=2; continue; }
      if (ptr === 2){ block['ç›®æ¨™']=line; ptr=3; continue; }
      if (ptr === 3){ block['çµæœ']=line; ptr=4; continue; }
      if (ptr === 4){ block['å¾©ç¿’']=line; rows.push(block); ptr=0; continue; }
    }
    if (ptr !== 0){ block['ç›®æ¨™']=block['ç›®æ¨™']??''; block['çµæœ']=block['çµæœ']??''; block['å¾©ç¿’']=block['å¾©ç¿’']??''; rows.push(block); }
    return { header:['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'], rows };
  }
  function importAnyText(text){
    try{ const n = importCsvText(text); if (n>0){ touch(); return n; } }catch(_){}
    if (looksLikeColumnBlocks(text)){
      if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return 0; }
      const parsed = parseColumnBlocks(text);
      let applied=0; const col = {date:'æ—¥ä»˜', type:'ç¨®åˆ¥', goal:'ç›®æ¨™', result:'çµæœ', review:'å¾©ç¿’'};
      for (const o of parsed.rows){
        const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
        if (dtk.y !== year || dtk.mo !== month) continue;
        const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
        const rec = rows.find(x=>x.date===ds); if(!rec) continue;
        let t = clean(o[col.type]); if (t==='ä¼‘ã¿') t='ä¼‘æ—¥';
        if (/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; }
        rec.goal   = clean(o[col.goal]); rec.result = clean(o[col.result]); rec.review = clean(o[col.review]);
        persist(rec); applied++;
      }
      if(applied) touch(); return applied;
    }
    return 0;
  }
  async function ocrImage(file){
    try{ const worker = await Tesseract.createWorker('jpn'); const { data:{ text } } = await worker.recognize(file); await worker.terminate(); return text; }
    catch(e){
      try{ const worker = await Tesseract.createWorker('eng'); const { data:{ text } } = await worker.recognize(file); await worker.terminate(); return text; }
      catch(err){ throw e; }
    }
  }

  /* ===================== My Points (Month) ===================== */
  function myMonthlyPoints(){
    let total=0; const base = loadSubjectMonth(subject);
    monthDates(year,month).forEach(date=>{
      const r=base.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray'){
        if(r.type==='å¾©ç¿’') total+=6;
        else if(r.type==='å­¦ç¿’') total+=10;
        else if(r.type==='ä¼‘æ—¥') total+=0;
      }
    });
    return total + getDailyPointsFor($('#displayName').value||'æ©‹æœ¬æ·‘é›…'); // ä»Šæ—¥ã®ã‚†ã‚‰ãã‚‚åŠ ç®—
  }

  /* ===================== Classmates & Lines (page2/4 ä¸€å…ƒ) ===================== */
  const CLASSMATES = [
    'æ©‹æœ¬æ·‘é›…','æœ›æœˆäºœå¸Œå­',
    'æ°¸ç”°ç§€ä»','é«˜æ©‹','å¶‹åº·','ç”°ä¸­','æ± ä¹‹å†…è‹±æ˜','åŠ è—¤','ä½ã€…æœ¨','å¯Œç”°é›„äºŒ','å¯Œå³¶é›…äºº','æˆæœ¨æ´‹å¹³','å”æ‰å…ˆç”Ÿ',
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','æ©‹æœ¬ç¯„ä¹‹','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€',
    'å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­'
  ];
  const FEMALES = new Set(['æœ›æœˆäºœå¸Œå­','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­']);
  const FAMOUS_SET = new Set([
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­',
    'æœ›æœˆäºœå¸Œå­'
  ]);

  // åˆæœŸæ—¢å®šã‚»ãƒªãƒ•ï¼ˆå…¨å“¡ç•°ãªã‚‹ç³»ã‚’å°‘é‡ãšã¤ï¼‰
  const DEFAULT_CUSTOM_LINES = (()=> {
    const meName = ($('#displayName')?.value)||'ã¨ã—ãã‚“';
    const gen = (a)=>a; // çŸ­ã
    return {
      'æ©‹æœ¬æ·‘é›…': gen(['ä»Šæ—¥ã®è‡ªåˆ†ã«å‹ã¨ã†ï¼','å°ã•ãªå®Œäº†ãŒå¤§ããªè‡ªä¿¡ã«ãªã‚‹ã‚ˆ','ä¼‘ã‚€ã®ã‚‚æˆ¦ç•¥ã ã‚ˆ']),
      'æœ›æœˆäºœå¸Œå­': gen(['ã‚ã€æ•™ç§‘æ›¸ãã“ï¼ä¸€ç·’ã«ã‚„ã‚ï¼Ÿ','ä»Šã“ã“è¸ã‚“å¼µã‚Œã°æ˜æ—¥ãŒæ¥½ã ã‚ˆ','ã¡ã‚‡ã£ã¨ä¼¸ã³ã¦ã‚‹ã€ã„ã„æ³¢ï¼']),
      'æ°¸ç”°ç§€ä»': gen(['å¾®ç©ã®ä¾‹é¡Œã“ã“é‡è¦','ä¼‘æ†©5åˆ†â†’å†é–‹ï¼','ç›®æ¬¡ã«å°ã¤ã‘ã¨ã‘ãƒ¼']),
      'é«˜æ©‹': gen(['æ­´å²ã¯å› æœã§è¦šãˆã‚‹æ´¾ï¼','èªå‘‚åˆã‚ã›ä½œã£ã¨ã„ãŸã‚ˆ','å›³éŒ²è¦‹ã‚‹ã¨è¨˜æ†¶ã«åˆºã•ã‚‹']),
      'å¶‹åº·': gen(['è‹±å˜èª10å€‹ã ã‘è¿½åŠ ã—ã‚ˆ','â€œchunkâ€ã§è¦šãˆã‚‹ã¨é€Ÿã„','ãƒãƒ¼ãƒˆã«æ˜Ÿå°ï¼']),
      'ç”°ä¸­': gen(['è³‡æ–™é›†ã®åœ°å›³ã€ç©´å ´ã ã','ã‚°ã‚°ã‚‰ãšã¾ãšè€ƒãˆã‚‹æ´¾','ä»Šæ—¥ã¯ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆå¤šã‚ã§']),
      'æ± ä¹‹å†…è‹±æ˜': gen(['ç¡çœ è² å‚µãŸã‚ãªã„ã§ã­','ç³–åˆ†ã‚ˆã‚Šã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼','å§¿å‹¢ã‚’ç«‹ã¦ç›´ã']),
      'åŠ è—¤': gen(['æ˜¨æ—¥ã‚ˆã‚Š+1ãƒšãƒ¼ã‚¸ï¼','ã‚ã‹ã‚‰ã‚“ã¯ãƒ¡ãƒ¢ã£ã¦å¾Œã§è³ªå•','æ›¸ã„ã¦è¦šãˆã‚‹â†’å£°ã«å‡ºã™']),
      'ä½ã€…æœ¨': gen(['ä»Šæ—¥ã®+10ptå–ã‚Šã«ã„ã“','ãƒ†ãƒ³ãƒå‡ºã™ãªã‚‰25åˆ†é›†ä¸­','ã‚¹ãƒãƒ›ã‚’è£è¿”ã—ï¼']),
      'å¯Œç”°é›„äºŒ': gen(['ä¸–ç•Œå²ã¯ã€Œæµã‚Œã€ã§','é©å‘½â†’ç”£æ¥­â†’å¸å›½ä¸»ç¾©ã®ç·š','å¹´å·ã¯åŒºåˆ‡ã£ã¦è¦šãˆã‚‹']),
      'å¯Œå³¶é›…äºº': gen(['è‹±ä½œ1æ–‡ã€æ¨æ•²ã—ã‚ˆ','SVOCã®æ ¸ã‚’å¤ªå­—ã«ï¼','ä¾‹æ–‡ã¾ã‚‹ã”ã¨æš—å”±ï¼']),
      'æˆæœ¨æ´‹å¹³': gen(['æ¼¢æ–‡ã€è¿”ã‚Šç‚¹ãƒã‚¹ã‚¿ãƒ¼ä¼ç”»','ç´ èª­ã§ãƒªã‚ºãƒ æ´ã‚ã‚‹','èªå½™ã‚«ãƒ¼ãƒ‰æ›´æ–°ã—ãŸï¼Ÿ']),
      'å”æ‰å…ˆç”Ÿ': gen(['åŸºç¤ãŒæœ€å¼·ã®è¿‘é“ã ã','éŸ³èª­ã¯è£åˆ‡ã‚‰ã‚“','è³ªå•ã¯ã„ã¤ã§ã‚‚æ­“è¿ï¼']),
      'ã·ã‚ãŸã‚“': gen(['ç­‹ãƒˆãƒ¬ã‚‚å‹‰å¼·ã‚‚ç¶™ç¶šã‚²ãƒ¼ï¼','ç· åˆ‡ãƒ‰ãƒ¼ãƒ”ãƒ³ã‚°ç™ºå‹•ã ï¼','æ°´åˆ†è£œçµ¦ã—ã¦ã‘ãƒ¼']),
      'å¤§æ£®å…ƒæœ¨': gen(['ãƒŸã‚»ã‚¹è´ããªãŒã‚‰ã‚„ã‚‹ã‹ï¼','â€œé’ã¨å¤â€æµã™ï¼Ÿ','BPMã§ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­åˆ»ã‚‚ã†']),
      'æ©‹æœ¬ç¯„ä¹‹': gen(['è¨ˆç”»â†’å®Ÿè¡Œâ†’æŒ¯ã‚Šè¿”ã‚Šã®ä¸‰æ®µ','æœªå®Œäº†ã¯ç¿Œæ—¥ã«é€ƒãŒã™ã ã‘','ç„¦ã‚‰ãšå‰é€²']),
      'ç±³å±±éš†ä¸€': gen(['ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®èƒŒæ™¯ã‚’ä¸€æ¬¡è³‡æ–™ã§','çµ±è¨ˆã¯ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ï¼','ç–‘ã†â†’ç¢ºã‹ã‚ã‚‹â†’ç´å¾—']),
      'ã²ã‚ã‚†ã': gen(['ãã‚Œã£ã¦ã‚ãªãŸã®æ„Ÿæƒ³ã§ã™ã‚ˆã­ï¼Ÿâ†’ãƒ‡ãƒ¼ã‚¿å‡ºãã†','ã‚³ã‚¹ãƒ‘è‰¯ãã„ã“ã†','çµè«–ã‹ã‚‰æ›¸ãã¨èª­ã¿ã‚„ã™ã„']),
      'ç¶¾ç€¬ã¯ã‚‹ã‹': gen(['æ·±å‘¼å¸ã—ã¦ã„ã“ã£','å§¿å‹¢ãã‚Œã„ï¼','å¿œæ´ã—ã¦ã‚‹ã‚ˆ']),
      'æ°¸é‡èŠ½éƒ': gen(['é›†ä¸­ã‚¹ã‚¤ãƒƒãƒå…¥ã‚Œã‚ˆï¼Ÿ','ã‚³ãƒ¼ãƒ’ãƒ¼æ·¹ã‚Œã‚ˆã£ã‹','ãã®èª¿å­ï¼']),
      'çŸ³åŸã•ã¨ã¿': gen(['åŒºåˆ‡ã£ã¦ã„ã‘ã°çµ¶å¯¾ã§ãã‚‹','é¡”ä¸Šã’ã¦ã€å‰è¦‹ã¦ã­','ç›®æ¨™ã€å£°ã«å‡ºã—ã¦ã¿ã‚ˆ']),
      'åŒ—å·æ™¯è‰²': gen(['é™ã‹ã«ç‡ƒãˆã¦ã‚‹æ„Ÿã˜å¥½ã','ä»Šã¯åŸºç¤ã«æŠ•è³‡ã®æ™‚æœŸ','æ‰‹å…ƒã®ãƒ¡ãƒ¢ç¾ã—ã„']),
      'æœ‰æ‘æ¶ç´”': gen(['ä¸€ç·’ã«ãŒã‚“ã°ã‚ã£','ä¼‘æ†©ã¯æ‚ªã˜ã‚ƒãªã„','ãˆã‚‰ã„ã€ã¡ã‚ƒã‚“ã¨ã‚„ã£ã¦ã‚‹']),
      'é•·æ¾¤ã¾ã•ã¿': gen(['ä»Šæ—¥ã®ãƒ™ã‚¹ãƒˆã‚’ç©ã¿ä¸Šã’ã‚ˆ','ç¬‘ã£ã¦ã‚„ã‚‹ã®ãŒæœ€å¼·','è² ã‘ãªã„ï¼']),
      'åºƒç€¬ã™ãš': gen(['ã‚„ã‚Œã°ã§ãã‚‹ã®è¨¼æ˜ä¸­','1å•ã‚¯ãƒªã‚¢ã§è‡ªä¿¡1å€‹UP','æ°´åˆ†ã¨ã‚ï¼']),
      'æ·±ç”°æ­å­': gen(['è‡ªåˆ†ç”˜ã‚„ã‹ã—ã™ããªã„ç¨‹åº¦ã«','ã§ã‚‚å„ªã—ãã­','ç„¡ç†ã—ãªã„å‹‡æ°—']),
      'æœ¬ç”°ç¿¼': gen(['ã‚²ãƒ¼ãƒ æ„Ÿè¦šã§é€²æ—ç¨¼ã”ï¼','ã‚¯ã‚¨ã‚¹ãƒˆå—æ³¨ã ãƒ¼','ãƒ‰ãƒ­ãƒƒãƒ—ç‹™ã„ï¼']),
      'æ': gen(['æœã®å…‰ã€å¥½ãã ã­','ãƒãƒ¼ãƒˆã«ä½™ç™½ã¤ãã‚','å°ã•ãã¦ã‚‚ä»Šæ—¥ã®å‹ã¡ã‚’']),
      'æœ¨æ‘æ–‡ä¹ƒ': gen(['æ·¡ã€…ã¨ã‚„ã‚‹äººãŒçµå±€å‹ã¤','å™¨ç”¨ã˜ã‚ƒãªãã¦ã„ã„','ç¶šã‘ã‚‹ã‚»ãƒ³ã‚¹']),
      'å„ªé¦™': gen(['ä½“æ¸©ã‚ã¦é›†ä¸­åŠ›UP','ç¬‘ã†ã¨è¡€æµã‚ãŒã‚‹ã‚ˆ','è‚©å›ã—ã¦ã“ï¼']),
      'ç”Ÿç”°çµµæ¢¨èŠ±': gen(['éŸ³ã§è¦šãˆã‚‹ã®ã‚‚æ‰‹ã ã‚ˆ','ãƒªã‚ºãƒ ç·´ã‚‹ã¨æ—ã‚‹','åŒºåˆ‡ã‚Šã”ã¨ã«æ‹']),
      'ä¸Šæˆ¸å½©': gen(['â€œä»Šã‚„ã‚‹â€ã®ãŒä¸€ç•ªæ—©ã„','æœªæ¥ã®è‡ªåˆ†ãŒå–œã¶ã‚ˆ','ã„ã‘ã‚‹ã„ã‘ã‚‹ï¼']),
      'èœã€…ç·’': gen(['è¨€ã„è¨³ã€ã‚¼ãƒ­ã§ã„ã“ï¼Ÿ','çµæœã§èªã‚‹æ—¥','è‡ªåˆ†ã«å¼·ã']),
      'å†…ç”°æœ‰ç´€': gen(['ç´™ã«æ›¸ãã¨æ•´ç†ã§ãã‚‹','è¦–è¦šåŒ–ã¯æ­¦å™¨','ã‚¿ã‚¹ã‚¯åˆ†è§£ã—ã‚ˆ']),
      'å¤šéƒ¨æœªè¯å­': gen(['æ¯”å–©ã§è¦šãˆã‚‹ã¨å¿˜ã‚Œã«ãã„','ã‚¤ãƒ¡ãƒ¼ã‚¸å¤§äº‹','å›³è§£ã¤ãã‚']),
      'æˆ¸ç”°æµæ¢¨é¦™': gen(['èªå½™ã®æ£®ã«æ¢æ¤œã ','æ´¾ç”Ÿèªã¾ã¨ã‚ã‚ˆ','èªæºã¯ç‰©èª']),
      'åºƒç€¬ã‚¢ãƒªã‚¹': gen(['ç¬‘ã£ã¦ã‚„ã‚ãƒ¼ãœ','è©°ã¾ã£ãŸã‚‰æ·±å‘¼å¸','ã‚„ã‚Œã°ã§ãã‚‹ï¼']),
      'å‰é«˜ç”±é‡Œå­': gen(['ãƒãƒªã¨å‹¢ã„ã‚‚å¤§åˆ‡','ã¾ãšæ‰‹ã‚’å‹•ã‹ã','å®Œç’§ã‚ˆã‚Šå‰é€²'])
    };
  })();

  let customLines = loadCustomLines();
  function loadCustomLines(){
    try{
      const raw=localStorage.getItem(LINES_KEY);
      if(raw){ return JSON.parse(raw)||{}; }
      // åˆå›ï¼šæ—¢å®šã‚’ä¿å­˜ã—ã¦ä½¿ã†ï¼ˆå…¨å“¡ã“ã¨ãªã‚‹ï¼‰
      try{ localStorage.setItem(LINES_KEY, JSON.stringify(DEFAULT_CUSTOM_LINES)); }catch(_){}
      return JSON.parse(JSON.stringify(DEFAULT_CUSTOM_LINES));
    }catch(_){ return JSON.parse(JSON.stringify(DEFAULT_CUSTOM_LINES)); }
  }
  function saveCustomLines(){ try{ localStorage.setItem(LINES_KEY, JSON.stringify(customLines)); }catch(_){} }
  let lineAutosaveTimer=null;
  function scheduleLinesSave(){ if(lineAutosaveTimer) clearTimeout(lineAutosaveTimer); lineAutosaveTimer=setTimeout(()=>{ saveCustomLines(); }, 600); }

  function getLinesFor(name){
    const arr = Array.isArray(customLines[name]) ? customLines[name] : [];
    return arr.length ? arr.slice() : [];
  }

  const recentLines = [];
  function lineFor(name){
    const pool = getLinesFor(name);
    if(pool.length===0) return null;
    let msg = pool[Math.floor(Math.random()*pool.length)];
    let guard = 0;
    while(recentLines.includes(msg) && guard++<10){
      msg = pool[Math.floor(Math.random()*pool.length)];
    }
    recentLines.push(msg); if(recentLines.length>24) recentLines.shift();
    return msg;
  }

  // ãƒ©ãƒ³ãƒ€ãƒ å¼·åŒ–ï¼šãŸã¾ã«å·¨å¤§å«ã³
  function randomIsYell(){ return Math.random() < 0.14; }

  /* ===================== Classroom ===================== */
  let classTicker = null; const lastSpokenAt = new Map(); let layoutMode='MFM'; // or 'shuffle'
  function factorFromBoost(k){ return 1 / (1 + Math.max(0, Number(k)||0)/100); }
  function getBoost(){ const v = Number($('#boostInput').value)||0; return Math.max(0, v); }
  function visibleDurationMs(){ return Math.round(2600 * factorFromBoost(getBoost())); }
  function cooldownMs(){ return Math.max(700, Math.round(visibleDurationMs()*0.9)); }
  function baseTickMs(){ return Math.max(200, Math.round(800 * factorFromBoost(getBoost()))); }
  function randomEmissionCount(){ const r=Math.random(); if(r<0.15) return 0; if(r<0.45) return 1; if(r<0.80) return 2; if(r<0.96) return 3; return 4; }

  function arrangeNamesMFM(){
    const males = CLASSMATES.filter(n=>!FEMALES.has(n));
    const females = CLASSMATES.filter(n=>FEMALES.has(n));
    const half = Math.ceil(males.length/2);
    const col1 = males.slice(0, half);
    const col3 = males.slice(half);
    const col2 = females;
    const rows = Math.max(col1.length, col2.length, col3.length);
    const arranged = [];
    for(let i=0;i<rows;i++){
      if(col1[i]) arranged.push(col1[i]);
      if(col2[i]) arranged.push(col2[i]);
      if(col3[i]) arranged.push(col3[i]);
    }
    return arranged;
  }
  function buildClassroom(){
    const desks=$('#desks'); if(!desks) return; desks.innerHTML='';
    const names = (layoutMode==='MFM') ? arrangeNamesMFM() : shuffle(CLASSMATES.slice());
    names.forEach((name)=>{
      const d=document.createElement('div'); d.className='desk';
      d.classList.add(FEMALES.has(name)?'female':'male');
      d.innerHTML = `
        <div class="name">${name}</div>
        <div class="role">${name==='æ©‹æœ¬æ·‘é›…'?'ï¼ˆã‚ãªãŸï¼‰':'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ'}</div>
        <div class="bubble"></div>`;
      d.addEventListener('click',()=> showBubble(d, name));
      desks.appendChild(d);
    });
  }
  function showBubble(deskEl, name){
    const bubble = deskEl.querySelector('.bubble'); if(!bubble) return;
    const msg = lineFor(name); if(msg === null){ bubble.classList.remove('show'); return; }
    const isFamous = FAMOUS_SET.has(name);
    bubble.className = 'bubble' + (isFamous ? ' famous' : '') + (randomIsYell() ? ' yell':'');
    // å¤§å¹…ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—è€…ã‹ã‚‰ã®å¿œæ´ãƒ–ãƒ¼ã‚¹ãƒˆ
    const cheer = getCheerPrefixFor(name);
    bubble.textContent = cheer ? `${cheer}`.replace('{me}', $('#displayName').value||'ã¨ã—ãã‚“') + '\n' + msg : msg;
    bubble.classList.add('show');
    const vms = visibleDurationMs();
    setTimeout(()=> bubble.classList.remove('show'), vms);
    lastSpokenAt.set(name, Date.now());
  }
  function tickOnce(){
    const desks = Array.from(document.querySelectorAll('#desks .desk'));
    if(desks.length===0) return;
    const now = Date.now();
    const count = randomEmissionCount();
    const candidates = desks
      .map(el=>({el, name: el.querySelector('.name')?.textContent || ''}))
      .filter(x=>x.name && (!lastSpokenAt.has(x.name) || (now - (lastSpokenAt.get(x.name)||0) > cooldownMs())))
      .filter(x=> (getLinesFor(x.name).length>0));
    for(let i=0; i<count && candidates.length>0; i++){
      const idx = Math.floor(Math.random()*candidates.length);
      const pick = candidates.splice(idx,1)[0];
      showBubble(pick.el, pick.name);
    }
  }
  function startClassTicker(){ stopClassTicker(); classTicker = setInterval(tickOnce, baseTickMs()); }
  function stopClassTicker(){ if(classTicker){ clearInterval(classTicker); classTicker=null; } }
  function restartClassTicker(){ stopClassTicker(); startClassTicker(); }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  /* ===================== Editor (Page4) ===================== */
  function renderEditPage(){
    const grid = $('#editGrid'); if(!grid) return;
    grid.innerHTML='';
    CLASSMATES.forEach(name=>{
      const card=document.createElement('div'); card.className='card';
      const id='ta_'+btoa(unescape(encodeURIComponent(name))).replace(/=+/g,'');
      const lines = getLinesFor(name);
      const text = lines.join('\n');
      card.innerHTML=`
        <h4>${name}</h4>
        <textarea id="${id}" placeholder="1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºãªã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆ">${escapeHtml(text)}</textarea>
        <div class="row">
          <button data-name="${name}" class="btnClear chip">ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆç©ºã«ï¼‰</button>
          <span class="muted">ç¾åœ¨ ${lines.length} ä»¶</span>
        </div>`;
      grid.appendChild(card);
      const ta = card.querySelector('textarea');
      ta.addEventListener('input', ()=>{
        pushHistory();
        const v=String(ta.value||''); const arr=v.split('\n').map(s=>s.trim()).filter(Boolean);
        customLines[name]=arr; scheduleLinesSave();
      });
      card.querySelector('.btnClear').addEventListener('click',()=>{
        pushHistory(); customLines[name]=[]; const ta2=card.querySelector('textarea'); ta2.value=''; scheduleLinesSave();
      });
    });
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  $('#exportLines').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(customLines, null, 2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='class_lines.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  $('#importLinesFile').addEventListener('change',async(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{ const txt=await f.text(); const obj=JSON.parse(txt);
      if(obj && typeof obj==='object'){ pushHistory(); customLines=obj; saveCustomLines(); renderEditPage(); }
    }catch(_){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    e.target.value='';
  });

  /* ===================== Rank ===================== */
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  function classmatesMonthlyBase(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=10; else if(r>0.50) sum+=6;});
      if(name==='æœ›æœˆäºœå¸Œå­') sum += 20 + Math.floor(rnd()*10); // æœ›æœˆã•ã‚“å¼·åŒ–
      return {name, pts:sum};
    });
  }

  // æ—¥åˆ¥ã‚†ã‚‰ãï¼ˆ18æ™‚ã¾ã§ãƒ©ã‚¤ãƒ–ï¼‰ã‚’ä¿æŒ
  function loadDailyPoints(){
    try{ const raw=localStorage.getItem(DP_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; }
  }
  function saveDailyPoints(obj){ try{ localStorage.setItem(DP_KEY, JSON.stringify(obj)); }catch(_){} }
  function getDailyPointsFor(name){
    const all=loadDailyPoints(); const today=ymd(new Date());
    return (all[today]?.[name])||0;
  }
  function addDailyPoints(name, delta){
    const all=loadDailyPoints(); const today=ymd(new Date());
    if(!all[today]) all[today]={}; all[today][name]=(all[today][name]||0)+delta; saveDailyPoints(all);
  }

  let lastOrder = []; // å‰å›ã®ä¸¦ã³ï¼ˆé †ä½å¤‰å‹•è¡¨ç¤ºç”¨ï¼‰
  function renderRank(){
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyBase();

    // æ—¥åˆ¥ã‚†ã‚‰ãã‚’åˆç®—
    const allDP = loadDailyPoints(); const today=ymd(new Date());
    rivals = rivals.map(p=> ({...p, pts:p.pts + ((allDP[today]?.[p.name])||0)}));
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    const nowOrder = list.map(p=>p.name);
    const grid=$('#pageRank #rankGrid'); grid.innerHTML='';

    list.forEach((p,i)=>{
      const was = lastOrder.indexOf(p.name);
      const delta = (was>=0) ? (was - i) : 0; // ä¸ŠãŒã£ãŸã‚‰ + å€¤

      const div=document.createElement('div'); div.className='rank-item';
      if(delta>=5) div.classList.add('rise5'); else if(delta>=2) div.classList.add('rise2');

      div.innerHTML=`<div class="rank-row">
        <div class="rank-no">${i+1}ä½</div>
        <div class="grow"><strong>${p.name}</strong></div>
        <div>${p.pts} pt</div>
      </div>`;
      grid.appendChild(div);
      if(delta>=2) flagCheer(p.name, delta); // å¿œæ´ãƒ•ãƒ©ã‚°ï¼ˆæ•™å®¤ã§åŠ±ã¾ã—ï¼‰
    });
    lastOrder = nowOrder;
    $('#rankTicker').textContent = 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆã€œ18:00ï¼‰ç¨¼åƒä¸­';
  }

  // 18:00ã¾ã§ãƒ©ãƒ³ãƒ€ãƒ ã§åŠ ç‚¹ï¼ˆå­¦æ ¡å‹¢ã¯å¤•æ–¹ã«ä¼¸ã³ã‚„ã™ã„ï¼‰
  function rankLiveTick(){
    const hour=(new Date()).getHours();
    const cutOff = hour>=18;
    if(cutOff){ $('#rankTicker').textContent='æœ¬æ—¥ã®ãƒ©ã‚¤ãƒ–åŠ ç‚¹ã¯çµ‚äº†ï¼ˆä»¥é™ã¯ç¿Œæ—¥ã«åæ˜ ï¼‰'; return; }
    const pool = CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…');
    // æ™‚é–“å¸¯ã§é‡ã¿
    const isSchoolTime = (hour>=16 && hour<18);
    const isMorning = (hour>=8 && hour<12);
    const nChanges = isSchoolTime? 4 : (isMorning? 3 : 2);
    for(let i=0;i<nChanges;i++){
      const name = pool[Math.floor(Math.random()*pool.length)];
      const delta = isSchoolTime? (Math.random()<0.5? 6:10) : (Math.random()<0.5? 0:6);
      if(delta>0) addDailyPoints(name, delta);
    }
    renderRank();
  }
  setInterval(rankLiveTick, 30000); // 30ç§’ãŠã

  // å¿œæ´ãƒ•ãƒ©ã‚°â†’æ•™å®¤ã§ã‚»ãƒªãƒ•å‰ç½®ã
  const cheerers = new Set();
  function flagCheer(name, delta){ if(delta>=5){ cheerers.add(name+'+5'); } else if(delta>=2){ cheerers.add(name+'+2'); } }
  function getCheerPrefixFor(name){
    const me = $('#displayName').value||'ã¨ã—ãã‚“';
    if(cheerers.has(name+'+5')) return `ã€æ€¥ä¸Šæ˜‡ã€‘{me}ã€ã“ã“ã‹ã‚‰ä¸€æ°—ã«æ±ºã‚ã‚ˆã†ï¼`;
    if(cheerers.has(name+'+2')) return `ã€é †ä½â†‘ã€‘{me}ã€ã„ã„æµã‚Œã ã­ï¼`;
    return '';
  }

  /* ===================== Timetable (modal) ===================== */
  function ttKey(s=subject){ return `${TT_KEY}:${s}`; }
  function loadTT(s=subject){ try{ const raw=localStorage.getItem(ttKey(s)); return raw? JSON.parse(raw): []; }catch(_){ return []; } }
  function saveTT(s=subject, data){ try{ localStorage.setItem(ttKey(s), JSON.stringify(data)); }catch(_){} }
  function renderTimetable(){
    const title = $('#ttTitle'); title.textContent = `${subject} ã®ä»Šæ—¥ã®æ™‚é–“å‰²`;
    const rowsEl = $('#ttRows'); rowsEl.innerHTML='';
    const data = loadTT(subject);
    data.forEach((item,idx)=>{
      const row = document.createElement('div'); row.className='tt-row';
      row.innerHTML = `
        <div><input type="time" value="${item.start||''}"></div>
        <div><input type="time" value="${item.end||''}"></div>
        <div><input type="text" placeholder="ä½•ã‚’ã™ã‚‹ï¼Ÿ" value="${escapeHtml(item.title||'')}"></div>
        <div>
          <span class="linklike" data-act="up">â†‘</span>
          <span class="linklike" data-act="down" style="margin-left:8px">â†“</span>
          <span class="linklike" data-act="del" style="margin-left:8px">å‰Šé™¤</span>
        </div>`;
      const inputs = row.querySelectorAll('input');
      inputs[0].addEventListener('input',()=>{ item.start = inputs[0].value; saveTT(subject, data); });
      inputs[1].addEventListener('input',()=>{ item.end   = inputs[1].value; saveTT(subject, data); });
      inputs[2].addEventListener('input',()=>{ item.title = inputs[2].value; saveTT(subject, data); });
      row.querySelector('[data-act="del"]').addEventListener('click',()=>{ data.splice(idx,1); saveTT(subject, data); renderTimetable(); });
      row.querySelector('[data-act="up"]').addEventListener('click',()=>{ if(idx>0){ const t=data[idx-1]; data[idx-1]=data[idx]; data[idx]=t; saveTT(subject, data); renderTimetable(); }});
      row.querySelector('[data-act="down"]').addEventListener('click',()=>{ if(idx<data.length-1){ const t=data[idx+1]; data[idx+1]=data[idx]; data[idx]=t; saveTT(subject, data); renderTimetable(); }});
      rowsEl.appendChild(row);
    });
  }
  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
  const modal=$('#ttModal');
  $('#ttOpen').addEventListener('click',()=>{ modal.classList.add('show'); renderTimetable(); });
  $('#ttClose').addEventListener('click',()=> modal.classList.remove('show'));
  modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('show'); });

  // è¡Œè¿½åŠ 
  $('#ttAddRow').addEventListener('click',()=>{
    const data = loadTT(subject); data.push({start:'', end:'', title:''}); saveTT(subject, data); renderTimetable();
  });

  // ææ¡ˆ20ä»¶
  let suggestions=[]; let sugIndex=0;
  function generateSuggestions(){
    // ã ã„ãŸã„ä»Šæ—¥ã®ä»Šã‹ã‚‰ or 09:00é–‹å§‹ ã€œ 18:00ã¾ã§ã§å¯å¤‰
    const baseStart = new Date(); baseStart.setMinutes( baseStart.getMinutes()>0 ? Math.ceil(baseStart.getMinutes()/5)*5 : 0 );
    const startHour = Math.max(9, baseStart.getHours());
    const dayStart = new Date(); dayStart.setHours(startHour, 0, 0, 0);
    const endHour = 18;

    function slotsMake(seed){
      const rng = seedRand(seed); const blocks=[];
      let t = new Date(dayStart);
      const subs = shuffle(subjects.slice());
      while(t.getHours() < endHour){
        const dur = [25,30,40,45,50,60][Math.floor(rng()*6)];
        const nt = new Date(t.getTime() + dur*60000);
        const s = String(t.getHours()).padStart(2,'0')+':'+String(t.getMinutes()).padStart(2,'0');
        const e = String(nt.getHours()).padStart(2,'0')+':'+String(nt.getMinutes()).padStart(2,'0');
        const pick = subs[Math.floor(rng()*subs.length)];
        const label = (rng()<0.5? 'å¾©ç¿’':'å­¦ç¿’') + 'ï¼š' + pick;
        blocks.push({start:s,end:e,title:label});
        t = new Date(nt.getTime()+ (rng()<0.4? 5:10)*60000); // ä¼‘æ†©
      }
      return blocks.slice(0, Math.min(9, blocks.length));
    }
    const list=[]; for(let i=0;i<20;i++) list.push(slotsMake(Date.now()+i*97));
    return list;
  }
  $('#ttSuggest').addEventListener('click',()=>{
    suggestions = generateSuggestions(); sugIndex=0;
    $('#ttSuggestBar').style.display='flex';
    previewSuggestion();
  });
  function previewSuggestion(){
    const data = suggestions[sugIndex]||[];
    const rowsEl = $('#ttRows'); rowsEl.innerHTML='';
    data.forEach(item=>{
      const row=document.createElement('div'); row.className='tt-row';
      row.innerHTML=`
        <div>${item.start}</div>
        <div>${item.end}</div>
        <div>${escapeHtml(item.title)}</div>
        <div class="muted">ææ¡ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>`;
      rowsEl.appendChild(row);
    });
    $('#ttIndex').textContent = `${sugIndex+1} / ${suggestions.length}`;
  }
  $('#ttPrev').addEventListener('click',()=>{ if(sugIndex>0){ sugIndex--; previewSuggestion(); }});
  $('#ttNext').addEventListener('click',()=>{ if(suggestions && sugIndex<suggestions.length-1){ sugIndex++; previewSuggestion(); }});
  $('#ttApply').addEventListener('click',()=>{
    const data = suggestions[sugIndex]||[];
    saveTT(subject, data); renderTimetable(); alert('ææ¡ˆã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã“ã“ã‹ã‚‰ç·¨é›†ã§ãã¾ã™ã€‚');
  });

  /* ===================== Events / Buttons ===================== */
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY);
    const me = saved || 'æ©‹æœ¬æ·‘é›…';
    $('#displayName').value = me;
    $('#meOnBoard').textContent = me;
  })();
  $('#saveName').addEventListener('click',()=>{
    const me = ($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim();
    localStorage.setItem(NAME_KEY, me);
    $('#meOnBoard').textContent = me;
    renderRank();
  });

  // ã‚¿ãƒ–
  $('#tabProgress').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));
  $('#tabEdit').addEventListener('click',()=>showPage('edit'));
  function setActiveTab(t1,t2,t3,t4){
    $('#tabProgress').classList.toggle('active', t1);
    $('#tabClass').classList.toggle('active', t2);
    $('#tabRank').classList.toggle('active', t3);
    $('#tabEdit').classList.toggle('active', t4);
  }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit');
    const show = (a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); stopClassTicker(); renderProgress(); }
    if(which==='class'){ show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); buildClassroom(); restartClassTicker(); }
    if(which==='rank'){ show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); stopClassTicker(); renderRank(); }
    if(which==='edit'){ show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); stopClassTicker(); renderEditPage(); }
  }

  // æœˆç§»å‹•
  $('#prev').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} renderProgress(); renderRank(); });
  $('#next').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} renderProgress(); renderRank(); });

  // ä¿å­˜/èª­è¾¼
  $('#save').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); renderRank(); scrollTodayIntoView(); });
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); renderRank(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // ä¸€è¦§è¡¨ç¤º(ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ)
  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  // å–è¾¼
  $('#importPaste').addEventListener('click',()=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
    const text = prompt('æ—¥ä»˜ã¨ç¨®åˆ¥ã®ä¸€è¦§ã‚„ã€ç¸¦ä¸€åˆ—ã®è¡¨ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: 8/13(æ—¥) ä¼‘æ—¥ ãªã©ï¼‰'); if(!text) return;
    pushHistory(); const n = parseTypeImport(text) || importAnyText(text);
    renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  });
  $('#importFile').addEventListener('change',async (e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
    pushHistory(); const n= importAnyText(txt);
    renderProgress(); renderRank(); alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    e.target.value='';
  });
  $('#importImg').addEventListener('change',async (e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ä¸å¯ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text = await ocrImage(f);
      pushHistory(); const n = importAnyText(text) || parseTypeImport(text||'');
      renderProgress(); renderRank();
      alert(n?`OCRå–è¾¼ã§å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'æ–‡å­—ãŒèªè­˜ã§ããªã„ã‹ã€å½“æœˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }catch(_){ alert('OCRã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã®é®®æ˜ã•ãƒ»ç…§æ˜ãƒ»å‚¾ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); }
    finally{ e.target.value=''; }
  });

  // Undo/Redoï¼ˆP/C/T/Sï¼‰
  $('#undoP').onclick = $('#undoC').onclick = $('#undoT').onclick = $('#undoS').onclick = ()=>{ undo(); setTimeout(scrollTodayIntoView,0); };
  $('#redoP').onclick = $('#redoC').onclick = $('#redoT').onclick = $('#redoS').onclick = ()=>{ redo(); setTimeout(scrollTodayIntoView,0); };
  $('#wipeP').onclick = ()=>{ if(confirm((showAll?'å…¨ç§‘ç›®ã®ä»Šæœˆè¡Œã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚':'å½“æœˆã®é€²æ—ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚')+'\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
      pushHistory();
      if(showAll){
        subjects.forEach(sub=>{
          const arr = loadSubjectMonth(sub);
          monthDates(year,month).forEach(ds=>{
            const r=arr.find(x=>x.date===ds);
            if(r){ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; }
          });
          doSaveToLocal(sub, arr);
        });
      }else{
        rows.forEach(r=>{ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; });
        touch();
      }
      renderProgress(); renderRank();
    } };
  $('#wipeC').onclick = ()=>{ if(confirm('Cãƒšãƒ¼ã‚¸ã®ç™ºè©±çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ recentLines.length=0; lastSpokenAt.clear(); buildClassroom(); } };
  $('#wipeT').onclick = ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ')){ renderRank(); } };

  // ğŸ¹ï¼ãƒ›ãƒ¼ãƒ ï¼†ä»Šæ—¥ã¸
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });

  // Rï¼å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹ï¼‰
  $('#reloadBtn').addEventListener('click',()=>{
    const url = location.pathname + '?r=' + Date.now(); location.replace(url);
  });

  // â‘¡ãƒšãƒ¼ã‚¸ é€Ÿã•%å¢—ã—
  (function initBoost(){
    const saved = localStorage.getItem(BOOST_KEY);
    const v = saved ? Number(saved) : 0;
    $('#boostInput').value = String(isFinite(v)?v:0);
    updateBoostHint();
  })();
  function updateBoostHint(){ const v = getBoost(); $('#boostHint').textContent = `ï¼ˆç¾åœ¨: ${v}%å¢—ã— / é–“éš”ã¨å¹ãå‡ºã—æ™‚é–“ã‚’çŸ­ç¸®ï¼‰`; }
  $('#applyBoost').addEventListener('click',()=>{
    const v = getBoost(); localStorage.setItem(BOOST_KEY, String(v)); updateBoostHint(); restartClassTicker();
  });
  $('#boostInput').addEventListener('change',()=>{
    const v = getBoost(); localStorage.setItem(BOOST_KEY, String(v)); updateBoostHint(); restartClassTicker();
  });

  // å¸­æ›¿ãˆ/æ•´åˆ—
  $('#shuffleSeat').addEventListener('click',()=>{ layoutMode='shuffle'; buildClassroom(); });
  $('#toggleLayout').addEventListener('click',()=>{ layoutMode=(layoutMode==='MFM'?'shuffle':'MFM'); buildClassroom(); });

  // å…¨ç§‘ç›®ãƒœã‚¿ãƒ³
  function highlightAllToggle(){ $('#allIcon').textContent = showAll? 'ğŸ“–':'ğŸ“š'; $('#toggleAllBtn').classList.toggle('primary', showAll); }
  $('#toggleAllBtn').addEventListener('click',()=>{ pushHistory(); showAll=!showAll; renderProgress(); highlightAllToggle(); });

  // ç§‘ç›®é¸æŠ
  $('#addSubject').addEventListener('click',()=>{
    const name = prompt('è¿½åŠ ã™ã‚‹ç§‘ç›®åï¼ˆä¾‹ï¼šè‹±èªï¼‰'); if(!name) return;
    const trimmed = name.trim(); if(!trimmed) return;
    if(subjects.includes(trimmed)){ alert('ãã®ç§‘ç›®ã¯ã™ã§ã«ã‚ã‚Šã¾ã™'); return; }
    subjects.push(trimmed); saveSubjects(); renderSubjectSelect();
    subject = trimmed; showAll=false; renderProgress();
  });
  $('#subjectSelect').addEventListener('change', e=>{ pushHistory(); subject = e.target.value; showAll=false; renderProgress(); });

  // ã‚«ãƒ©ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ
  const PRESETS = {
    redsox:  {hex:'#BD3039', tint:18},           // Boston Red Sox (red)
    bluejays:{hex:'#134A8E', tint:18},           // Toronto Blue Jays (royal blue)
    dodgers: {hex:'#005A9C', tint:16},           // LA Dodgers (dodger blue/navy)
    nl:      {hex:'#13274F', tint:14},           // NL All-Star é¢¨ãƒã‚¤ãƒ“ãƒ¼
  };
  document.querySelectorAll('.preset').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const key=btn.dataset.preset; const p=PRESETS[key];
      $('#colorPicker').value = p.hex; $('#tintRange').value = p.tint;
    });
  });
  $('#applyColor').addEventListener('click',()=>{
    const hex = ($('#colorPicker').value||'').trim();
    const tint = +$('#tintRange').value||18;
    if(!/^#?[0-9a-fA-F]{6}$/.test(hex)){ alert('HEXã‚«ãƒ©ãƒ¼ã‚’ #RRGGBB ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    const hx = hex.startsWith('#')? hex : ('#'+hex);
    subjectColors[subject] = {hex:hx, tint: Math.max(0,Math.min(90,tint))};
    saveSubjectColors(); renderProgress();
  });

  /* ===================== Init ===================== */
  function renderAll(){
    renderSubjectSelect();
    const p1 = $('#pageProgress').style.display!=='none';
    const p2 = $('#pageClass').style.display!=='none';
    const p3 = $('#pageRank').style.display!=='none';
    const p4 = $('#pageEdit').style.display!=='none';
    if(p1) renderProgress();
    if(p2) { buildClassroom(); restartClassTicker(); }
    if(p3) renderRank();
    if(p4) renderEditPage();
    highlightAllToggle();
  }
  (function init(){
    renderSubjectSelect();
    load(); renderProgress(); document.body.classList.add('compact'); renderRank();
    setTimeout(scrollTodayIntoView,0);
  })();

})();
</script>
</body>
</html>
