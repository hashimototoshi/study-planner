<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆé–“é€²æ—ï¼‹C(ğŸ«)ï¼‹T(ğŸ†)</title>

<!-- OCRï¼ˆiPadå®Œçµï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff;
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;
    --scale:1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:.82}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale));display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"],input[type="number"],textarea,select{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  textarea{width:100%;min-height:120px;resize:vertical;cursor:text}
  input[type="number"]{width:7em}
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .pill{border-radius:999px;padding:6px 10px;font-size:14px}
  .chip{border-radius:999px;padding:6px 10px;border:1px solid var(--line);background:#fff;font-size:14px}
  .chip.active{background:#eef2ff;border-color:#c7d2fe}

  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:calc(84vh*var(--scale))}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:calc(8px*var(--scale));border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:calc(12px*var(--scale));color:var(--muted);
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow)
  }
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}

  .type-buttons{display:flex;gap:6px}
  .col-date{width:calc(150px*var(--scale))}
  .col-type{width:calc(190px*var(--scale))}
  .col-goal,.col-result,.col-review{width:calc(210px*var(--scale))}
  .col-donebtn{width:calc(110px*var(--scale))}

  .cell{display:flex;align-items:center;gap:6px}

  /* ä¸Šéƒ¨ï¼šã‚«ãƒ©ãƒ¼ï¼†ãƒã‚¤ãƒ³ãƒˆè¨­å®š */
  .cfg{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .box{border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff;display:flex;gap:8px;align-items:center}
  .swatch{width:20px;height:20px;border-radius:6px;border:1px solid #ccc}
  .range{width:120px}

  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;-webkit-user-select:none;right:14px;bottom:14px
  }
  .fab span{font-size:22px;line-height:1}

  /* Page2 */
  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:110px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .bubble{
    position:absolute;left:8px;right:8px;top:8px;border:1px solid #d6e6ff;background:#f4f8ff;border-radius:12px;padding:8px 10px;font-size:14px;box-shadow:0 6px 12px rgba(0,0,0,.06);
    display:none;white-space:pre-line
  }
  .bubble.show{display:block;animation:fadeIn .15s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  /* Page3 */
  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-grid{column-width:240px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}

  /* Page4 */
  .grid-edit{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .card h4{margin:0 0 6px}

  /* +pt ã‚¢ãƒ‹ãƒ¡ */
  .pop{
    position:fixed;pointer-events:none;z-index:99;
    background:rgba(0,0,0,.75);color:#fff;padding:.25rem .5rem;border-radius:999px;font-weight:700;
    transform:translate(-50%,-50%);animation:popfade 1.2s ease forwards
  }
  @keyframes popfade{
    0%{opacity:0;transform:translate(-50%,-20px) scale(.9)}
    10%{opacity:1;transform:translate(-50%,-28px) scale(1)}
    100%{opacity:0;transform:translate(-50%,-64px) scale(1.05)}
  }
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab">C ğŸ«</button>
    <button id="tabRank" class="tab">T ğŸ†</button>
    <button id="tabEdit" class="tab">S ğŸ’¬</button>
  </div>

  <!-- ===== Page 1: é€²æ— ===== -->
  <section id="pageProgress" style="display:block">
    <div class="topbar">
      <button id="undoP">æˆ»ã‚‹</button>
      <button id="redoP">é€²ã‚€</button>
      <button id="wipeP">å…¨å‰Šé™¤</button>
      <span class="muted">çŸ¢å°ã‚­ãƒ¼ã§ä¸Šä¸‹å·¦å³ã«ç§»å‹•ã§ãã¾ã™</span>
    </div>

    <!-- ç§‘ç›®/å…¨ç§‘ç›® + ã‚«ãƒ©ãƒ¼ï¼†ãƒã‚¤ãƒ³ãƒˆè¨­å®š -->
    <div class="topbar cfg">
      <div class="box">
        <span class="muted">ç§‘ç›®ï¼š</span>
        <select id="subjectSelect"></select>
        <button id="addSubject">ï¼‹ç§‘ç›®è¿½åŠ </button>
        <button id="toggleAllBtn" class="pill" title="å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰">ğŸ“š å…¨ç§‘ç›®</button>
      </div>

      <div class="box">
        <strong>ç§‘ç›®ã‚«ãƒ©ãƒ¼</strong>
        <div class="swatch" id="swSub"></div>
        <input id="subHex" type="text" value="#005A9C" style="width:100px">
        <input id="subTint" class="range" type="range" min="5" max="95" value="18" title="æ¿ƒæ·¡">
        <button class="pill" id="presetRS">RedSox</button>
        <button class="pill" id="presetBJ">BlueJays</button>
        <button class="pill" id="presetDG">Dodgers</button>
        <button class="pill" id="presetAS">All-Star NL</button>
      </div>

      <div class="box">
        <strong>ã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢ï¼ˆä¼‘æ—¥/å®Œäº†ï¼‰</strong>
        <div class="swatch" id="swDone"></div>
        <input id="doneHex" type="text" value="#b0a89f" style="width:100px">
        <input id="doneTint" class="range" type="range" min="5" max="95" value="85" title="æ¿ƒæ·¡">
      </div>

      <div class="box">
        <strong>ãƒã‚¤ãƒ³ãƒˆ</strong>
        <span class="muted">å­¦ç¿’ å®Œäº†ï¼š</span><input id="ptStudy" type="number" value="10" style="width:72px">
        <span class="muted">å¾©ç¿’ å®Œäº†ï¼š</span><input id="ptReview" type="number" value="6" style="width:72px">
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="primary">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
      <button id="save">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div class="topbar">
      <button id="importPaste">ğŸ“‹ è²¼ã‚Šä»˜ã‘å–è¾¼</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">ğŸ“„ CSV/TSV/TXTå–è¾¼</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">ğŸ–¼ ç”»åƒOCRå–è¾¼</button>
      </label>
      <span class="muted">è¦‹å‡ºã—ï¼š<code>æ—¥ä»˜, ç¨®åˆ¥(å­¦ç¿’/ä¼‘æ—¥/å¾©ç¿’), ç›®æ¨™, çµæœ, å¾©ç¿’</code></span>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <!-- å…¨ç§‘ç›®ONæ™‚ã¯å…ˆé ­ã«â€œç§‘ç›®â€åˆ—ãŒè¶³ã•ã‚Œã¾ã™ -->
            <th class="col-date">æ—¥ä»˜</th>
            <th class="col-type">ç¨®åˆ¥</th>
            <th class="col-goal">ç›®æ¨™</th>
            <th class="col-result">çµæœ</th>
            <th class="col-review">å¾©ç¿’</th>
            <th class="col-donebtn">å®Œäº†</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ ===== -->
  <section id="pageClass" style="display:none">
    <div class="topbar">
      <button id="undoC">æˆ»ã‚‹</button>
      <button id="redoC">é€²ã‚€</button>
      <button id="wipeC">å…¨å‰Šé™¤</button>
    </div>
    <div class="blackboard">
      1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œ<span id="meOnBoard">æ©‹æœ¬æ·‘é›…</span>ã€ã‚’å¿œæ´ä¸­ï¼
      <span class="muted" style="margin-left:10px">é€Ÿã•%å¢—ã—ï¼š</span>
      <input id="boostInput" type="number" min="0" step="1" value="0">
      <button id="applyBoost">é©ç”¨</button>
      <span id="boostHint" class="muted"></span>
    </div>
    <div class="room"><div class="desks" id="desks"></div></div>
  </section>

  <!-- ===== Page 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== -->
  <section id="pageRank" style="display:none">
    <div class="topbar">
      <button id="undoT">æˆ»ã‚‹</button>
      <button id="redoT">é€²ã‚€</button>
      <button id="wipeT">å…¨å‰Šé™¤</button>
    </div>
    <div class="rank-card">
      <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
      <div class="muted" style="margin:6px 0">
        ãƒ«ãƒ¼ãƒ«ï¼šå®Œäº†(å­¦ç¿’)=æ—¢å®š+10ã€å®Œäº†(å¾©ç¿’)=æ—¢å®š+6ã€ä¼‘æ—¥=0ã€‚<br>
        â€»ãƒœã‚¿ãƒ³ã§æ•°å€¤ã¯å¤‰æ›´å¯ï¼ã€Œä¼‘æ—¥ã€ã¯ç°è‰²è¡¨ç¤ºã§ã‚‚åŠ ç‚¹ãªã—ã€‚
      </div>
      <div id="rankGrid" class="rank-grid"></div>
    </div>
  </section>

  <!-- ===== Page 4: ã‚»ãƒªãƒ•ç·¨é›† ===== -->
  <section id="pageEdit" style="display:none">
    <div class="topbar">
      <button id="undoS">æˆ»ã‚‹</button>
      <button id="redoS">é€²ã‚€</button>
      <span class="muted">å„äººï¼š1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºæ¬„=ãƒŸãƒ¥ãƒ¼ãƒˆï¼0.6ç§’ã§ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–</span>
      <button id="exportLines">ğŸ’¾ æ›¸ãå‡ºã—</button>
      <label>
        <input id="importLinesFile" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('importLinesFile').click()">ğŸ“¥ èª­è¾¼</button>
      </label>
    </div>
    <div class="grid-edit" id="editGrid"></div>
  </section>

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';

  /* ==================== å®šæ•°/ä¿å­˜ã‚­ãƒ¼ ==================== */
  const KEY='studyplanner.v15.ocr';
  const NAME_KEY='studyplanner.displayName';
  const LINES_KEY='studyplanner.v15.lines';
  const BOOST_KEY='studyplanner.v15.classBoost';
  const SUBJ_KEY='studyplanner.v15.subjects';
  const TT_KEY='studyplanner.v15.tt';
  const COLOR_KEY='studyplanner.v15.colors';
  const PTS_KEY='studyplanner.v15.points';

  /* ==================== çŠ¶æ…‹ ==================== */
  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[];                   // ã„ã¾è¡¨ç¤ºã—ã¦ã„ã‚‹æœˆã®é…åˆ—ï¼ˆç§‘ç›® or å…¨ç§‘ç›®ï¼‰
  let subjects=loadSubjects();   // ['ä¸–ç•Œå²','è‹±èª',...]
  let subject=subjects[0]||'ä¸–ç•Œå²';
  let showAll=false;

  // ã‚«ãƒ©ãƒ¼è¨­å®š
  let colors = loadColors();     // { sub:{ç§‘ç›®:{hex,tint}}, done:{hex,tint} }
  let doneColor = colors.done || {hex:'#b0a89f', tint:85};

  // ãƒã‚¤ãƒ³ãƒˆ
  let pointCfg = loadPoints();   // {study:10, review:6}

  // Undo/Redo
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({year,month,rows,subject,showAll,colors,pointCfg}));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); Object.assign(stateFrom(prev), prev); renderAll(); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); Object.assign(stateFrom(nxt), nxt); renderAll(); }
  function stateFrom(s){return {year:s.year,month:s.month,rows:s.rows,subject:s.subject,showAll:s.showAll,colors:s.colors,pointCfg:s.pointCfg};}

  /* ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==================== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function mix(a,b,t){return Math.round(a*(1-t)+b*t);}
  function hex2rgb(hex){hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(x=>x+x).join(''); const n=parseInt(hex,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
  function tintCss(hex, tint){ // tint=ç™½ã¨ã®æ··åˆ(%)
    const t=Math.max(0,Math.min(100,Number(tint)||0))/100;
    const {r,g,b}=hex2rgb(hex); const R=mix(r,255,t), G=mix(g,255,t), B=mix(b,255,t);
    return `rgb(${R},${G},${B})`;
  }
  function showPop(target, text){
    const rect = target.getBoundingClientRect();
    const div = document.createElement('div');
    div.className='pop'; div.textContent=text;
    div.style.left = (rect.left + rect.width/2) + 'px';
    div.style.top  = (rect.top  - 6 + window.scrollY) + 'px';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),1200);
  }

  /* ==================== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ==================== */
  const AUTOSAVE_MS = 700;
  let autoSaveTimer=null;
  const currentKey=(s=subject)=> `${KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;

  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        // å…¨ç§‘ç›®ã¯åˆ†å‰²ä¿å­˜
        const map=new Map();
        rows.forEach(r=>{
          const subj=r._subject||subject;
          if(!map.has(subj)) map.set(subj,[]);
          const {_subject,np,...rest}=r;
          map.get(subj).push({...rest,np:!!np}); // np = noPoint(ä¼‘æ—¥ã§ç°è‰²ã ãŒåŠ ç®—ã—ãªã„)
        });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      // ä»˜éšè¨­å®š
      saveColors(colors); savePoints(pointCfg);
      autoSaveTimer=null;
    }, AUTOSAVE_MS);
  }
  function flushAutoSave(){ if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; } touch(); }

  function persist(rec){
    const idx=rows.findIndex(x=> x.date===rec.date && (showAll? (x._subject===rec._subject):true));
    if(idx>=0) rows[idx]=rec; else rows.push(rec);
  }

  function ensureScaffoldFor(arr){
    const need=new Set(monthDates(year,month));
    const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s));
    let arr=[]; if(raw){ try{ arr=JSON.parse(raw)||[]; }catch{} }
    ensureScaffoldFor(arr); return arr;
  }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr = loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r, _subject:sub}));
      });
      rows = merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
    }else{
      rows = loadSubjectMonth(subject);
    }
    return true;
  }

  function loadSubjects(){
    try{ const raw=localStorage.getItem(SUBJ_KEY); const arr=raw?JSON.parse(raw):null; return (Array.isArray(arr)&&arr.length)?arr:['ä¸–ç•Œå²','è‹±èª']; }catch(_){ return ['ä¸–ç•Œå²','è‹±èª']; }
  }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }

  function loadColors(){
    try{ const raw=localStorage.getItem(COLOR_KEY); const obj=raw?JSON.parse(raw):{}; return { sub:obj.sub||{}, done:obj.done||{hex:'#b0a89f',tint:85}}; }catch(_){ return {sub:{},done:{hex:'#b0a89f',tint:85}}; }
  }
  function saveColors(o){ try{ localStorage.setItem(COLOR_KEY, JSON.stringify(o)); }catch(_){} }
  function colorFor(subj){
    const d = colors.sub[subj] || {hex:'#005A9C', tint:18}; // æ—¢å®š=Dodgersçš„
    return d;
  }
  function loadPoints(){
    try{ const raw=localStorage.getItem(PTS_KEY); const o=raw?JSON.parse(raw):null; return o||{study:10, review:6}; }catch(_){ return {study:10, review:6}; }
  }
  function savePoints(o){ try{ localStorage.setItem(PTS_KEY, JSON.stringify(o)); }catch(_){} }

  /* ==================== Page1 ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ==================== */
  function renderSubjectSelect(){
    const sel=$('#subjectSelect'); sel.innerHTML='';
    subjects.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
    if(!subjects.includes(subject)) subject=subjects[0];
    sel.value=subject;
  }

  function renderProgress(opts={reload:true}){
    if(opts.reload) load();

    // è¦‹å‡ºã—
    const days=monthDates(year,month).length;
    $('#label').textContent = showAll? `å…¨ç§‘ç›® ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰` : `${subject} â€” ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰`;

    // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå…¨ç§‘ç›®ONãªã‚‰ç§‘ç›®åˆ—ã‚’è¿½åŠ ï¼‰
    const thead=$('#theadRow'); thead.innerHTML='';
    if(showAll){
      thead.innerHTML=`
        <th class="col-date">ç§‘ç›®</th>
        <th class="col-date">æ—¥ä»˜</th>
        <th class="col-type">ç¨®åˆ¥</th>
        <th class="col-goal">ç›®æ¨™</th>
        <th class="col-result">çµæœ</th>
        <th class="col-review">å¾©ç¿’</th>
        <th class="col-donebtn">å®Œäº†</th>`;
    }else{
      thead.innerHTML=`
        <th class="col-date">æ—¥ä»˜</th>
        <th class="col-type">ç¨®åˆ¥</th>
        <th class="col-goal">ç›®æ¨™</th>
        <th class="col-result">çµæœ</th>
        <th class="col-review">å¾©ç¿’</th>
        <th class="col-donebtn">å®Œäº†</th>`;
    }

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());
    const subjCol = colorFor(subject);
    const themeTint = tintCss(subjCol.hex, subjCol.tint);
    const doneTint  = tintCss(doneColor.hex, doneColor.tint);

    // è¡¨ç¤ºãƒªã‚¹ãƒˆï¼ˆå…¨ç§‘ç›®ONã®ã¨ãã¯æ—¥Ã—ç§‘ç›®ã§å±•é–‹ï¼‰
    let list=[];
    if(showAll){
      const need=monthDates(year,month);
      need.forEach(d=>{
        subjects.forEach(sub=>{
          const hit=rows.find(x=>x.date===d && x._subject===sub);
          list.push(hit || {_subject:sub,date:d,type:'å­¦ç¿’',goal:'',result:'',review:'',color:'normal'});
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach((r,rowIdx)=>{
      const tr=document.createElement('tr');

      // èƒŒæ™¯è‰²ï¼šä»Šæ—¥>å„ªå…ˆã€æ¬¡ã«ä¼‘æ—¥/å®Œäº†(ç°)ã€ãã®ä»–ã¯ç§‘ç›®è‰²ãƒ†ã‚£ãƒ³ãƒˆ
      const isHoliday = (r.type==='ä¼‘æ—¥');
      const isDone = isHoliday || (r.color==='gray');
      if(r.date===todayStr){ tr.classList.add('today'); }
      else{
        const tintColor = isDone ? doneTint : (showAll ? tintCss((colors.sub[r._subject||subject]?.hex)||subjCol.hex, (colors.sub[r._subject||subject]?.tint)||subjCol.tint) : themeTint);
        tr.querySelectorAll?.('td').forEach(td => td.style.backgroundColor = tintColor);
        // ç›´æ¥ tr ã«èƒŒæ™¯è‰²
        tr.style.backgroundColor = tintColor;
      }

      // === ã‚»ãƒ«æ§‹ç¯‰
      if(showAll){
        const tdSub=document.createElement('td'); tdSub.className='col-date'; tdSub.innerHTML=`<div class="cell">${r._subject||subject}</div>`; tr.appendChild(tdSub);
      }

      const tdDate=document.createElement('td'); tdDate.className='col-date'; tdDate.innerHTML=`<div class="cell">${jpDateLabel(r.date)}</div>`;
      tr.appendChild(tdDate);

      const tdType=document.createElement('td'); tdType.className='col-type';
      tdType.innerHTML=`<div class="cell type-buttons">
        <button class="chip btnType ${r.type==='å­¦ç¿’'?'active':''}" data-val="å­¦ç¿’">å­¦ç¿’</button>
        <button class="chip btnType ${r.type==='ä¼‘æ—¥'?'active':''}" data-val="ä¼‘æ—¥">ä¼‘æ—¥</button>
      </div>`;
      tr.appendChild(tdType);

      const tdGoal=document.createElement('td'); tdGoal.className='col-goal';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼š23ã€œ24'; inGoal.value=(r.goal??'');
      tdGoal.appendChild(inGoal); tr.appendChild(tdGoal);

      const tdRes=document.createElement('td'); tdRes.className='col-result';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾'; inRes.value=(r.result??'');
      tdRes.appendChild(inRes); tr.appendChild(tdRes);

      const tdRev=document.createElement('td'); tdRev.className='col-review';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²'; inRev.value=(r.review??'');
      tdRev.appendChild(inRev); tr.appendChild(tdRev);

      const tdDone=document.createElement('td'); tdDone.className='col-donebtn';
      const btnDone=document.createElement('button'); btnDone.className='chip'; btnDone.textContent='å®Œäº†';
      tdDone.appendChild(btnDone); tr.appendChild(tdDone);

      // å…¥åŠ›ä¿æŒï¼ˆæ¶ˆã•ãªã„ï¼‰
      const onInput=(field)=>(e)=>{ pushHistory(); r[field]=e.target.value; persist(r); touch(); };
      inGoal.addEventListener('input', onInput('goal'));
      inRes .addEventListener('input', onInput('result'));
      inRev .addEventListener('input', onInput('review'));

      // ç¨®åˆ¥ï¼ˆå­¦ç¿’/ä¼‘æ—¥ï¼‰â€” ä¼‘æ—¥ã¯ç°è‰²åŒ–ï¼‹ãƒã‚¤ãƒ³ãƒˆãªã—ï¼ˆnp=trueï¼‰
      tdType.querySelectorAll('.btnType').forEach(btn=>{
        btn.addEventListener('click',()=>{
          pushHistory();
          r.type=btn.dataset.val;
          if(r.type==='ä¼‘æ—¥'){ r.color='gray'; r.np=true; } else { if(r.color!=='gray') r.np=false; }
          persist(r); touch(); renderProgress({reload:false}); scrollTodayIntoView();
        });
      });

      // å®Œäº† â€” ç°è‰²åŒ–ï¼ˆnpã¯ type ã§æ±ºã¾ã‚‹ï¼‰ï¼‹ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
      btnDone.addEventListener('click',(ev)=>{
        pushHistory();
        r.color='gray'; // è¦‹ãŸç›®ã¯ç°
        // ä¼‘æ—¥ã®ã¾ã¾å®Œäº†ãªã‚‰ np=true ã®ã¾ã¾ï¼ˆåŠ ç‚¹ãªã—ï¼‰
        persist(r); touch(); renderProgress({reload:false}); scrollTodayIntoView();

        // åŠ ç‚¹ã‚¢ãƒ‹ãƒ¡ï¼ˆä¼‘æ—¥ã¯0ï¼‰
        const add = (r.type==='å¾©ç¿’')? pointCfg.review : (r.type==='ä¼‘æ—¥'? 0 : pointCfg.study);
        if(add>0) showPop(ev.target, `+${add}`);
      });

      // ã‚­ãƒ¼ç§»å‹•
      const focusables=[inGoal,inRes,inRev,btnDone];
      focusables.forEach((el,colIndex)=>{
        el.setAttribute('data-row-index', rowIdx);
        el.setAttribute('data-col-index', colIndex);
        el.addEventListener('keydown',(ev)=>{
          const rI=+el.dataset.rowIndex, cI=+el.dataset.colIndex;
          let nr=rI, nc=cI;
          if(ev.key==='ArrowDown') nr=rI+1;
          if(ev.key==='ArrowUp')   nr=rI-1;
          if(ev.key==='ArrowRight')nc=cI+1;
          if(ev.key==='ArrowLeft') nc=cI-1;
          if(ev.key==='Enter')     nr=rI+1;
          if(nr!==rI || nc!==cI){
            ev.preventDefault();
            const next=$(`#tbody [data-row-index="${nr}"][data-col-index="${nc}"]`);
            if(next){ next.focus(); if(next.select) next.select(); }
          }
        });
      });

      tb.appendChild(tr);
    });

    const t=new Date();
    $('#todayBanner').textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;
    scrollTodayIntoView();
    renderRank(); // ã™ãåæ˜ 
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const todayRow=scroller.querySelector('tr.today'); if(!todayRow) return;
    const thead=scroller.querySelector('thead'); const headerH=thead.getBoundingClientRect().height;
    scroller.scrollTo({top:Math.max(0,todayRow.offsetTop-headerH-4), behavior:'instant'});
  }

  /* ==================== å–ã‚Šè¾¼ã¿ / OCR ==================== */
  function normalizeDateToken(raw){
    if(!raw) return null;
    let s=String(raw).trim(); s=s.replace(/ï¼ˆ.*?ï¼‰|\(.*?\)/g,''); s=s.replace(/[ï¼ã€‚ãƒ»â€’â€“â€”â€•ã€œï½]/g,'-');
    let m=s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/); if(m) return {y:+m[1], mo:+m[2]-1, d:+m[3]};
    m=s.match(/^(\d{1,2})\s*(?:\/|æœˆ)\s*(\d{1,2})/); if(m){const y=year; return {y,mo:+m[1]-1,d:+m[2]};}
    return null;
  }
  function clean(v){ const s=String(v??'').trim(); if(!s) return ''; if(/^(nan|null|undefined)$/i.test(s)) return ''; return s; }

  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
    const sep=(text.indexOf('\t')!==-1)?'\t':','; const lines=text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header=lines[0].split(sep).map(s=>s.trim());
    const rows=lines.slice(1).map(line=>{const cells=line.split(sep); const obj={}; header.forEach((h,i)=> obj[h]=(cells[i]??'').trim()); return obj;});
    return {header, rows};
  }

  function importCsvText(text){
    const {header, rows:objs}=parseDelimited(text);
    const col={}; header.forEach(h=>{ if(/æ—¥ä»˜/.test(h)) col.date=h; if(/ç¨®åˆ¥/.test(h)) col.type=h; if(/ç›®æ¨™/.test(h)) col.goal=h; if(/çµæœ/.test(h)) col.result=h; if(/å¾©ç¿’/.test(h)) col.review=h; });
    if(!col.date || !col.type){ alert('CSVè¦‹å‡ºã—ã‚’ç¢ºèªï¼ˆå°‘ãªãã¨ã‚‚æ—¥ä»˜ãƒ»ç¨®åˆ¥ï¼‰'); return 0; }
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return 0; }

    let applied=0;
    for(const o of objs){
      const dtk=normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds=ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec=rows.find(x=>x.date===ds); if(!rec) continue;

      const t=clean(o[col.type]); if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) rec.type=t;
      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);

      persist(rec); applied++;
    }
    if(applied) touch();
    return applied;
  }

  async function ocrImage(file){
    try{ const worker=await Tesseract.createWorker('jpn'); const {data:{text}}=await worker.recognize(file); await worker.terminate(); return text; }
    catch(e){ const worker=await Tesseract.createWorker('eng'); const {data:{text}}=await worker.recognize(file); await worker.terminate(); return text; }
  }

  /* ==================== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ==================== */
  function pointsForType(t){
    if(t==='å¾©ç¿’') return pointCfg.review;
    if(t==='ä¼‘æ—¥') return 0;
    return pointCfg.study; // å­¦ç¿’
  }
  function myMonthlyPoints(){
    // color='gray' ã‹ã¤ npã§ãªã„ (=ä¼‘æ—¥ç°ã¯é™¤å¤–)
    let total=0;
    (loadSubjectMonth(subject)||[]).forEach(r=>{
      if(r.color==='gray' && !r.np){ total += pointsForType(r.type||'å­¦ç¿’'); }
    });
    return total;
  }
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  const CLASSMATES=[ 'æ©‹æœ¬æ·‘é›…','æœ›æœˆäºœå¸Œå­','æ°¸ç”°ç§€ä»','é«˜æ©‹','å¶‹åº·','ç”°ä¸­','æ± ä¹‹å†…è‹±æ˜','åŠ è—¤','ä½ã€…æœ¨','å¯Œç”°é›„äºŒ','å¯Œå³¶é›…äºº','æˆæœ¨æ´‹å¹³','å”æ‰å…ˆç”Ÿ','ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','æ©‹æœ¬ç¯„ä¹‹','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­' ];
  function classmatesMonthlyPoints(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=pointCfg.study; else if(r>0.50) sum+=pointCfg.review;});
      if(name==='æœ›æœˆäºœå¸Œå­') sum += 12 + Math.floor(rnd()*8);
      return {name, pts:sum};
    });
  }
  function renderRank(){
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    const mePts=myMonthlyPoints();
    let rivals=classmatesMonthlyPoints();
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    const grid=$('#rankGrid'); grid.innerHTML='';
    list.forEach((p,i)=>{
      const div=document.createElement('div'); div.className='rank-item';
      div.innerHTML=`<strong>${i+1}ä½</strong>ã€€${p.name}ã€€${p.pts} pt`;
      grid.appendChild(div);
    });
  }

  /* ==================== Page2ï¼ˆæ•™å®¤ï¼‰ç°¡ç•¥ ==================== */
  const FEMALES=new Set(['æœ›æœˆäºœå¸Œå­','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­']);
  const BASE_GENERAL=['ä»Šæ—¥ã‚‚ä¸€æ­©ãšã¤ï¼','ãã®èª¿å­ï¼','ä¼‘æ†©ã‚‚å¿˜ã‚Œãšã«','æ˜¨æ—¥ã®å¾©ç¿’ã„ã“ï¼','ç›®æ¨™ãƒ¡ãƒ¢ã—ãŸï¼Ÿ','çµ‚ã‚ã£ãŸã‚‰ï¼‹10ptã ï¼','åˆ†ã‹ã‚‰ãªã„æ‰€ã¯ä»˜ç®‹ï¼','ç„¦ã‚‰ãšä¸å¯§ã«ï¼','5åˆ†ã ã‘ã§ã‚‚æ‰‹ã‚’å‹•ã‹ãã†','é–“é•ã„ã¯ä¼¸ã³ã—ã‚ã ï¼'];
  const defaultLines={}; CLASSMATES.forEach(n=>defaultLines[n]=[]);
  let customLines = loadCustomLines();
  function loadCustomLines(){ try{ const raw=localStorage.getItem(LINES_KEY); return raw?JSON.parse(raw):{}; }catch(_){ return {}; } }
  let lineAutosaveTimer=null; function scheduleLinesSave(){ if(lineAutosaveTimer) clearTimeout(lineAutosaveTimer); lineAutosaveTimer=setTimeout(()=>saveCustomLines(),600); }
  function saveCustomLines(){ try{ localStorage.setItem(LINES_KEY, JSON.stringify(customLines)); }catch(_){} }
  function getLinesFor(name){ if(Object.prototype.hasOwnProperty.call(customLines,name)){ const a=Array.isArray(customLines[name])?customLines[name]:[]; return a; } const base=(defaultLines[name]&&defaultLines[name].length?defaultLines[name]:BASE_GENERAL); return base.slice(); }
  const recentLines=[];
  function lineFor(name){
    const pool=getLinesFor(name); if(!pool.length) return null;
    let msg=pool[Math.floor(Math.random()*pool.length)]; let guard=0;
    while(recentLines.includes(msg) && guard++<6){ msg=pool[Math.floor(Math.random()*pool.length)]; }
    recentLines.push(msg); if(recentLines.length>12) recentLines.shift(); return msg;
  }
  function buildClassroom(){
    const desks=$('#desks'); desks.innerHTML='';
    const names = arrangeNamesMFM();
    names.forEach(name=>{
      const d=document.createElement('div'); d.className='desk'; d.innerHTML=`
        <div class="name" style="color:${FEMALES.has(name)?'#f97316':'#2563eb'}">${name}</div>
        <div class="role">${name==='æ©‹æœ¬æ·‘é›…'?'ï¼ˆã‚ãªãŸï¼‰':'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ'}</div>
        <div class="bubble"></div>`;
      d.addEventListener('click',()=>{ const b=d.querySelector('.bubble'); const m=lineFor(name); if(!m){ b.classList.remove('show'); return; } b.textContent=m; b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 2200); });
      desks.appendChild(d);
    });
  }
  function arrangeNamesMFM(){
    const males=CLASSMATES.filter(n=>!FEMALES.has(n)), females=CLASSMATES.filter(n=>FEMALES.has(n));
    const half=Math.ceil(males.length/2), col1=males.slice(0,half), col3=males.slice(half), col2=females;
    const rows=Math.max(col1.length,col2.length,col3.length), arr=[];
    for(let i=0;i<rows;i++){ if(col1[i]) arr.push(col1[i]); if(col2[i]) arr.push(col2[i]); if(col3[i]) arr.push(col3[i]); }
    return arr;
  }

  /* ==================== Page4 ç·¨é›† ==================== */
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function renderEditPage(){
    const grid=$('#editGrid'); grid.innerHTML='';
    CLASSMATES.forEach(name=>{
      const card=document.createElement('div'); card.className='card';
      const id='ta_'+btoa(unescape(encodeURIComponent(name))).replace(/=+/g,'');
      const lines=getLinesFor(name);
      const text=(Object.prototype.hasOwnProperty.call(customLines,name)?customLines[name]:lines).join('\n');
      card.innerHTML=`<h4>${name}</h4>
        <textarea id="${id}" placeholder="1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºã«ã™ã‚‹ã¨ãƒŸãƒ¥ãƒ¼ãƒˆ">${escapeHtml(text)}</textarea>`;
      grid.appendChild(card);
      const ta=card.querySelector('textarea');
      ta.addEventListener('input',()=>{
        pushHistory();
        const v=String(ta.value||''); const arr=v.split('\n').map(s=>s.trim()).filter(Boolean);
        customLines[name]=arr; scheduleLinesSave();
      });
    });
  }

  /* ==================== ã‚¤ãƒ™ãƒ³ãƒˆ ==================== */
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY); const me=saved||'æ©‹æœ¬æ·‘é›…';
    $('#displayName').value=me; $('#meOnBoard').textContent=me;
  })();
  $('#saveName').addEventListener('click',()=>{ const me=($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim(); localStorage.setItem(NAME_KEY,me); $('#meOnBoard').textContent=me; renderRank(); });

  // ã‚¿ãƒ–
  $('#tabProgress').addEventListener('click',()=>showPage('progress'));
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));
  $('#tabEdit').addEventListener('click',()=>showPage('edit'));
  function setActiveTab(t1,t2,t3,t4){ $('#tabProgress').classList.toggle('active',t1); $('#tabClass').classList.toggle('active',t2); $('#tabRank').classList.toggle('active',t3); $('#tabEdit').classList.toggle('active',t4); }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit');
    const show=(a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); renderProgress({reload:true}); }
    if(which==='class'){    show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); buildClassroom(); }
    if(which==='rank'){     show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); renderRank(); }
    if(which==='edit'){     show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); renderEditPage(); }
  }

  // Undo/Redo ãƒœã‚¿ãƒ³
  $('#undoP').onclick=$('#undoC').onclick=$('#undoT').onclick=$('#undoS').onclick=()=>undo();
  $('#redoP').onclick=$('#redoC').onclick=$('#redoT').onclick=$('#redoS').onclick=()=>redo();

  // æœˆç§»å‹•
  $('#prev').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} renderProgress({reload:true}); });
  $('#next').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} renderProgress({reload:true}); });

  // ä¿å­˜/èª­è¾¼
  $('#save').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); renderProgress({reload:false}); });
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress({reload:false}); renderRank(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // è¡¨ç¤ºåˆ‡æ›¿
  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); scrollTodayIntoView(); });

  // å–è¾¼
  $('#importPaste').addEventListener('click',()=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
    const text=prompt('æ—¥ä»˜ã¨ç¨®åˆ¥ã®ä¸€è¦§ã‚„ã€ç¸¦ä¸€åˆ—ã®è¡¨ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: 8/13(æ—¥) ä¼‘æ—¥ ãªã©ï¼‰'); if(!text) return;
    pushHistory();
    const applied = importCsvText(text);
    renderProgress({reload:false}); renderRank();
    alert(applied?`å½“æœˆã« ${applied} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  });
  $('#importFile').addEventListener('change',async(e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); pushHistory();
    const n=importCsvText(txt); renderProgress({reload:false}); renderRank(); alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãªã—'); e.target.value='';
  });
  $('#importImg').addEventListener('change',async(e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return;
    try{ const text=await ocrImage(f); pushHistory(); const n=importCsvText(text); renderProgress({reload:false}); renderRank(); alert(n?`OCRã§ ${n} ä»¶åæ˜ `:'å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); }
    catch{ alert('OCRã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    finally{ e.target.value=''; }
  });

  // å…¨å‰Šé™¤
  $('#wipeP').onclick=()=>{ if(confirm('ä»Šæœˆã®è¡Œã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){ pushHistory(); rows.forEach(r=>{ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; r.np=false; }); touch(); renderProgress({reload:false}); } };
  $('#wipeC').onclick=()=>{ if(confirm('Cãƒšãƒ¼ã‚¸ã®ç™ºè©±çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ } };
  $('#wipeT').onclick=()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ')){ renderRank(); } };

  // ç§‘ç›®UI
  $('#addSubject').addEventListener('click',()=>{
    const name=prompt('è¿½åŠ ã™ã‚‹ç§‘ç›®åï¼ˆä¾‹ï¼šè‹±èªï¼‰'); if(!name) return;
    const trimmed=name.trim(); if(!trimmed) return; if(subjects.includes(trimmed)){ alert('ãã®ç§‘ç›®ã¯ã™ã§ã«ã‚ã‚Šã¾ã™'); return; }
    subjects.push(trimmed); saveSubjects(); renderSubjectSelect(); subject=trimmed; showAll=false; updateAllBtn(); renderProgress({reload:true});
  });
  $('#subjectSelect').addEventListener('change', e=>{ pushHistory(); subject=e.target.value; showAll=false; updateAllBtn(); renderProgress({reload:true}); });
  $('#toggleAllBtn').addEventListener('click',()=>{ pushHistory(); showAll=!showAll; updateAllBtn(); renderProgress({reload:true}); });
  function updateAllBtn(){ $('#toggleAllBtn').textContent = showAll? 'ğŸ“š å…¨ç§‘ç›®ï¼ˆONï¼‰' : 'ğŸ“š å…¨ç§‘ç›®'; }

  // ã‚«ãƒ©ãƒ¼ï¼†ãƒã‚¤ãƒ³ãƒˆUI
  function applyColorUI(){
    const sub = colorFor(subject); $('#subHex').value=sub.hex; $('#subTint').value=sub.tint; $('#swSub').style.background=sub.hex;
    $('#doneHex').value=doneColor.hex; $('#doneTint').value=doneColor.tint; $('#swDone').style.background=doneColor.hex;
    $('#ptStudy').value=pointCfg.study; $('#ptReview').value=pointCfg.review;
  }
  $('#subHex').addEventListener('input',()=>{ colors.sub[subject]={hex:$('#subHex').value,tint:+$('#subTint').value}; $('#swSub').style.background=$('#subHex').value; touch(); renderProgress({reload:false}); });
  $('#subTint').addEventListener('input',()=>{ colors.sub[subject]={hex:$('#subHex').value,tint:+$('#subTint').value}; touch(); renderProgress({reload:false}); });
  $('#doneHex').addEventListener('input',()=>{ doneColor.hex=$('#doneHex').value; colors.done=doneColor; $('#swDone').style.background=doneColor.hex; touch(); renderProgress({reload:false}); });
  $('#doneTint').addEventListener('input',()=>{ doneColor.tint=+$('#doneTint').value; colors.done=doneColor; touch(); renderProgress({reload:false}); });
  $('#ptStudy').addEventListener('input',()=>{ pointCfg.study=+$('#ptStudy').value||0; savePoints(pointCfg); renderRank(); });
  $('#ptReview').addEventListener('input',()=>{ pointCfg.review=+$('#ptReview').value||0; savePoints(pointCfg); renderRank(); });

  // MLBãƒ—ãƒªã‚»ãƒƒãƒˆ
  $('#presetRS').addEventListener('click',()=>{ // Red Sox
    colors.sub[subject]={hex:'#BD3039', tint:78}; touch(); applyColorUI(); renderProgress({reload:false});
  });
  $('#presetBJ').addEventListener('click',()=>{ // Blue Jays
    colors.sub[subject]={hex:'#134A8E', tint:78}; touch(); applyColorUI(); renderProgress({reload:false});
  });
  $('#presetDG').addEventListener('click',()=>{ // Dodgers
    colors.sub[subject]={hex:'#005A9C', tint:82}; touch(); applyColorUI(); renderProgress({reload:false});
  });
  $('#presetAS').addEventListener('click',()=>{ // All-Star NLï¼ˆæ±ç”¨ãƒã‚¤ãƒ“ãƒ¼ï¼‰
    colors.sub[subject]={hex:'#13274F', tint:82}; touch(); applyColorUI(); renderProgress({reload:false});
  });

  // ğŸ¹ãƒ›ãƒ¼ãƒ 
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); });

  // Rï¼å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
  $('#reloadBtn').addEventListener('click',()=>{ const url=location.pathname+'?r='+Date.now(); location.replace(url); });

  // ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆPage2ï¼‰
  (function initBoost(){
    const saved=localStorage.getItem(BOOST_KEY); const v=saved?Number(saved):0; $('#boostInput').value=String(isFinite(v)?v:0); updateBoostHint();
  })();
  function updateBoostHint(){ const v=Math.max(0,Number($('#boostInput').value)||0); $('#boostHint').textContent=`ï¼ˆç¾åœ¨: ${v}%å¢—ã—ï¼‰`; }
  $('#applyBoost').addEventListener('click',()=>{ localStorage.setItem(BOOST_KEY,String(Math.max(0,Number($('#boostInput').value)||0))); updateBoostHint(); });

  // åˆæœŸåŒ–
  (function init(){
    renderSubjectSelect(); updateAllBtn(); applyColorUI();
    load(); renderProgress({reload:false}); renderRank();
  })();

})();
</script>
</body>
</html>
