<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆé–“é€²æ—ï¼‹C(ğŸ«)ï¼‹T(ğŸ†)</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today-bg:#005A9C; --today-text:#ffffff; /* Dodgersãƒ–ãƒ«ãƒ¼(æ—¢å­˜ã®ä»Šæ—¥è‰²) */
    --row-gray-bg:#b0a89f; --row-gray-text:#000000; /* ã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢ç° */
    --header-bg:#ffffff; --header-shadow:0 6px 12px rgba(0,0,0,.06);
    --accent:#2563eb;

    --male:#2563eb; --female:#f97316;

    --bubble-gen-bg:#f4f8ff; --bubble-gen-bd:#d6e6ff;
    --bubble-fam-bg:#fff9ec; --bubble-fam-bd:#ffe5ad;

    --scale: 1;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  body.compact{--scale:0.72;}

  h1{margin:0 0 calc(12px*var(--scale));font-size:calc(18px*var(--scale));display:flex;gap:8px;align-items:center}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:calc(8px*var(--scale))}
  .muted{color:var(--muted);font-size:calc(12px*var(--scale))}
  button,input[type="text"],input[type="file"],input[type="number"],input[type="time"],textarea,select{
    padding:calc(10px*var(--scale)) calc(12px*var(--scale));
    border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:calc(16px*var(--scale));cursor:pointer
  }
  textarea{width:100%;min-height:120px;resize:vertical;cursor:text}
  input[type="number"]{width:7em}
  input[type="color"]{padding:0;width:42px;height:42px;border-radius:10px}
  button.primary{background:var(--accent);border-color:#2563eb;color:#fff}
  .pill{border-radius:999px;padding:6px 10px;font-size:14px}
  .ghost{background:#f8fafc}

  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe}

  .today-banner{
    margin:6px 0 10px;padding:8px 12px;border:1px solid var(--line);
    border-radius:10px;background:#f8fafc;font-size:calc(14px*var(--scale))
  }

  .tbl{width:100%;border:1px solid var(--line);border-radius:12px;overflow:auto;max-height:calc(84vh*var(--scale))}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle;background:#fff}
  th{
    text-align:left;font-weight:600;font-size:calc(12px*var(--scale));color:var(--muted);
    position:sticky;top:0;z-index:3;background:var(--header-bg);
    border-bottom:2px solid var(--line);box-shadow:var(--header-shadow)
  }
  tr.today td{background:var(--today-bg)!important;color:var(--today-text)!important}
  tr.manual-gray td{background:var(--row-gray-bg)!important;color:var(--row-gray-text)!important}

  .type-wrap{display:flex;align-items:center;gap:8px}
  .type-badge{font-weight:700;min-width:3.5em}

  /* ç§‘ç›®ã‚«ãƒ©ãƒ¼ã®è¦–èªæ€§ã‚’ä¸Šã’ã‚‹ï¼ˆãƒœãƒ¼ãƒ€ãƒ¼ï¼‹æ·¡ã„èƒŒæ™¯ï¼‰ */
  tr.theme-row td{background-clip:padding-box}
  tr.theme-row .theme-left{position:relative}
  tr.theme-row .theme-left::before{
    content:"";position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:6px 0 0 6px;background:var(--theme-accent,#ddd)
  }

  .fab{
    position:fixed;z-index:5;width:54px;height:54px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;border:1px solid var(--line);background:#fff;
    box-shadow:0 10px 20px rgba(0,0,0,.12);user-select:none;right:14px;bottom:14px
  }
  .fab span{font-size:22px;line-height:1}

  .blackboard{border-radius:10px;border:2px solid #2f4f4f;background:#0f3b3f;color:#e0f2f1;padding:10px 12px;font-weight:600;margin-bottom:10px}
  .room{border:1px solid var(--line);border-radius:12px;padding:14px;background:#f7fafc;max-height:80vh;overflow:auto}
  .desks{display:grid;gap:10px;grid-template-columns:repeat(3, minmax(0,1fr))}
  .desk{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:100px;display:flex;flex-direction:column;justify-content:flex-end;position:relative;overflow:hidden}
  .desk .name{font-weight:700}
  .desk .role{font-size:12px;color:#6b7280}
  .desk.male .name{color:var(--male)} .desk.female .name{color:var(--female)}

  .bubble{
    position:absolute;left:6px;right:6px;top:6px;border:1px solid var(--bubble-gen-bd);background:var(--bubble-gen-bg);
    border-radius:12px;padding:8px 10px;box-shadow:0 6px 12px rgba(0,0,0,.06);display:none;white-space:pre-line
  }
  .bubble::after{content:"";position:absolute;left:22px;bottom:-10px;border-width:10px 10px 0 10px;border-style:solid;border-color:var(--bubble-gen-bd) transparent transparent transparent}
  .bubble::before{content:"";position:absolute;left:22px;bottom:-9px;border-width:9px 9px 0 9px;border-style:solid;border-color:var(--bubble-gen-bg) transparent transparent transparent}
  .bubble.famous{background:var(--bubble-fam-bg);border-color:var(--bubble-fam-bd)}
  .bubble.famous::after{border-top-color:var(--bubble-fam-bd)}
  .bubble.famous::before{border-top-color:var(--bubble-fam-bg)}
  .bubble.show{display:block;animation:fadeIn .12s ease}
  .bubble.shout{transform:scale(1.06);font-size:18px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

  .rank-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .rank-grid{column-width:260px;column-gap:16px}
  .rank-item{break-inside:avoid;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff;display:block}
  .rank-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .rank-no{font-weight:800;min-width:3.5em}
  .rank-up2{background:#ffe6f2} /* ãƒ”ãƒ³ã‚¯ç³»ï¼‹2ä»¥ä¸Š */
  .rank-up5{background:#e6f0ff;border-color:#bcd3ff} /* ãƒ–ãƒ«ãƒ¼ç³»ï¼‹5ä»¥ä¸Š */

  .ops{display:flex;gap:8px;align-items:center;margin:6px 0 10px}

  /* Page4 editor */
  .grid-edit{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .card h4{margin:0 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Timetable: ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ */
  .tt{margin-left:auto; position:relative}
  .tt .pill{cursor:pointer}
  .tt-panel{
    position:absolute; right:0; top:42px; width:min(92vw,780px); max-height:72vh; overflow:auto;
    border:1px solid var(--line); border-radius:12px; background:#fff; box-shadow:0 20px 40px rgba(0,0,0,.12);
    opacity:0; transform:translateY(-6px) scale(.98); pointer-events:none; transition:opacity .18s ease, transform .18s ease; padding:10px;
  }
  .tt.open .tt-panel{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
  .tt-grid{display:grid;grid-template-columns:110px 1fr 1fr 1fr; gap:8px; align-items:center}
  .tt-grid > div{padding:6px 8px; border:1px solid var(--line); border-radius:8px; background:#fff}
  .tt-row{display:contents}
  .tt-actions{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
  .linklike{color:var(--accent);text-decoration:underline;cursor:pointer}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  .sep{height:1px;background:#e5e7eb;margin:8px 0}
  /* å°ã•ãªæœ¬ãƒœã‚¿ãƒ³ */
  .book{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:18px;background:#fff}
  .book.active{background:#fffbeb;border-color:#f59e0b}
</style>
</head>
<body>
  <h1>
    å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼‰
    <button id="reloadBtn" class="pill" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">R</button>
  </h1>

  <div class="topbar">
    <input id="displayName" type="text" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šæ©‹æœ¬æ·‘é›…ï¼‰" style="min-width:240px">
    <button id="saveName">ä¿å­˜</button>
    <span class="muted">â€»ä¿å­˜ã™ã‚‹ã¨å‘¼ã³ã‹ã‘ãƒ»é †ä½ã«åæ˜ </span>
  </div>

  <div class="tabs">
    <button id="tabProgress" class="tab active">é€²æ—</button>
    <button id="tabClass" class="tab" title="å­¦æ ¡">C ğŸ«</button>
    <button id="tabRank" class="tab" title="é †ä½">T ğŸ†</button>
    <button id="tabEdit" class="tab" title="ã‚»ãƒªãƒ•ç·¨é›†">S ğŸ’¬</button>
  </div>

  <!-- æ—§ï¼šãƒšãƒ¼ã‚¸ç§»å‹•ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ -->

  <!-- ===== Page 1: é€²æ— ===== -->
  <section id="pageProgress" style="display:block">
    <div class="ops">
      <button id="undoP">æˆ»ã‚‹</button>
      <button id="redoP">é€²ã‚€</button>
      <button id="wipeP">å…¨å‰Šé™¤</button>
    </div>

    <!-- ç§‘ç›®åˆ‡æ›¿ + å…¨ç§‘ç›®ï¼ˆğŸ“šï¼‰ + ç§‘ç›®ã‚«ãƒ©ãƒ¼è¨­å®š + æ™‚é–“å‰² -->
    <div class="topbar" style="gap:12px; align-items:center; flex-wrap:wrap">
      <div class="row" style="gap:8px">
        <label class="muted">ç§‘ç›®ï¼š</label>
        <select id="subjectSelect"></select>
        <button id="addSubject">ï¼‹ç§‘ç›®è¿½åŠ </button>

        <button id="toggleAllBtn" class="book" title="å…¨ç§‘ç›®ï¼ˆä¸€è¦§è¡¨ç¤ºï¼‰">ğŸ“š</button>
      </div>

      <div class="row" style="gap:8px">
        <span class="muted">è¡Œã‚«ãƒ©ãƒ¼ï¼š</span>
        <button class="pill ghost" id="presetRedSox">RedSox</button>
        <button class="pill ghost" id="presetBlueJays">BlueJays</button>
        <button class="pill ghost" id="presetDodgers">Dodgers</button>
        <button class="pill ghost" id="presetNL">All-Star NL</button>
        <input type="color" id="customColor">
        <input type="text" id="hexColor" placeholder="#RRGGBB" style="width:9em">
        <label class="muted">æ¿ƒæ·¡</label><input type="range" id="tintRange" min="5" max="30" step="1" value="12" style="width:140px">
        <button id="applyTheme" class="pill">é©ç”¨</button>
      </div>

      <div class="tt" id="ttBox">
        <span id="ttToggle" class="pill">ğŸ—“ æ™‚é–“å‰²ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼‰</span>
        <div class="tt-panel">
          <div class="row tt-actions">
            <strong id="ttTitle">ä»Šæ—¥ã®æ™‚é–“å‰²</strong>
            <button id="ttAddRow">ï¼‹è¡Œè¿½åŠ </button>
            <button id="ttShuffle20">ğŸ”€ è‡ªå‹•ææ¡ˆ(20)</button>
            <span class="muted">â† / â†’ ã§åˆ‡æ›¿</span>
            <button id="ttAdopt" class="pill">æ¡ç”¨</button>
            <button id="ttClose" class="pill ghost">é–‰ã˜ã‚‹</button>
          </div>
          <div id="ttPreview" class="muted" style="margin:4px 0 8px"></div>
          <div class="sep"></div>
          <div class="tt-grid">
            <div class="muted">é–‹å§‹</div>
            <div class="muted">çµ‚äº†</div>
            <div class="muted">å†…å®¹</div>
            <div class="muted">æ“ä½œ</div>
          </div>
          <div id="ttRows"></div>
          <div class="muted" style="margin-top:8px">
            ãƒ’ãƒ³ãƒˆï¼š<span class="kbd">â†‘â†“</span>ã§è¡Œç§»å‹•ã€<span class="kbd">â†â†’</span>ã§åˆ—ç§»å‹•ã€‚å…¥åŠ›ã¯ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="topbar">
      <button id="prev" class="primary">â—€ å‰æœˆ</button>
      <div id="label" class="muted"></div>
      <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
      <button id="save">ğŸ’¾ æ›´æ–°/ä¿å­˜</button>
      <button id="load">ğŸ“¥ èª­è¾¼</button>
      <button id="toggleCompact">ğŸ—‚ ä¸€è¦§è¡¨ç¤º</button>
    </div>

    <div class="topbar">
      <button id="importPaste">ğŸ“‹ è²¼ã‚Šä»˜ã‘å–è¾¼</button>
      <label>
        <input id="importFile" type="file" accept=".csv,.tsv,.txt" style="display:none">
        <button onclick="document.getElementById('importFile').click()">ğŸ“„ CSV/TSV/TXTå–è¾¼</button>
      </label>
      <label>
        <input id="importImg" type="file" accept="image/*" style="display:none">
        <button onclick="document.getElementById('importImg').click()">ğŸ–¼ ç”»åƒOCRå–è¾¼</button>
      </label>
      <span class="muted">è¦‹å‡ºã—ï¼š<code>æ—¥ä»˜, ç¨®åˆ¥, ç›®æ¨™, çµæœ, å¾©ç¿’</code></span>
    </div>

    <div id="todayBanner" class="today-banner">æœ¬æ—¥: èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="tbl" id="scroller">
      <table>
        <thead>
          <tr id="theadRow">
            <th class="medium theme-left">æ—¥ä»˜</th>
            <th class="small">ç¨®åˆ¥</th>
            <th class="medium">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
            <th class="medium">çµæœ</th>
            <th class="medium">å¾©ç¿’</th>
            <th class="small">è‰²</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- ===== Page 2: ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆ ===== -->
  <section id="pageClass" style="display:none">
    <div class="ops">
      <button id="undoC">æˆ»ã‚‹</button>
      <button id="redoC">é€²ã‚€</button>
      <button id="wipeC">å…¨å‰Šé™¤</button>
      <button id="shuffleSeats">å¸­æ›¿ãˆ</button>
    </div>
    <div class="blackboard">
      1å¹´Bçµ„ â€“ ã‚¯ãƒ©ã‚¹ãƒ¡ãƒ¼ãƒˆãŒã€Œ<span id="meOnBoard">æ©‹æœ¬æ·‘é›…</span>ã€ã‚’å¿œæ´ä¸­ï¼
      <span style="margin-left:10px" class="muted">é€Ÿã•%å¢—ã—ï¼š</span>
      <input id="boostInput" type="number" min="0" step="1" value="0" title="ä¾‹: 13 â†’ 13%é€Ÿã">
      <button id="applyBoost">é©ç”¨</button>
      <span id="boostHint" class="muted"></span>
    </div>
    <div class="room">
      <div class="desks" id="desks"></div>
    </div>
  </section>

  <!-- ===== Page 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== -->
  <section id="pageRank" style="display:none">
    <div class="ops">
      <button id="undoT">æˆ»ã‚‹</button>
      <button id="redoT">é€²ã‚€</button>
      <button id="wipeT">å…¨å‰Šé™¤</button>
    </div>
    <div class="rank-card">
      <h3>ä»Šæœˆã®é †ä½ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼‰</h3>
      <div class="muted" style="margin:6px 0 10px; line-height:1.6">
        ãƒ«ãƒ¼ãƒ«ï¼š<strong>å®Œäº†=+10</strong>ï¼ˆå­¦ç¿’ï¼‰ï¼<strong>å®Œäº†=+6</strong>ï¼ˆå¾©ç¿’ï¼‰ï¼ä¼‘æ—¥=0ã€‚<br>
        ãƒ©ã‚¤ãƒ–å¢—æ¸›ï¼š<span class="muted">16æ™‚ã€œ18æ™‚ã¯ã€Œåœ¨å­¦çµ„ã€ãŒä¼¸ã³ã‚„ã™ã„ï¼åˆå‰ã€œ15æ™‚ã¯ã€Œæµªäººçµ„ã€å„ªå‹¢ã€‚<strong>18æ™‚ã§å½“æ—¥åˆ†ã‚’ç· ã‚</strong>ã€ä»¥é™ã¯ç¿Œæ—¥ã«åæ˜ ã€‚</span><br>
        æ¼”å‡ºï¼šå‰æ—¥ã‹ã‚‰<strong>+2ä½</strong>ä»¥ä¸Šâ†’<span style="background:#ffe6f2;border-radius:4px;padding:0 6px">ãƒ”ãƒ³ã‚¯</span>ã€<strong>+5ä½</strong>ä»¥ä¸Šâ†’<span style="background:#e6f0ff;border-radius:4px;padding:0 6px">é’</span>ã€‚ãŒã‚“ã°ã‚Šçµ„ã¯æ•™å®¤ã§ã‚‚åŠ±ã¾ã—ç™ºè¨€ãŒå¢—ãˆã¾ã™ã€‚
      </div>
      <div id="rankGrid" class="rank-grid"></div>
    </div>
  </section>

  <!-- ===== Page 4: ã‚»ãƒªãƒ•ç·¨é›† ===== -->
  <section id="pageEdit" style="display:none">
    <div class="ops">
      <button id="undoS">æˆ»ã‚‹</button>
      <button id="redoS">é€²ã‚€</button>
      <button id="wipeS">å…¨æ¶ˆå»</button>
      <span class="muted">å„äººï¼š1è¡Œ=1ã‚»ãƒªãƒ•ï¼ˆç©ºæ¬„=ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰ï¼åœæ­¢0.6ç§’ã§è‡ªå‹•ä¿å­˜</span>
      <button id="exportLines">ğŸ’¾ æ›¸ãå‡ºã—</button>
      <label>
        <input id="importLinesFile" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('importLinesFile').click()">ğŸ“¥ èª­è¾¼</button>
      </label>
    </div>
    <div class="grid-edit" id="editGrid"></div>
  </section>

  <button class="fab" id="fabHome" title="ãƒ›ãƒ¼ãƒ ã¸"><span>ğŸ¹</span></button>

<script>
(function(){
  'use strict';

  /* ====== Keys ====== */
  const KEY='studyplanner.v16.ocr';
  const NAME_KEY='studyplanner.displayName';
  const LINES_KEY='studyplanner.v16.lines';
  const BOOST_KEY='studyplanner.v16.classBoost';
  const SUBJ_KEY='studyplanner.v16.subjects';
  const THEME_KEY='studyplanner.v16.theme'; // {subject:{hex,tint}}
  const TT_KEY='studyplanner.v16.tt';
  const RANK_LIVE_KEY='studyplanner.v16.rank.live'; // {yyyymmdd:{name:delta}}
  const RANK_PREV_KEY='studyplanner.v16.rank.prev'; // {yyyymmdd:[name order]}

  let year=(new Date()).getFullYear(), month=(new Date()).getMonth();
  let rows=[];
  let subjects = loadSubjects();
  let subject = subjects[0] || 'ä¸–ç•Œå²';
  let showAll = false;

  /* ======= Auto Save (Page1) ======= */
  const AUTOSAVE_MS = 800;
  let autoSaveTimer = null;
  const currentKey = (s=subject)=> `${KEY}:${s}:${year}-${String(month+1).padStart(2,'0')}`;
  function doSaveToLocal(s=subject, dataRows=rows){
    const data=dataRows.filter(r=>{
      const d=fromYmd(r.date);
      return d.getMonth()===month && d.getFullYear()===year;
    });
    try{ localStorage.setItem(currentKey(s), JSON.stringify(data)); }catch(_){}
  }
  function touch(){
    if(autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer=setTimeout(()=>{
      if(showAll){
        const map = new Map();
        rows.forEach(r=>{
          const subj = r._subject || subject;
          if(!map.has(subj)) map.set(subj,[]);
          map.get(subj).push(stripSubject(r));
        });
        map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
      }else{
        doSaveToLocal(subject, rows);
      }
      autoSaveTimer=null;
    }, AUTOSAVE_MS);
  }
  function flushAutoSave(){
    if(autoSaveTimer){ clearTimeout(autoSaveTimer); autoSaveTimer=null; }
    if(showAll){
      const map = new Map();
      rows.forEach(r=>{
        const subj = r._subject || subject;
        if(!map.has(subj)) map.set(subj,[]);
        map.get(subj).push(stripSubject(r));
      });
      map.forEach((arr,subj)=> doSaveToLocal(subj, arr));
    }else{
      doSaveToLocal(subject, rows);
    }
  }
  window.addEventListener('beforeunload', flushAutoSave);

  /* ====== Undo/Redo for pages ====== */
  const history = { past:[], future:[] };
  const snapshot = () => JSON.parse(JSON.stringify({year,month,rows,subject,showAll, themes:loadThemes(), customLines}));
  const pushHistory = () => { history.past.push(snapshot()); history.future.length=0; };
  function undo(){ if(!history.past.length) return; const cur=snapshot(); const prev=history.past.pop(); history.future.push(cur); restore(prev); }
  function redo(){ if(!history.future.length) return; const cur=snapshot(); const nxt=history.future.pop(); history.past.push(cur); restore(nxt); }
  function restore(state){
    ({year,month,rows,subject,showAll}=state);
    saveThemes(state.themes||{});
    customLines = state.customLines||customLines;
    renderAll();
  }

  /* ====== Utils ====== */
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};
  function monthDates(y,m){const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[]; for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d)); return arr;}
  function ensureScaffoldFor(arr){
    const need=new Set(monthDates(year,month));
    const have=new Set(arr.map(r=>r.date));
    need.forEach(d=>{ if(!have.has(d)) arr.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); });
    arr.sort((a,b)=>a.date.localeCompare(b.date));
  }
  function persist(rec){const i=rows.findIndex(x=>x.date===rec.date && (showAll? (x._subject===rec._subject):true)); if(i>=0) rows[i]=rec; else rows.push(rec);}
  function stripSubject(r){ const { _subject, ...rest } = r; return rest; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  /* ====== Subjects ====== */
  function loadSubjects(){
    try{
      const raw=localStorage.getItem(SUBJ_KEY);
      let arr = raw? JSON.parse(raw): null;
      if(!Array.isArray(arr) || arr.length===0) arr=['ä¸–ç•Œå²','è‹±èª','æ•°å­¦'];
      return arr;
    }catch(_){ return ['ä¸–ç•Œå²','è‹±èª','æ•°å­¦']; }
  }
  function saveSubjects(){ try{ localStorage.setItem(SUBJ_KEY, JSON.stringify(subjects)); }catch(_){} }
  function renderSubjectSelect(){
    const sel = $('#subjectSelect'); sel.innerHTML='';
    subjects.forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
    });
    if(!subjects.includes(subject)) subject=subjects[0];
    sel.value=subject;
  }

  /* ====== Themes (MLBç­‰) ====== */
  const PRESETS = {
    RedSox:   { hex:'#BD3039', accent:'#0D2B56' },
    BlueJays: { hex:'#134A8E', accent:'#1D2D5C' },
    Dodgers:  { hex:'#005A9C', accent:'#EF3E42' },
    NL:       { hex:'#13294B', accent:'#C8102E' } // NLã‚ªãƒ¼ãƒ«ã‚¹ã‚¿ãƒ¼ã£ã½ã„ç´ºï¼‹èµ¤
  };
  function loadThemes(){ try{ return JSON.parse(localStorage.getItem(THEME_KEY)||'{}'); }catch(_){ return {}; } }
  function saveThemes(o){ try{ localStorage.setItem(THEME_KEY, JSON.stringify(o)); }catch(_){} }
  function themeFor(subj){
    const all = loadThemes();
    if(all[subj]) return all[subj];
    // æ—¢å®šï¼šè‹±èªâ†’RedSoxã€æ•°å­¦â†’BlueJaysã€ä¸–ç•Œå²â†’Dodgers
    if(subj==='è‹±èª') return {hex:PRESETS.RedSox.hex, accent:PRESETS.RedSox.accent, tint:12};
    if(subj==='æ•°å­¦') return {hex:PRESETS.BlueJays.hex, accent:PRESETS.BlueJays.accent, tint:12};
    if(subj==='ä¸–ç•Œå²') return {hex:PRESETS.Dodgers.hex, accent:PRESETS.Dodgers.accent, tint:12};
    return {hex:'#2d3748', accent:'#1a202c', tint:12};
  }
  function setTheme(subj, cfg){ const all=loadThemes(); all[subj]=cfg; saveThemes(all); }

  function hexToRgb(hex){
    const h=hex.replace('#','').trim(); if(h.length!==6) return {r:45,g:55,b:72};
    return { r:parseInt(h.slice(0,2),16), g:parseInt(h.slice(2,4),16), b:parseInt(h.slice(4,6),16) };
  }
  function rgba(hex,alpha){
    const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${alpha})`;
  }

  /* ====== Page1 Save/Load ====== */
  function save(){ pushHistory(); flushAutoSave(); alert('æ›´æ–°ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); renderRank(); scrollTodayIntoView(); }
  function loadSubjectMonth(s=subject){
    const raw=localStorage.getItem(currentKey(s));
    let arr=[];
    if(raw){ try{ arr = JSON.parse(raw)||[]; }catch(_{}); }
    ensureScaffoldFor(arr);
    return arr;
  }
  function load(){
    if(showAll){
      const merged=[];
      subjects.forEach(sub=>{
        const arr = loadSubjectMonth(sub);
        arr.forEach(r=> merged.push({...r, _subject:sub}));
      });
      rows = merged.sort((a,b)=> a.date===b.date? (a._subject||'').localeCompare(b._subject||'') : a.date.localeCompare(b.date));
      return true;
    }else{
      rows = loadSubjectMonth(subject);
      return true;
    }
  }

  /* ====== Page1 Render ====== */
  function renderProgress(){
    load();
    const days = monthDates(year,month).length;
    $('#label').textContent = showAll? `å…¨ç§‘ç›® ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰` : `${subject} â€” ${year}å¹´${month+1}æœˆï¼ˆ${days}æ—¥ï¼‰`;

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    const thead = $('#theadRow'); thead.innerHTML='';
    if(showAll){
      thead.innerHTML = `
        <th class="theme-left small">ç§‘ç›®</th>
        <th class="medium">æ—¥ä»˜</th>
        <th class="small">ç¨®åˆ¥</th>
        <th class="medium">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
        <th class="medium">çµæœ</th>
        <th class="medium">å¾©ç¿’</th>
        <th class="small">è‰²</th>`;
    }else{
      thead.innerHTML = `
        <th class="theme-left medium">æ—¥ä»˜</th>
        <th class="small">ç¨®åˆ¥</th>
        <th class="medium">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
        <th class="medium">çµæœ</th>
        <th class="medium">å¾©ç¿’</th>
        <th class="small">è‰²</th>`;
    }

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());
    let list=[];
    if(showAll){
      const needDays=monthDates(year,month);
      needDays.forEach(d=>{
        subjects.forEach(sub=>{
          const arr = rows.filter(r=> r.date===d && r._subject===sub);
          if(arr.length){ list.push(arr[0]); }
          else{ list.push({_subject:sub, date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); }
        });
      });
    }else{
      list = rows.slice();
    }

    list.forEach((r,rowIdx)=>{
      const tr=document.createElement('tr');
      tr.dataset.date=r.date;
      if(r.color==='gray') tr.classList.add('manual-gray');
      else if(r.date===todayStr) tr.classList.add('today');

      // ãƒ†ãƒ¼ãƒè‰²ï¼ˆç§‘ç›®åˆ¥ï¼‰é©ç”¨
      const sub = showAll ? (r._subject||subject) : subject;
      const thm = themeFor(sub);
      if(r.color!=='gray'){
        tr.classList.add('theme-row');
        const bg = rgba(thm.hex, clamp((thm.tint||12)/100, 0.04, 0.35));
        tr.style.setProperty('--theme-accent', thm.accent||thm.hex);
        Array.from(tr.children).forEach(()=>{});
        tr.style.background=bg;
      }else{
        tr.style.background='';
      }

      function makeInputCell(value, placeholder, colName){
        const td=document.createElement('td'); td.className='';
        const inp=document.createElement('input'); inp.type='text'; inp.placeholder=placeholder; inp.value=value||''; inp.dataset.col=colName; inp.dataset.row=rowIdx;
        attachNavHandlers(inp);
        inp.addEventListener('input',e=>{ pushHistory(); r[colName]=e.target.value; persist(r); touch(); });
        td.appendChild(inp); return td;
      }

      // åˆ—
      if(showAll){ const tdSub=document.createElement('td'); tdSub.textContent=sub; tdSub.className='theme-left'; tr.appendChild(tdSub); }

      const tdDate=document.createElement('td'); tdDate.textContent=jpDateLabel(r.date); tdDate.className='theme-left'; tr.appendChild(tdDate);

      const tdType=document.createElement('td');
      const wrap=document.createElement('div'); wrap.className='type-wrap';
      const badge=document.createElement('span'); badge.className='type-badge'; badge.textContent=(r.type==='ä¼‘æ—¥')?'ä¼‘æ—¥':(r.type==='å¾©ç¿’'?'å¾©ç¿’':'å­¦ç¿’');
      const btn=document.createElement('button'); btn.className='type-toggle'; btn.type='button'; btn.textContent=(r.type==='ä¼‘æ—¥')?'å­¦ç¿’ã«ã™ã‚‹':'ä¼‘æ—¥ã«ã™ã‚‹';
      btn.addEventListener('click',()=>{
        pushHistory();
        r.type=(r.type==='ä¼‘æ—¥')?'å­¦ç¿’':'ä¼‘æ—¥';
        // ä¼‘æ—¥ã¯è‡ªå‹•ã§ã‚¸ãƒ£ãƒ³ã‚¬ãƒªã‚¢ç°è‰²ï¼ˆãƒã‚¤ãƒ³ãƒˆåŠ ç®—ãªã—ï¼‰
        if(r.type==='ä¼‘æ—¥'){ r.color='gray'; }
        persist(r); touch(); renderProgress(); renderRank(); scrollTodayIntoView();
      });
      wrap.appendChild(badge); wrap.appendChild(btn); tdType.appendChild(wrap); tr.appendChild(tdType);

      tr.appendChild(makeInputCell(r.goal,'ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24','goal'));
      tr.appendChild(makeInputCell(r.result,'å®Ÿç¸¾','result'));
      tr.appendChild(makeInputCell(r.review,'å¾©ç¿’ç¯„å›²','review'));

      const tdClr=document.createElement('td');
      const sel=document.createElement('select'); sel.dataset.col='color'; sel.dataset.row=rowIdx;
      [{v:'normal',t:'é€šå¸¸'}, {v:'gray',t:'å®Œäº†'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t; if((r.color||'normal')===p.v) o.selected=true; sel.appendChild(o);
      });
      attachNavHandlers(sel);
      sel.addEventListener('change',e=>{
        pushHistory();
        r.color=e.target.value;
        // å®Œäº†ã«ã—ãŸã‚‰ä»Šæ—¥ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‹å†è¨ˆç®—ï¼ˆãƒã‚¤ãƒ³ãƒˆå…¥ã‚‹/å¾©ç¿’ã¯+6ï¼‰
        persist(r); touch(); renderProgress(); renderRank(); scrollTodayIntoView();
      });
      tdClr.appendChild(sel); tr.appendChild(tdClr);

      tb.appendChild(tr);
    });

    // ä»Šæ—¥è¡¨ç¤ºãƒãƒŠãƒ¼
    const t=new Date();
    $('#todayBanner').textContent=`æœ¬æ—¥: ${t.getMonth()+1}æœˆ${t.getDate()}æ—¥(${jpWeek(t)})`;

    // ç§‘ç›®ãƒ†ãƒ¼ãƒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¡¨ç¤ºæ›´æ–°
    const thm = themeFor(subject);
    $('#customColor').value = thm.hex;
    $('#hexColor').value = thm.hex;
    $('#tintRange').value = thm.tint||12;

    scrollTodayIntoView();
    renderTimetable();
  }

  function scrollTodayIntoView(){
    const scroller=$('#scroller'); if(!scroller) return;
    const todayRow=scroller.querySelector('tr.today'); if(!todayRow) return;
    scroller.scrollTo({top:Math.max(0,todayRow.offsetTop-60), behavior:'instant'});
  }

  /* ====== Arrow key navigation ====== */
  function attachNavHandlers(el){
    el.addEventListener('keydown', (ev)=>{
      const col = ev.target.dataset.col;
      const row = +ev.target.dataset.row;
      if(!col) return;
      const cols = showAll? ['_subject','date','type','goal','result','review','color'] : ['date','type','goal','result','review','color'];
      const focusTo = (r,c)=>{
        const tbody = $('#tbody'); if(!tbody) return;
        const tr = tbody.children[r]; if(!tr) return;
        let el;
        if(c==='goal') el = tr.querySelector('input[data-col="goal"]');
        else if(c==='result') el = tr.querySelector('input[data-col="result"]');
        else if(c==='review') el = tr.querySelector('input[data-col="review"]');
        else if(c==='color') el = tr.querySelector('select[data-col="color"]');
        if(el){ el.focus(); el.select?.(); }
      };
      if(ev.key==='ArrowUp'){ ev.preventDefault(); focusTo(Math.max(0,row-1), col); }
      if(ev.key==='ArrowDown'){ ev.preventDefault(); focusTo(Math.min($('#tbody').children.length-1,row+1), col); }
      if(ev.key==='ArrowLeft'){
        const order=['goal','result','review','color'];
        const idx=Math.max(0, order.indexOf(col)-1);
        ev.preventDefault(); focusTo(row, order[idx]);
      }
      if(ev.key==='ArrowRight'){
        const order=['goal','result','review','color'];
        const idx=Math.min(order.length-1, order.indexOf(col)+1);
        ev.preventDefault(); focusTo(row, order[idx]);
      }
    });
  }

  /* ====== Import/OCR helpers (unchanged core) ====== */
  function normalizeDateToken(raw){
    if(!raw) return null;
    let s = String(raw).trim();
    s = s.replace(/ï¼ˆ.*?ï¼‰|\(.*?\)/g,'');
    s = s.replace(/[ï¼ã€‚ãƒ»â€’â€“â€”â€•ã€œï½]/g,'-');
    let m = s.match(/^(\d{4})\s*[-/]\s*(\d{1,2})\s*[-/]\s*(\d{1,2})$/);
    if(m){ return {y:+m[1], mo:+m[2]-1, d:+m[3]}; }
    m = s.match(/^(\d{1,2})\s*(?:\/|æœˆ)\s*(\d{1,2})/);
    if(m){ const y = year; return {y, mo:+m[1]-1, d:+m[2]}; }
    return null;
  }
  function clean(v){ const s = String(v ?? '').trim(); if(!s) return ''; if(/^(nan|null|undefined)$/i.test(s)) return ''; return s; }
  function parseDelimited(text){
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const sep = (text.indexOf('\t')!==-1) ? '\t' : ',';
    const lines = text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim()!=='');
    const header = lines[0].split(sep).map(s=>s.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(sep);
      const obj = {}; header.forEach((h,i)=> obj[h] = (cells[i]??'').trim());
      return obj;
    });
    return {header, rows};
  }

  function parseTypeImport(text){
    const lines = (text||'').replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    let applied=0;
    for(const ln of lines){
      const parts = ln.split(/[\s,ã€€\t]+/).filter(Boolean);
      if(parts.length<2) continue;
      const dtk = normalizeDateToken(parts[0]); if(!dtk) continue;
      let typ = parts[1].replace(/\s/g,'').trim();
      if(typ==='ä¼‘ã¿') typ='ä¼‘æ—¥';
      if(!/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(typ)) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯è²¼ã‚Šä»˜ã‘å–è¾¼ã¯ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return 0; }
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds);
      if(rec){ pushHistory(); rec.type=typ; if(typ==='ä¼‘æ—¥'){ rec.color='gray'; } persist(rec); applied++; }
    }
    if(applied) touch();
    return applied;
  }

  function importCsvText(text){
    const {header, rows:objs} = parseDelimited(text);
    const col = {};
    header.forEach(h=>{
      if(/æ—¥ä»˜/.test(h)) col.date=h;
      if(/ç¨®åˆ¥/.test(h)) col.type=h;
      if(/ç›®æ¨™/.test(h)) col.goal=h;
      if(/çµæœ/.test(h)) col.result=h;
      if(/å¾©ç¿’/.test(h)) col.review=h;
    });
    if(!col.date || !col.type){ alert('CSVè¦‹å‡ºã—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆå°‘ãªãã¨ã‚‚ã€Œæ—¥ä»˜ã€ã€Œç¨®åˆ¥ã€ï¼‰'); return 0; }
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯CSVå–è¾¼ã¯ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return 0; }

    let applied=0;
    for(const o of objs){
      const dtk = normalizeDateToken(o[col.date]); if(!dtk) continue;
      if(dtk.y!==year || dtk.mo!==month) continue;
      const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
      const rec = rows.find(x=>x.date===ds); if(!rec) continue;

      let t = clean(o[col.type]); if(t==='ä¼‘ã¿') t='ä¼‘æ—¥';
      if(/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; if(t==='ä¼‘æ—¥'){ rec.color='gray'; } }

      if(col.goal   !== undefined) rec.goal   = clean(o[col.goal]);
      if(col.result !== undefined) rec.result = clean(o[col.result]);
      if(col.review !== undefined) rec.review = clean(o[col.review]);

      persist(rec); applied++;
    }
    if(applied) touch();
    return applied;
  }
  function looksLikeColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    if (L.length < 12) return false;
    const i = L.findIndex(s => s.includes('æ—¥ä»˜'));
    if (i < 0 || i + 4 >= L.length) return false;
    const head = L.slice(i, i+5);
    const need = ['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'];
    if (!need.every((w,idx)=> (head[idx]||'').includes(w))) return false;
    return L.slice(i+5).some(s => /^\d{1,2}[\/\-æœˆ]\d{1,2}/.test(s) || /^\d{4}-\d{2}-\d{2}$/.test(s));
  }
  function parseColumnBlocks(text){
    const L = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const i = L.findIndex(s => s.includes('æ—¥ä»˜'));
    const data = L.slice(i+5);
    const rows = []; let block = {}; let ptr = 0;
    for (const line of data){
      if (['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'].includes(line)) continue;
      if (ptr === 0){ block={}; block['æ—¥ä»˜']=line; ptr=1; continue; }
      if (ptr === 1){ block['ç¨®åˆ¥']=line; ptr=2; continue; }
      if (ptr === 2){ block['ç›®æ¨™']=line; ptr=3; continue; }
      if (ptr === 3){ block['çµæœ']=line; ptr=4; continue; }
      if (ptr === 4){ block['å¾©ç¿’']=line; rows.push(block); ptr=0; continue; }
    }
    if (ptr !== 0){ block['ç›®æ¨™']=block['ç›®æ¨™']??''; block['çµæœ']=block['çµæœ']??''; block['å¾©ç¿’']=block['å¾©ç¿’']??''; rows.push(block); }
    return { header:['æ—¥ä»˜','ç¨®åˆ¥','ç›®æ¨™','çµæœ','å¾©ç¿’'], rows };
  }
  function importAnyText(text){
    try{ const n = importCsvText(text); if (n>0){ touch(); return n; } }catch(_){}
    if (looksLikeColumnBlocks(text)){
      if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return 0; }
      const parsed = parseColumnBlocks(text);
      let applied=0;
      for (const o of parsed.rows){
        const dtk = normalizeDateToken(o['æ—¥ä»˜']); if(!dtk) continue;
        if (dtk.y !== year || dtk.mo !== month) continue;
        const ds = ymd(new Date(dtk.y, dtk.mo, dtk.d));
        const rec = rows.find(x=>x.date===ds); if(!rec) continue;

        let t = clean(o['ç¨®åˆ¥']); if (t==='ä¼‘ã¿') t='ä¼‘æ—¥';
        if (/^(å­¦ç¿’|ä¼‘æ—¥|å¾©ç¿’)$/.test(t)) { pushHistory(); rec.type=t; if(t==='ä¼‘æ—¥'){ rec.color='gray'; } }

        rec.goal   = clean(o['ç›®æ¨™']);
        rec.result = clean(o['çµæœ']);
        rec.review = clean(o['å¾©ç¿’']);

        persist(rec); applied++;
      }
      if(applied) touch();
      return applied;
    }
    return 0;
  }

  async function ocrImage(file){
    try{ const worker = await Tesseract.createWorker('jpn'); const { data:{ text } } = await worker.recognize(file); await worker.terminate(); return text; }
    catch(e){
      const worker = await Tesseract.createWorker('eng'); const { data:{ text } } = await worker.recognize(file); await worker.terminate(); return text;
    }
  }

  /* ====== Ranking ====== */
  function myMonthlyPoints(){
    let total=0;
    const base = loadSubjectMonth(subject);
    monthDates(year,month).forEach(date=>{
      const r=base.find(x=>x.date===date); if(!r) return;
      if(r.color==='gray'){
        if(r.type==='å¾©ç¿’') total+=6;
        else if(r.type==='å­¦ç¿’') total+=10;
        // ä¼‘æ—¥ã¯0
      }
    });
    return total;
  }
  function seedRand(seed){let x=seed%2147483647; if(x<=0)x+=2147483646; return ()=> (x=x*16807%2147483647)/2147483647;}
  const CLASSMATES = [
    'æ©‹æœ¬æ·‘é›…','æœ›æœˆäºœå¸Œå­','æ°¸ç”°ç§€ä»','é«˜æ©‹','å¶‹åº·','ç”°ä¸­','æ± ä¹‹å†…è‹±æ˜','åŠ è—¤','ä½ã€…æœ¨','å¯Œç”°é›„äºŒ','å¯Œå³¶é›…äºº','æˆæœ¨æ´‹å¹³','å”æ‰å…ˆç”Ÿ',
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','æ©‹æœ¬ç¯„ä¹‹','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­'
  ];
  function classmatesMonthlyPointsStatic(){
    const seed=parseInt(`${year}${String(month+1).padStart(2,'0')}`);
    const rnd=seedRand(seed); const dates=monthDates(year,month);
    return CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…').map(name=>{
      let sum=0; dates.forEach(()=>{const r=rnd(); if(r>0.65) sum+=10; else if(r>0.50) sum+=6;});
      if(name==='æœ›æœˆäºœå¸Œå­') sum += 20 + Math.floor(rnd()*10);
      return {name, pts:sum};
    });
  }
  function yyyymmdd(d=new Date()){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}${m}${dd}`; }
  function loadLive(){ try{ return JSON.parse(localStorage.getItem(RANK_LIVE_KEY)||'{}'); }catch(_){ return {}; } }
  function saveLive(o){ try{ localStorage.setItem(RANK_LIVE_KEY, JSON.stringify(o)); }catch(_){} }
  function loadPrev(){ try{ return JSON.parse(localStorage.getItem(RANK_PREV_KEY)||'{}'); }catch(_){ return {}; } }
  function savePrev(o){ try{ localStorage.setItem(RANK_PREV_KEY, JSON.stringify(o)); }catch(_){} }

  function activeWindowFor(name){
    // ã¨ã‚Šã‚ãˆãšåŠã€…ã§ã‚«ãƒ†ã‚´ãƒªå‰²å½“
    const idx = CLASSMATES.indexOf(name);
    const type = (idx%2===0)?'school':'ronin';
    return type;
  }

  function liveTick(){
    const now = new Date();
    const hh = now.getHours();
    const cutoff = 18; // 18æ™‚ã§ç· ã‚
    const id = yyyymmdd(now);
    const live = loadLive(); if(!live[id]) live[id]={};
    if(hh >= cutoff) return; // ç· åˆ‡ä»¥é™ã¯åŠ ç®—ã—ãªã„ï¼ˆç¿Œæ—¥ã¸ï¼‰

    CLASSMATES.filter(n=>n!=='æ©‹æœ¬æ·‘é›…').forEach(name=>{
      const typ = activeWindowFor(name);
      let p = 0;
      if(typ==='school' && hh>=16 && hh<18){ if(Math.random()<0.5) p+=1; if(Math.random()<0.18) p+=1; }
      if(typ==='ronin'  && hh<16){          if(Math.random()<0.45) p+=1; if(Math.random()<0.15) p+=1; }
      if(p>0){ live[id][name]=(live[id][name]||0)+p; }
    });
    saveLive(live);
    renderRank(); // ãƒ©ã‚¤ãƒ–åæ˜ 
  }
  setInterval(liveTick, 30000); // 30ç§’ã”ã¨ã«é›°å›²æ°—å¯å¤‰

  function renderRank(){
    const meName=(($('#displayName').value)||'æ©‹æœ¬æ·‘é›…').trim();
    const mePts=myMonthlyPoints();

    // é™çš„ + ãƒ©ã‚¤ãƒ–
    const rivalsBase = classmatesMonthlyPointsStatic();
    const id = yyyymmdd(new Date());
    const live = loadLive()[id]||{};
    const rivals = rivalsBase.map(o=> ({...o, pts:o.pts + (live[o.name]||0)}));

    // é †ä½ï¼†æ˜‡æ ¼æ¼”å‡º
    const list=[...rivals,{name:meName,pts:mePts,me:true}].sort((a,b)=>b.pts-a.pts);

    // å‰æ—¥ã‹ã‚‰ã®é †ä½å·®åˆ†ã§è‰²ä»˜ã‘
    const prev = loadPrev();
    const prevOrder = prev[id] || list.map(p=>p.name); // åˆå›ã¯ç¾çŠ¶
    const rankMapPrev = new Map(prevOrder.map((n,i)=>[n,i+1]));
    const grid=$('#rankGrid'); grid.innerHTML='';
    list.forEach((p,i)=>{
      const rankNow=i+1;
      const rankWas=rankMapPrev.get(p.name) ?? rankNow;
      const diff = rankWas - rankNow; // æ­£ãªã‚‰é †ä½UP
      const div=document.createElement('div'); div.className='rank-item';
      if(diff>=5) div.classList.add('rank-up5'); else if(diff>=2) div.classList.add('rank-up2');
      div.innerHTML=`<div class="rank-row">
          <div class="rank-no">${rankNow}ä½</div>
          <div class="grow"><strong>${p.name}</strong> <span class="muted">${diff? (diff>0?`â†‘${diff}`:`â†“${-diff}`):''}</span></div>
          <div>${p.pts} pt</div>
        </div>`;
      grid.appendChild(div);
    });
    // æ¬¡å›æ¯”è¼ƒç”¨ã«ä¿å­˜
    prev[id] = list.map(p=>p.name);
    savePrev(prev);
  }

  /* ====== Page2: Class ====== */
  const FEMALES = new Set(['æœ›æœˆäºœå¸Œå­','ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­','æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­']);
  const FAMOUS_SET = new Set([
    'ã·ã‚ãŸã‚“','å¤§æ£®å…ƒæœ¨','ç±³å±±éš†ä¸€','ã²ã‚ã‚†ã',
    'ç¶¾ç€¬ã¯ã‚‹ã‹','æ°¸é‡èŠ½éƒ','çŸ³åŸã•ã¨ã¿','åŒ—å·æ™¯è‰²','æœ‰æ‘æ¶ç´”','é•·æ¾¤ã¾ã•ã¿','åºƒç€¬ã™ãš','æ·±ç”°æ­å­',
    'æœ¬ç”°ç¿¼','æ','æœ¨æ‘æ–‡ä¹ƒ','å„ªé¦™','ç”Ÿç”°çµµæ¢¨èŠ±','ä¸Šæˆ¸å½©','èœã€…ç·’','å†…ç”°æœ‰ç´€','å¤šéƒ¨æœªè¯å­','æˆ¸ç”°æµæ¢¨é¦™','åºƒç€¬ã‚¢ãƒªã‚¹','å‰é«˜ç”±é‡Œå­',
    'æœ›æœˆäºœå¸Œå­'
  ]);

  // æ—¢å®šã‚»ãƒªãƒ•ï¼ˆäººã”ã¨ã«ç•°ãªã‚‹å†…å®¹ã‚’å¤šæ•°ã‚»ãƒƒãƒˆï¼‰
  const defaultLines = {
    'æ©‹æœ¬æ·‘é›…': ['ã¨ã—ãã‚“ã€æ·±å‘¼å¸ã—ã¦ã„ã“ï¼','5åˆ†ã§ã„ã„ã€ãƒšãƒ³ã‚’å‹•ã‹ãã†','ä»Šæ—¥ã¯ã€Œå‹ã¦ã‚‹æ—¥ã€ã«ã—ã‚ˆ'],
    'æœ›æœˆäºœå¸Œå­': ['ã‚ã€ã“ã‚Œè§£èª¬ã†ã¾ãã¾ã¨ã‚ãŸã‚ˆ','ä¼‘æ†©ã®ã¨ãç´…èŒ¶ã„ã‚Œã‚‹ï¼Ÿ','ã‚„ã‚‹ã˜ã‚ƒã‚“ã€ã¨ã—ãã‚“ï¼'],
    'æ°¸ç”°ç§€ä»': ['ä¸€æ¬¡å¤§æˆ¦ã®åŸå› ã¯â€¦ä¸‰å›½åŒç›Ÿvsä¸‰å›½å”å•†ã ã','ä¸–ç•Œå²ã‚¹ãƒ«ãƒ¡ã€å™›ã‚€ã»ã©æ—¨ã„'],
    'é«˜æ©‹': ['è‹±å˜èªã‚«ãƒ¼ãƒ‰å›ã™ï¼Ÿ','æ•°å­¦ã¯ä¾‹é¡Œâ†’åŸºæœ¬å•é¡Œã®é †ã§å›ºã‚ã‚‹æ´¾'],
    'å¶‹åº·': ['ãƒãƒ¼ãƒˆå†™çµŒã—ã¦ã‚‚ç‚¹ã¯ä¼¸ã³ãªã„ã€è§£ãã¹ã—ï¼','ãƒ‹ãƒ¥ãƒ¼ã‚¹è¦‹ãŸï¼Ÿä¸­æ±æƒ…å‹¢ã¾ãŸå‹•ã„ã¦ã‚‹'],
    'ç”°ä¸­': ['æš—è¨˜ã¯å£°ã«å‡ºã™ã¨å®šç€ç‡1.5å€(ä½“æ„Ÿ)','å¯ä¸è¶³ã¯æ•µã€ä»Šæ—¥ã¯æ—©å¯ã§å‹ã¤'],
    'æ± ä¹‹å†…è‹±æ˜': ['å®—æ•™æ”¹é©ã€èªã‚Œã¾ã™ï¼Ÿãƒ«ã‚¿ãƒ¼ã¨ã‚«ãƒ«ãƒ´ã‚¡ãƒ³é•ã„ãƒã‚§ãƒƒã‚¯','æ­´å²å¹´å·ã¯èªå‘‚ã§è¸Šã‚ã†'],
    'åŠ è—¤': ['è‹±èªã€å—å‹•æ…‹â†’åˆ†è©æ§‹æ–‡ã®æµã‚ŒãŒã‚«ã‚®','ç™ºéŸ³ç·´ç¿’ã§ãƒªã‚¹ãƒ‹ãƒ³ã‚°çˆ†ä¼¸ã³ã™ã‚‹ã‚ˆ'],
    'ä½ã€…æœ¨': ['éŒå€‰æ–°ä»æ•™ï¼šæ³•ç„¶ãƒ»è¦ªé¸ãƒ»é“å…ƒãƒ»æ—¥è“®ï¼','ä»æ•™ã£ã¦ç¾ä»£ã«ã‚‚ä½¿ãˆã‚‹ã‚“ã ã‚ˆã­'],
    'å¯Œç”°é›„äºŒ': ['ä»Šæ—¥ã¯ãƒ™ãƒ¼ã‚¹ç·´â€¦ã˜ã‚ƒãªãã¦åŸºç¤ç·´ï¼','é›†ä¸­25åˆ†â†’ä¼‘æ†©5åˆ†ã®ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã§'],
    'å¯Œå³¶é›…äºº': ['ãƒŸã‚»ã‚¹ã®æ–°æ›²ã‚ˆã‹ã£ãŸã‚ã€œï¼ˆå¤§æ£®ã«åŒæ„ï¼‰','ã¨ã—ãã‚“ã€ãƒªã‚ºãƒ ä½œã£ã¦ã“'],
    'æˆæœ¨æ´‹å¹³': ['æ°—åœ§ä½ã„æ—¥ã¯ç„¡ç†ã›ãšã€è–„ãé•·ãã§OK','ã‚³ãƒ¼ãƒ’ãƒ¼ã¯åˆå¾Œ2æ™‚ã¾ã§æ´¾'],
    'å”æ‰å…ˆç”Ÿ': ['ã¾ãšã¯æ•™ç§‘æ›¸ï¼æ¬¡ã«å•é¡Œé›†ï¼é †åºãŒå‘½ï¼','å¾©ç¿’ã“ãç‹é“ã€äºˆç¿’ã¯åŠ¹ç‡UPã®éµ'],
    'ã·ã‚ãŸã‚“': ['èƒŒä¸­ã®æ—¥ã‹ï¼Ÿã„ã‚„æš—è¨˜ã®æ—¥ã ï¼','ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ‘‚ã£ã¦ã‹ã‚‰å‹‰å¼·ã™ã‚‹ã¨é›†ä¸­é•ã†ã'],
    'å¤§æ£®å…ƒæœ¨': ['ãƒŸã‚»ã‚¹ã€ŒSoranjiã€è´ã„ã¦æ°—åˆã„å…¥ã‚Œã‚ˆï¼','æ­Œè©ã£ã¦è‹±èªè¡¨ç¾ã®å®åº«ã ã‚ˆã­'],
    'æ©‹æœ¬ç¯„ä¹‹': ['ãƒ™ã‚¤ã‚ºæ€è€ƒã§ã„ã“ã†ã€ä»®èª¬â†’æ¤œè¨¼ï¼','çµ±è¨ˆã¯è£åˆ‡ã‚‰ãªã„'],
    'ç±³å±±éš†ä¸€': ['ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯1æ¬¡æƒ…å ±ã«å½“ãŸã‚ã†','æ”¿ç­–æ¯”è¼ƒã€è¦ç‚¹ã‚’3è¡Œã§æ›¸ã‘ã‚‹ï¼Ÿ'],
    'ã²ã‚ã‚†ã': ['ãã‚Œã£ã¦ã‚ãªãŸã®æ„Ÿæƒ³ã§ã™ã‚ˆã­ï¼Ÿ ã§ã‚‚æ ¹æ‹ ã¯ï¼Ÿ','ã¾ãšã¯æ‰‹ã‚’å‹•ã‹ã™ã®ãŒã‚³ã‚¹ãƒ‘è‰¯ã„ã§ã™'],
    'ç¶¾ç€¬ã¯ã‚‹ã‹': ['ç¬‘ã£ã¦ã„ã“ã†ï¼é–“é•ã£ã¦ã‚‚å¤§ä¸ˆå¤«','æ°´åˆ†ã¨ã£ã¦ã­'],
    'æ°¸é‡èŠ½éƒ': ['ä»˜ç®‹ã§ã‚«ãƒ©ãƒ•ãƒ«ä½œæˆ¦ã„ã“â™ª','ã¨ã—ãã‚“ã€ä»Šæ—¥ã‚‚ä¸€æ­©ï¼'],
    'çŸ³åŸã•ã¨ã¿': ['å£°ã«å‡ºã™ã¨è¡¨æƒ…ã‚‚å‹•ã„ã¦è¦šãˆã‚„ã™ã„ã‚ˆ','å§¿å‹¢ãƒ”ãƒ³ã§é›†ä¸­UP'],
    'åŒ—å·æ™¯è‰²': ['ãƒãƒ¼ãƒˆã¯ç¾ã—ãï¼è¦‹è¿”ã—ãŸããªã‚‹é­”æ³•','è‹±ä½œæ–‡ã€ä¸»èªâ†’å‹•è©ã§ãƒªã‚ºãƒ ä½œã‚'],
    'æœ‰æ‘æ¶ç´”': ['å¿œæ´ã—ã¦ã‚‹ã‚ˆã€ç„¦ã‚‰ãšã„ã“ã†','ã”ã»ã†ã³ç”¨ãƒãƒ§ã‚³æº–å‚™ã—ãŸï¼Ÿ'],
    'é•·æ¾¤ã¾ã•ã¿': ['ã‚„ã‚‹æ™‚ã¯ã‚„ã‚‹ï¼ãã†ã„ã†ã®å¥½ã','åŒºåˆ‡ã£ã¦è€ƒãˆã‚‹ã¨ã§ãã‚‹ã‚ˆ'],
    'åºƒç€¬ã™ãš': ['BGMã¯ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ã‹é›¨éŸ³ãŒæœ€å¼·èª¬','ã‚¿ã‚¤ãƒãƒ¼å›ã™ï¼Ÿ3,2,1â€¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼'],
    'æ·±ç”°æ­å­': ['ç¡çœ ã¯æ­£ç¾©â™¡','ã¨ã—ãã‚“ã€ã¡ã‚ƒã‚“ã¨é£Ÿã¹ãŸï¼Ÿ'],
    'æœ¬ç”°ç¿¼': ['ã‚²ãƒ¼ãƒ ã¯ã‚¯ãƒªã‚¢ã€å‹‰å¼·ã‚‚ã‚¯ã‚¨ã‚¹ãƒˆï¼','ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆåŸ‹ã‚ã‚ˆï¼'],
    'æ': ['SDGsãƒã‚¿ã§å°è«–æ–‡ã„ã‘ã‚‹ã‚„ã¤','æœ¬è³ªã¯ã©ã“ï¼Ÿå•ã„ã‚’ç«‹ã¦ã‚ˆã†'],
    'æœ¨æ‘æ–‡ä¹ƒ': ['ã‚¹ã‚­ãƒæ™‚é–“ã®ä½¿ã„æ–¹ãŒå‹è² ','å˜èªã¯å£°ã«å‡ºã—ã¦3å‘¨'],
    'å„ªé¦™': ['é ‘å¼µã‚Šã™ãæ³¨æ„ã€œï¼','å§¿å‹¢çŒ«èƒŒç¦æ­¢ã­'],
    'ç”Ÿç”°çµµæ¢¨èŠ±': ['éŸ³èª­ã¯ãƒªã‚ºãƒ ã€æŠ‘æšã¤ã‘ã¦','éŸ³æ¥½ã§é›†ä¸­ã‚¾ãƒ¼ãƒ³å…¥ã‚'],
    'ä¸Šæˆ¸å½©': ['å°ç›®æ¨™ã‚’ã‚¯ãƒªã‚¢ã—ã¦é”æˆæ„Ÿç©ã‚‚ã†','ã‚¹ãƒãƒ›é ã–ã‘ã‚ˆ'],
    'èœã€…ç·’': ['å§¿å‹¢è‰¯ãã€ã‚·ãƒ£ã‚­ãƒƒã¨ï¼','è‡ªä¿¡ã¯ç©ã¿ä¸Šã’ã®å‰¯ç”£ç‰©'],
    'å†…ç”°æœ‰ç´€': ['ãƒãƒ¼ãƒˆã®ä½™ç™½ã«æ°—ã¥ãã‚’ãƒ¡ãƒ¢','å¾©ç¿’ã«è‰²ã‚’ã¤ã‘ã¦å·®åˆ†ã‚’è¦‹ã‚ˆ'],
    'å¤šéƒ¨æœªè¯å­': ['ä¸€æ°—ã«ã‚„ã‚‰ãšã€ç´°åˆ‡ã‚Œã«ä¸å¯§ã«','æ˜¼å¯15åˆ†ã§å›å¾©'],
    'æˆ¸ç”°æµæ¢¨é¦™': ['ä»®èª¬ã‚’ç«‹ã¦ã¦ã‹ã‚‰èª­ã‚€ã¨æ—ã‚‹ã‚ˆ','è¦ç´„3è¡Œãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼'],
    'åºƒç€¬ã‚¢ãƒªã‚¹': ['ã¨ã—ãã‚“ã€ãƒŠã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒˆï¼','ä»Šæ—¥ã¯è‚©ã®åŠ›æŠœã„ã¦ã­'],
    'å‰é«˜ç”±é‡Œå­': ['ãƒã‚¤ãƒ©ã‚¤ãƒˆå¼•ãã™ãæ³¨æ„ï¼è¦ç‚¹ã ã‘','ã”è¤’ç¾ã¯â€œçµ‚ã‚ã£ã¦ã‹ã‚‰â€ã­']
  };
  const BASE_GENERAL = ['ä»Šæ—¥ã‚‚ä¸€æ­©ãšã¤ï¼','ãã®èª¿å­ï¼','ä¼‘æ†©ã‚‚å¿˜ã‚Œãšã«','æ˜¨æ—¥ã®å¾©ç¿’ã„ã“ï¼','ç›®æ¨™ãƒ¡ãƒ¢ã—ãŸï¼Ÿ','çµ‚ã‚ã£ãŸã‚‰ï¼‹10ptã ï¼','åˆ†ã‹ã‚‰ãªã„æ‰€ã¯ä»˜ç®‹ï¼','ç„¦ã‚‰ãšä¸å¯§ã«ï¼','5åˆ†ã ã‘ã§ã‚‚æ‰‹ã‚’å‹•ã‹ãã†','é–“é•ã„ã¯ä¼¸ã³ã—ã‚ã ï¼'];

  // ä¿å­˜/èª­è¾¼ï¼ˆPage4ã¨å…±é€šï¼‰
  let customLines = loadCustomLines();
  function loadCustomLines(){ try{ const raw=localStorage.getItem(LINES_KEY); return raw? JSON.parse(raw): {}; }catch(_){ return {}; } }
  let lineAutosaveTimer=null;
  function scheduleLinesSave(){ if(lineAutosaveTimer) clearTimeout(lineAutosaveTimer); lineAutosaveTimer = setTimeout(()=>{ saveCustomLines(); }, 600); }
  function saveCustomLines(){ try{ localStorage.setItem(LINES_KEY, JSON.stringify(customLines)); }catch(_){} }

  function getLinesFor(name){
    if(Object.prototype.hasOwnProperty.call(customLines, name)){
      const arr = Array.isArray(customLines[name]) ? customLines[name] : [];
      return arr;
    }
    // æ—¢å®šï¼ˆäººåˆ¥â†’ãªã‘ã‚Œã°ä¸€èˆ¬ï¼‰
    if(defaultLines[name]) return defaultLines[name].slice();
    return BASE_GENERAL.slice();
  }

  const recentLines = [];
  function pickLine(name){
    const pool = getLinesFor(name);
    if(!pool.length) return null;
    let msg = pool[Math.floor(Math.random()*pool.length)];
    let guard = 0;
    while(recentLines.includes(msg) && guard++<8){ msg = pool[Math.floor(Math.random()*pool.length)]; }
    recentLines.push(msg); if(recentLines.length>24) recentLines.shift();
    return msg;
  }

  // é€Ÿã•èª¿æ•´
  function factorFromBoost(boostPct){ const k = Math.max(0, Number(boostPct)||0); return 1 / (1 + k/100); }
  function getBoost(){ const v = Number($('#boostInput').value)||0; return Math.max(0, v); }

  // è¤‡æ•°äººåŒæ™‚ç™ºè¨€ with ãŸã¾ã«ãƒ‡ã‚«å£°
  let classTicker = null;
  const lastSpokenAt = new Map();
  function visibleDurationMs(){ return Math.round(2800 * factorFromBoost(getBoost())); }
  function cooldownMs(){ return Math.max(700, Math.round(visibleDurationMs()*0.9)); }
  function baseTickMs(){ return Math.max(180, Math.round(1100 * factorFromBoost(getBoost()))); }
  function randomEmissionCount(){ const r=Math.random(); if(r<0.18) return 0; if(r<0.55) return 1; if(r<0.88) return 2; if(r<0.97) return 3; return 4; }

  // ãƒ©ãƒ³ã‚¯UPçµ„ã®å¿œæ´ãƒ–ãƒ¼ã‚¹ãƒˆ
  function boostSpeakers(){
    const id = yyyymmdd(new Date());
    const prev = loadPrev()[id]||[];
    const now = Array.from($('#rankGrid')?.querySelectorAll('.rank-item strong')||[]).map(el=>el.textContent);
    const mapPrev = new Map(prev.map((n,i)=>[n,i+1]));
    return new Set(now.filter((n,i)=> (mapPrev.get(n)??(i+1)) - (i+1) >= 2));
  }

  function showBubble(deskEl, name){
    const bubble = deskEl.querySelector('.bubble'); if(!bubble) return;
    const msg = pickLine(name); if(msg === null){ bubble.classList.remove('show'); return; }
    const isFamous = FAMOUS_SET.has(name);
    bubble.className = 'bubble' + (isFamous ? ' famous' : '');
    bubble.textContent = msg;
    // ã‚µã‚¤ã‚ºãƒ©ãƒ³ãƒ€ãƒ ï¼†ãŸã¾ã«å¤§å£°
    if(Math.random()<0.18) bubble.classList.add('shout'); else bubble.classList.remove('shout');
    if(Math.random()<0.12) bubble.style.fontSize = (14 + Math.floor(Math.random()*10))+'px';
    else bubble.style.fontSize = '14px';

    bubble.classList.add('show');
    const vms = visibleDurationMs();
    setTimeout(()=> bubble.classList.remove('show'), vms);
    lastSpokenAt.set(name, Date.now());
  }

  let seatShuffleSeed = 0;
  function arrangeNamesMFM(shuffle=false){
    let males = CLASSMATES.filter(n=>!FEMALES.has(n));
    let females = CLASSMATES.filter(n=>FEMALES.has(n));
    if(shuffle){
      const rng = seedRand(++seatShuffleSeed + Date.now());
      males = males.sort(()=>rng()-0.5);
      females = females.sort(()=>rng()-0.5);
    }
    const half = Math.ceil(males.length/2);
    const col1 = males.slice(0, half);
    const col3 = males.slice(half);
    const col2 = females;
    const rows = Math.max(col1.length, col2.length, col3.length);
    const arranged = [];
    for(let i=0;i<rows;i++){
      if(col1[i]) arranged.push(col1[i]);
      if(col2[i]) arranged.push(col2[i]);
      if(col3[i]) arranged.push(col3[i]);
    }
    return arranged;
  }

  function buildClassroom(shuffle=false){
    const desks=$('#desks'); if(!desks) return; desks.innerHTML='';
    const names = arrangeNamesMFM(shuffle);
    const boosters = boostSpeakers();
    names.forEach((name)=>{
      const d=document.createElement('div'); d.className='desk';
      d.classList.add(FEMALES.has(name)?'female':'male');
      d.innerHTML = `
        <div class="name">${name}</div>
        <div class="role">${name==='æ©‹æœ¬æ·‘é›…'?'ï¼ˆã‚ãªãŸï¼‰':'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ'}</div>
        <div class="bubble"></div>
      `;
      d.addEventListener('click',()=> showBubble(d, name));
      // ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã¯æ™‚ã€…ã™ãç™ºè¨€
      if(boosters.has(name) && Math.random()<0.4) setTimeout(()=>showBubble(d,name), 400+Math.random()*800);
      desks.appendChild(d);
    });
  }

  function tickOnce(){
    const desks = Array.from(document.querySelectorAll('#desks .desk'));
    if(desks.length===0) return;
    const now = Date.now();
    const count = randomEmissionCount();
    const candidates = desks
      .map(el=>({el, name: el.querySelector('.name')?.textContent || ''}))
      .filter(x=>x.name && (!lastSpokenAt.has(x.name) || (now - (lastSpokenAt.get(x.name)||0) > cooldownMs())))
      .filter(x=> (getLinesFor(x.name).length>0));
    if(!candidates.length) return;
    for(let i=0; i<count && candidates.length>0; i++){
      const idx = Math.floor(Math.random()*candidates.length);
      const pick = candidates.splice(idx,1)[0];
      showBubble(pick.el, pick.name);
    }
  }

  function startClassTicker(){ stopClassTicker(); classTicker = setInterval(tickOnce, baseTickMs()); }
  function stopClassTicker(){ if(classTicker){ clearInterval(classTicker); classTicker=null; } }
  function restartClassTicker(){ stopClassTicker(); startClassTicker(); }

  /* ====== Page4: Editor with Undo/Redo ====== */
  const linesHistory = { past:[], future:[] };
  function pushLines(){ linesHistory.past.push(JSON.stringify(customLines)); linesHistory.future.length=0; }
  function undoLines(){ if(!linesHistory.past.length) return; const cur=JSON.stringify(customLines); const prev=linesHistory.past.pop(); linesHistory.future.push(cur); customLines=JSON.parse(prev); saveCustomLines(); renderEditPage(); }
  function redoLines(){ if(!linesHistory.future.length) return; const cur=JSON.stringify(customLines); const nxt=linesHistory.future.pop(); linesHistory.past.push(cur); customLines=JSON.parse(nxt); saveCustomLines(); renderEditPage(); }

  function renderEditPage(){
    const grid = $('#editGrid'); if(!grid) return;
    grid.innerHTML='';
    CLASSMATES.forEach(name=>{
      const card = document.createElement('div');
      card.className='card';
      const id = 'ta_'+btoa(unescape(encodeURIComponent(name))).replace(/=+/g,'');
      const lines = getLinesFor(name);
      const text = (Object.prototype.hasOwnProperty.call(customLines, name) ? customLines[name] : lines).join('\n');
      card.innerHTML = `
        <h4>${name}</h4>
        <textarea id="${id}" placeholder="1è¡Œ=1ã‚»ãƒªãƒ•ã€‚ç©ºã«ã™ã‚‹ã¨ãƒŸãƒ¥ãƒ¼ãƒˆ">${escapeHtml(text)}</textarea>
        <div class="row">
          <button data-name="${name}" class="btnClear">ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆç©ºã«ã™ã‚‹ï¼‰</button>
          <span class="muted">ç¾åœ¨ ${lines.length} ä»¶</span>
        </div>
      `;
      grid.appendChild(card);
      const ta = card.querySelector('textarea');
      ta.addEventListener('input',()=>{
        pushLines();
        const v = String(ta.value||'');
        const arr = v.split('\n').map(s=>s.trim()).filter(s=>s.length>0);
        customLines[name] = arr;
        scheduleLinesSave();
      });
      card.querySelector('.btnClear').addEventListener('click',()=>{
        pushLines();
        customLines[name] = [];
        const ta2 = card.querySelector('textarea'); ta2.value='';
        scheduleLinesSave();
      });
    });
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  $('#exportLines').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(customLines, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'class_lines.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  $('#importLinesFile').addEventListener('change',async(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const txt=await f.text();
      const obj=JSON.parse(txt);
      if(obj && typeof obj==='object'){ pushLines(); customLines = obj; saveCustomLines(); renderEditPage(); }
    }catch(_){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    e.target.value='';
  });

  /* ====== Timetable ====== */
  function ttKey(s=subject){ return `${TT_KEY}:${s}`; }
  function loadTT(s=subject){ try{ const raw=localStorage.getItem(ttKey(s)); return raw? JSON.parse(raw): []; }catch(_){ return []; } }
  function saveTT(s=subject, data){ try{ localStorage.setItem(ttKey(s), JSON.stringify(data)); }catch(_){} }

  function renderTimetable(){
    const title = $('#ttTitle'); title.textContent = showAll? 'ï¼ˆå…¨ç§‘ç›®ãƒ¢ãƒ¼ãƒ‰ï¼šè¡¨ç¤ºã®ã¿ï¼‰ä»Šæ—¥ã®æ™‚é–“å‰²' : `${subject} ã®ä»Šæ—¥ã®æ™‚é–“å‰²`;
    const rowsEl = $('#ttRows'); rowsEl.innerHTML='';
    const data = loadTT(subject);
    data.forEach((item,idx)=>{
      const row = document.createElement('div'); row.className='tt-row';
      row.innerHTML = `
        <div><input type="time" value="${item.start||''}"></div>
        <div><input type="time" value="${item.end||''}"></div>
        <div><input type="text" placeholder="ä½•ã‚’ã™ã‚‹ï¼Ÿ" value="${escapeHtml(item.title||'')}"></div>
        <div>
          <span class="linklike" data-act="up">â†‘</span>
          <span class="linklike" data-act="down" style="margin-left:8px">â†“</span>
          <span class="linklike" data-act="del" style="margin-left:8px">å‰Šé™¤</span>
        </div>`;
      const inputs = row.querySelectorAll('input');
      inputs[0].addEventListener('input',()=>{ item.start = inputs[0].value; saveTT(subject, data); });
      inputs[1].addEventListener('input',()=>{ item.end   = inputs[1].value; saveTT(subject, data); });
      inputs[2].addEventListener('input',()=>{ item.title = inputs[2].value; saveTT(subject, data); });
      row.querySelector('[data-act="del"]').addEventListener('click',()=>{ data.splice(idx,1); saveTT(subject, data); renderTimetable(); });
      row.querySelector('[data-act="up"]').addEventListener('click',()=>{ if(idx>0){ const t=data[idx-1]; data[idx-1]=data[idx]; data[idx]=t; saveTT(subject, data); renderTimetable(); }});
      row.querySelector('[data-act="down"]').addEventListener('click',()=>{ if(idx<data.length-1){ const t=data[idx+1]; data[idx+1]=data[idx]; data[idx]=t; saveTT(subject, data); renderTimetable(); }});
      rowsEl.appendChild(row);
    });
    $('#ttAddRow').disabled = showAll;
    $('#ttShuffle20').disabled = showAll;
    $('#ttAdopt').disabled = showAll;
  }

  // ææ¡ˆ20
  let proposals = []; let propIdx = 0;
  function genProposals(){
    const out=[];
    const today = new Date(); const todayYmd = ymd(today);
    const base = loadSubjectMonth(subject);
    const todo = [];
    base.forEach(r=>{
      if(r.date>=todayYmd && r.color!=='gray'){ if(r.goal) todo.push(r.goal); if(r.review) todo.push('å¾©ç¿’: '+r.review); }
    });
    if(todo.length===0){ todo.push('äºˆç¿’/å¾©ç¿’'); }
    const starts = ['07:30','08:00','13:00','15:30','16:00'];
    for(let k=0;k<20;k++){
      const plan=[];
      let cur = starts[Math.floor(Math.random()*starts.length)];
      let [h,m] = cur.split(':').map(Number);
      const endHour = 22;
      while(h<endHour){
        const dur = [45,50,60][Math.floor(Math.random()*3)];
        const brk = [5,10,10][Math.floor(Math.random()*3)];
        const title = todo[Math.floor(Math.random()*todo.length)];
        const startStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        let hm = h*60+m+dur; let eh=Math.floor(hm/60), em=hm%60;
        const endStr = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;
        plan.push({start:startStr, end:endStr, title});
        hm += brk; h=Math.floor(hm/60); m=hm%60;
        if(plan.length>8 && Math.random()<0.3) break;
      }
      out.push(plan);
    }
    return out;
  }

  $('#ttShuffle20').addEventListener('click',()=>{ proposals = genProposals(); propIdx=0; showProposal(); });
  function showProposal(){
    if(!proposals.length){ $('#ttPreview').textContent='ææ¡ˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè‡ªå‹•ææ¡ˆ(20)ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'; return; }
    $('#ttPreview').textContent = `ææ¡ˆ ${propIdx+1} / ${proposals.length}ã€€â† / â†’ ã§åˆ‡æ›¿ã€æ¡ç”¨ã§å›ºå®š`;
  }
  $('#ttAdopt').addEventListener('click',()=>{
    if(!proposals.length) return;
    saveTT(subject, proposals[propIdx]); renderTimetable();
  });
  document.addEventListener('keydown',(e)=>{
    const panelOpen = $('#ttBox').classList.contains('open');
    if(!panelOpen || !proposals.length) return;
    if(e.key==='ArrowRight'){ propIdx=(propIdx+1)%proposals.length; showProposal(); e.preventDefault(); }
    if(e.key==='ArrowLeft'){ propIdx=(propIdx+proposals.length-1)%proposals.length; showProposal(); e.preventDefault(); }
  });

  /* ====== Events ====== */
  (function initName(){
    const saved=localStorage.getItem(NAME_KEY);
    const me = saved || 'æ©‹æœ¬æ·‘é›…';
    $('#displayName').value = me;
    $('#meOnBoard').textContent = me;
  })();
  $('#saveName').addEventListener('click',()=>{
    const me = ($('#displayName').value||'æ©‹æœ¬æ·‘é›…').trim();
    localStorage.setItem(NAME_KEY, me);
    $('#meOnBoard').textContent = me;
    renderRank();
  });

  // ã‚¿ãƒ–
  $('#tabProgress').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });
  $('#tabClass').addEventListener('click',()=>showPage('class'));
  $('#tabRank').addEventListener('click',()=>showPage('rank'));
  $('#tabEdit').addEventListener('click',()=>showPage('edit'));

  function setActiveTab(t1,t2,t3,t4){
    $('#tabProgress').classList.toggle('active', t1);
    $('#tabClass').classList.toggle('active', t2);
    $('#tabRank').classList.toggle('active', t3);
    $('#tabEdit').classList.toggle('active', t4);
  }
  function showPage(which){
    const p1=$('#pageProgress'), p2=$('#pageClass'), p3=$('#pageRank'), p4=$('#pageEdit');
    const show = (a,b)=>{ a.style.display='block'; b.forEach(x=>x.style.display='none'); };
    if(which==='progress'){ show(p1,[p2,p3,p4]); setActiveTab(true,false,false,false); stopClassTicker(); renderProgress(); }
    if(which==='class'){ show(p2,[p1,p3,p4]); setActiveTab(false,true,false,false); buildClassroom(); restartClassTicker(); }
    if(which==='rank'){ show(p3,[p1,p2,p4]); setActiveTab(false,false,true,false); stopClassTicker(); renderRank(); }
    if(which==='edit'){ show(p4,[p1,p2,p3]); setActiveTab(false,false,false,true); stopClassTicker(); renderEditPage(); }
  }

  // æœˆç§»å‹•
  $('#prev').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month-=1; if(month<0){month=11;year-=1;} renderProgress(); renderRank(); });
  $('#next').addEventListener('click',()=>{ pushHistory(); flushAutoSave(); month+=1; if(month>11){month=0;year+=1;} renderProgress(); renderRank(); });

  // ä¿å­˜/èª­è¾¼
  $('#save').addEventListener('click',save);
  $('#load').addEventListener('click',()=>{ const ok=load(); renderProgress(); renderRank(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // è¡¨ç¤ºåˆ‡æ›¿
  $('#toggleCompact').addEventListener('click',()=>{ document.body.classList.toggle('compact'); setTimeout(scrollTodayIntoView,0); });

  // å–è¾¼
  $('#importPaste').addEventListener('click',()=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
    const text = prompt('æ—¥ä»˜ã¨ç¨®åˆ¥ã®ä¸€è¦§ã‚„ã€ç¸¦ä¸€åˆ—ã®è¡¨ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: 8/13(æ—¥) ä¼‘æ—¥ ãªã©ï¼‰');
    if(!text) return;
    pushHistory();
    const n = parseTypeImport(text) || importAnyText(text);
    renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆè¦‹å‡ºã—ãƒ»æœˆãƒ»æ›¸å¼ã‚’ç¢ºèªï¼‰');
  });
  $('#importFile').addEventListener('change',async (e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text();
    pushHistory();
    const n= importAnyText(txt);
    renderProgress(); renderRank();
    alert(n?`å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'åæ˜ å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆè¦‹å‡ºã—ãƒ»å½“æœˆã‹è¦ç¢ºèªï¼‰');
    e.target.value='';
  });
  $('#importImg').addEventListener('change',async (e)=>{
    if(showAll){ alert('å…¨ç§‘ç›®ï¼ˆä¸€è¦§ï¼‰ã§ã¯å–è¾¼ã§ãã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); e.target.value=''; return; }
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text = await ocrImage(f);
      pushHistory();
      const n = importAnyText(text) || parseTypeImport(text||'');
      renderProgress(); renderRank();
      alert(n?`OCRå–è¾¼ã§å½“æœˆã« ${n} ä»¶åæ˜ ã—ã¾ã—ãŸ`:'æ–‡å­—ãŒèªè­˜ã§ããªã„ã‹ã€å½“æœˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }catch(err){
      alert('OCRã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒã®é®®æ˜ã•ãƒ»ç…§æ˜ãƒ»å‚¾ãã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }finally{ e.target.value=''; }
  });

  // Undo/Redo/å…¨å‰Šé™¤
  $('#undoP').onclick = $('#undoC').onclick = $('#undoT').onclick = ()=>{ undo(); setTimeout(scrollTodayIntoView,0); };
  $('#redoP').onclick = $('#redoC').onclick = $('#redoT').onclick = ()=>{ redo(); setTimeout(scrollTodayIntoView,0); };
  $('#wipeP').onclick = ()=>{ if(confirm((showAll?'å…¨ç§‘ç›®ã®ä»Šæœˆè¡Œã‚’ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚':'å½“æœˆã®é€²æ—ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚')+'ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
      pushHistory();
      if(showAll){
        subjects.forEach(sub=>{
          const arr = loadSubjectMonth(sub);
          monthDates(year,month).forEach(ds=>{
            const r=arr.find(x=>x.date===ds);
            if(r){ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; }
          });
          doSaveToLocal(sub, arr);
        });
      }else{
        rows.forEach(r=>{ r.type='å­¦ç¿’'; r.goal=''; r.result=''; r.review=''; r.color='normal'; });
        touch();
      }
      renderProgress(); renderRank();
    } };
  $('#wipeC').onclick = ()=>{ if(confirm('Cãƒšãƒ¼ã‚¸ã®ç™ºè©±çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ recentLines.length=0; lastSpokenAt.clear(); buildClassroom(); } };
  $('#wipeT').onclick = ()=>{ if(confirm('ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ')){ renderRank(); } };

  // Page4 undo/redo
  $('#undoS').addEventListener('click', undoLines);
  $('#redoS').addEventListener('click', redoLines);
  $('#wipeS').addEventListener('click',()=>{
    if(!confirm('å…¨å“¡ã®ã‚»ãƒªãƒ•ã‚’ç©ºã«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    pushLines(); customLines={}; saveCustomLines(); renderEditPage();
  });

  // ğŸ¹ãƒ›ãƒ¼ãƒ 
  $('#fabHome').addEventListener('click',()=>{ showPage('progress'); setTimeout(scrollTodayIntoView,0); });

  // Rï¼å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
  $('#reloadBtn').addEventListener('click',()=>{ const url = location.pathname + '?r=' + Date.now(); location.replace(url); });

  // â‘¡ãƒšãƒ¼ã‚¸ é€Ÿã•%å¢—ã—
  (function initBoost(){
    const saved = localStorage.getItem(BOOST_KEY);
    const v = saved ? Number(saved) : 0;
    $('#boostInput').value = String(isFinite(v)?v:0);
    updateBoostHint();
  })();
  function updateBoostHint(){ const v = getBoost(); $('#boostHint').textContent = `ï¼ˆç¾åœ¨: ${v}%å¢—ã— / é–“éš”ã¨å¹ãå‡ºã—æ™‚é–“ã‚’çŸ­ç¸®ï¼‰`; }
  $('#applyBoost').addEventListener('click',()=>{ const v = getBoost(); localStorage.setItem(BOOST_KEY, String(v)); updateBoostHint(); restartClassTicker(); });
  $('#boostInput').addEventListener('change',()=>{ const v = getBoost(); localStorage.setItem(BOOST_KEY, String(v)); updateBoostHint(); restartClassTicker(); });

  // ç§‘ç›®UI
  function setShowAll(v){ showAll=!!v; $('#toggleAllBtn').classList.toggle('active', showAll); renderProgress(); }
  $('#toggleAllBtn').addEventListener('click',()=>{ pushHistory(); setShowAll(!showAll); });
  $('#addSubject').addEventListener('click',()=>{
    const name = prompt('è¿½åŠ ã™ã‚‹ç§‘ç›®åï¼ˆä¾‹ï¼šè‹±èªï¼‰'); if(!name) return;
    const trimmed = name.trim(); if(!trimmed) return;
    if(subjects.includes(trimmed)){ alert('ãã®ç§‘ç›®ã¯ã™ã§ã«ã‚ã‚Šã¾ã™'); return; }
    subjects.push(trimmed); saveSubjects(); renderSubjectSelect();
    subject = trimmed; setShowAll(false); renderProgress();
  });
  $('#subjectSelect').addEventListener('change', e=>{ pushHistory(); subject = e.target.value; setShowAll(false); renderProgress(); });

  // ç§‘ç›®ã‚«ãƒ©ãƒ¼æ“ä½œ
  function applyPreset(p){ const th=themeFor(subject); const cfg={hex:PRESETS[p].hex, accent:PRESETS[p].accent, tint:th.tint||12}; setTheme(subject,cfg); renderProgress(); }
  $('#presetRedSox').addEventListener('click',()=>applyPreset('RedSox'));
  $('#presetBlueJays').addEventListener('click',()=>applyPreset('BlueJays'));
  $('#presetDodgers').addEventListener('click',()=>applyPreset('Dodgers'));
  $('#presetNL').addEventListener('click',()=>applyPreset('NL'));
  $('#applyTheme').addEventListener('click',()=>{
    const hex = ($('#hexColor').value||$('#customColor').value||'#2d3748').trim();
    const ok = /^#?[0-9a-fA-F]{6}$/.test(hex);
    const use = hex.startsWith('#')?hex:('#'+hex);
    const tint = +$('#tintRange').value||12;
    if(!ok){ alert('ã‚«ãƒ©ãƒ¼ã¯ #RRGGBB ã§å…¥åŠ›ã—ã¦ã­'); return; }
    const th=themeFor(subject);
    setTheme(subject,{hex:use, accent:th.accent||use, tint});
    renderProgress();
  });
  $('#customColor').addEventListener('input',e=>{ $('#hexColor').value = e.target.value; });

  // å¸­æ›¿ãˆ
  $('#shuffleSeats').addEventListener('click',()=> buildClassroom(true));

  // æ™‚é–“å‰²ï¼šãƒ‘ãƒãƒ«é–‹é–‰
  $('#ttToggle').addEventListener('click',()=> $('#ttBox').classList.toggle('open'));
  $('#ttClose').addEventListener('click',()=> $('#ttBox').classList.remove('open'));

  // åˆæœŸåŒ–
  function renderAll(){
    renderSubjectSelect();
    $('#toggleAllBtn').classList.toggle('active', showAll);
    const p1 = $('#pageProgress').style.display!=='none';
    const p2 = $('#pageClass').style.display!=='none';
    const p3 = $('#pageRank').style.display!=='none';
    const p4 = $('#pageEdit').style.display!=='none';
    if(p1) renderProgress();
    if(p2) { buildClassroom(); restartClassTicker(); }
    if(p3) renderRank();
    if(p4) renderEditPage();
  }
  (function init(){
    renderSubjectSelect();
    load(); renderProgress(); document.body.classList.add('compact'); renderRank();
    setTimeout(scrollTodayIntoView,0);
  })();

})();
</script>
</body>
</html>
