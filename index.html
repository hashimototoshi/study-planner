<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Planner â€“ æœˆä¸€è¦§ï¼ˆæ›œæ—¥ã¤ããƒ»è¡Œè‰²å¯¾å¿œï¼‰</title>
<style>
  :root{
    --line:#e5e7eb; --muted:#6b7280;
    --today:#e6f0ff;      /* æœ¬æ—¥ï¼šè–„ã„é’ */
    --row-gray:#f3f4f6;   /* æ‰‹å‹•ï¼šè–„ã„ã‚°ãƒ¬ãƒ¼ */
  }
  *{box-sizing:border-box}
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;color:#111827;background:#fff}
  h1{margin:0 0 12px;font-size:18px}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .muted{color:var(--muted);font-size:12px}
  button,select,input[type="text"]{
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px
  }
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  .tbl{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{text-align:left;font-weight:600;font-size:12px;color:var(--muted)}
  td.padL{padding-left:22px} /* åˆ—é–“ã®ã‚†ã¨ã‚Š */
  td.small{width:120px}
  td.medium{width:160px}
  tr.today:not(.gray) td{background:var(--today)} /* æœ¬æ—¥ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆç°æŒ‡å®šæ™‚ã¯ä¸Šæ›¸ãã—ãªã„ï¼‰ */
  tr.gray td{background:var(--row-gray)}
  @media (max-width:820px){th,td{font-size:16px}button,select,input{font-size:16px}}
</style>
</head>
<body>
  <h1>å­¦ç¿’è¨ˆç”»ï¼ˆ1ãƒ¶æœˆè¡¨ç¤ºï¼æ›œæ—¥ã¤ãï¼‰</h1>
  <div class="bar">
    <button id="prev" class="primary">â—€ å‰æœˆ</button>
    <div id="label" class="muted"></div>
    <button id="next" class="primary">æ¬¡æœˆ â–¶</button>
    <button id="save">ğŸ’¾ ä¿å­˜</button>
    <button id="load">ğŸ“¥ èª­è¾¼</button>
  </div>

  <div class="tbl">
    <table>
      <thead>
        <tr>
          <th class="medium">æ—¥ä»˜</th>
          <th class="small padL">ç¨®åˆ¥</th>
          <th class="medium padL">ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰</th>
          <th class="medium padL">çµæœ</th>
          <th class="medium padL">å¾©ç¿’</th>
          <th class="small padL">è¡Œè‰²</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
(function(){
  'use strict';
  const KEY='studyplanner.month.form.v1';

  // æœˆåˆ‡æ›¿
  let year, month; // 0-11
  const now=new Date(); year=now.getFullYear(); month=now.getMonth();

  // ãƒ¢ãƒ‡ãƒ«ï¼šdate(YYYY-MM-DD), type('å­¦ç¿’'|'ä¼‘æ—¥'|'å¾©ç¿’'|''), goal, result, review, color('normal'|'gray')
  let rows=[];

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  const $=sel=>document.querySelector(sel);
  const ymd=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const fromYmd=s=>{const [y,m,d]=s.split('-').map(Number); return new Date(y, m-1, d);};
  const jpWeek=d=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  const jpDateLabel=s=>{const d=fromYmd(s);return `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeek(d)})`;};

  // æœˆã®æ—¥ä»˜ä¸€è¦§
  function monthDates(y,m){
    const first=new Date(y,m,1), last=new Date(y,m+1,0), arr=[];
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(ymd(d));
    return arr;
  }

  // ä»Šæœˆã®æ ã‚’ç”¨æ„ï¼ˆæ—¢å­˜ã¯æ¸©å­˜ï¼ç„¡ã„æ—¥ã ã‘ä½œæˆï¼‰
  function ensureScaffold(){
    const need=new Set(monthDates(year,month));
    const have=new Set(rows.map(r=>r.date));
    need.forEach(d=>{
      if(!have.has(d)){
        rows.push({date:d, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'}); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå­¦ç¿’ï¼ç›®æ¨™ç©º
      }
    });
    // ä»–æœˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ä¸€æ—¦æ®‹ã—ã¦ã‚‚è‰¯ã„ãŒã€è¡¨ç¤ºã¯ä»Šæœˆé™å®š
    rows.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function save(){
    try{
      const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
      const data=rows.filter(r=>fromYmd(r.date).getMonth()===month && fromYmd(r.date).getFullYear()===year);
      localStorage.setItem(key, JSON.stringify(data));
      alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰');
    }catch(e){}
  }

  function load(){
    const key=`${KEY}:${year}-${String(month+1).padStart(2,'0')}`;
    const raw=localStorage.getItem(key);
    if(!raw) return false;
    try{
      const data=JSON.parse(raw)||[];
      // ä»Šæœˆåˆ†ã‚’ãƒãƒ¼ã‚¸ï¼ˆä»–æœˆãƒ‡ãƒ¼ã‚¿ã¯ rows ã«æ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒè¡¨ç¤ºã¯ä»Šæœˆã®ã¿ï¼‰
      const map=new Map(rows.map(r=>[r.date,r]));
      data.forEach(d=>map.set(d.date, d));
      rows=[...map.values()];
      return true;
    }catch(e){ return false; }
  }

  function render(){
    ensureScaffold();
    $('#label').textContent=`${year}å¹´${month+1}æœˆï¼ˆ${monthDates(year,month).length}æ—¥ï¼‰`;

    const tb=$('#tbody'); tb.innerHTML='';
    const todayStr=ymd(new Date());

    monthDates(year,month).forEach(date=>{
      const r = rows.find(x=>x.date===date) || {date, type:'å­¦ç¿’', goal:'', result:'', review:'', color:'normal'};
      const tr=document.createElement('tr');

      // è¡Œè‰²ï¼ˆtodayå„ªå…ˆã€ãŸã ã—æ‰‹å‹•grayæŒ‡å®šãªã‚‰grayï¼‰
      if(r.color==='gray'){ tr.classList.add('gray'); }
      else if(date===todayStr){ tr.classList.add('today'); }

      // æ—¥ä»˜
      const tdDate=document.createElement('td');
      tdDate.className='medium';
      tdDate.textContent = jpDateLabel(date);

      // ç¨®åˆ¥
      const tdType=document.createElement('td'); tdType.className='small padL';
      const selType=document.createElement('select');
      ['å­¦ç¿’','ä¼‘æ—¥','å¾©ç¿’',''].forEach(opt=>{
        const o=document.createElement('option');
        o.value=opt; o.textContent = opt||'ï¼ˆæœªè¨­å®šï¼‰';
        if((r.type||'')===opt) o.selected=true;
        selType.appendChild(o);
      });
      selType.addEventListener('change',e=>{
        r.type=e.target.value;
        // ä¼‘æ—¥ã®ã¨ãã¯å…¥åŠ›æ¬„ã‚’ä½¿ã‚ãªã„ï¼ˆå€¤ã¯ä¿æŒï¼‰
        render(); // è¡¨ç¤ºçŠ¶æ…‹ã®æ›´æ–°ï¼ˆdisabledåˆ‡æ›¿ï¼‰
        persistInMemory(r);
      });
      tdType.appendChild(selType);

      // ç›®æ¨™ï¼ˆç§‘ç›®åï¼‰
      const tdGoal=document.createElement('td'); tdGoal.className='medium padL';
      const inGoal=document.createElement('input'); inGoal.type='text'; inGoal.placeholder='ä¾‹ï¼šä¸–ç•Œå² 23ã€œ24';
      inGoal.value=r.goal||'';
      inGoal.disabled = (r.type==='ä¼‘æ—¥');
      inGoal.addEventListener('input',e=>{ r.goal=e.target.value; persistInMemory(r); });
      tdGoal.appendChild(inGoal);

      // çµæœ
      const tdRes=document.createElement('td'); tdRes.className='medium padL';
      const inRes=document.createElement('input'); inRes.type='text'; inRes.placeholder='å®Ÿç¸¾';
      inRes.value=r.result||'';
      inRes.disabled = (r.type==='ä¼‘æ—¥');
      inRes.addEventListener('input',e=>{ r.result=e.target.value; persistInMemory(r); });
      tdRes.appendChild(inRes);

      // å¾©ç¿’
      const tdRev=document.createElement('td'); tdRev.className='medium padL';
      const inRev=document.createElement('input'); inRev.type='text'; inRev.placeholder='å¾©ç¿’ç¯„å›²';
      inRev.value=r.review||'';
      inRev.disabled = (r.type==='ä¼‘æ—¥');
      inRev.addEventListener('input',e=>{ r.review=e.target.value; persistInMemory(r); });
      tdRev.appendChild(inRev);

      // è¡Œè‰²ï¼ˆæ‰‹å‹•ï¼‰
      const tdClr=document.createElement('td'); tdClr.className='small padL';
      const selClr=document.createElement('select');
      [{v:'normal',t:'é€šå¸¸'},{v:'gray',t:'è–„ã„ã‚°ãƒ¬ãƒ¼'}].forEach(p=>{
        const o=document.createElement('option'); o.value=p.v; o.textContent=p.t;
        if((r.color||'normal')===p.v) o.selected=true;
        selClr.appendChild(o);
      });
      selClr.addEventListener('change',e=>{
        r.color=e.target.value;
        render(); // å³åæ˜ 
        persistInMemory(r);
      });
      tdClr.appendChild(selClr);

      tr.appendChild(tdDate);
      tr.appendChild(tdType);
      tr.appendChild(tdGoal);
      tr.appendChild(tdRes);
      tr.appendChild(tdRev);
      tr.appendChild(tdClr);

      tb.appendChild(tr);
    });
  }

  // rowsé…åˆ—å†…ã®è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
  function persistInMemory(rec){
    const i = rows.findIndex(x=>x.date===rec.date);
    if(i>=0) rows[i]=rec; else rows.push(rec);
    // ä¿å­˜ã¯æ˜ç¤ºãƒœã‚¿ãƒ³ã§ã€‚ã“ã¾ã‚ã«ä¿å­˜ã—ãŸã„ãªã‚‰ã“ã“ã§ localStorage ã—ã¦ã‚‚OKã€‚
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  $('#prev').addEventListener('click',()=>{ month-=1; if(month<0){month=11;year-=1;} load(); render(); });
  $('#next').addEventListener('click',()=>{ month+=1; if(month>11){month=0;year+=1;} load(); render(); });
  $('#save').addEventListener('click',save);
  $('#load').addEventListener('click',()=>{ const ok=load(); render(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });

  // åˆæœŸæç”»
  load(); render();
})();
</script>
</body>
</html>
