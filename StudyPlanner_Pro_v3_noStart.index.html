<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StudyPlannerï¼ˆä»Šæœˆ1ã‹æœˆå¸¸æ™‚è¡¨ç¤º / é–‹å§‹æ™‚é–“ãªã—ï¼‰</title>
<style>
  :root { --fg:#111827; --bg:#fff; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --chip:#eef2ff; }
  *{box-sizing:border-box}
  body{margin:0;color:var(--fg);background:var(--bg);font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
  .wrap{display:flex;gap:8px;align-items:center;padding:10px 12px;flex-wrap:wrap}
  h1{margin:0;font-size:16px;font-weight:700}
  button,select,input[type="date"],input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button.ghost{background:#f8fafc}
  main{padding:14px;max-width:1000px;margin:0 auto}
  .tbl{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  th,td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;background:#fff}
  th{text-align:left;font-weight:600;font-size:12px;color:var(--muted)}
  td.right{text-align:right}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;display:flex;gap:8px;align-items:center}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:var(--chip);font-size:14px}
  .sep{height:10px}
  @media (max-width:820px){th,td{font-size:16px}input,select,button{font-size:16px}select{width:100%}}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>StudyPlannerï¼ˆä»Šæœˆå¸¸æ™‚è¡¨ç¤ºï¼‰</h1>
    <button id="regenBtn" class="primary">ğŸ” ä»Šæœˆã‚’å†ç”Ÿæˆ</button>
    <button id="saveBtn" class="ghost">ğŸ’¾ ä¿å­˜</button>
    <button id="loadBtn" class="ghost">ğŸ“¥ èª­è¾¼</button>
    <button id="exportBtn" class="ghost">â¬‡ï¸ JSON</button>
    <input id="importFile" type="file" accept=".json" style="display:none">
    <button id="importBtn" class="ghost">â¬†ï¸ JSON</button>
    <span class="muted" id="monthLabel"></span>
  </div>
</header>

<main>
  <details>
    <summary>ç§‘ç›®ã®ç®¡ç†</summary>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
      <input id="newSubject" type="text" placeholder="ç§‘ç›®ã‚’è¿½åŠ ï¼ˆä¾‹ï¼šä¸–ç•Œå²ã€è‹±èªã€æ•°å­¦ï¼‰">
      <button id="addSubject" class="ghost">ï¼‹ è¿½åŠ </button>
      <span class="muted">ç¾åœ¨ã®ç§‘ç›®ï¼š</span>
      <div id="subjectChips" class="chips"></div>
    </div>
  </details>

  <div class="sep"></div>

  <h3>ç·¨é›†ãƒ“ãƒ¥ãƒ¼ï¼ˆä»Šæœˆï¼šå…¨æ—¥ä»˜ã‚’å¿…ãšè¡¨ç¤ºï¼‰</h3>
  <div class="tbl">
    <table>
      <thead>
        <tr>
          <th style="width:170px">æ—¥ä»˜</th>
          <th style="width:150px">ç¨®åˆ¥</th>
          <th>ç§‘ç›®ï¼ˆå­¦ç¿’ã®ã¨ããƒã‚§ãƒƒã‚¯ï¼‰</th>
          <th class="right" style="width:120px"></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="sep"></div>

  <h3>å±•é–‹ãƒ“ãƒ¥ãƒ¼</h3>
  <div class="tbl">
    <table>
      <thead>
        <tr>
          <th style="width:170px">æ—¥ä»˜</th>
          <th style="width:200px">ç¨®åˆ¥/ç§‘ç›®</th>
        </tr>
      </thead>
      <tbody id="xtbody"></tbody>
    </table>
  </div>
</main>

<script>
(function(){
  'use strict';
  const KEY='studyplanner.noStart.monthScaffold.v1';
  const subjects=new Set(['ä¸–ç•Œå²','è‹±èª']);
  let rows=[]; // {id,date(YYYY-MM-DD),type:'å­¦ç¿’'|'ä¼‘æ—¥'|'',subjects:[]}

  const $=sel=>document.querySelector(sel);
  const $$=sel=>Array.from(document.querySelectorAll(sel));
  const uid=()=>Math.random().toString(36).slice(2,9);
  const esc=s=>String(s).replace(/[&<>\"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  const ymd=(d)=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  const jpWeek=(d)=>'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
  function parseYMD(s){ const [y,m,dd]=s.split('-').map(Number); return new Date(y,m-1,dd); }

  // ä»Šæœˆã®1æ—¥ã€œæœ«æ—¥ é…åˆ—
  function monthDates(baseDate=new Date()){
    const y=baseDate.getFullYear(), m=baseDate.getMonth(); // ä»Šæœˆ
    const first=new Date(y,m,1);
    const last=new Date(y,m+1,0);
    $('#monthLabel').textContent = `å¯¾è±¡: ${y}å¹´${m+1}æœˆï¼ˆ${first.getMonth()+1}/1ã€œ${last.getMonth()+1}/${last.getDate()}ï¼‰`;
    const out=[];
    for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)){
      out.push(ymd(d));
    }
    return out;
  }

  // rows ã«ã€Œä»Šæœˆã®æœ€ä½1è¡Œ/æ—¥ã€ã‚’ä¿è¨¼ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ç¶­æŒï¼‰
  function ensureMonthScaffold(){
    const need = new Set(monthDates());
    // æ—¢ã«å­˜åœ¨ã™ã‚‹æ—¥ä»˜ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    const have = new Map(); // date -> count
    rows.forEach(r=>{ const k=r.date; have.set(k,(have.get(k)||0)+1); });
    // ç„¡ã„æ—¥ä»˜ã¯ç©ºè¡Œã‚’è¿½åŠ ï¼ˆtypeç©ºã§OKï¼‰
    need.forEach(date=>{
      if(!have.has(date)){ rows.push({ id:uid(), date, type:'', subjects:[] }); }
    });
    // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
    rows.sort((a,b)=> (a.date||'').localeCompare(b.date||'') );
  }

  function renderSubjectChips(){
    const box=$('#subjectChips'); box.innerHTML='';
    [...subjects].forEach(name=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${esc(name)}</span> <button class="ghost" data-del="${esc(name)}">Ã—</button>`;
      box.appendChild(chip);
    });
  }

  function subjectChecks(row){
    const wrap=document.createElement('div'); wrap.className='chips';
    [...subjects].forEach(name=>{
      const span=document.createElement('span'); span.className='chip';
      const checked = row.subjects.includes(name) ? 'checked' : '';
      span.innerHTML=`<label><input type="checkbox" data-sub="${esc(name)}" ${checked}>${esc(name)}</label>`;
      wrap.appendChild(span);
    });
    wrap.addEventListener('change',e=>{
      const input=e.target; if(!input.matches('input[type="checkbox"][data-sub]'))return;
      const name=input.getAttribute('data-sub');
      if(input.checked){ if(!row.subjects.includes(name)) row.subjects.push(name); }
      else{ row.subjects=row.subjects.filter(s=>s!==name); }
      renderExpanded(); save();
    });
    return wrap;
  }

  function renderEdit(){
    ensureMonthScaffold();
    const tb=$('#tbody'); tb.innerHTML='';
    rows.forEach(r=>{
      // ä»Šæœˆä»¥å¤–ã®è¡ŒãŒã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå°†æ¥ã®æ‹¡å¼µã«å‚™ãˆï¼‰
      const d=parseYMD(r.date), now=new Date();
      if(d.getMonth()!==now.getMonth() || d.getFullYear()!==now.getFullYear()) return;

      const tr=document.createElement('tr'); tr.dataset.id=r.id;

      // æ—¥ä»˜ï¼ˆå›ºå®šè¡¨ç¤ºï¼‹æ›œæ—¥ï¼‰
      const tdD=document.createElement('td');
      const dt=parseYMD(r.date);
      const label = `${dt.getMonth()+1}/${dt.getDate()}ï¼ˆ${jpWeek(dt)}ï¼‰`;
      tdD.innerHTML = `<div>${label}</div><div class="muted">${r.date}</div>`;

      // ç¨®åˆ¥
      const tdT=document.createElement('td');
      const sel=document.createElement('select'); ['','å­¦ç¿’','ä¼‘æ—¥'].forEach(opt=>{
        const o=document.createElement('option'); o.value=opt; o.textContent=opt||'ï¼ˆæœªè¨­å®šï¼‰';
        if(r.type===opt) o.selected=true; sel.appendChild(o);
      });
      sel.addEventListener('change',e=>{ r.type=e.target.value; if(r.type!=='å­¦ç¿’') r.subjects=[]; renderAll(); save(); });
      tdT.appendChild(sel);

      // ç§‘ç›®ï¼ˆå­¦ç¿’ã®ã¿ï¼‰
      const tdS=document.createElement('td');
      if(r.type==='å­¦ç¿’'){ tdS.appendChild(subjectChecks(r)); }
      else { tdS.innerHTML='<span class="muted">â€”</span>'; }

      // è¿½åŠ å‰Šé™¤ï¼ˆåŒæ—¥è¤‡æ•°ã‚¿ã‚¹ã‚¯ã‚‚å¯ï¼‰
      const tdOp=document.createElement('td'); tdOp.className='right';
      const addBtn=document.createElement('button'); addBtn.textContent='åŒæ—¥ï¼‹';
      addBtn.addEventListener('click',()=>{
        rows.push({ id:uid(), date:r.date, type:'å­¦ç¿’', subjects:[...subjects] });
        renderAll(); save();
      });
      const delBtn=document.createElement('button'); delBtn.textContent='å‰Šé™¤';
      delBtn.style.marginLeft='6px';
      delBtn.addEventListener('click',()=>{
        // ä»Šæœˆåˆ†ã¯æœ€ä½1è¡Œ/æ—¥ã‚’ç¶­æŒï¼šåŒæ—¥ãŒ1è¡Œã—ã‹ãªã„æ™‚ã¯ã€Œæœªè¨­å®šã€ã«ãƒªã‚»ãƒƒãƒˆ
        const sameDay = rows.filter(x=>x.date===r.date);
        if(sameDay.length<=1){
          r.type=''; r.subjects=[]; renderAll(); save();
        }else{
          rows = rows.filter(x=>x.id!==r.id); renderAll(); save();
        }
      });
      tdOp.appendChild(addBtn); tdOp.appendChild(delBtn);

      tr.appendChild(tdD); tr.appendChild(tdT); tr.appendChild(tdS); tr.appendChild(tdOp);
      tb.appendChild(tr);
    });
  }

  function renderExpanded(){
    const tb=$('#xtbody'); tb.innerHTML='';
    const now=new Date();
    const out=[];
    rows.forEach(r=>{
      const d=parseYMD(r.date);
      if(d.getMonth()!==now.getMonth() || d.getFullYear()!==now.getFullYear()) return;
      if(!r.type){ out.push({date:r.date,label:'ï¼ˆæœªè¨­å®šï¼‰'}); }
      else if(r.type==='ä¼‘æ—¥'){ out.push({date:r.date,label:'ä¼‘æ—¥'}); }
      else if(r.subjects.length===0){ out.push({date:r.date,label:'å­¦ç¿’ï¼ˆæœªé¸æŠï¼‰'}); }
      else r.subjects.forEach(s=> out.push({date:r.date,label:s}));
    });
    out.sort((a,b)=> (a.date||'').localeCompare(b.date||'') || a.label.localeCompare(b.label));
    out.forEach(rec=>{
      const d=parseYMD(rec.date);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.getMonth()+1}/${d.getDate()}ï¼ˆ${jpWeek(d)}ï¼‰<div class="muted">${rec.date}</div></td><td><span class="pill">${esc(rec.label)}</span></td>`;
      tb.appendChild(tr);
    });
  }

  function renderSubjectChips(){
    const box=$('#subjectChips'); box.innerHTML='';
    [...subjects].forEach(name=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span>${esc(name)}</span> <button class="ghost" data-del="${esc(name)}">Ã—</button>`;
      box.appendChild(chip);
    });
  }

  function renderAll(){ renderSubjectChips(); renderEdit(); renderExpanded(); }
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify({rows,subjects:[...subjects]})); }catch(e){} }
  function load(){ const raw=localStorage.getItem(KEY); if(!raw) return false; try{ const d=JSON.parse(raw); rows=Array.isArray(d.rows)?d.rows:[]; subjects.clear(); (d.subjects||[]).forEach(s=>subjects.add(s)); return true; }catch(e){ return false; } }
  function exportJSON(){
    const payload= {rows, subjects:[...subjects]};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='studyplanner_month.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function importJSON(file){
    const r=new FileReader();
    r.onload=e=>{ try{ const d=JSON.parse(e.target.result); rows=Array.isArray(d.rows)?d.rows:[]; subjects.clear(); (d.subjects||[]).forEach(s=>subjects.add(s)); renderAll(); save(); } catch(err){ alert('èª­ã¿è¾¼ã¿å¤±æ•—: '+err.message); } };
    r.readAsText(file);
  }

  // Events
  document.addEventListener('click',e=>{
    const del=e.target.closest('button[data-del]');
    if(del){ const name=del.getAttribute('data-del'); subjects.delete(name); rows.forEach(r=>r.subjects=r.subjects.filter(s=>s!==name)); renderAll(); save(); }
  }, {passive:true});
  $('#regenBtn').addEventListener('click',()=>{ ensureMonthScaffold(); renderAll(); save(); });
  $('#saveBtn').addEventListener('click',()=>{ save(); alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰'); });
  $('#loadBtn').addEventListener('click',()=>{ const ok=load(); renderAll(); alert(ok?'èª­ã¿è¾¼ã¿ã¾ã—ãŸ':'ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); });
  $('#exportBtn').addEventListener('click',exportJSON);
  $('#importBtn').addEventListener('click',()=> $('#importFile').click());
  $('#importFile').addEventListener('change',e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });

  // åˆæœŸåŒ–ï¼šä¿å­˜èª­è¾¼â†’ä»Šæœˆã‚¹ã‚­ãƒ£ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰â†’æç”»
  load(); ensureMonthScaffold(); renderAll();
})();
</script>
</body>
</html>
